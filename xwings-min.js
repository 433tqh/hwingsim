function loadrock(t){var e;for(PATTERN=t.image(ROCKIMG,0,0,200,200).pattern(0,0,200,200),e=1;6>=e;e++)Snap.load("data/rock"+e+".svg",function(t){OBSTACLES.push(new Rock(t))})}function getid(){return id++}function Rock(t){var e,i=getid(),n=[300,500,300,500,300,500],a=[250,250,400,400,550,550];for(this.g=t.select("path"),this.g.attr({fill:PATTERN,strokeWidth:0,stroke:"#F00"}),this.o=[],this.name="Asteroid #"+i,this.arraypts=[],e=0;e<this.g.getTotalLength();e+=5)this.arraypts.push(this.g.getPointAtLength(e));this.dragged=!1,this.m=(new Snap.Matrix).add(MT(n[i],a[i])).add(MS(.5,.5)),this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this)),this.path="",this.g.hover(function(){this.g.attr({strokeWidth:4})}.bind(this),function(){this.g.attr({strokeWidth:0})}.bind(this)),this.g.addClass("unit");var o=this.g.getBBox();this.g.transform("t "+-o.width/2+" "+-o.height/2),this.showrange=!0,this.show()}function winevent(){return new CustomEvent("win",{detail:{time:new Date},bubbles:!0,cancelable:!0})}function Team(t){"undefined"==typeof isia&&(isia=!1),this.team=t,this.isdead=!1,this.isia=!1,this.units=[]}function center(){var t=activeunit.g.getBBox();$("#playmat").scrollLeft(t.x-window.innerWidth/2+t.width/2),$("#playmat").scrollTop(t.y-window.innerHeight/2+t.height/2)}function prevselect(){if(!(waitingforaction>0)){var t=activeunit;if(phase==ACTIVATION_PHASE||phase==COMBAT_PHASE){if(-1==skillturn)return;active=0==active?tabskill[skillturn].length-1:active-1,tabskill[skillturn][active].select()}else active=0==active?squadron.length-1:active-1,squadron[active].select();t.unselect()}}function nextselect(){if(!(waitingforaction>0)){var t=activeunit;if(phase==ACTIVATION_PHASE||phase==COMBAT_PHASE){if(-1==skillturn)return;active=active==tabskill[skillturn].length-1?0:active+1,tabskill[skillturn][active].select()}else active=active==squadron.length-1?0:active+1,squadron[active].select();t.unselect()}}function hitrangetostr(t){var e,i,n,a,o="",s=[];for(a=0;a<squadron.length&&squadron[a]!=activeunit;a++);for(e=1;3>=e;e++)if(t[e].length>0)for(i=0;i<t[e].length;i++){var n=t[e][i].unit,r=squadron[n];for(o+="<tr>",o+="<td class='tohit'>"+e+"</td>",o+="<td>"+r.name+"</td>",w=0;w<t[e][i].wp.length;w++){var l=activeunit.weapons[w],c=activeunit.evaluatetohit(w,r);if(void 0==c)break;var d=c.tokill[r.hull+r.shield];d="undefined"==typeof d?0:Math.floor(1e4*d)/100,-1==s.indexOf(l.type)&&s.push(l.type),o+="<td class='probacell' style='background:hsl("+1.2*(100-c.tohit)+",100%,80%)'",o+=phase==COMBAT_PHASE&&skillturn==activeunit.skill&&activeunit.canfire()?" onclick='resolvecombat("+n+","+w+")'>":">",o+="<div class='reddice'>"+activeunit.getattackstrength(w,r)+"</div><div class='greendice'>"+r.getdefensestrength(w,activeunit)+"</div>",o+="<div>"+c.tohit+"%</div><div><code class='symbols' style='border:0'>d</code>"+c.meanhit+"</div><div><code class='symbols'  style='border:0'>c</code>"+c.meancritical+"</div><div>"+d+"% kill</div>",o+="</td>"}o+="</tr>"}if(""==o)o="No unit in range of "+activeunit.name,activeunit.istargeting=!1;else{var h="";for(h="<table><tr><th>Range</th><th>Name</th>",e=0;e<s.length;e++)h+="<th style='width:2em;border:0'><div class='"+s[e]+"' style='width:100px;border:0;background:white;color:black'></div></th>";o=h+"</tr>"+o+"</table>"}return o}function inhitrange(){$("#listtitle").html("Units in weapon range of "+activeunit.name),$("#listunits").html(hitrangetostr(activeunit.gethitrangeallunits())),window.location="#modal"}function unitstostr(){var t,e,i=["","",""];for(e=0;e<squadron.length;e++){var n=squadron[e];i[n.team]+=n}return t="<div id='squad1'><div>Stats</div><div>Names</div><div>Ship</div><div>Points</div><div>Description</div></div>"+i[1]+"<div id='squad2'><div>Stats</div><div>Names</div><div>Ship</div><div>Points</div><div>Description</div></div>"+i[2]}function allunitlist(){$("#listtitle").html("List of units"),$("#listunits").html(unitstostr()),window.location="#modal"}function nextstep(){0==waitingforaction&&(phase==ACTIVATION_PHASE&&(enablenextphase(),log("after enablenextphase:"+waitingforaction),activeunit.show(),log("after show:"+waitingforaction),nextactivation(),log("after nextactivation:"+waitingforaction)),phase==COMBAT_PHASE&&nextcombat())}function nextcombat(){for(var t,e=0,i=0,n=activeunit;0==e&&skillturn>=0;){for(t=0;t<tabskill[skillturn].length;t++)if(tabskill[skillturn][t].canfire()){e++,i=t;break}if(0==e)for(skillturn--;skillturn>=0&&0==tabskill[skillturn].length;)skillturn--}if(-1==skillturn){for(log("No more firing units, ready to end phase."),t=0;t<squadron.length;t++)squadron[t].endcombatphase();return void $(".nextphase").prop("disabled",!1)}e=tabskill[skillturn].length,active=i,tabskill[skillturn][i].select(),n.unselect(),activeunit.beginattack(),activeunit.show()}function nextactivation(){var t,e=0,i=0;if(!(skillturn>12)){for(t=0;t<tabskill[skillturn].length;t++)-1!=tabskill[skillturn][t].maneuver&&(e++,i=t);if(0==e){for(skillturn++;13>skillturn&&0==tabskill[skillturn].length;)skillturn++;if(13==skillturn)return;e=tabskill[skillturn].length,i=0}var n=activeunit;active=i,tabskill[skillturn][i].select(),n.unselect(),activeunit.beginactivation()}}function modroll(t,e,i){var n,a=0,o=$(".focusreddice").length,s=$(".hitreddice").length,r=$(".criticalreddice").length,l=t(100*o+10*r+s,e);for($("#attack").empty(),n=0;n<Math.floor(l/100)%10;n++,a++)$("#attack").append("<b class='focusreddice'></b>");for(n=0;n<Math.floor(l/10)%10;n++,a++)$("#attack").append("<b class='criticalreddice'></b>");for(n=0;l%10>n;n++,a++)$("#attack").append("<b class='hitreddice'></b>");for(n=a;e>n;n++)$("#attack").append("<b class='blankreddice'></b>");$("#moda"+i).remove()}function modrolld(t,e,i){{var n,a=0,o=$(".focusgreendice").length,s=$(".evadegreendice").length,r=t(10*o+s,e);Math.floor(r/10)}for($("#defense").empty(),n=0;n<Math.floor(r/10);n++,a++)$("#defense").append("<b class='focusgreendice'></b>");for(n=0;r%10>n;n++,a++)$("#defense").append("<b class='evadegreendice'></b>");for(n=a;e>n;n++)$("#defense").append("<b class='blankgreendice'></b>");$("#modd"+i).remove()}function reroll(t,e,i,n){var a,o,s=0,r=["blank","focus","hit","critical"],l=["blank","focus","evade"];if(e){for(a=0;4>a;a++)i%10>=1&&(o=$("."+r[a]+"reddice:not([noreroll])"),o.length<t?(o.remove(),s+=o.length,t-=o.length):($("."+r[a]+"reddice:lt("+t+"):not([noreroll])").remove(),s+=t,t=0),i=Math.floor(i/10));for($("#rerolla"+n).remove(),a=0;s>a;a++){var c=Math.floor(7*Math.random());$("#attack").prepend("<td noreroll='true' class='"+FACE[ATTACKDICE[c]]+"reddice'></td>")}}else{for(a=0;3>a;a++)i%10>=1&&(o=$("."+l[a]+"greendice:not([noreroll])"),o.length<t?(o.remove(),s+=o.length,t-=o.length):($("."+r[a]+"greendice:lt("+t+"):not([noreroll])").remove(),s+=t,t=0),i=Math.floor(i/10));for($("#rerolld"+n).remove(),a=0;s>a;a++){var c=Math.floor(7*Math.random());$("#defense").prepend("<td noreroll='true' class='"+FACE[DEFENSEDICE[c]]+"greendice'></td>")}}}function enablenextphase(){var t,e=!0;switch(phase){case PLANNING_PHASE:for(t=0;t<squadron.length;t++)if(squadron[t].maneuver<0&&!squadron[t].isdead){e=!1;break}e&&$(".nextphase").prop("disabled")&&log("All units have planned a maneuver, ready to end phase");break;case ACTIVATION_PHASE:for(t=0;t<squadron.length;t++)if(squadron[t].maneuver>=0&&!squadron[t].isdead){e=!1;break}e&&$(".nextphase").prop("disabled")&&log("All units have been activated, ready to end phase")}return e&&$(".nextphase").prop("disabled",!1),e}function firecomplete(t){$("#primary").hide(),showfire(t.detail.ar,t.detail.da,t.detail.dr,t.detail.dd)}function win(){var t="",e=[];for(TEAMS[1].checkdead()&&!TEAMS[2].checkdead()&&(t="Team #2 wins !"),TEAMS[2].checkdead()&&!TEAMS[1].checkdead()&&(t="Team #1 wins !"),TEAMS[1].checkdead()&&TEAMS[2].checkdead()&&(t="Draw !"),$("#listtitle").html(t),e[1]="",e[2]="",i=0;i<allunits.length;i++){var n=allunits[i];e[n.team]+="<tr><td>"+n.name+"</td><td>"+Math.floor(100*n.hitresolved/round)/100+"</td><td>"+Math.floor(100*n.criticalresolved/round)/100+"</td></tr>"}e[1]="<table><tr><th>Name</th><th>Avg. Hits/round</th><th>Avg. Crit./round</th></tr>"+e[1]+"</table>",e[2]="<table><tr><th>Name</th><th>Avg. Hits/round</th><th>Avg. Crit./round</th></tr>"+e[2]+"</table>",$("#listunits").html(e[1]+e[2]),window.location="#modal"}function bind(t,e,i){$(document.body).bind("keydown."+t,jwerty.event(e,i))}function unbind(t){$(document.body).unbind("keydown."+t)}function bindall(t){var e,i=keybindings[t];for(e=0;e<i.length;e++)bind(t,i[e].k,i[e].f)}function filltabskill(){for(tabskill=[],i=0;i<=12;i++)tabskill[i]=[];for(i=0;i<squadron.length;i++)tabskill[squadron[i].skill].push(squadron[i])}function nextphase(){var t;switch(window.location="#",phase){case SELECT_PHASE1:$("#rightpanel").show(),zone[1]=s.rect(0,0,100,900).attr({fill:TEAMS[1].color,strokeWidth:2,opacity:.3,pointerEvents:"none"}),zone[1].appendTo(s);break;case SELECT_PHASE2:zone[2]=s.rect(800,0,900,900).attr({fill:TEAMS[2].color,strokeWidth:2,opacity:.3,pointerEvents:"none"}),zone[2].appendTo(s);break;case SETUP_PHASE:for(activeunit.g.undrag(),zone[1].remove(),zone[2].remove(),t=0;t<SOUNDS.length;t++)$("#"+SOUNDS[t]).trigger("load");for($(".nextphase").prop("disabled",!0),$(".unit").css("cursor","pointer"),$("#positiondial").hide(),t=0;t<OBSTACLES.length;t++)OBSTACLES[t].g.undrag();break;case PLANNING_PHASE:$("#maneuverdial").hide();break;case ACTIVATION_PHASE:for($("#actiondial").hide(),$("#activationdial").hide(),t=0;t<squadron.length;t++)squadron[t].hasmoved=!1,squadron[t].actiondone=!1,squadron[t].endactivationphase();var e=[];for(t=0;t<BOMBS.length;t++)e[t]=BOMBS[t];for(t=0;t<e.length;t++)e[t].explode();break;case COMBAT_PHASE:for($("#attackdial").hide(),$("#listunits").html(""),t=0;t<squadron.length;t++)squadron[t].endround();round++}if(waitingforaction=0,phase=phase==COMBAT_PHASE?PLANNING_PHASE:phase+1,$("#phase").html(3>phase?phasetext[phase]:"Turn #"+round+" "+phasetext[phase]),$("#combatdial").hide(),phase>SELECT_PHASE2)for(t=0;t<squadron.length;t++)squadron[t].unselect();for(t=SELECT_PHASE1;COMBAT_PHASE>=t;t++)t!=phase?unbind("phase"+t):bindall("phase"+t);switch(phase){case SELECT_PHASE1:$(".activeunit").prop("disabled",!0),$("#rightpanel").hide();break;case SELECT_PHASE2:TEAMS[1].endselection(s);break;case SETUP_PHASE:TEAMS[2].endselection(s),$(".activeunit").prop("disabled",!1),loadrock(s),activeunit=squadron[0],activeunit.select(),activeunit.show(),jwerty.key("l",allunitlist),jwerty.key("w",inhitrange),jwerty.key("s",function(){activeunit.togglehitsector()}),jwerty.key("shift+s",function(){activeunit.togglerange()}),jwerty.key("x",function(){window.location="#"}),jwerty.key("escape",nextphase),jwerty.key("c",center),jwerty.key("0",function(){log("active:"+activeunit.name+" wfa:"+waitingforaction+" hasfire:"+activeunit.hasfired+" hasdamaged:"+activeunit.damage+" m:"+activeunit.maneuver+" a:"+activeunit.action)}),jwerty.key("1",function(){activeunit.focus++,activeunit.show()}),jwerty.key("2",function(){activeunit.evade++,activeunit.show()}),jwerty.key("3",function(){activeunit.iscloaked||(activeunit.iscloaked=!0,activeunit.agility+=2,activeunit.show())}),jwerty.key("4",function(){activeunit.stress++,activeunit.show()}),log("<div>[turn "+round+"] Setup phase</div>"),$(".unit").css("cursor","move"),$("#positiondial").show(),bindall("select");break;case PLANNING_PHASE:log("<div>[turn "+round+"] Planning phase</div>"),$(".nextphase").prop("disabled",!0),$("#maneuverdial").show();var i=activeunit;for(squadron[0].select(),i.unselect(),t=0;t<squadron.length;t++)squadron[t].beginplanningphase();break;case ACTIVATION_PHASE:for(log("<div>[turn "+round+"] Activation phase</div>"),$(".nextphase").prop("disabled",!0),$("#activationdial").show(),t=0;t<squadron.length;t++)squadron[t].beginactivationphase();filltabskill(),skillturn=0,nextactivation();break;case COMBAT_PHASE:for(waitingforaction=0,log("<div>[turn "+round+"] Combat phase</div>"),$("#attackdial").show(),skillturn=12,t=0;t<squadron.length;t++)squadron[t].begincombatphase();nextstep()}phase>SELECT_PHASE2&&activeunit.show()}function log(t){$("#log").append("<div>"+t+"<div>"),$("footer").scrollTop(1e4)}function record(){}function select(t){var e;for(e=0;e<squadron.length&&squadron[e].id!=t;e++);var i=activeunit;activeunit=squadron[e],activeunit.select(),$("#"+i.id).attr({color:"black",background:"white"}),$("#"+activeunit.id).attr({color:"white",background:"tomato"}),i.unselect()}function addattackdice(t,e){var i,n,a,o,s=[];for(i=0;t>i;i++)for(a=0;t-i>a;a++)for(n=0;t-a-i>n;n++)o=100*i+a+10*n,s[o]=0,s[o+1]=0,s[o+10]=0,s[o+100]=0;for(i=0;t>i;i++)for(a=0;t-i>a;a++)for(n=0;t-a-i>n;n++)o=100*i+a+10*n,s[o]+=e[o]*a1[0],s[o+1]+=e[o]*a1[1],s[o+10]+=e[o]*a1[10],s[o+100]+=e[o]*a1[100];return s}function adddefensedice(t,e){var i,n,a,o=[];for(i=0;t>i;i++)for(n=0;t-i>n;n++)a=10*i+n,o[a]=0,o[a+1]=0,o[a+10]=0;for(i=0;t>i;i++)for(n=0;t-i>n;n++)a=10*i+n,o[a]+=e[a]*d1[0],o[a+1]+=e[a]*d1[1],o[a+10]+=e[a]*d1[10];return o}function attackproba(t){var e,i=[];for(i[0]=a1[0],i[1]=a1[1],i[10]=a1[10],i[100]=a1[100],e=2;t>=e;e++)i=addattackdice(e,i);return i}function defenseproba(t){var e,i=[];for(i[0]=d1[0],i[1]=d1[1],i[10]=d1[10],e=2;t>=e;e++)i=adddefensedice(e,i);return i}function attackwithreroll(t,e,i){var n,a,o,s,r,l,c,d,h,u=[];if(0==t.reroll)return e;if("undefined"==typeof t.reroll)return e;for(n=0;i>=n;n++)for(a=0;i-n>=a;a++)for(o=0;i-a-n>=o;o++)c=100*n+a+10*o,u[c]=0;var p,f=0;for(n=0;i>=n;n++)for(a=0;i-n>=a;a++)for(o=0;i-a-n>=o;o++)if(c=100*n+a+10*o,h=i-a-o-n,p=t.reroll,f=n,t.reroll>h&&(0==t.focus?t.reroll>n+h?(p=n+h,f=0):f=n-(p-h):p=h),0==p)u[c]+=e[c];else{for(s=0;p>=s;s++)for(r=0;p-s>=r;r++)for(l=0;p-s-r>=l;l++)d=100*s+r+10*l,k=100*(f+s)+a+r+10*(o+l),u[k]+=e[c]*ATTACK[p][d]}return u}function defendwithreroll(t,e,i){var n,a,o,s,r,l,c,d=[];if(0==t.reroll)return e;if("undefined"==typeof t.reroll)return e;for(n=0;i>=n;n++)for(a=0;i-n>=a;a++)d[10*n+a]=0;var h,u=0;for(n=0;i>=n;n++)for(a=0;i-n>=a;a++)if(r=10*n+a,c=i-a-n,h=t.reroll,u=n,t.reroll>c&&(0==t.focus?t.reroll>n+c?(h=n+c,u=0):u=n-(h-c):h=c),0==h)d[r]+=e[r];else for(o=0;h>=o;o++)for(s=0;h-o>=s;s++)l=10*o+s,k=10*(u+o)+a+s,d[k]+=e[r]*DEFENSE[h][l];return d}function tohitproba(t,e,i,n,a,o){var s,r,l,c,d,h,u,p,f,g=[],m=[],y=0,v=0,k=0,b=i,E=n,n=(t.reroll,0==o?[]:n);for(r=0;a>=r;r++)for(l=0;a-r>=l;l++)h=r+10*l,g[h]=0;if("undefined"==typeof b)return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0};for(b=attackwithreroll(t,i,a),o>0&&(E=defendwithreroll(e,n,o)),u=0;20>=u;u++)m[u]=0;for(s=0;a>=s;s++)for(r=0;a-s>=r;r++)for(l=0;a-r-s>=l;l++){var T,w,S,A,M=100*s+10*l+r,R=b[100*s+r+10*l];for("undefined"!=typeof t.modifyattackroll&&(M=t.modifyattackroll(M,e)),T=Math.floor(M/100),w=Math.floor((M-100*T)/10),S=M-100*T-10*w,A=0;o>=A;A++)for(ef=0;ef<=o-A;ef++){var d,C=10*A+ef;"undefined"!=typeof e.modifydefenseroll&&(C=e.modifydefenseroll(C)),d=Math.floor(C/10),f=C-10*d,c=0==o?1:E[C],p=S,h=0,e.evade>0&&(f+=1),e.focus>0&&(f+=d),t.focus>0&&(p+=T),p>f?(h=p-f,f=0):f-=p,w>f&&(h+=10*(w-f)),g[h]+=R*c}}for(r=0;a>=r;r++)for(l=0;a-r>=l;l++)switch(h=r+10*l,l+r>0&&(y+=g[h]),v+=r*g[h],k+=l*g[h],l){case 0:for(u=1;l+r>=u;u++)m[u]+=g[h];break;case 1:for(u=1;l+r>=u;u++)m[u]+=26*g[h]/33;for(u=2;l+r+1>=u;u++)m[u]+=7*g[h]/33;break;default:for(u=1;l+r>=u;u++)m[u]+=26*g[h]/33*25/32;for(u=2;l+r+1>=u;u++)m[u]+=.3446969696969697*g[h];for(u=3;l+r+2>=u;u++)m[u]+=7*g[h]/33*6/32}return{proba:g,tohit:Math.floor(1e4*y)/100,meanhit:0==y?0:Math.floor(100*v/y)/100,meancritical:0==y?0:Math.floor(k/y*100)/100,tokill:m}}function probatable(t,e){var i,n,a="";for(i=0;5>=i;i++){for(a+="<tr><td>"+i+"</td>",n=0;5>=n;n++){var o=n;e.adddice>0&&(o+=e.adddice);var s=tohitproba(t,e,ATTACK[i],DEFENSE[o],i,o);a+="<td class='probacell' style='background:hsl("+1.2*(100-s.tohit)+",100%,80%)'>",a+="<div>"+s.tohit+"%</div><div><code class='symbols'>d</code>"+s.meanhit+"</div><div><code class='symbols'>c</code>"+s.meancritical+"</div></td>"}a+="</tr>"}return a}function fillprobatable(){var t,e={focus:$("#focusA").prop("checked")?1:0,reroll:$("#targetA").prop("checked")?5:0},i={focus:$("#focusD").prop("checked")?1:0,evade:$("#evadeD").prop("checked")?1:0,adddice:$("#cloakD").prop("checked")?2:0,reroll:0};t=parseInt($("#rerollA").val(),10);var n=parseInt($("#rerollD").val(),10);(0==e.reroll||t>0&&t<e.reroll)&&(e.reroll=t),(0==i.reroll||n>0&&n<i.reroll)&&(i.reroll=n);var a="<tr><th>Rolls</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>"+probatable(e,i);$("#probatable").html(a)}function loadsound(){var t;for(t=0;t<SOUND_FILES.length;t++)SOUNDS[SOUND_NAMES[t]]=new buzz.sound(SOUND_FILES[t],{formats:["ogg","wav"]});SOUNDS.cloak=new buzz.sound("ogg/cloak_romulan",{formats:["ogg","mp3"]}),SOUNDS.uncloak=new buzz.sound("ogg/decloak_romulan",{formats:["ogg","mp3"]})}function uncloakevent(){return new CustomEvent("uncloakcomplete",{detail:{time:new Date},bubbles:!0,cancelable:!0})}function fireevent(t,e,i,n){return new CustomEvent("firecomplete",{detail:{ar:t,da:e,dr:i,dd:n,time:new Date},bubbles:!0,cancelable:!0})}function transformPoint(t,e){var i=e.x*t.a+e.y*t.c+t.e,n=e.x*t.b+e.y*t.d+t.f;return{x:i,y:n}}function halftone(t){return t==GREEN?HALFGREEN:t==RED?HALFRED:t==WHITE?HALFWHITE:t==BLUE?HALFBLUE:t==YELLOW?HALFYELLOW:t}function repeat(t,e){if(1>e)return"";for(var i="";e>1;)1&e&&(i+=t),e>>=1,t+=t;return i+t}function dist(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}function Unit(t){var e;this.dead=!1,this.hull=this.agility=this.skill=this.shield=0,this.ship={name:"",select:""},this.id=gid,this.pilotid=-1;var i=this.id;generics["u"+gid]=this,gid++,this.ship.select="<select id='select"+i+"' onchange='generics[\"u"+i+"\"].selectship()' style='width:170px;background:white;text-align:center'>",this.team=t,this.faction=TEAMS[t].faction,this.ship.select+="<option disabled selected>Select unit</option>";for(var n in unitlist)unitlist[n].faction.indexOf(this.faction)>=0&&(this.ship.select+="<option>"+n+"</option>");for(this.ship.select+="</select>",this.shipactionList=[],this.dial=[],this.dialselect="<div id='dial"+i+"' class='table'></div>",this.pts="<div class='pts' id='pts"+i+"'></div>",this.text="<div id='text"+i+"' class='details' style='margin:4px'></div>",this.pilotselect="<select onchange='generics[\"u"+i+"\"].selectpilot()' id='name"+i+"' style='background:lightsteelblue;width:170px;text-align:center'></select>",this.name="",this.upgradesno=0,this.upgrades=[],this.removeupg=[],e=0;10>e;e++)this.removeupg[e]=Unit.prototype.defaultremoveupg;this.stats="<div id='stats"+i+"'></div>",this.actions="<div id='actions"+i+"'></div>",this.DEFENSEREROLLD=[],this.ATTACKREROLLA=[],this.ATTACKMODA=[],this.DEFENSEMODD=[]}function Pilot(t){var e,i=PILOT_dict[t];for(e=0;e<PILOTS.length;e++)if(PILOTS[e].name==i)return Pilotfromid(e);console.log("Could not find pilot "+t)}function Pilotfromid(t){var e=new Unit(PILOTS[t]);return e.id=name,e.unique||(e.id=""+e.id+globalid++),void 0!=e.init&&e.init(),e}function Laser(t,e,i){return new Weapon(t,{type:e,name:"Laser",isactive:!0,attack:i,range:[1,3],isprimary:!0})}function Bomb(t,e){$.extend(this,e),t.upgrades.push(this),log("Installing bomb "+this.name),this.isactive=!0,this.unit=t,t.bombs.push(this),this.exploded=!1,void 0!=this.init&&this.init(t)}function Weapon(t,e){this.isprimary=!1,$.extend(this,e),t.upgrades.push(this),log("Installing weapon "+this.name+" ["+this.type+"]"),this.isactive=!0,this.unit=t,t.weapons.push(this),void 0!=this.init&&this.init(t)}function Upgrade(t,e){$.extend(this,UPGRADES[e]),t.upgrades.push(this),log("Installing upgrade "+this.name.replace(/\'/g,"&#39;")+" ["+this.type+"]"),this.isactive=!0,this.unit=t,void 0!=this.init&&this.init(t)}function Upgradefromname(t,e){var i;for(i=0;i<UPGRADES.length;i++)if(UPGRADES[i].name==e){var n=UPGRADES[i];return"Bomb"==n.type?new Bomb(t,n):"undefined"!=typeof n.isWeapon?n.isWeapon()?new Weapon(t,n):new Upgrade(t,i):n.type.match("Turretlaser|Bilaser|Laser|Torpedo|Cannon|Missile|Turret")||1==n.isweapon?new Weapon(t,n):new Upgrade(t,i)}console.log("Could not find upgrade "+e)}var ROCKIMG="img/asteroid.jpg",OBSTACLES=[],id=0;Rock.prototype={getrangeallunits:function(){return Unit.prototype.getrangeallunits.call(this)},getrange:function(t){return Unit.prototype.getrange.call(this,t)},gethitrangeallunits:function(){return[[],[],[],[]]},togglehitsector:function(){},togglerange:function(){},getOutlinePoints:function(){var t,e=[];if(this.m==this.mop)return this.op;for(t=0;t<this.arraypts.length;t++)e.push(transformPoint(this.m,this.arraypts[t]));return this.op=e,this.mop=this.m,e.obstacle=!0,e},getBox:function(){},getOutline:function(){var t;for(this.path="M ",t=0;t<this.arraypts.length;t++){var e=transformPoint(this.m,this.arraypts[t]);this.path+=e.x+" "+e.y+" ",0==t&&(this.path+=" L ")}this.path+="Z";var i=s.path(this.path);return i.appendTo(s),i},turn:function(t){this.m.add(MR(t,0,0)),this.show()},unselect:function(){},select:function(){if(phase==SETUP_PHASE)if(this.showpanel(),this.showrange){for(var t=this.g.getBBox(),e=1;4>e;e++)this.o[e]=s.ellipse(t.x+t.width/2,t.y+t.height/2,100*e+t.width/2,100*e+t.height/2).attr({pointerEvents:"none",display:"block",fill:WHITE,opacity:.3,strokeWidth:2}),this.o[e].prependTo(s);this.showrange=!1}else{for(var i=1;4>i;i++)this.o[i].remove();this.showrange=!0}},showpanel:function(){var t=this.g.getBBox(),e=$("#playmat").position(),i=e.left+(t.x+(this.islarge?80:40))*$("#playmat").width()/900,n=e.top+t.y*$("#playmat").height()/900;$(".phasepanel").css({left:i+10,top:n}).appendTo("body").show()},dragmove:function(t,e){var i=900*t/$("#playmat").width(),n=900*e/$("#playmat").height();if(this.dragMatrix=MT(i,n).add(this.m),phase==SETUP_PHASE)for(var a=1;4>a;a++)this.o[a].remove();this.dragged=!0,$(".phasepanel").hide(),this.g.transform(this.dragMatrix)},dragstart:function(t,e,i){this.dragged=!1;var i=activeunit;activeunit=this,this.select(),i.unselect()},dragstop:function(){this.dragged&&(this.m=this.dragMatrix,this.showpanel()),this.dragged=!1},show:function(){this.g.transform(this.m),this.g.appendTo(s)}},Iaunit.prototype={showdial:function(){var t=this.getdial();if($("#move").css({display:"none"}),$("#maneuverdial").empty(),phase==PLANNING_PHASE&&activeunit==this&&-1==this.maneuver){log("IA show dial");var e=Math.floor(Math.random()*t.length);this.setmaneuver(e)}if(phase>=PLANNING_PHASE){if(-1==this.maneuver||this.hasmoved)return this.dialspeed.attr({text:""}),void this.dialdirection.attr({text:""});e=t[this.maneuver];var i=C[e.difficulty];activeunit!=this&&(i=halftone(i)),this.dialspeed.attr({text:P[e.move].speed,fill:i}),this.dialdirection.attr({text:P[e.move].key,fill:i})}},showaction:function(){if(this.updateactionlist(),$("#actiondial").empty(),this.canuncloak(),this.candoaction()){var t=this.actionList.indexOf("FOCUS"),e=this.actionList.indexOf("EVADE");t>-1&&this.candofocus()?this.action=t:e>-1&&this.candoevade()&&(this.action=e),resolveaction()}else this.endaction();if(this.action>this.actionList.length&&this.action>-1){var i=this.actionList[this.action],n=A[i].color;this.actionicon.attr({fill:this==activeunit?n:halftone(n)})}else this.actionicon.attr({text:""})},showattack:function(){var t,e,i,n=[];if($("#attackdial").empty(),phase==COMBAT_PHASE&&0==waitingforaction&&skillturn==this.skill&&this.canfire()){var a=this.gethitrangeallunits();for(t=1;3>=t;t++)for(e=0;e<a[t].length;e++)for(i=0;i<a[t][e].wp.length;i++){var o=a[t][e].wp[i];-1==n.indexOf(o)&&n.push(o)}this.selecttargetforattack(n[0])}},getusabletokens:function(){var t="",e="";e="";for(var i=0;i<this.istargeted.length;i++)e+=this.istargeted[i].name+" ";return""!=e&&(t+="<div title='targeted by "+e.replace(/\'/g,"&#39;")+"' class='xtargetedtoken'></div>"),this.stress>0&&(t+="<div title='"+this.stress+" stress token(s)' class='xstresstoken'></div>"),this.ionized>0&&(t+="<div title='"+this.ionized+" ionization token(s)' class='xionizedtoken'></div>"),t},attackroll:function(t){var e,i,n,a,o=this.getattacktable(t),s=0,r=Math.random();for(i=0;t>=i;i++)for(n=0;t-i>=n;n++)for(a=0;t-i-n>=a;a++)if(e=100*i+n+10*a,s+=o[e],s>r)return this.canusefocus()&&i>0?(this.usefocus(),10*a+n+i):100*i+10*a+n;return 0},defenseroll:function(t){var e,i,n,a=this.getdefensetable(t),o=0,s=Math.random();if(0==t)return 0;for(n=0;t>=n;n++)for(i=0;t-n>=i;i++)if(e=10*n+i,o+=a[e],o>s)return this.canuseevade()&&(this.useevade(),i++),this.canusefocus()?n+i:10*n+i;return 0}};var factions=["REBEL","EMPIRE"],currentteam=1,allunits=[];Team.prototype={setfaction:function(t){$("#team"+this.team).empty(),this.faction=t,this.addpoints(),this.addunit(),$("#"+t+this.team).prop("checked",!0),this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW},changefaction:function(t){var e;for(var e in generics)generics[e].team==this.team&&delete generics[e];this.setfaction(t)},checkdead:function(){var t,e=!0;for(t=0;t<this.units.length;t++)if(!this.units[t].dead){e=!1;break}return this.isdead=e,e},changeplayer:function(t){this.isia="human"==t?!1:!0},addpoints:function(){var t=this.team,e=["REBEL","SCUM","EMPIRE"];for($("#team"+t).append("<input id='teamname"+this.team+"' type='text' placeholder='Team #"+t+"' style='width:160px'>"),$("#team"+t).append("<p id='playerselect"+t+"'></p>"),$("#playerselect"+t).append("<input id='human"+t+"' checked name='player"+t+"' type='radio' selected onchange='TEAMS["+t+'].changeplayer("human")\'>'),$("#playerselect"+t).append("<label for='human"+t+"' >Human</label>"),$("#playerselect"+t).append("<input id='computer"+t+"' name='player"+t+"' type='radio' onchange='TEAMS["+t+'].changeplayer("computer")\'>'),$("#playerselect"+t).append("<label for='computer"+t+"'>Computer</label>"),$("#team"+t).append("<p id='factionselect"+t+"'></p>"),i=0;i<3;i++)$("#factionselect"+t).append("<input id='"+e[i]+t+"' name='faction"+t+"' type='radio' onchange='TEAMS["+t+'].changefaction("'+e[i]+"\")'>"),$("#factionselect"+t).append("<label for='"+e[i]+t+"' style='font-size:30px' class='"+e[i]+"'>")},updatepoints:function(){var t,e=$("#team"+this.team+" .pts").map(function(){return parseInt($(this).text())}).get(),i=0;for(t=0;t<e.length;t++)isNaN(e[t])||(i+=e[t]);$("#total"+this.team).html(i)},addunit:function(){var t=this.team;$("#addunit"+t).remove(),$("#total"+t).remove(),$("#totallbl"+t).remove(),$("#team"+t).append("<div>"+new Unit(t)+"</div>"),$("#team"+t).append("<div id='addunit"+t+"' onclick='TEAMS["+t+"].addunit("+t+")'><span class='plus addunit'>+</span><span class='addunit'>Add new unit</span></div><div><div><div class='totalpts' id='total"+t+"'>0</div></div></div><div  id='totallbl"+t+"'><div><div class='total'>Total points</div></div></div>"),this.updatepoints()},tosquadron:function(t){{var e;this.team}for(var e in generics)generics[e].team==this.team&&(u=generics[e],u.tosquadron(t),allunits.push(u),squadron.push(u),this.units.push(u),this.isia&&(u=$.extend(u,IAUnit.prototype)));return this.units.sort(function(t,e){return e.skill-t.skill}),squadron.sort(function(t,e){return e.skill-t.skill}),this.units},endselection:function(t){var e,i=this.team;for($("#team"+i).empty(),$("#importexport"+i).remove(),sq=this.tosquadron(t),e=0;e<sq.length;e++)1==i?(sq[e].m.add(MT(80,70+82*e)).add(MR(90,0,0)),$("#team1").append('<div id="'+sq[e].id+'" onclick=\'select("'+sq[e].id+"\")'>"+sq[e]+"</div>")):(sq[e].m.add(MT(820,70+82*e)).add(MR(-90,0,0)),$("#team2").append('<div id="'+sq[e].id+'" onclick=\'select("'+sq[e].id+"\")'>"+sq[e]+"</div>")),sq[e].show();activeunit=sq[0]},toJSON:function(){var t={},e={REBEL:"rebels",SCUM:"scum",EMPIRE:"empire"};t.description="",t.faction=e[this.faction],t.name=$("#teamname"+this.team).val();var i=[];for(var n in generics)generics[n].team==this.team&&i.push(generics[n].toJSON());return t.pilots=i,t.points=$("#total"+this.team).val(),t.vendor={xwsbenchmark:{builder:"X-Wings Squadron Benchmark",builder_url:"http://xws-bench.github.io/bench/"}},t.version="0.2.0",t},parseJSON:function(t,e){var i;try{i=$.parseJSON(e)}catch(n){return void alert("JSON error:"+n.message)}var a,o,s,r=["ept","turret","torpedo","mod","title","amd","missile","crew","cannon","bomb","system","illicit","salvaged"],l={rebels:"REBEL",empire:"EMPIRE",scum:"SCUM"};this.faction=l[i.faction],this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;for(a in generics)generics[a].team==this.team&&delete generics[a];for(a=0;a<i.pilots.length;a++){var c,d=i.pilots[a];if(d.team=this.team,c=new Unit(this.team),c.selectship(PILOT_dict[d.ship],PILOT_dict[d.name]),"undefined"!=typeof d.upgrades)for(o=0;o<r.length;o++){var h=d.upgrades[r[o]];if("undefined"!=typeof h)for(s=0;s<h.length;s++)Upgradefromname(c,UPGRADE_dict[h[s]])}}nextphase()}};var phase=0,round=1,skillturn=0,waitingforaction=0,tabskill,VERSION="v0.5",SETUP_PHASE=2,PLANNING_PHASE=3,ACTIVATION_PHASE=4,COMBAT_PHASE=5,SELECT_PHASE1=0,SELECT_PHASE2=1,DICES=["focusred","hitred","criticalred","blankred","focusgreen","evadegreen","blankgreen"],BOMBS=[],allunits=[],keybindings={phase0:[],phase1:[],phase2:[{k:"t",f:function(){activeunit.turn(45)}},{k:"shift+t",f:function(){activeunit.turn(-45)}},{k:"b",f:function(){activeunit.turn(5)}},{k:"shift+b",f:function(){activeunit.turn(-5,0,0)}}],phase3:[{k:"m",f:function(){activeunit.nextmaneuver()}},{k:"shift+m",f:function(){activeunit.prevmaneuver()}}],phase4:[],phase5:[{k:"enter",f:function(){inhitrange(),window.location="#modal"}}],action:[{k:"a",f:function(){!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==skillturn&&activeunit.nextaction()}},{k:"shift+a",f:function(){!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==skillturn&&activeunit.prevaction()}},{k:"enter",f:function(){phase==ACTIVATION_PHASE&&!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==skillturn&&resolveaction()}}],select:[{k:"n",f:nextselect},{k:"shift+n",f:prevselect}]};document.addEventListener("firecomplete",firecomplete,!1),document.addEventListener("win",win,!1);var phasetext=["Build squad #1","Build squad #2","Setup","Planning","Activation","Combat"],zone=[],a1=[];a1[0]=.25,a1[1]=3/8,a1[10]=1/8,a1[100]=.25;var d1=[];d1[0]=3/8,d1[1]=3/8,d1[10]=.25;var dice=1,ATTACK=[],DEFENSE=[],TEAMS=[0,new Team(1),new Team(2)];$(document).ready(function(){s=Snap("#svgout"),P={F0:{path:s.path("M 0 0 L 0 0"),speed:0,key:"5"},F1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"8"},F2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"8"},F3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"8"},F4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"8"},F5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"8"},TR1:{path:s.path("M0 0 C 0 -40 15 -55 55 -55"),speed:1,key:"6"},TR2:{path:s.path("M0 0 C 0 -50 33 -83 83 -83"),speed:2,key:"6"},TR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105"),speed:3,key:"6"},TL1:{path:s.path("M0 0 C 0 -40 -15 -55 -55 -55"),speed:1,key:"4"},TL2:{path:s.path("M0 0 C 0 -50 -33 -83 -83 -83"),speed:2,key:"4"},TL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105"),speed:3,key:"4"},BR1:{path:s.path("M0 0 C 0 -20 18 -72 38 -92"),speed:1,key:"9"},BR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126"),speed:2,key:"9"},BR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"9"},SR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"3"},BL1:{path:s.path("M0 0 C 0 -20 -18 -72 -38 -92"),speed:1,key:"7"},BL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126"),speed:2,key:"7"},BL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"7"},SL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"1"},K1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"2"},K2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"2"},K3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"2"},K4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"2"},K5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"2"}},$.ajax({dataType:"json",url:"data/ships.json",mimeType:"application/json",success:function(t){var e=setInterval(function(){ATTACK[dice]=attackproba(dice),DEFENSE[dice]=defenseproba(dice),dice++,7==dice&&(fillprobatable(),$("#showproba").prop("disabled",!1),clearInterval(e))},500);unitlist=t;
