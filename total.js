function IAUnit(){}
IAUnit.prototype={getmaneuver:function(){var b,c,e=[],f=[],g=[],h=this.getdial();for(b=0;b<squadron.length;b++)if(squadron[b].team!=this.team){var l=squadron[b],m=l.getdial();for(c=0;c<m.length;c++)e.push(l.getOutlinePoints(l.getpathmatrix(l.m.clone(),m[c].move)))}for(b=0;b<h.length;b++){l=0;c=this.m.clone();h[b].move.match(/K\d|SL\d|SR\d/)&&(c=c.add(MR(180,0,0)));var m=this.getpathmatrix(c,h[b].move),n=!1;this.isinzone(m)||(n=!0);if(!n){var q=this.getOutline(m);for(c=0;c<OBSTACLES.length;c++)if(this.isintersecting(OBSTACLES[c].getOutlinePoints(),q)){n=
!0;break}q.remove()}if(!n){g.push(b);m=this.getSectorString(3,m);for(c=0;c<e.length;c++)this.isintersecting(e[c],m)&&l++;0<l&&f.push({n:l,m:b})}}if(0<f.length)f.sort(function(b,c){return c.n-b.n}),b=f[0].m;else{for(b=0;b<g.length&&!h[g[b]].move.match(/F\d/);b++);b==g.length&&(b=0);b=g[b]}return b},freeaction:function(b){b()},resolveactionselection:function(b,c){c(0)},resolveactionmove:function(b,c,e,f){var g=[],h=!1;for(e=0;e<b.length;e++)g[e]=this.getpossibleoutline(b[e]),g[e].ol.remove();for(e=
0;e<b.length;e++)if(g[e].b||f){h=!0;break}h?(this.m=b[e],c(this,e)):c(this,-1)},beginplanningphase:function(){if(-1==this.maneuver)var b=setInterval(function(){this.maneuver=this.getmaneuver();nextstep();clearInterval(b)}.bind(this),200)},timetoshowmaneuver:function(){return-1<this.maneuver&&phase==ACTIVATION_PHASE},showdial:function(){$("#move").css({display:"none"});$("#maneuverdial").empty();if(phase>PLANNING_PHASE)if(-1==this.maneuver||this.hasmoved)this.dialspeed.attr({text:""}),this.dialdirection.attr({text:""});
else{d=this.getdial()[this.maneuver];var b=C[d.difficulty];activeunit!=this&&(b=halftone(b));this.dialspeed.attr({text:P[d.move].speed,fill:b});this.dialdirection.attr({text:P[d.move].key,fill:b})}},beginactivation:function(){this.resolvemaneuver()},showactivation:function(){$("#activationdial").empty();this.timeformaneuver()&&this.resolvemaneuver()},endmaneuver:function(){this.ionized=0;this.action=-1;this.updateactionlist();$("#actiondial").empty();this.canuncloak();if(this.candoaction()&&!this.actiondone){this.actiondone=
!0;var b=this.actionList.indexOf("FOCUS"),c=this.actionList.indexOf("EVADE");-1<b&&this.candofocus()?(this.actionsdone.push("FOCUS"),this.addfocus()):-1<c&&this.candoevade()?(this.actionsdone.push("EVADE"),this.addevade()):this.endaction()}else this.endaction()},showaction:function(){$("#actiondial").empty();this.updateactionlist();if(this.action<this.actionList.length&&-1<this.action){var b=A[this.actionList[this.action]].color;this.actionicon.attr({fill:this==activeunit?b:halftone(b)})}else this.actionicon.attr({text:""})},
selecttargetforattack:function(b){var c=this.weapons[b].getrangeallunits(),e,f=[];for(e=0;e<c.length;e++)c[e].team!=this.team&&f.push(c[e]);if(0==f.length)return!1;this.declareattack(b,f[0]);this.resolveattack(b,f[0]);return!0},beginattack:function(){var b=[],c,e,f;if(this.canfire()){var g=this.gethitrangeallunits();for(c=1;3>=c;c++)for(e=0;e<g[c].length;e++)for(f=0;f<g[c][e].wp.length;f++){var h=g[c][e].wp[f];-1==b.indexOf(h)&&b.push(h)}this.selecttargetforattack(b[0])}},showattack:function(){$("#attackdial").empty()},
getusabletokens:function(b,c){var e="",f="",f="";0<this.focus&&(e+="<td title='"+this.focus+" focus token(s)' class='xfocustoken'></td>");0<this.evade&&(e+="<td title='"+this.evade+" evade token(s)' class='xevadetoken'></td>");for(var g=0;g<this.targeting.length;g++)f+=this.targeting[g].name+" ";""!=f&&(e+="<td title='targeting "+f.replace(/\'/g,"&#39;")+"' class='xtargettoken'></td>");f="";for(g=0;g<this.istargeted.length;g++)f+=this.istargeted[g].name+" ";""!=f&&(e+="<td title='targeted by "+f.replace(/\'/g,
"&#39;")+"' class='xtargetedtoken'></td>");0<this.stress&&(e+="<td title='"+this.stress+" stress token(s)' class='xstresstoken'></td>");0<this.ionized&&(e+="<td title='"+this.ionized+" ionization token(s)' class='xionizedtoken'></td>");return e},attackroll:function(b){var c,e,f,g,h=this.getattacktable(b),l=0,m=Math.random();for(e=0;e<=b;e++)for(f=0;f<=b-e;f++)for(g=0;g<=b-e-f;g++)if(c=100*e+f+10*g,l+=h[c],l>m)return this.canusefocus()&&0<e?(this.usefocus(),10*g+f+e):100*e+10*g+f;return 0},defenseroll:function(b){var c,
e,f,g=this.getdefensetable(b),h=0,l=Math.random();if(0==b)return 0;for(f=0;f<=b;f++)for(e=0;e<=b-f;e++)if(c=10*f+e,h+=g[c],h>l)return this.canuseevade()&&(this.useevade(),e++),this.canusefocus()?f+e:10*f+e;return 0}};var s,GREEN="#0F0",RED="#F00",WHITE="#FFF",BLUE="#0AF",YELLOW="#FF0",HALFGREEN="#080",HALFRED="#800",HALFWHITE="#888",HALFBLUE="#058",HALFYELLOW="#880",TIMEANIM=1E3,FACE=["focus","hit","critical","evade","blank"],ATTACKDICE=[0,0,1,1,1,2,4,4],DEFENSEDICE=[0,0,3,3,3,4,4,4],MPOS={F0:[0,2],F1:[1,2],F2:[2,2],F3:[3,2],F4:[4,2],F5:[5,2],BL1:[1,1],BL2:[2,1],BL3:[3,1],TL1:[1,0],TL2:[2,0],TL3:[3,0],BR1:[1,3],BR2:[2,3],BR3:[3,3],TR1:[1,4],TR2:[2,4],TR3:[3,4],K1:[1,5],K2:[2,5],K3:[3,5],K4:[4,4],K5:[5,4],SL3:[3,
0],SR3:[3,4]},generics=[],gid=0,UNIQUE=[[],[],[]],ATTACKREROLLA=[],DEFENSEREROLLD=[],ATTACKMODA=[],DEFENSEMODD=[],xws_lookup=function(b){for(var c in PILOT_dict)if(PILOT_dict[c]==b)return c;return""},upg_lookup=function(b){for(var c in UPGRADE_dict)if(UPGRADE_dict[c]==b)return c;return""},activeunit,unitlist,pilotlist,squadron=[],active=0,globalid=1,targetunit,PATTERN,SOUND_FILES="ogg/EXPLODE3 ogg/KX9_laser_cannon ogg/TIE-Fire ogg/Slave1-Guns ogg/Falcon-Guns ogg/XWing-Fly1 ogg/TIE-Fly2 ogg/Slave1-Fly1 ogg/Falcon-Fly1 ogg/Falcon-Fly3 ogg/YWing-Fly2 ogg/ISD-Fly ogg/Missile".split(" "),
SOUNDS={},SOUND_NAMES="explode xwing_fire tie_fire slave_fire falcon_fire xwing_fly tie_fly slave_fly falcon_fly yt2400_fly ywing_fly isd_fly missile".split(" ");function loadsound(){var b;for(b=0;b<SOUND_FILES.length;b++)SOUNDS[SOUND_NAMES[b]]=new buzz.sound(SOUND_FILES[b],{formats:["ogg","wav"]});SOUNDS.cloak=new buzz.sound("ogg/cloak_romulan",{formats:["ogg","mp3"]});SOUNDS.uncloak=new buzz.sound("ogg/decloak_romulan",{formats:["ogg","mp3"]})}
function uncloakevent(){return new CustomEvent("uncloakcomplete",{detail:{time:new Date},bubbles:!0,cancelable:!0})}function transformPoint(b,c){return{x:c.x*b.a+c.y*b.c+b.e,y:c.x*b.b+c.y*b.d+b.f}}function halftone(b){return b==GREEN?HALFGREEN:b==RED?HALFRED:b==WHITE?HALFWHITE:b==BLUE?HALFBLUE:b==YELLOW?HALFYELLOW:b}
var MS=function(b,c){return(new Snap.Matrix).scale(b,c)},MT=function(b,c){return(new Snap.Matrix).translate(b,c)},MR=function(b,c,e){return(new Snap.Matrix).rotate(b,c,e)},C={GREEN:"#0F0",RED:"#F00",WHITE:"#FFF"},P,A={ROLL:{key:"r",color:GREEN},FOCUS:{key:"f",color:GREEN},TARGET:{key:"l",color:BLUE},EVADE:{key:"e",color:GREEN},BOOST:{key:"b",color:GREEN},STRESS:{key:"s",color:RED},CLOAK:{key:"k",color:BLUE},ISTARGETED:{key:"l",color:RED},ASTROMECH:{key:"A",color:YELLOW},CANNON:{key:"C",color:YELLOW},
CREW:{key:"W",color:YELLOW},MISSILE:{key:"M",color:YELLOW},TORPEDO:{key:"P",color:YELLOW},ELITE:{key:"E",color:YELLOW},TURRET:{key:"U",color:YELLOW},UPGRADE:{key:"S",color:YELLOW},CRITICAL:{key:"c",color:RED},SALVAGED:{key:"V",color:YELLOW},BOMB:{key:"B",color:YELLOW},TITLE:{key:"t",color:YELLOW},MOD:{key:"m",color:YELLOW},SYSTEM:{key:"S",color:YELLOW},ILLICIT:{key:"I",color:YELLOW},LASER:{key:"%",color:RED},TURRETLASER:{key:"$",color:RED},BILASER:{key:"%",color:RED},NOTHING:{key:"&nbsp;",color:WHITE}},
AINDEX="ROLL FOCUS TARGET EVADE BOOST STRESS CLOAK ISTARGETED ASTRO CANNON CREW MISSILE TORPEDO ELITE TURRET UPGRADE CRITICAL NOTHING".split(" ");function repeat(b,c){if(1>c)return"";for(var e="";1<c;)c&1&&(e+=b),c>>=1,b+=b;return e+b}function dist(b,c){return(b.x-c.x)*(b.x-c.x)+(b.y-c.y)*(b.y-c.y)}
function Unit(b){this.dead=!1;this.hull=this.agility=this.skill=this.shield=0;this.ship={name:"",select:""};this.id=gid;this.pilotid=-1;var c=this.id;generics["u"+gid]=this;gid++;this.ship.select="<select id='select"+c+"' onchange='generics[\"u"+c+"\"].selectship()' style='width:170px;background:white;text-align:center'>";this.team=b;this.faction=TEAMS[b].faction;this.ship.select+="<option disabled selected>Select unit</option>";for(var e in unitlist)0<=unitlist[e].faction.indexOf(this.faction)&&
(this.ship.select+="<option>"+e+"</option>");this.ship.select+="</select>";this.shipactionList=[];this.dial=[];this.dialselect="<div id='dial"+c+"' class='table'></div>";this.pts="<div class='pts' id='pts"+c+"'></div>";this.text="<div id='text"+c+"' class='details' style='margin:4px'></div>";this.pilotselect="<select onchange='generics[\"u"+c+"\"].selectpilot()' id='name"+c+"' style='background:lightsteelblue;width:170px;text-align:center'></select>";this.name="";this.upgradesno=0;this.upgrades=[];
this.removeupg=[];for(b=0;10>b;b++)this.removeupg[b]=Unit.prototype.defaultremoveupg;this.stats="<div id='stats"+c+"'></div>";this.actions="<div id='actions"+c+"'></div>";this.DEFENSEREROLLD=[];this.ATTACKREROLLA=[];this.ATTACKMODA=[];this.DEFENSEMODD=[]}
Unit.prototype={tosquadron:function(b){var c=this.upg;this.action=this.maneuver=-1;this.actionsdone=[];this.actiondone=this.hasmoved=!1;this.focus=this.reroll=0;this.iscloaked=!1;this.target=0;this.istargeted=[];this.targeting=[];this.criticalresolved=this.hitresolved=this.hasfired=this.evade=this.ionized=this.stress=0;this.m=new Snap.Matrix;this.collision=!1;this.ocollision={overlap:-1,template:0};for(j in c)-1<c[j]&&Upgradefromname(this,UPGRADES[c[j]].name);this.color="REBEL"==this.faction?RED:
"EMPIRE"==this.faction?GREEN:YELLOW;this.img=this.islarge?b.image("png/"+this.ship.img[0],-50*this.scale,-50*this.scale,100*this.scale,100*this.scale).transform("r 90 0 0"):b.image("png/"+this.ship.img[0],-20*this.scale,-20*this.scale,40*this.scale,40*this.scale).transform("r 90 0 0");var e=this.islarge?40:20;this.outline=b.rect(-e,-e,2*e,2*e).attr({fill:"rgba(8,8,8,0.5)",strokeWidth:2});this.skillbar=b.text(1-e,3-e,repeat("u",this.skill)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#fa0"});
this.firebar=b.text(1-e,5-e,repeat("u",this.weapons[0].attack)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#f00"});this.evadebar=b.text(1-e,7-e,repeat("u",this.agility)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#0f0"});this.hullbar=b.text(1-e,9-e,repeat("u",this.hull)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#cc0"});this.shieldbar=b.text(1-e,9-e,repeat("u",this.shield+this.hull)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#0af"});this.gstat=b.group(this.skillbar,
this.firebar,this.evadebar,this.shieldbar,this.hullbar);this.dialspeed=b.text(2+e,3-e,"").attr({class:"dialspeed"});this.dialdirection=b.text(e+8,3-e,"").attr({class:"symbols"});this.actionicon=b.text(e+2,-7,"").attr({class:"symbols",strokeWidth:0});this.sector=b.polygon(3-e,-e,0,0,e-3,-e).attr({fill:this.color,opacity:.5,strokeWidth:0});this.ranges=[];this.sectors=[];this.infoicon=[];for(c=0;4>c;c++)this.infoicon[c]=b.text(e-7,6-e+7*c,A[AINDEX[c+2]].key).attr({class:"xsymbols",fill:A[AINDEX[c+2]].color,
strokeWidth:0});this.g=b.group(this.sector,this.outline,this.img,this.dialspeed,this.dialdirection,this.actionicon,this.infoicon[0],this.infoicon[1],this.infoicon[2],this.infoicon[3],this.gstat);this.g.addClass("unit");this.g.hover(function(){var b=this.g.getBBox(),c=$("#playmat").position(),e=c.left+b.x*$("#playmat").width()/900,b=c.top+(b.y-20)*$("#playmat").height()/900;$(".info").css({left:e,top:b}).html(this.name).appendTo("body").show()}.bind(this),function(){$(".info").hide()}.bind(this));
this.setdefaultclickhandler();for(c in PILOTS[this.pilotid])b=PILOTS[this.pilotid],"function"==typeof b[c]&&(this[c]=b[c]);"undefined"!=typeof this.init&&this.init();this.upgrades.sort(function(b,c){b.isWeapon();b.isBomb();c.isWeapon();c.isBomb();return c-b});this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this))},defaultremoveupg:function(b,c){var e=this.upg[b];$("#upgradetext"+this.id+"_"+b+" div").remove();$("#pts"+this.id+"_"+b).html("");-1!=e&&("undefined"!=
typeof UPGRADES[e].unique&&delete UNIQUE[this.team][UPGRADES[e].name],"undefined"!=typeof UPGRADES[e].uninstall&&UPGRADES[e].uninstall(this),this.showdial(),this.showstats(),this.showactions(),this.upg[b]=-1,c&&($("#upgrade"+this.id+"_"+b+" option").prop("selected",!1),$("#upgrade"+this.id+"_"+b+" option[val=-1]").prop("selected",!0)))},toJSON:function(){var b={};b.name=xws_lookup(this.name);b.points=PILOTS[this.pilotid].points;b.ship=xws_lookup(this.ship.name);for(var c={},e=0;10>e;e++)if(-1!=this.upg[e]){var f=
UPGRADES[this.upg[e]],g=UPGRADE_TYPES[f.type];"undefined"==typeof c[g]&&(c[g]=[]);c[g].push(upg_lookup(f.name))}b.upgrades=c;return b},toASCII:function(){var b;b=""+this.pilotid;for(var c=1;c<this.upgrades.length;c++){for(var e=0;e<UPGRADES.length&&UPGRADES[e].name!=this.upgrades[c].name;e++);b+=","+e}return b},toString2:function(){var b;b="<div>"+("<div><div class='dial' style='border:0;margin:0;padding:0'>"+this.dialselect+"</div></div>");b+="<div><div>"+this.pts+"</div></div>";b+="<div><div class='name'>"+
this.pilotselect+"</div></div>";b+="<div><div>"+this.ship.select+"</div></div>";b+="<div>"+this.stats+"</div>";b+="<div>"+this.actions+"</div>";b+="<div>"+this.text+"</div>";b+="<div id='upgrade"+this.id+"'></div>";return b+="</div></div>"},getagility:function(){return this.agility},getdial:function(){return 0<this.ionized&&!this.islarge||1<this.ionized?[{move:"F1",difficulty:"WHITE"}]:this.dial},showdial:function(){var b=[],c,e,f=this.getdial();$("#move").css({display:"none"});if(phase==PLANNING_PHASE||
phase==SELECT_PHASE1||phase==SELECT_PHASE2){for(c=0;5>=c;c++)for(b[c]=[],e=0;5>=e;e++)b[c][e]="<div></div>";$("#select"+this.id).val();for(c=0;c<f.length;c++){e=f[c];var g=MPOS[e.move][0],h=MPOS[e.move][1];"RED"==e.difficulty&&0<this.stress?b[g][h]="<div></div>":(b[g][h]="<div",phase==PLANNING_PHASE&&(b[g][h]+=" onclick='activeunit.setmaneuver("+c+")'"),b[g][h]+=" class='symbols "+e.difficulty,this.maneuver==c&&(b[g][h]+=" selected"),b[g][h]+="' >"+P[e.move].key+"</div>")}f="";for(c=5;0<=c;c--){f+=
"<div>";f=0<c&&5>c?f+("<div>"+c+"</div>"):f+"<div>&nbsp;</div>";for(e=0;5>=e;e++)f+=b[c][e];f+="</div>\n"}phase==SELECT_PHASE1||phase==SELECT_PHASE2?$("#dial"+this.id).html(f):$("#maneuverdial").html(f)}else phase==ACTIVATION_PHASE&&this.skill==skillturn&&-1<this.maneuver&&!this.hasmoved&&$("#move").css({display:"block"});phase>=PLANNING_PHASE&&(-1==this.maneuver||this.hasmoved)&&(this.dialspeed.attr({text:""}),this.dialdirection.attr({text:""}))},removepilot:function(b){if(-1!=this.pilotid){for(k=
0;10>k;k++)this.removeupg[k].call(this,k,!0);this.uninstall();if("undefined"!=typeof UNIQUE[this.team][this.name])UNIQUE[this.team][this.name](this.name,!1)}1==b&&$("#name"+this.id).empty()},getpilotlist:function(){var b,c=-1,e=$("#select"+this.id).val();$("#name"+this.id).append("<option disabled>Select pilot</option>");for(b=0;b<PILOTS.length;b++)PILOTS[b].unit==e&&PILOTS[b].faction==this.faction&&($("#name"+this.id).append("<option"+(-1==c?" selected":"")+">"+PILOTS[b].name+" ("+PILOTS[b].points+
")</option>"),-1==c&&1!=PILOTS[b].unique&&(c=b))},selectship:function(b,c){var e=b;"undefined"==typeof b&&(e=$("#select"+this.id).val());var f=unitlist[e];this.ship.firesnd=f.firesnd;this.ship.flysnd=f.flysnd;this.ship.code=f.code;this.ship.img=f.img;this.ship.hull=f.hull;this.ship.shield=f.shield;this.scale=f.scale;this.islarge=1==f.islarge?!0:!1;this.agility=f.evade;this.hull=f.hull;this.shield=f.shield;this.ship.name=e;this.dial=f.dial.slice(0);this.shipactionList=f.actionList.slice(0);this.weapons=
[];this.upgrades=[];this.bombs=[];this.lastdrop=-1;Laser(this,f.weapon_type,f.fire);$("#text"+this.id).html("");this.showdial();this.showactions();this.removepilot(!0);this.getpilotlist();this.selectpilot(c)},initupgradelist:function(b,c){for(var e=PILOTS[this.pilotid],f="",g=0;g<UPGRADES.length;g++){var h=UPGRADES[g];"undefined"!=typeof h.faction&&h.faction!=e.faction||"undefined"!=typeof h.ship&&h.ship!=e.unit||"undefined"!=typeof h.ishuge||"undefined"!=typeof h.islarge&&1!=this.islarge||"undefined"!=
typeof h.skillmin&&this.skill<h.skillmin||"undefined"!=typeof h.noupgrades&&-1<e.upgrades.indexOf(h.noupgrades)||("undefined"==typeof h.actionrequired||-1!=this.shipactionList.indexOf(h.actionrequired.toUpperCase()))&&b.match(h.type)&&(f+="<option value='"+g+"'>"+h.name+"</option>")}return f},addupgradetype:function(b,c,e){var f=0;"undefined"!=typeof e&&(f=e);e="<div id='upgradetext"+this.id+"_"+c+"' class='upgrade'>";e+="<span class='pts' id='pts"+this.id+"_"+c+"'></span>";e=e+("<a href='#' class='upgrades "+
("Cannon|Torpedo|Missile"==b?"CannonTorpedoMissile":b)+"'></a>")+("<select id='upgrade"+this.id+"_"+c+"' onchange='generics[\"u"+this.id+'"].selectupgrade("'+b+'",'+c+","+f+")'>");e+="<option value='-1' selected>none</option>";b=this.initupgradelist(b,c);""!=b?(e+=b+"</select></div>",$("#upgrade"+this.id).append(e)):$("#upgrade"+this.id).append("<div id='upgradetext"+this.id+"_"+c+"'></div>")},showstats:function(){$("#stats"+this.id).html("<div class='PS'>"+this.skill+"</div><div class='statfire'>"+
this.weapons[0].attack+"</div><div class='statevade'>"+this.getagility()+"</div><div class='statshield'>"+this.shield+"</div><div class='stathull'>"+this.hull+"</div>")},showactions:function(){for(var b="",c=0;c<this.shipactionList.length;c++)b+="<code class='symbols'>"+A[this.shipactionList[c]].key+"</code>";$("#actions"+this.id).html(b)},selectpilot:function(b){this.removepilot(!1);var c=b;"undefined"==typeof b&&(c=$("#name"+this.id).val());for(b=0;b<PILOTS.length&&0!=c.indexOf(PILOTS[b].name+("SCUM"==
this.team?" (Scum)":""));b++);this.name=PILOTS[b].name;if(b!=PILOTS.length){this.pilotid=b;this.unique=1==PILOTS[b].unique?!0:!1;this.skill=PILOTS[b].skill;this.install="undefined"!=typeof PILOTS[b].install?PILOTS[b].install:function(){};this.uninstall="undefined"!=typeof PILOTS[b].uninstall?PILOTS[b].uninstall:function(){};c=PILOTS[b].upgrades;this.upg=[];for(b=0;10>b;b++)this.upg[b]=-1;$("#upgrade"+this.id).html("");for(b=0;b<c.length;b++)this.addupgradetype(c[b],b);this.addupgradetype("Mod",c.length);
this.addupgradetype("Title",c.length+1);this.upgradesno=c.length+2;this.install(this);if(this.unique){log(this.name+" is a unique pilot");c=UNIQUE[this.team][this.name];if("undefined"!=typeof c)UNIQUE[this.team][this.name](this.name,!0);UNIQUE[this.team][this.name]=function(b,c){c?(log("Only one pilot "+b),this.removepilot(!0),this.getpilotlist(),this.selectpilot()):delete UNIQUE[this.team][b]}.bind(this)}c=PILOTS[this.pilotid].upg;c=PILOT_translation.english[this.name+("SCUM"==this.faction?" (Scum)":
"")];"undefined"==typeof c&&(c="");$("#text"+this.id).html(c);this.showstats();$("#pts"+this.id).html(PILOTS[this.pilotid].points);TEAMS[this.team].updatepoints()}},selectupgrade:function(b,c,e){this.removeupg[c].call(this,c,!1);var f=$("#upgrade"+this.id+"_"+c).val();this.upg[c]=f;if(-1==f)$("#upgrade"+this.id+"_"+c).css({margin:"0px"}),$("#pts"+this.id+"_"+c).html("");else{$("#upgrade"+this.id+"_"+c).css({margin:"0 0 30px 0"});"undefined"!=typeof UPGRADES[f].install&&UPGRADES[f].install(this);if(1==
UPGRADES[f].unique){var g=UPGRADES[f];log(g.name+" is a unique upgrade");if("undefined"!=typeof UNIQUE[this.team][g.name])UNIQUE[this.team][g.name](g.name,!0);UNIQUE[this.team][g.name]=function(b,c){log("Removing unique upgrade "+b);this.obj.removeupg[this.key].call(this.obj,this.key,c);delete UNIQUE[this.team][b]}.bind({key:c,obj:this})}e=UPGRADES[f].points+e;$("#pts"+this.id+"_"+c).html(e);e=UPGRADES[f];$("#upgradetext"+this.id+"_"+c).prepend("<div class='dial details' style='border:0;margin:0;padding:0'>"+
(e.attack?"<b class='statfire'>"+e.attack+"</b>["+e.range[0]+"-"+e.range[1]+"], ":"")+UPGRADE_translation.english[e.name+("Crew"==b?"(Crew)":"")]+"</div>");b=UPGRADES[f].addedaction;"undefined"!=typeof b&&(e=b.toUpperCase(),this.shipactionList.push(e),log("Added action:"+b),this.removeupg[c]=function(b,c){var e=this.shipactionList.indexOf(UPGRADES[this.upg[b]].addedaction.toUpperCase());-1<e&&this.shipactionList.splice(e,1);this.defaultremoveupg(b,c);this.removeupg[b]=this.defaultremoveupg}.bind(this));
b=UPGRADES[f].upgrades;if("undefined"!=typeof b){for(e=0;e<b.length;e++)this.addupgradetype(b[e],this.upgradesno+e,UPGRADES[f].pointsupg);$("#upgrade"+this.id+"_"+c).prop("start",this.upgradesno);this.removeupg[c]=function(b,c){for(var e=UPGRADES[this.upg[b]].upgrades,f=$("#upgrade"+this.id+"_"+b).prop("start"),g=f;g<f+e.length;g++)$("#upgradetext"+this.id+"_"+g).remove(),this.removeupg[g].call(this,g,!0);this.upgradesno-=e.length;this.defaultremoveupg(b,c);this.removeupg[b]=this.defaultremoveupg}.bind(this);
this.upgradesno+=b.length}this.showdial();this.showactions();this.showstats()}TEAMS[this.team].updatepoints()},getattacktable:function(b){return ATTACK[b]},attackroll:function(b){var c,e,f,g,h=this.getattacktable(b),l=0,m=Math.random();for(e=0;e<=b;e++)for(f=0;f<=b-e;f++)for(g=0;g<=b-e-f;g++)if(c=100*e+f+10*g,l+=h[c],l>m)return 100*e+10*g+f;return 0},getdefensetable:function(b){return DEFENSE[b]},defenseroll:function(b){var c,e,f,g=this.getdefensetable(b),h=0,l=Math.random();if(0==b)return 0;for(f=
0;f<=b;f++)for(e=0;e<=b-f;e++)if(c=10*f+e,h+=g[c],h>l)return 10*f+e;return 0},addattackrerolla:function(b,c,e,f,g){g?ATTACKREROLLA.push({org:b,type:c,n:e,req:f}):this.ATTACKREROLLA.push({org:b,type:c,n:e,req:f})},adddefensererolld:function(b,c,e,f,g){g?DEFENSEREROLLD.push({org:b,type:c,n:e,req:f}):this.DEFENSEREROLLD.push({org:b,type:c,n:e,req:f})},addattackmoda:function(b,c,e,f,g){f?ATTACKMODA.push({org:b,req:c,f:e,str:g}):this.ATTACKMODA.push({org:b,req:c,f:e,str:g})},adddefensemodd:function(b,
c,e,f,g){f?DEFENSEMODD.push({org:b,req:c,f:e,str:g}):this.DEFENSEMODD.push({org:b,req:c,f:e,str:g})},setclickhandler:function(b){this.g.unmousedown();this.g.mousedown(b)},setdefaultclickhandler:function(){this.g.unmousedown();this.g.mousedown(function(){if(this!=activeunit){var b=activeunit;this.select();b.unselect()}}.bind(this))},dragmove:function(b,c,e,f){b=900*b/$("#playmat").width();c=900*c/$("#playmat").height();this.dragMatrix=MT(b,c).add(this.m);this.dragged=!0;$(".phasepanel").hide();this.g.transform(this.dragMatrix)},
dragstart:function(b,c,e){this.showhitsector(!1);this.dragged=!1},dragstop:function(b){this.dragged&&(this.m=this.dragMatrix,this.showpanel());this.dragged=!1},isinzone:function(b){b=this.getOutlinePoints(b);for(var c=0;4>c;c++)if(0>b[c].x||900<b[c].x||0>b[c].y||900<b[c].y)return!1;return!0},getOutlinePoints:function(b){if(this.moutline==b)return this.op;this.moutline=b;var c=this.islarge?40:20,e=transformPoint(b,{x:-c,y:-c}),f=transformPoint(b,{x:c,y:-c}),g=transformPoint(b,{x:c,y:c});b=transformPoint(b,
{x:-c,y:c});return this.op=[e,f,g,b]},getOutline:function(b){b=this.getOutlinePoints(b);return s.path("M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+" "+b[2].x+" "+b[2].y+" "+b[3].x+" "+b[3].y+" Z").attr({display:"none"})},getRangeString:function(b,c){var e=this.islarge?40:20,f=transformPoint(c,{x:-e,y:-100*b-e}),g=transformPoint(c,{x:e,y:-100*b-e}),h=transformPoint(c,{x:100*b+e,y:-e}),l=transformPoint(c,{x:100*b+e,y:e}),m=transformPoint(c,{x:e,y:100*b+e}),n=transformPoint(c,{x:-e,y:100*b+e}),q=transformPoint(c,
{x:-100*b-e,y:e}),v=transformPoint(c,{x:-100*b-e,y:-e}),u=transformPoint(c,{x:50*b+e,y:-100*b-e}),r=transformPoint(c,{x:100*b+e,y:-50*b-e}),t=transformPoint(c,{x:100*b+e,y:50*b+e}),x=transformPoint(c,{x:50*b+e,y:100*b+e}),y=transformPoint(c,{x:-50*b-e,y:100*b+e}),z=transformPoint(c,{x:-100*b-e,y:50*b+e}),B=transformPoint(c,{x:-100*b-e,y:-50*b-e}),e=transformPoint(c,{x:-50*b-e,y:-100*b-e});return"M "+f.x+" "+f.y+" L "+g.x+" "+g.y+" C "+u.x+" "+u.y+" "+r.x+" "+r.y+" "+h.x+" "+h.y+" L "+l.x+" "+l.y+
" C "+t.x+" "+t.y+"  "+x.x+" "+x.y+" "+m.x+" "+m.y+" L "+n.x+" "+n.y+" C "+y.x+" "+y.y+" "+z.x+" "+z.y+" "+q.x+" "+q.y+" L "+v.x+" "+v.y+" C "+B.x+" "+B.y+" "+e.x+" "+e.y+" "+f.x+" "+f.y},getSubRangeString:function(b,c,e){var f=this.islarge?40:20,g=transformPoint(e,{x:-f,y:-100*b-f}),h=transformPoint(e,{x:f,y:-100*b-f}),l=transformPoint(e,{x:100*b+f,y:-f}),m=transformPoint(e,{x:100*b+f,y:f}),n=transformPoint(e,{x:f,y:100*b+f}),q=transformPoint(e,{x:-f,y:100*b+f}),v=transformPoint(e,{x:-100*b-f,y:f}),
u=transformPoint(e,{x:-100*b-f,y:-f}),r=transformPoint(e,{x:50*b+f,y:-100*b-f}),t=transformPoint(e,{x:100*b+f,y:-50*b-f}),x=transformPoint(e,{x:100*b+f,y:50*b+f}),y=transformPoint(e,{x:50*b+f,y:100*b+f}),z=transformPoint(e,{x:-50*b-f,y:100*b+f}),B=transformPoint(e,{x:-100*b-f,y:50*b+f}),D=transformPoint(e,{x:-100*b-f,y:-50*b-f});b=transformPoint(e,{x:-50*b-f,y:-100*b-f});var E="M "+g.x+" "+g.y+" L "+h.x+" "+h.y+" C "+r.x+" "+r.y+" "+t.x+" "+t.y+" "+l.x+" "+l.y+" L "+m.x+" "+m.y+" C "+x.x+" "+x.y+
"  "+y.x+" "+y.y+" "+n.x+" "+n.y+" L "+q.x+" "+q.y+" C "+z.x+" "+z.y+" "+B.x+" "+B.y+" "+v.x+" "+v.y+" L "+u.x+" "+u.y+" C "+D.x+" "+D.y+" "+b.x+" "+b.y+" "+g.x+" "+g.y,g=transformPoint(e,{x:-f,y:-100*c-f}),h=transformPoint(e,{x:f,y:-100*c-f}),l=transformPoint(e,{x:100*c+f,y:-f}),m=transformPoint(e,{x:100*c+f,y:f}),n=transformPoint(e,{x:f,y:100*c+f}),q=transformPoint(e,{x:-f,y:100*c+f}),v=transformPoint(e,{x:-100*c-f,y:f}),u=transformPoint(e,{x:-100*c-f,y:-f}),r=transformPoint(e,{x:50*c+f,y:-100*
c-f}),t=transformPoint(e,{x:100*c+f,y:-50*c-f}),x=transformPoint(e,{x:100*c+f,y:50*c+f}),y=transformPoint(e,{x:50*c+f,y:100*c+f}),z=transformPoint(e,{x:-50*c-f,y:100*c+f}),B=transformPoint(e,{x:-100*c-f,y:50*c+f}),D=transformPoint(e,{x:-100*c-f,y:-50*c-f});b=transformPoint(e,{x:-50*c-f,y:-100*c-f});return E+=" L "+g.x+" "+g.y+" C "+b.x+" "+b.y+" "+D.x+" "+D.y+" "+u.x+" "+u.y+" L "+v.x+" "+v.y+" C "+B.x+" "+B.y+" "+z.x+" "+z.y+" "+q.x+" "+q.y+" L "+n.x+" "+n.y+" C "+y.x+" "+y.y+" "+x.x+" "+x.y+" "+
m.x+" "+m.y+" L "+l.x+" "+l.y+" C "+t.x+" "+t.y+" "+r.x+" "+r.y+" "+h.x+" "+h.y+" L "+g.x+" "+g.y},getSectorString:function(b,c){var e=this.islarge?40:20,f=this.getSectorPoints(b,new Snap.matrix),g=this.getSectorPoints(b,c),h=transformPoint(c,{x:0,y:0}),l=transformPoint(c,{x:f[0].x+e/2*b,y:f[0].y-e*b/2}),m=transformPoint(c,{x:(f[0].x+3*f[1].x)/4,y:f[1].y}),n=transformPoint(c,{x:(3*f[2].x+f[3].x)/4,y:f[2].y}),e=transformPoint(c,{x:f[3].x-e/2*b,y:f[3].y-e/2*b});return"M "+h.x+" "+h.y+" L "+g[0].x+" "+
g[0].y+" C "+l.x+" "+l.y+" "+m.x+" "+m.y+" "+g[1].x+" "+g[1].y+" L "+g[2].x+" "+g[2].y+" C "+n.x+" "+n.y+" "+e.x+" "+e.y+" "+g[3].x+" "+g[3].y+" Z"},getSubSectorString:function(b,c,e){var f=this.islarge?40:20,g=this.getSectorPoints(b,new Snap.matrix),h=this.getSectorPoints(b,e),l=transformPoint(e,{x:g[0].x+f/2*b,y:g[0].y-f*b/2}),m=transformPoint(e,{x:(g[0].x+3*g[1].x)/4,y:g[1].y}),n=transformPoint(e,{x:(3*g[2].x+g[3].x)/4,y:g[2].y}),g=transformPoint(e,{x:g[3].x-f/2*b,y:g[3].y-f/2*b});b="M "+h[0].x+
" "+h[0].y+" C "+l.x+" "+l.y+" "+m.x+" "+m.y+" "+h[1].x+" "+h[1].y+" L "+h[2].x+" "+h[2].y+" C "+n.x+" "+n.y+" "+g.x+" "+g.y+" "+h[3].x+" "+h[3].y;g=this.getSectorPoints(c,new Snap.matrix);h=this.getSectorPoints(c,e);l=transformPoint(e,{x:g[0].x+f/2*c,y:g[0].y-f*c/2});m=transformPoint(e,{x:(g[0].x+3*g[1].x)/4,y:g[1].y});n=transformPoint(e,{x:(3*g[2].x+g[3].x)/4,y:g[2].y});g=transformPoint(e,{x:g[3].x-f/2*c,y:g[3].y-f/2*c});return b+="L "+h[3].x+" "+h[3].y+" C "+g.x+" "+g.y+" "+n.x+" "+n.y+" "+h[2].x+
" "+h[2].y+" L "+h[1].x+" "+h[1].y+" C "+m.x+" "+m.y+" "+l.x+" "+l.y+" "+h[0].x+" "+h[0].y+" Z"},getSectorPoints:function(b,c){var e=this.islarge?40:20,f=Math.sqrt((e-3)*(e-3)+e*e),g=transformPoint(c,{x:-.95*(f+100*b)/Math.sqrt(1+e*e/(e-3)/(e-3)),y:-(f+100*b)/Math.sqrt(1+(e-3)*(e-3)/e/e)}),h=transformPoint(c,{x:-e+3,y:-e-100*b}),l=transformPoint(c,{x:e-3,y:-e-100*b}),e=transformPoint(c,{x:.95*(f+100*b)/Math.sqrt(1+e*e/(e-3)/(e-3)),y:-(f+100*b)/Math.sqrt(1+(e-3)*(e-3)/e/e)});return[g,h,l,e]},setmaneuver:function(b){"RED"==
this.getdial()[b].difficulty&&0<this.stress||(this.maneuver=b,record(this.id,"this.maneuver="+b),enablenextphase(),this.showdial(),this.showmaneuver())},nextmaneuver:function(){this.maneuver=0>this.maneuver?0:this.maneuver==this.dial.length-1?0:this.maneuver+1;"RED"==this.getdial()[this.maneuver].difficulty&&0<this.stress&&this.nextmaneuver();enablenextphase();this.showdial()},prevmaneuver:function(){this.maneuver=0>this.maneuver?this.dial.length-1:0==this.maneuver?this.dial.length-1:this.maneuver-
1;"RED"==this.getdial()[this.maneuver].difficulty&&0<this.stress&&this.prevmaneuver();enablenextphase();this.showdial()},nextaction:function(){this.action=-1==this.action?0:this.action==this.actionList.length-1?0:this.action+1},prevaction:function(){this.action=-1==this.action?0:0==this.action?this.actionList.length-1:this.action-1},turn:function(b){this.m.add(MR(b,0,0));this.show()},select:function(){waitingforaction.isexecuting||(activeunit=this,$("#"+this.id).addClass("selected"),this.show(),center(this))},
unselect:function(){this!=activeunit&&($("#"+this.id).removeClass("selected"),this.showoutline(),this.showmaneuver())},getocollisions:function(b,c,e,f){var g,h=[],l={overlap:-1,template:0},m=this.getOutline(c);for(g=0;g<OBSTACLES.length;g++)if(this.isintersecting(OBSTACLES[g].getOutlinePoints(),m)){m.remove();l.overlap=g;break}for(c=0;c<=f;c++)g=e.getPointAtLength(c),h.push(transformPoint(b,g));e=[];for(b=0;b<h.length;b++)for(g=0;g<OBSTACLES.length;g++)if(g!=l.overlap&&-1==e.indexOf(g))for(f=OBSTACLES[g].getOutlinePoints(),
c=0;c<f.length;c++){var n=f[c].x-h[b].x,q=f[c].y-h[b].y;if(100>=n*n+q*q){e.push(g);l.template++;break}}m.remove();return l},iscollidingunit:function(b,c){var e=this.getOutline(b),f=c.getOutline(c.m),g=0<Snap.path.intersection(e,f).length;this.islarge&&(g=g||this.isinoutline(e,c,c.m));c.islarge&&(g=g||c.isinoutline(f,this,b));e.remove();f.remove();return g},iscollidinganyunit:function(b){var c;for(c=0;c<squadron.length;c++){var e=squadron[c];if(e!=this&&this.iscollidingunit(b,e))return this.collides=
e,!0}return!1},getpathmatrix:function(b,c){var e=P[c].path.transform(this.m).attr({display:"none"}),f=e.getTotalLength(),e=e.getPointAtLength(f);b.add(MT(e.x,e.y)).add(MR(e.alpha-90,0,0));return b},getpossibleoutline:function(b){var c=this.getOutline(b).attr({fill:this.color,opacity:.5,display:"block"}),e=!0;if(!this.isinzone(b))return c.attr({display:"none"}),{ol:c,b:!1};for(b=0;b<squadron.length;b++){var f=squadron[b];if(f!=this){var f=f.getOutline(f.m),g=Snap.path.intersection(c,f);f.remove();
if(0<g.length){e=!1;c.attr({display:"none"});break}}}if(e)for(b=0;b<OBSTACLES.length;b++)if(this.isintersecting(OBSTACLES[b].getOutlinePoints(),c)){e=!1;c.attr({display:"none"});break}return{ol:c,b:e}},isTurret:function(b){return"Turretlaser"==b.type},updateactionlist:function(){var b;this.actionList=[];for(b=0;b<this.shipactionList.length;b++){var c=this.shipactionList[b];-1==this.actionsdone.indexOf(c)&&this.actionList.push(c)}for(b=0;b<this.upgrades.length;b++)c=this.upgrades[b],c.isactive&&"function"==
typeof c.action&&c.candoaction()&&this.actionList.push(c.type.toUpperCase())},addevadetoken:function(){this.evade++;this.show();record(this.id,"TE")},addevade:function(){this.addevadetoken();this.endaction();return!0},addfocustoken:function(){this.focus++;this.show();record(this.id,"TF")},addfocus:function(){this.addfocustoken();this.endaction();return!0},addstress:function(){this.stress++;record(this.id,"TS");this.show()},addiontoken:function(){this.ionized++;record(this.id,"TI");this.show()},removeiontoken:function(){this.ionized--;
record(this.id,"RI");this.show()},dies:function(){var b;record(this.i,"D");$("#"+this.id).attr("onclick","");$("#"+this.id).addClass("dead");$("#"+this.id).html(""+this);for(b=0;b<squadron.length;b++)if(squadron[b]==this){squadron.splice(b,1);break}this.dead=!0;this.m=MT(-60,-60);log(this.name+" has exploded !");this.show();TEAMS[this.team].checkdead()&&win();SOUNDS.explode.play()},canbedestroyed:function(){return skillturn!=this.skill?!0:!1},checkdead:function(){return 0>=this.hull||!this.isinzone(this.m)?
(this.dies(),!0):!1},cancelhit:function(b,c,e){return b>c?b-c:0},cancelcritical:function(b,c,e){return b>c?b-c:0},evadeattack:function(b){var c=$(".hitreddice").length,e=$(".criticalreddice").length,f=$(".evadegreendice").length,g=$(".evadegreen").length,c=b.weapons[b.activeweapon].modifydamagegiven(10*e+c),e=Math.floor(c/10),h=c-=10*e,c=this.cancelhit(c,f,b),f=f-(h-c),h=c,c=c>=g?c-g:0,g=g-(h-c),e=this.cancelcritical(e,f,b);return 10*(e>=g?e-g:0)+c},declareattack:function(b,c){targetunit=c;this.activeweapon=
b;this.weapons[b].declareattack(c);log(this.name+" attacks "+c.name+" with "+this.weapons[b].name);c.isattackedby(b,this)},isattackedby:function(b,c){},modifydamageassigned:function(b,c){return b},ishit:function(b,c){},resolvedamage:function(){this.fireline.remove();this.playfiresnd();var b=targetunit.evadeattack(this),b=this.weapons[this.activeweapon].modifydamageassigned(b,targetunit),b=targetunit.modifydamageassigned(b,this),c=Math.floor(b/10),b=b-10*c;this.hasdamaged=!0;0<c+b&&(c+b<targetunit.shield?
log(targetunit.name+" lost "+(c+b)+" <p class='cshield'></p>"):0<targetunit.shield&&log(targetunit.name+" lost all <p class='cshield'></p>"),targetunit.ishit(this),this.hitresolved+=b,this.criticalresolved+=c,targetunit.resolvehit(b),targetunit.resolvecritical(c));targetunit.endbeingattacked(c,b);this.weapons[this.activeweapon].endattack(c,b);this.endattack(c,b);targetunit.canbedestroyed(skillturn)&&targetunit.checkdead();this.cleanupattack()},cleanupattack:function(){log("calling nextstep from cleanup");
nextstep()},endround:function(){this.focus=this.evade=0;this.showinfo()},playfiresnd:function(){var b=targetunit.g.getBBox(),c=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)}),e=s.path("M "+c.x+" "+c.y+" L "+(b.x+b.w/2)+" "+(b.y+b.h/2)).attr({stroke:this.color,strokeWidth:2}),f=setInterval(function(){e.remove();clearInterval(f)},200);"undefined"!=typeof this.weapons[this.activeweapon].firesnd?SOUNDS[this.weapons[this.activeweapon].firesnd].play():SOUNDS[this.ship.firesnd].play();record(this.id,
"playfiresnd()")},endattack:function(b,c){for(i=0;i<DICES.length;i++)$("."+DICES[i]+"dice").remove();this.show()},endbeingattacked:function(b,c){this.show();this.activeweapon=-1},usecloak:function(b){waitingforaction.isexecuting||phase!=ACTIVATION_PHASE||0!=this.stress||this.hasmoved||this.resolveuncloak()},usestress:function(b){},usefocusattack:function(b){this.removefocustoken();this.show();b=$(".focusreddice").length;$(".focusreddice").remove();for(i=0;i<b;i++)$("#attack").prepend("<td class='hitreddice'></td>");
$("#attack > .xfocustoken").remove()},usefocus:function(b){if(phase==COMBAT_PHASE)if(this==activeunit)this.usefocusattack(b);else if(this==targetunit)for(targetunit.removefocustoken(),targetunit.show(),b=$(".focusgreendice").length,$(".focusgreendice").remove(),$("#defense > .xfocustoken").remove(),i=0;i<b;i++)$("#defense").prepend("<td class='evadegreendice'></td>")},removetarget:function(b){var c;c=b.istargeted.indexOf(this);-1<c&&b.istargeted.splice(c,1);this.targeting.splice(b);b.show();0==this.targeting.length&&
$("#attack > .xtargettoken").remove()},usetarget:function(){return phase==COMBAT_PHASE&&activeunit==this&&-1<this.targeting.indexOf(targetunit)?(this.removetarget(targetunit),reroll(10,!0,99,""),!0):!1},useevade:function(){phase==COMBAT_PHASE&&this==targetunit&&(this.removeevadetoken(),this.show(),$("#defense > .xevadetoken").remove(),$("#defense").prepend("<td class='evadegreen'></td>"))},removeevadetoken:function(){record(this.id,"RE");this.evade--;this.show()},removefocustoken:function(){record(this.id,
"RF");this.focus--;this.show()},resolveactionmove:function(b,c,e,f){var g;this.pos=[];var h=function(b,c,f){for(g=0;g<this.pos.length;g++)this.pos[g].ol.remove();e&&(this.m=b);f(this,c);this.show()}.bind(this);for(g=0;g<b.length;g++){var l=this.getpossibleoutline(b[g]);f||l.b?(l.ol.attr({display:"block"}),this.pos.push({ol:l.ol,k:g})):l.ol.remove()}if(0<this.pos.length)if(1==this.pos.length)h(this.pos[0].ol,this.pos[0].k,c);else for(g=0;g<this.pos.length;g++)(function(e){var f=this.pos[e];f.ol.hover(function(){this.pos[e].ol.attr({stroke:this.color,
strokeWidth:"4px"})}.bind(this),function(){this.pos[e].ol.attr({strokeWidth:"0px"})}.bind(this));f.ol.click(function(){h(b[this.pos[e].k],this.pos[e].k,c)}.bind(this))}).call(this,g);else h(this.m,-1,c)},resolveactionselection:function(b,c){var e;this.pos=[];var f=function(f){for(e=0;e<b.length;e++)b[e].outline.attr({fill:"rgba(8,8,8,0.5)"}),b[e].setdefaultclickhandler();c(f)}.bind(this);if(0==b.length)f(-1);else if(1==b.length)f(0);else for(e=0;e<b.length;e++)b[e].outline.attr({fill:"rgba(100,100,100,0.8)"}),
function(c){b[c].setclickhandler(function(){f(c)})}(e)},resolveboost:function(){waitingforaction.add(function(){this.resolveactionmove([this.getpathmatrix(this.m.clone().add(MT(0,this.islarge?-20:0)),"F1").add(MT(0,-20)),this.getpathmatrix(this.m.clone().add(MT(0,this.islarge?-20:0)),"BL1").add(MT(0,-20)),this.getpathmatrix(this.m.clone().add(MT(0,this.islarge?-20:0)),"BR1").add(MT(0,-20))],function(b,c){this.endaction()},!0)}.bind(this));return!0},resolveuncloak:function(){var b=this.getpathmatrix(this.m.clone().add(MR(90,
0,0)).add(MT(0,this.islarge?-20:0)),"F2").add(MR(-90,0,0)).add(MT(0,-20)),c=this.getpathmatrix(this.m.clone().add(MR(-90,0,0)).add(MT(0,this.islarge?-20:0)),"F2").add(MR(90,0,0)).add(MT(0,20)),e=this.getpathmatrix(this.m.clone(),"F2");waitingforaction.add(function(){this.resolveactionmove([b.clone().add(MT(0,0)),b.clone().add(MT(0,20)),b.clone().add(MT(0,40)),e,c.clone().add(MT(0,0)),c.clone().add(MT(0,-20)),c.clone().add(MT(0,-40))],function(b,c){b.agility-=2;b.iscloaked=!1;SOUNDS.uncloak.play()},
!0)}.bind(this));nextstep();return!0},resolveroll:function(){waitingforaction.add(function(){var b=this.getpathmatrix(this.m.clone().add(MR(90,0,0)).add(MT(0,this.islarge?-20:0)),"F1").add(MR(-90,0,0)).add(MT(0,-20)),c=this.getpathmatrix(this.m.clone().add(MR(-90,0,0)).add(MT(0,this.islarge?-20:0)),"F1").add(MR(90,0,0)).add(MT(0,-20));this.resolveactionmove([b.clone().add(MT(0,0)),b.clone().add(MT(0,20)),b.clone().add(MT(0,40)),c.clone().add(MT(0,0)),c.clone().add(MT(0,20)),c.clone().add(MT(0,40))],
function(b,c){this.endaction()},!0)}.bind(this));return!0},addtarget:function(b){for(var c=0;c<this.targeting.length;c++)this.removetarget(this.targeting[c]);this.targeting.push(b);b.istargeted.push(this);b.show();this.show()},gettargetableunits:function(b){var c=[],e;for(e=0;e<squadron.length;e++)squadron[e].team!=this.team&&this.getrange(squadron[e])<=b&&c.push(squadron[e]);return c},selectnearbyunits:function(b,c){for(var e=[],f=0;f<squadron.length;f++)log(this.name+":"+squadron[f].name+" "+c(this,
squadron[f])+" "+(this.getrange(squadron[f])<=b)),c(this,squadron[f])&&this.getrange(squadron[f])<=b&&e.push(squadron[f]);return e},resolvetarget:function(){var b;b=this.gettargetableunits(3);return 0<b.length?(log("<b>["+this.name+"] select target to lock</b>"),waitingforaction.add(function(){this.resolveactionselection(b,function(c){0<=c&&this.addtarget(b[c]);this.endaction()}.bind(this))}.bind(this)),!0):!1},resolvecloak:function(){this.iscloaked=!0;this.agility+=2;SOUNDS.cloak.play();this.endaction();
return!0},endaction:function(){this.actiondone=!0;this.action=-1;log("END ACTION");nextstep();return!0},resolveaction:function(){var b;$("#actiondial").empty();-1==this.action?b="NOTHING":(b=this.actionList[this.action],this.actionsdone.push(b));if("BOOST"==b)return this.resolveboost();if("ROLL"==b)return this.resolveroll();if("CLOAK"==b)return this.resolvecloak();if("FOCUS"==b)return this.addfocus();if("EVADE"==b)return this.addevade();if("TARGET"==b)return this.resolvetarget();var c,e=this.shipactionList.length;
for(c=0;c<this.upgrades.length;c++){var f=this.upgrades[c];if("function"==typeof f.action&&f.isactive){if(f.type.toUpperCase()==b&&this.action==e)return f.action();e++}}this.endaction();return!0},getattackreroll:function(b,c){return 0},modifyattackroll:function(b,c){return b},getdefensereroll:function(b,c){return 0},evaluatetohit:function(b,c){var e=this.gethitrange(b,c);if(c!=this&&3>=e&&0<e){var e=this.getattackstrength(b,c),f=c.getdefensestrength(b,this);-1<this.targeting.indexOf(c)?this.reroll=
10:this.reroll=this.weapons[b].getattackreroll(c)+this.getattackreroll(b,c);return tohitproba(this,c,this.getattacktable(e),c.getdefensetable(f),e,f)}return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0}},canfire:function(){var b=this.gethitrangeallunits();return 0==this.hasfired&&(0<b[1].length||0<b[2].length||0<b[3].length)&&!this.iscloaked&&-1==this.ocollision.overlap},getattackstrength:function(b,c){return this.weapons[b].getattack()+this.weapons[b].getattackbonus(c)},getdefensestrength:function(b,
c){var e=this.getagility(),f=this.getoutlinerange(this.m,c).o?1:0;0<f&&log(this.name+" +"+f+" defense for obstacle");return e+c.weapons[b].getdefensebonus(this)+f},getattackmodtokens:function(b,c){var e="",f,g;for(me=0;me<squadron.length&&squadron[me]!=this;me++);for(f=0;f<ATTACKMODA.length;f++){var h=ATTACKMODA[f];h.req(b,c)&&(e+="<td id='moda"+f+"' class='"+h.str+"modtokena' onclick='modroll(ATTACKMODA["+f+"].f,"+c+","+f+")' title='modify roll ["+h.org.name.replace(/\'/g,"&#39;")+"]'></td>")}for(g=
0;g<this.ATTACKMODA.length;g++)h=this.ATTACKMODA[g],h.req(b,c)&&(e+="<td id='moda"+(f+g)+"' class='"+h.str+"modtokena' onclick='modroll(squadron["+me+"].ATTACKMODA["+g+"].f,"+c+","+(f+g)+")' title='modify roll ["+h.org.name.replace(/\'/g,"&#39;")+"]'></td>");return e},getdefensemodtokens:function(b,c){var e="",f,g;for(me=0;me<squadron.length&&squadron[me]!=this;me++);for(f=0;f<DEFENSEMODD.length;f++){var h=DEFENSEMODD[f];h.req(b,c)&&(e+="<td id='modd"+f+"' class='"+h.str+"modtokend' onclick='modrolld(DEFENSEMODD["+
f+"].f,"+c+","+f+")' title='modify roll ["+h.org.name.replace(/\'/g,"&#39;")+"]'></td>")}for(g=0;g<this.DEFENSEMODD.length;g++)h=this.DEFENSEMODD[g],h.req(b,c)&&(e+="<td id='modd"+(f+g)+"' class='"+h.str+"modtokend' onclick='modrolld(squadron["+me+"].DEFENSEMODD["+g+"].f,"+c+","+(f+g)+")' title='modify roll ["+h.org.name.replace(/\'/g,"&#39;")+"]'></td>");return e},getattackrerolltokens:function(){for(var b="",c=function(b,c){var e=0,f=b.n();-1<b.type.indexOf("blank")&&(e+=f);-1<b.type.indexOf("focus")&&
(e+=10*f);-1<b.type.indexOf("hit")&&(e+=100*f);-1<b.type.indexOf("critical")&&(e+=1E3*f);return"<td id='rerolla"+c+"' class='tokens' onclick='reroll("+f+",true,"+e+","+c+")' title='"+f+" rerolls ["+b.org.name.replace(/\'/g,"&#39;")+"]'>R"+f+"</td>"},e=0;e<ATTACKREROLLA.length;e++){var f=ATTACKREROLLA[e];f.req(this,this.weapons[this.activeweapon],targetunit)&&(b+=c(f,e))}for(e=0;e<this.ATTACKREROLLA.length;e++)f=this.ATTACKREROLLA[e],f.req(this.weapons[this.activeweapon],targetunit)&&(b+=c(f,e+ATTACKREROLLA.length));
return b},getdefensererolltokens:function(){for(var b="",c=function(b,c){var e=0,f=b.n();-1<b.type.indexOf("blank")&&(e+=f);-1<b.type.indexOf("focus")&&(e+=10*f);-1<b.type.indexOf("evade")&&(e+=100*f);return"<td id='rerolld"+c+"' class='tokens' onclick='reroll("+f+",false,"+e+","+c+")' title='"+f+" rerolls ["+b.org.name.replace(/\'/g,"&#39;")+"]'>R"+f+"</td>"},e=0;e<DEFENSEREROLLD.length;e++){var f=DEFENSEREROLLD[e];f.req(this,this.weapons[this.activeweapon],targetunit)&&(b+=c(f,e))}for(e=0;e<targetunit.DEFENSEREROLLD.length;e++)f=
targetunit.DEFENSEREROLLD[e],f.req(this.weapons[this.activeweapon],this)&&(b+=c(f,e+DEFENSEREROLLD.length));return b},resolveattack:function(b,c){var e;this.gethitrange(b,c);var f=this.getattackstrength(b,c),g=c.getdefensestrength(b,this);this.hasfired++;this.hasdamaged=!1;$("#combatdial").show();e=c.g.getBBox();var h=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)});this.fireline=s.path("M "+h.x+" "+h.y+" L "+(e.x+e.w/2)+" "+(e.y+e.h/2)).attr({stroke:this.color,strokeWidth:2,strokeDasharray:100,
"class":"animated"});this.select();c.unselect();for(e=0;e<squadron.length&&squadron[e]!=this;e++);this.showattackroll(this.attackroll(f),f,e);c.showdefenseroll(c.defenseroll(g),g,e);this.show()},showattackroll:function(b,c,e){var f;$("#attackdial").empty();$("#dtokens").hide();$("#defense").hide();for(f=0;f<DICES.length;f++)$("."+DICES[f]+"dice").remove();$("#attack").html(this.getusabletokens(e,!0)+this.getattackrerolltokens()+this.getattackmodtokens(b,c));e=Math.floor(b/100);for(f=0;f<e;f++)$("#attack").prepend("<td class='focusreddice'></td>");
var g=Math.floor(b/10)%10;for(f=0;f<g;f++)$("#attack").prepend("<td class='criticalreddice'></td>");b%=10;for(f=0;f<b;f++)$("#attack").prepend("<td class='hitreddice'></td>");for(f=0;f<c-b-g-e;f++)$("#attack").prepend("<td class='blankreddice'></td>");$("#atokens").html('<button onclick=\'$("#defense").show(); $("#dtokens").show();$("#atokens").empty()\'>Done</button>')},showdefenseroll:function(b,c,e){var f;for(f=0;f<squadron.length&&squadron[f]!=this;f++);$("#defense").html(this.getusabletokens(f,
!0)+this.getdefensererolltokens()+this.getdefensemodtokens(b,c));$("#dtokens").html('<button onclick=\'$("#combatdial").hide();squadron['+e+"].resolvedamage()'>Fire!</button>");f=Math.floor(b/10);for(e=0;e<f;e++)$("#defense").prepend("<td class='focusgreendice'></td>");b%=10;for(e=0;e<b;e++)$("#defense").prepend("<td class='evadegreendice'></td>");for(e=0;e<c-b-f;e++)$("#defense").prepend("<td class='blankgreendice'></td>")},getmatrixwithmove:function(b,c){var e=b.getTotalLength(),f=this.m.clone();
if(this.islarge)if(20>=c)f.add(MT(0,-c));else{var e=c>e+20?c-e-20:0,g=b.getPointAtLength(c-e-20);f.add(MT(g.x,-20+g.y)).add(MR(g.alpha-90,0,0)).add(MT(0,-e))}else g=b.getPointAtLength(c),f.add(MT(g.x,g.y)).add(MR(g.alpha-90,0,0));return f},removestresstoken:function(){this.stress--;record(this.id,"RS");this.show()},handledifficulty:function(b){"RED"==b?this.addstress():"GREEN"==b&&0<this.stress&&this.removestresstoken()},completemaneuver:function(b,c,e){var f=P[c].path,g=f.transform(this.m).attr({display:"none"});
g.appendTo(s);var h=g.getTotalLength();this.collision=!1;this.futurem=new Snap.matrix;var l,m;this.showhitsector(!1);movePoint=g.getPointAtLength(h);this.islarge&&(h+=40);m=this.m;l=this.getmatrixwithmove(g,h);if(this.iscollidinganyunit(l))for(log(this.name+"  collides with "+this.collides.name+": no action"),this.collision=!0;0<h&&this.iscollidinganyunit(l);)l=this.getmatrixwithmove(g,h),--h;this.m=l;this.ocollision=this.getocollisions(m,this.m,f,h);-1<this.ocollision.overlap&&log(this.name+" overlaps obstacle: no action, cannot attack");
0<this.ocollision.template&&log(this.name+" template overlaps obstacle: no action");0<h?(SOUNDS[this.ship.flysnd].play(),Snap.animate(0,h,function(b){var c=this.m;this.m=m;l=this.getmatrixwithmove(g,b);this.m=c;this.g.transform(l)}.bind(this),TIMEANIM*h/200,mina.linear,function(){this.collision?record(this.id,"M"+c+":"+h):b.match(/K\d|SR\d|SL\d/)?(this.m.add(MR(180,0,0)),record(this.id,"M"+c+":"+h+":R")):record(this.id,"M"+c+":"+h);this.handledifficulty(e);this.maneuver=-1;this.show();g.remove();
(-1<this.ocollision.overlap||0<this.ocollision.template)&&this.resolveocollision();this.endmaneuver()}.bind(this))):(log(this.name+" cannot move"),this.handledifficulty(e),this.maneuver=-1,this.show(),g.remove(),this.endmaneuver())},resolvemaneuver:function(){$("#activationdial").empty();if(!(0>this.maneuver||this.hasmoved)){this.hasmoved=!0;var b=this.getdial()[this.maneuver].move,c=this.getdial()[this.maneuver].difficulty;"F0"==b?(this.handledifficulty(c),this.endmaneuver()):this.completemaneuver(b,
b,c)}},endmaneuver:function(){this.ionized=0;this.hasmoved=!0;this.checkdead()?(this.shield=this.hull=0,nextstep()):this.candoaction()&&this.timeforaction()&&this.showaction();this.showstats()},candoaction:function(){return 0<this.stress||0<this.collision||0<this.ocollision.template||-1<this.ocollision.overlap?!1:!0},canuncloak:function(){return!this.hasmoved&&this.iscloaked&&phase==ACTIVATION_PHASE},selecttargetforattack:function(b){var c=this.weapons[b].getrangeallunits(),e,f=[];for(e=0;e<c.length;e++)c[e].team!=
this.team&&f.push(c[e]);if(0==f.length)return!1;this.resolveactionselection(f,function(c){0<=c&&(this.declareattack(b,f[c]),this.resolveattack(b,f[c]))}.bind(this));return!0},showattack:function(){var b="",c=[],e,f,g;$("#attackdial").hide();phase==COMBAT_PHASE&&skillturn==this.skill&&log(this.name+" show attack ?"+!waitingforaction.isexecuting);if(phase==COMBAT_PHASE&&!waitingforaction.isexecuting&&skillturn==this.skill&&this.canfire()){var h=this.gethitrangeallunits();$("#attackdial").empty();for(e=
1;3>=e;e++)for(f=0;f<h[e].length;f++)for(g=0;g<h[e][f].wp.length;g++){var l=h[e][f].wp[g];-1==c.indexOf(l)&&c.push(l)}for(e=0;e<c.length;e++)g=A[this.weapons[c[e]].type.toUpperCase()],b+="<div class='symbols "+g.color+"' onclick='activeunit.selecttargetforattack("+c[e]+")'>"+g.key+"</div>";b+="<button onclick='activeunit.hasfired++;activeunit.show();'>Skip</button>";$("#attackdial").html("<div>"+b+"</div>").show()}},candotarget:function(){return 0<this.gettargetableunits(3).length},candofocus:function(){return!0},
candoevade:function(){return!0},candropbomb:function(){return this.lastdrop!=round&&!this.hasmoved&&this.skill==skillturn&&phase==ACTIVATION_PHASE},addactivationdial:function(b,c,e,f){this.activationdial.push({pred:b,action:c,html:e,elt:f})},updateactivationdial:function(){this.activationdial=[];this.addactivationdial(function(){return this.canuncloak()}.bind(this),function(){this.usecloak()}.bind(this),A.CLOAK.key,$("<div>").attr({class:"symbols"}));if(this.candropbomb())for(var b=0;b<this.bombs.length;b++){var c=
this.bombs[b];this.addactivationdial(function(){return this.isactive}.bind(c),function(){this.unit.lastdrop=round;$(".bombs").remove();this.drop(this.getbomblocation());this.unit.showactivation()}.bind(c),A.BOMB.key,$("<div>").attr({class:"symbols"}))}return this.activationdial},showactivation:function(){var b=this.updateactivationdial();$("#activationdial").html("<div></div>");for(var c=0;c<b.length;c++){var e=b[c];e.pred()&&e.elt.appendTo("#activationdial > div").click(e.action).html(e.html)}this.timeformaneuver()&&
$("<button>").html("Move").click(function(){this.resolvemaneuver()}.bind(this)).appendTo("#activationdial > div")},freeaction:function(b){this.tfa=this.timeforaction;this.ea=this.endaction;this.timeforaction=function(){return!0};this.endaction=function(){this.endaction=this.ea;this.timeforaction=this.tfa;this.show();b();return!1};this.timeforaction()&&this.showaction()},showaction:function(){var b="",c;$("#actiondial").empty();if(!waitingforaction.isexecuting){this.updateactionlist();for(c=0;c<squadron.length&&
squadron[c]!=this;c++);if(this.candoaction()){var e;for(e=0;e<this.actionList.length;e++){var f=this.actionList[e];if("TARGET"!=f||this.candotarget())if("FOCUS"!=f||this.candofocus())if("EVADE"!=f||this.candoevade())b+="<div class='symbols' onclick='activeunit.action="+e+";squadron["+c+"].resolveaction()'>"+A[f].key+"</div>"}}""!=b&&(b+="<button onclick='activeunit.action=-1;squadron["+c+"].resolveaction()'>Skip</button>",$("#actiondial").html("<div>"+b+"</div>").show());this.action<this.actionList.length&&
-1<this.action?(f=this.actionList[this.action],c=A[f].color,this.actionicon.attr({fill:this==activeunit?c:halftone(c)})):this.actionicon.attr({text:""});return""!=b?!0:!1}},showinfo:function(){var b=0,c;0<this.focus&&this.infoicon[b++].attr({text:A.FOCUS.key,fill:A.FOCUS.color});0<this.evade&&this.infoicon[b++].attr({text:A.EVADE.key,fill:A.EVADE.color});1==this.iscloaked&&this.infoicon[b++].attr({text:A.CLOAK.key,fill:A.CLOAK.color});0<this.targeting.length&&this.infoicon[b++].attr({text:A.TARGET.key,
fill:A.TARGET.color});0<this.istargeted.length&&this.infoicon[b++].attr({text:A.ISTARGETED.key,fill:A.ISTARGETED.color});0<this.stress&&this.infoicon[b++].attr({text:A.STRESS.key,fill:A.STRESS.color});0<this.ionized&&this.infoicon[b++].attr({text:"Z",fill:A.STRESS.color});for(c=b;4>c;c++)this.infoicon[b++].attr({text:""})},showoutline:function(){this.outline.attr({stroke:activeunit==this?this.color:halftone(this.color)})},endcombatphase:function(){this.hasfired=0},beginplanningphase:function(){},
beginactivationphase:function(){this.showmaneuver()},timetoshowmaneuver:function(){return-1<this.maneuver},showmaneuver:function(){if(this.timetoshowmaneuver()){var b=this.getdial()[this.maneuver],c=C[b.difficulty];activeunit!=this&&(c=halftone(c));this.dialspeed.attr({text:P[b.move].speed,fill:c});this.dialdirection.attr({text:P[b.move].key,fill:c})}},beginactivation:function(){this.show()},endactivationphase:function(){this.actionsdone=[]},begincombatphase:function(){},beginattack:function(){},
toString:function(){if(phase==SELECT_PHASE1||phase==SELECT_PHASE2&&2==this.team)return this.toString2();var b,c;for(b=0;b<squadron.length&&this!=squadron[b];b++);b==squadron.length&&(b=-1);str=-1==b?"<div class='dead '>":"<div>";c=8+2*this.upgrades.length;this.hull+this.shield<=c?(str+="<div class='vertical stat'>",str+="<div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>"):this.hull>c?(str+="<div class='vertical stat'>",str+="<div class='hull'>"+
repeat("u ",c)+"</div></div>",this.hull<=2*c?(str+="<div class='vertical stat2'>",str+="<div class='hull'>"+repeat("u ",this.hull-c)+"</div>",this.shield+this.hull<=2*c?str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>":(str+="<div class='shield'>"+repeat("u ",2*c-this.hull)+"</div></div>",str+="<div class='vertical stat3'>",str+="<div class='shield'>"+repeat("u ",this.shield-2*c+this.hull)+"</div></div>")):(str+="<div class='vertical stat2'><div class='hull'>"+repeat("u ",c)+"</div></div>",
str+="<div class='vertical stat3'><div class='hull'>"+repeat("u ",this.hull-2*c)+"</div>",str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>")):(str+="<div class='vertical stat'><div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",c-this.hull)+"</div></div>",str+="<div class='vertical stat2'><div class='shield'>"+repeat("u ",this.shield-c+this.hull)+"</div></div>");str+="<div><div class='statskill'>"+this.skill+"</div>";str+="<div class='horizontal statfire'>"+
this.weapons[0].getattack()+"</div>";str+="<div class='horizontal statevade'>"+this.getagility()+"</div>";str+="<div class='horizontal statshield'>"+this.shield+"</div>";str+="<div class='horizontal stathull'>"+this.hull+"</div></div>";str+="<div class='name'><div>"+this.name+"</div></div>";str+="<div><div style='font-size:small'><code class='"+this.faction+"'></code>"+this.ship.name+"</div></div>";str+="<div class='horizontal'><div>"+PILOTS[this.pilotid].points+"pts</div></div>";c=PILOT_translation.english[this.name+
("SCUM"==this.faction?" (Scum)":"")];"undefined"==typeof c&&(c="");str+="<div class='horizontal details'><div style='text-align:justify;margin:8px;width:100%'>"+c+"</div></div>";str+="<div class='vertical'><div>";-1<b&&(str+="<div><table style='width:100%'><tr style='width:100%'>"+this.getusabletokens(b,!1)+"</tr></table></div>");str+="</div></div>";var e=c="";b="<td class='statevade' onclick='if (!squadron["+b+"].dead) squadron["+b+"].togglerange();'>"+this.getagility()+"<span class='symbols'>^</span></td>";
c=1==this.team?c+("<tr><td></td>"+b+"</tr>"):c+("<tr>"+b+"<td></td></tr>");for(b=0;b<this.upgrades.length;b++)e+=this.upgrades[b];return str+="<table class='details' style='width:100%'>"+c+e+"</table></div>"},canusefocus:function(){return 0<this.focus},canuseevade:function(){return 0<this.evade},canusetarget:function(b){return 0<this.targeting.length&&("undefined"==typeof b||-1<this.targeting.indexOf(b))},getusabletokens:function(b,c){var e="",f="";this.canusefocus()&&(e+="<td title='"+this.focus+
" focus token(s)'"+(c?" onclick='squadron["+b+"].usefocus("+b+")'":"")+" class='xfocustoken'></td>");0<this.canuseevade()&&(e+="<td title='"+this.evade+" evade token(s)'"+(c?" onclick='squadron["+b+"].useevade("+b+")'":"")+" class='xevadetoken'></td>");for(var g=0;g<this.targeting.length;g++)f+=this.targeting[g].name+" ";0<this.canusetarget()&&(e+="<td title='targeting "+f.replace(/\'/g,"&#39;")+"'"+(c?" onclick='squadron["+b+"].usetarget()'":"")+" class='xtargettoken'></td>");f="";for(g=0;g<this.istargeted.length;g++)f+=
this.istargeted[g].name+" ";""!=f&&(e+="<td title='targeted by "+f.replace(/\'/g,"&#39;")+"' class='xtargetedtoken'></td>");this.iscloaked&&(e+="<td class='xcloaktoken'"+(c?" onclick='squadron["+b+"].usecloack("+b+")'":"")+"></td>");0<this.stress&&(e+="<td title='"+this.stress+" stress token(s)'"+(c?" onclick='squadron["+b+"].usestress("+b+")'":"")+" class='xstresstoken'></td>");0<this.ionized&&(e+="<td title='"+this.ionized+" ionization token(s)' class='xionizedtoken'></td>");return e},showstats:function(){phase==
SELECT_PHASE1||phase==SELECT_PHASE2?$("#stats"+this.id).html("<div class='PS'>"+this.skill+"</div><div class='statfire'>"+this.weapons[0].getattack()+"</div><div class='statevade'>"+this.getagility()+"</div><div class='statshield'>"+this.shield+"</div><div class='stathull'>"+this.hull+"</div>"):(this.skillbar.attr({text:repeat("u",this.skill)}),this.firebar.attr({text:repeat("u",this.weapons[0].getattack())}),this.evadebar.attr({text:repeat("u",this.getagility())}),this.hullbar.attr({text:repeat("u",
this.hull)}),this.shieldbar.attr({text:repeat("u",this.shield+this.hull)}),$("#"+this.id).html(""+this))},showpanel:function(){var b=this.g.getBBox(),c=$("#playmat").position(),e=c.left+(b.x+(this.islarge?80:40))*$("#playmat").width()/900,b=c.top+b.y*$("#playmat").height()/900;$(".phasepanel").css({left:e+10,top:b}).appendTo("body").show()},timeforaction:function(){log("TIME FOR ACTION for "+this.name+"?"+!waitingforaction.isexecuting);return!waitingforaction.isexecuting&&this==activeunit&&this.hasmoved&&
!this.actiondone&&phase==ACTIVATION_PHASE},timeformaneuver:function(){return this==activeunit&&-1<this.maneuver&&!this.hasmoved&&this.skill==skillturn},show:function(){"undefined"!=typeof this.g&&(this.g.transform(this.m),this.g.appendTo(s),this.showoutline(),this.showstats(),this.showinfo(),activeunit==this&&(this.showpanel(),this.showdial(),this.showmaneuver(),this.timeforaction()?this.showaction():$("#actiondial").empty(),phase==ACTIVATION_PHASE&&this.showactivation(),this.showattack(),0<this.hull&&
($("#"+this.id).html(""+this),$("#"+this.id).addClass("selected"))))},showhitsector:function(b,c){var e=activeunit;activeunit=this;e!=this&&(e.unselect(),this.select());if(b){for(h=0;h<this.weapons.length&&this.weapons[h].name!=c;h++);if(h!=this.weapons.length){var e=this.weapons[h].range[0],f=this.weapons[h].range[1];if(this.weapons[h].isTurret()||this.isTurret(this.weapons[h]))this.showrange(b,e,f);else{var g,h;if(1==e){for(g=e;g<=f;g++)this.sectors.push(s.path(this.getSectorString(g,this.m)).attr({fill:this.color,
stroke:this.color,opacity:.3,pointerEvents:"none"}));if("Bilaser"==this.weapons[h].type)for(g=e;g<=f;g++)this.sectors.push(s.path(this.getSectorString(g,this.m.clone().add(MR(180,0,0)))).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}))}else for(g=e;g<=f;g++)this.sectors.push(s.path(this.getSubSectorString(e-1,g,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}))}}}else{for(g=0;g<this.sectors.length;g++)this.sectors[g].remove();for(g=0;g<this.ranges.length;g++)this.ranges[g].remove();
this.ranges=[];this.sectors=[]}},showrange:function(b,c,e){var f=activeunit;activeunit=this;f!=activeunit&&(f.unselect(),this.select());if(b)if(1==c)for(b=c;b<=e;b++)this.ranges.push(s.path(this.getRangeString(b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}));else for(b=c;b<=e;b++)this.ranges.push(s.path(this.getSubRangeString(c-1,b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}));else{for(b=0;b<this.ranges.length;b++)this.ranges[b].remove();
this.ranges=[]}},togglehitsector:function(b){this.showhitsector(0<this.sectors.length+this.ranges.length?!1:!0,b)},togglerange:function(){this.showrange(0<this.ranges.length?!1:!0,1,3)},isintersecting:function(b,c){var e,f=!1;for(e=0;e<b.length;e++)f=f||Snap.path.isPointInside(c,b[e].x,b[e].y);return f},isinsector:function(b,c,e){var f=e.getOutlinePoints(e.m),g=this.getSectorString(c,b);if(this.getoutlinerange(b,e).d!=c)return!1;if(this.isintersecting(f,g))return!0;e=e.getOutline(e.m);b=this.getSectorPoints(c,
b);if(this.isintersecting(b,e))return e.remove(),!0;e.remove();return!1},gethitsector:function(b){var c;for(c=1;3>=c;c++)if(this.isinsector(this.m,c,b))return c;return 4},isinoutline:function(b,c,e){return this.isintersecting(c.getOutlinePoints(e),b)},checkcollision:function(b){return this.collision&&this.collides==b||b.collision&&b.collides==this},resolveocollision:function(){var b,c=this.ocollision.template;-1<this.ocollision.overlap&&c++;for(b=0;b<c;b++){var e=Math.floor(7*Math.random()),e=FACE[ATTACKDICE[e]];
"hit"==e?(this.resolvehit(1),this.checkdead()):"critical"==e&&(this.resolvecritical(1),this.checkdead())}},removeshield:function(b){record(this.id,"removeshield("+b+")");this.shield-=b},resolvehit:function(b){0!=b&&(this.shield>b?this.removeshield(b):(b-=this.shield,this.removeshield(this.shield),0<b&&this.applydamage(b)),this.showstats())},resolvecritical:function(b){0!=b&&(this.shield>b?this.removeshield(b):(b-=this.shield,this.removeshield(this.shield),0<b&&this.applycritical(b)),this.showstats())},
removehull:function(b){record(this.id,"removehull("+b+")");this.hull-=b},applydamage:function(b){this.removehull(b);log(this.name+" was dealt "+b+" <p class='hit'></p>, lost "+b+" <p class='chull'></p>")},applycritical:function(b){var c=0,e;for(e=0;e<b;e++)Math.random()<7/33&&c++;log(this.name+" was dealt "+b+" <p class='critical'></p>, lost "+(c+b)+" <p class='chull'></p>");this.removehull(c+b)},gethitrange:function(b,c){return c.team==this.team||this.checkcollision(c)||0==this.weapons[b].canfire(c)?
0:this.weapons[b].getrange(c)},gethitrangeallunits:function(){var b,c,e=[[],[],[],[],[]];for(c=0;c<squadron.length;c++){var f=squadron[c];if(f!=this)for(b=0;b<this.weapons.length;b++){var g=this.gethitrange(b,f);if(0<g){for(j=0;j<e[g].length&&e[g][j].unit!=c;j++);j<e[g].length?e[g][j].wp.push(b):e[g].push({unit:c,wp:[b]})}}}return e},getrange:function(b){return this.getoutlinerange(this.m,b).d},getoutlinerange:function(b,c){var e=this.getOutlinePoints(b),f=c.getOutlinePoints(c.m),g=90001,h,l,m=!1,
n,q;for(h=0;4>h;h++)for(l=0;4>l;l++){var v=dist(f[l],e[h]);v<g&&(g=v,n=h,q=l)}if(9E4<g)return{d:4,o:!1};var v=f[q].x-e[n].x,u=f[q].y-e[n].y,r=-e[n].x*u+e[n].y*v;for(l=0;l<OBSTACLES.length;l++){var t=OBSTACLES[l].getOutlinePoints(),x=t[0].x*u-t[0].y*v+r,y=x;for(h=1;h<t.length&&!(dist(f[q],t[h])<1.2*g&&dist(e[n],t[h])<1.2*g&&(y=t[h].x*u-t[h].y*v+r,0>y*x));h++);if(0>y*x)break}l<OBSTACLES.length&&(m=!0);return 1E4>=g?{d:1,o:m}:4E4>=g?{d:2,o:m}:{d:3,o:m}},getrangeallunits:function(){var b=[[],[],[],[],
[]],c;for(c=0;c<squadron.length;c++){var e=squadron[c];e!=this&&(e=this.getrange(e),b[e].push({unit:c}))}return b}};var phase=0,round=1,skillturn=0,tabskill,VERSION="v0.5",SETUP_PHASE=2,PLANNING_PHASE=3,ACTIVATION_PHASE=4,COMBAT_PHASE=5,SELECT_PHASE1=0,SELECT_PHASE2=1,DICES="focusred hitred criticalred blankred focusgreen evadegreen blankgreen".split(" "),BOMBS=[],allunits=[];function ActionQueue(){this.queue=[];this.isexecuting=!1}
ActionQueue.prototype={add:function(b){this.isexecuting?this.queue.push(b):(this.isexecuting=!0,activeunit.show(),b.call())},next:function(){if(0<this.queue.length){var b;b=this.queue.shift();this.isexecuting=!0;log("EXECUTING ACTION");activeunit.show();b.call()}else this.isexecuting=!1}};waitingforaction=new ActionQueue;function center(){var b=activeunit.g.getBBox();$("#playmat").scrollLeft(b.x-window.innerWidth/2+b.width/2);$("#playmat").scrollTop(b.y-window.innerHeight/2+b.height/2)}
function prevselect(){if(!waitingforaction.isexecuting){var b=activeunit;if(phase==ACTIVATION_PHASE||phase==COMBAT_PHASE){if(-1==skillturn)return;active=0==active?tabskill[skillturn].length-1:active-1;tabskill[skillturn][active].select()}else active=0==active?squadron.length-1:active-1,squadron[active].select();b.unselect()}}
function nextselect(){var b=activeunit;if(phase==ACTIVATION_PHASE||phase==COMBAT_PHASE){if(-1==skillturn)return;active=active==tabskill[skillturn].length-1?0:active+1;tabskill[skillturn][active].select()}else active=active==squadron.length-1?0:active+1,squadron[active].select();b.unselect()}
function hitrangetostr(b){var c="",e,f,g,h=[];for(e=0;e<squadron.length&&squadron[e]!=activeunit;e++);for(e=1;3>=e;e++)if(0<b[e].length)for(f=0;f<b[e].length;f++){g=b[e][f].unit;var l=squadron[g],c=c+"<tr>",c=c+("<td class='tohit'>"+e+"</td>"),c=c+("<td>"+l.name+"</td>");for(w=0;w<b[e][f].wp.length;w++){var m=activeunit.weapons[w],n=activeunit.evaluatetohit(w,l);if(void 0==n)break;var q=n.tokill[l.hull+l.shield],q="undefined"==typeof q?0:Math.floor(1E4*q)/100;-1==h.indexOf(m.type)&&h.push(m.type);
c+="<td class='probacell' style='background:hsl("+1.2*(100-n.tohit)+",100%,80%)'";c=phase==COMBAT_PHASE&&skillturn==activeunit.skill&&activeunit.canfire()?c+(" onclick='resolvecombat("+g+","+w+")'>"):c+">";c+="<div class='reddice'>"+activeunit.getattackstrength(w,l)+"</div><div class='greendice'>"+l.getdefensestrength(w,activeunit)+"</div>";c+="<div>"+n.tohit+"%</div><div><code class='symbols' style='border:0'>d</code>"+n.meanhit+"</div><div><code class='symbols'  style='border:0'>c</code>"+n.meancritical+
"</div><div>"+q+"% kill</div>";c+="</td>"}c+="</tr>"}if(""==c)c="No unit in range of "+activeunit.name,activeunit.istargeting=!1;else{b="";b="<table><tr><th>Range</th><th>Name</th>";for(e=0;e<h.length;e++)b+="<th style='width:2em;border:0'><div class='"+h[e]+"' style='width:100px;border:0;background:white;color:black'></div></th>";c=b+"</tr>"+c+"</table>"}return c}
function inhitrange(){$("#listtitle").html("Units in weapon range of "+activeunit.name);$("#listunits").html(hitrangetostr(activeunit.gethitrangeallunits()));window.location="#modal"}
function unitstostr(){var b,c=["","",""];for(b=0;b<squadron.length;b++){var e=squadron[b];c[e.team]+=e}return"<div id='squad1'><div>Stats</div><div>Names</div><div>Ship</div><div>Points</div><div>Description</div></div>"+c[1]+"<div id='squad2'><div>Stats</div><div>Names</div><div>Ship</div><div>Points</div><div>Description</div></div>"+c[2]}function allunitlist(){$("#listtitle").html("List of units");$("#listunits").html(unitstostr());window.location="#modal"}
function nextstep(){log("NEXT STEP");waitingforaction.next();waitingforaction.isexecuting||0!=waitingforaction.queue.length||(log("NEXTACTIVATION|COMBAT"),phase==ACTIVATION_PHASE&&(enablenextphase(),activeunit.show(),nextactivation()),phase==COMBAT_PHASE&&nextcombat())}
function nextcombat(){for(var b,c=0,e=0,f=activeunit;0==c&&0<=skillturn;){for(b=0;b<tabskill[skillturn].length;b++)if(tabskill[skillturn][b].canfire()){c++;e=b;break}if(0==c){var g=!1;skillturn--;for(b=0;b<tabskill[skillturn].length;b++){var h=tabskill[skillturn][b];h.canbedestroyed(skillturn)&&h.checkdead()&&(g=!0)}for(g&&(TEAMS[1].checkdead()||TEAMS[2].checkdead())&&win();0<=skillturn&&0==tabskill[skillturn].length;)skillturn--}}if(-1==skillturn)for(log("No more firing units, ready to end phase."),
b=0;b<squadron.length;b++)squadron[b].endcombatphase();else active=e,tabskill[skillturn][e].select(),f.unselect(),activeunit.beginattack(),activeunit.show()}
function nextactivation(){var b=0,c=0,e;if(!(12<skillturn)){for(e=0;e<tabskill[skillturn].length;e++)-1!=tabskill[skillturn][e].maneuver&&(b++,c=e);if(0==b){for(skillturn++;13>skillturn&&0==tabskill[skillturn].length;)skillturn++;if(13==skillturn)return;c=0}b=activeunit;active=c;tabskill[skillturn][c].select();b.unselect();activeunit.beginactivation()}}
function modroll(b,c,e){var f=0,g=$(".focusreddice").length,h=$(".hitreddice").length,l=$(".criticalreddice").length,g=b(100*g+10*l+h,c);$("#attack").empty();for(b=0;b<Math.floor(g/100)%10;b++,f++)$("#attack").append("<b class='focusreddice'></b>");for(b=0;b<Math.floor(g/10)%10;b++,f++)$("#attack").append("<b class='criticalreddice'></b>");for(b=0;b<g%10;b++,f++)$("#attack").append("<b class='hitreddice'></b>");for(b=f;b<c;b++)$("#attack").append("<b class='blankreddice'></b>");$("#moda"+e).remove()}
function modrolld(b,c,e){var f=0,g=$(".focusgreendice").length,h=$(".evadegreendice").length,g=b(10*g+h,c);$("#defense").empty();for(b=0;b<Math.floor(g/10);b++,f++)$("#defense").append("<b class='focusgreendice'></b>");for(b=0;b<g%10;b++,f++)$("#defense").append("<b class='evadegreendice'></b>");for(b=f;b<c;b++)$("#defense").append("<b class='blankgreendice'></b>");$("#modd"+e).remove()}
function reroll(b,c,e,f){var g,h=0,l=["blank","focus","hit","critical"],m=["blank","focus","evade"];if(c){for(c=0;4>c;c++)1<=e%10&&(g=$("."+l[c]+"reddice:not([noreroll])"),g.length<b?(g.remove(),h+=g.length,b-=g.length):($("."+l[c]+"reddice:lt("+b+"):not([noreroll])").remove(),h+=b,b=0),e=Math.floor(e/10));$("#rerolla"+f).remove();for(c=0;c<h;c++)b=Math.floor(7*Math.random()),$("#attack").prepend("<td noreroll='true' class='"+FACE[ATTACKDICE[b]]+"reddice'></td>")}else{for(c=0;3>c;c++)1<=e%10&&(g=
$("."+m[c]+"greendice:not([noreroll])"),g.length<b?(g.remove(),h+=g.length,b-=g.length):($("."+l[c]+"greendice:lt("+b+"):not([noreroll])").remove(),h+=b,b=0),e=Math.floor(e/10));$("#rerolld"+f).remove();for(c=0;c<h;c++)b=Math.floor(7*Math.random()),$("#defense").prepend("<td noreroll='true' class='"+FACE[DEFENSEDICE[b]]+"greendice'></td>")}}
function enablenextphase(){var b,c=!0;switch(phase){case PLANNING_PHASE:for(b=0;b<squadron.length;b++)if(0>squadron[b].maneuver&&!squadron[b].isdead){c=!1;break}c&&$(".nextphase").prop("disabled")&&log("All units have planned a maneuver, ready to end phase");break;case ACTIVATION_PHASE:for(b=0;b<squadron.length;b++)if(0<=squadron[b].maneuver&&!squadron[b].isdead){c=!1;break}c&&$(".nextphase").prop("disabled")&&log("All units have been activated, ready to end phase")}c&&$(".nextphase").prop("disabled",
!1);return c}
var keybindings={phase0:[],phase1:[],phase2:[{k:"t",f:function(){activeunit.turn(45)}},{k:"shift+t",f:function(){activeunit.turn(-45)}},{k:"b",f:function(){activeunit.turn(5)}},{k:"shift+b",f:function(){activeunit.turn(-5,0,0)}}],phase3:[{k:"m",f:function(){activeunit.nextmaneuver()}},{k:"shift+m",f:function(){activeunit.prevmaneuver()}}],phase4:[],phase5:[{k:"enter",f:function(){inhitrange();window.location="#modal"}}],action:[{k:"a",f:function(){!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==
skillturn&&activeunit.nextaction()}},{k:"shift+a",f:function(){!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==skillturn&&activeunit.prevaction()}},{k:"enter",f:function(){phase==ACTIVATION_PHASE&&!activeunit.actiondone&&activeunit.hasmoved&&activeunit.skill==skillturn&&resolveaction()}}],select:[{k:"n",f:nextselect},{k:"shift+n",f:prevselect}]};
function win(){var b="",c=[];TEAMS[1].checkdead()&&!TEAMS[2].checkdead()&&(b="Team #2 wins !");TEAMS[2].checkdead()&&!TEAMS[1].checkdead()&&(b="Team #1 wins !");TEAMS[1].checkdead()&&TEAMS[2].checkdead()&&(b="Draw !");$("#listtitle").html(b);c[1]="";c[2]="";for(i=0;i<allunits.length;i++)b=allunits[i],c[b.team]+="<tr><td>"+b.name+"</td><td>"+Math.floor(100*b.hitresolved/round)/100+"</td><td>"+Math.floor(100*b.criticalresolved/round)/100+"</td></tr>";c[1]="<table><tr><th>Name</th><th>Avg. Hits/round</th><th>Avg. Crit./round</th></tr>"+
c[1]+"</table>";c[2]="<table><tr><th>Name</th><th>Avg. Hits/round</th><th>Avg. Crit./round</th></tr>"+c[2]+"</table>";$("#listunits").html(c[1]+c[2]);window.location="#modal"}document.addEventListener("win",win,!1);function bind(b,c,e){$(document.body).bind("keydown."+b,jwerty.event(c,e))}function unbind(b){$(document.body).unbind("keydown."+b)}function bindall(b){var c=keybindings[b],e;for(e=0;e<c.length;e++)bind(b,c[e].k,c[e].f)}var phasetext="Build squad #1;Build squad #2;Setup;Planning;Activation;Combat".split(";");
function filltabskill(){tabskill=[];for(i=0;12>=i;i++)tabskill[i]=[];for(i=0;i<squadron.length;i++)tabskill[squadron[i].skill].push(squadron[i])}var zone=[];
function nextphase(){var b;window.location="#";switch(phase){case SELECT_PHASE1:$("#rightpanel").show();zone[1]=s.rect(0,0,100,900).attr({fill:TEAMS[1].color,strokeWidth:2,opacity:.3,pointerEvents:"none"});zone[1].appendTo(s);break;case SELECT_PHASE2:zone[2]=s.rect(800,0,900,900).attr({fill:TEAMS[2].color,strokeWidth:2,opacity:.3,pointerEvents:"none"});zone[2].appendTo(s);break;case SETUP_PHASE:zone[1].remove();zone[2].remove();for(b=0;b<SOUNDS.length;b++)$("#"+SOUNDS[b]).trigger("load");$(".nextphase").prop("disabled",
!0);$(".unit").css("cursor","pointer");$("#positiondial").hide();for(b=0;b<OBSTACLES.length;b++)OBSTACLES[b].g.undrag();for(b=0;b<squadron.length;b++)squadron[b].g.undrag();break;case PLANNING_PHASE:$("#maneuverdial").hide();break;case ACTIVATION_PHASE:$("#actiondial").hide();$("#activationdial").hide();for(b=0;b<squadron.length;b++)squadron[b].hasmoved=!1,squadron[b].actiondone=!1,squadron[b].endactivationphase();var c=[];for(b=0;b<BOMBS.length;b++)c[b]=BOMBS[b];for(b=0;b<c.length;b++)c[b].explode();
break;case COMBAT_PHASE:$("#attackdial").hide();$("#listunits").html("");for(b=0;b<squadron.length;b++)squadron[b].endround();round++}phase=phase==COMBAT_PHASE?PLANNING_PHASE:phase+1;3>phase?$("#phase").html(phasetext[phase]):$("#phase").html("Turn #"+round+" "+phasetext[phase]);$("#combatdial").hide();if(phase>SELECT_PHASE2)for(b=0;b<squadron.length;b++)squadron[b].unselect();for(b=SELECT_PHASE1;b<=COMBAT_PHASE;b++)b!=phase?unbind("phase"+b):bindall("phase"+b);switch(phase){case SELECT_PHASE1:$(".permalink").hide();
$(".activeunit").prop("disabled",!0);$("#rightpanel").hide();break;case SELECT_PHASE2:TEAMS[1].endselection(s);break;case SETUP_PHASE:TEAMS[2].endselection(s);$(".activeunit").prop("disabled",!1);loadrock(s);activeunit=squadron[0];activeunit.select();activeunit.show();jwerty.key("l",allunitlist);jwerty.key("w",inhitrange);jwerty.key("s",function(){activeunit.togglehitsector()});jwerty.key("shift+s",function(){activeunit.togglerange()});jwerty.key("x",function(){window.location="#"});jwerty.key("escape",
nextphase);jwerty.key("c",center);jwerty.key("0",function(){log("active:"+activeunit.name+" wfa:"+waitingforaction.isexecuting+" hasfire:"+activeunit.hasfired+" hasdamaged:"+activeunit.damage+" m:"+activeunit.maneuver+" a:"+activeunit.action+" o"+activeunit.ocollision.overlap+" ad"+activeunit.actiondone)});jwerty.key("1",function(){activeunit.focus++;activeunit.show()});jwerty.key("2",function(){activeunit.evade++;activeunit.show()});jwerty.key("3",function(){activeunit.iscloaked||(activeunit.iscloaked=
!0,activeunit.agility+=2,activeunit.show())});jwerty.key("4",function(){activeunit.stress++;activeunit.show()});log("<div>[turn "+round+"] Setup phase</div>");$(".unit").css("cursor","move");$("#positiondial").show();bindall("select");$(".permalink").show();break;case PLANNING_PHASE:$(".permalink").hide();log("<div>[turn "+round+"] Planning phase</div>");$(".nextphase").prop("disabled",!0);$("#maneuverdial").show();b=activeunit;squadron[0].select();b.unselect();for(b=0;b<squadron.length;b++)squadron[b].beginplanningphase();
break;case ACTIVATION_PHASE:log("<div>[turn "+round+"] Activation phase</div>");$(".nextphase").prop("disabled",!0);$("#activationdial").show();for(b=0;b<squadron.length;b++)squadron[b].beginactivationphase();filltabskill();skillturn=0;log("STARTACTIVATIONPHASE");nextstep();break;case COMBAT_PHASE:log("<div>[turn "+round+"] Combat phase</div>");$("#attackdial").show();skillturn=12;for(b=0;b<squadron.length;b++)squadron[b].begincombatphase();log("STARTCOMBATPHASE");nextstep()}phase>SELECT_PHASE2&&
activeunit.show()}function log(b){$("#log").append("<div>"+b+"<div>");$("footer").scrollTop(1E4)}function permalink(){var b="?"+TEAMS[1].toASCII()+"&"+TEAMS[2].toASCII();document.location.search=b}function resetlink(){document.location.search=""}function record(b,c){}
function select(b){var c;for(c=0;c<squadron.length&&squadron[c].id!=b;c++);b=activeunit;activeunit=squadron[c];activeunit.select();$("#"+b.id).attr({color:"black",background:"white"});$("#"+activeunit.id).attr({color:"white",background:"tomato"});b.unselect()}var a1=[.25,.375];a1[10]=.125;a1[100]=.25;var d1=[.375,.375];d1[10]=.25;
function addattackdice(b,c){var e,f,g,h,l=[];for(e=0;e<b;e++)for(g=0;g<b-e;g++)for(f=0;f<b-g-e;f++)h=100*e+g+10*f,l[h]=0,l[h+1]=0,l[h+10]=0,l[h+100]=0;for(e=0;e<b;e++)for(g=0;g<b-e;g++)for(f=0;f<b-g-e;f++)h=100*e+g+10*f,l[h]+=c[h]*a1[0],l[h+1]+=c[h]*a1[1],l[h+10]+=c[h]*a1[10],l[h+100]+=c[h]*a1[100];return l}
function adddefensedice(b,c){var e,f,g,h=[];for(e=0;e<b;e++)for(f=0;f<b-e;f++)g=10*e+f,h[g]=0,h[g+1]=0,h[g+10]=0;for(e=0;e<b;e++)for(f=0;f<b-e;f++)g=10*e+f,h[g]+=c[g]*d1[0],h[g+1]+=c[g]*d1[1],h[g+10]+=c[g]*d1[10];return h}function attackproba(b){var c,e=[];e[0]=a1[0];e[1]=a1[1];e[10]=a1[10];e[100]=a1[100];for(c=2;c<=b;c++)e=addattackdice(c,e);return e}function defenseproba(b){var c,e=[];e[0]=d1[0];e[1]=d1[1];e[10]=d1[10];for(c=2;c<=b;c++)e=adddefensedice(c,e);return e}
function attackwithreroll(b,c,e){var f,g,h,l,m,n,q,v,u=[];if(0==b.reroll||"undefined"==typeof b.reroll)return c;for(f=0;f<=e;f++)for(g=0;g<=e-f;g++)for(h=0;h<=e-g-f;h++)q=100*f+g+10*h,u[q]=0;var r=0,t;for(f=0;f<=e;f++)for(g=0;g<=e-f;g++)for(h=0;h<=e-g-f;h++)if(q=100*f+g+10*h,l=e-g-h-f,t=b.reroll,r=f,b.reroll>l&&(0==b.focus?b.reroll>f+l?(t=f+l,r=0):r=f-(t-l):t=l),0==t)u[q]+=c[q];else for(l=0;l<=t;l++)for(m=0;m<=t-l;m++)for(n=0;n<=t-l-m;n++)v=100*l+m+10*n,k=100*(r+l)+g+m+10*(h+n),u[k]+=c[q]*ATTACK[t][v];
return u}function defendwithreroll(b,c,e){var f,g,h,l,m,n,q=[];if(0==b.reroll||"undefined"==typeof b.reroll)return c;for(f=0;f<=e;f++)for(g=0;g<=e-f;g++)q[10*f+g]=0;var v=0,u;for(f=0;f<=e;f++)for(g=0;g<=e-f;g++)if(m=10*f+g,h=e-g-f,u=b.reroll,v=f,b.reroll>h&&(0==b.focus?b.reroll>f+h?(u=f+h,v=0):v=f-(u-h):u=h),0==u)q[m]+=c[m];else for(h=0;h<=u;h++)for(l=0;l<=u-h;l++)n=10*h+l,k=10*(v+h)+g+l,q[k]+=c[m]*DEFENSE[u][n];return q}
function tohitproba(b,c,e,f,g,h){var l=[],m=[],n,q,v,u,r,t,x,y=0,z=0,B=0,D=f;f=0==h?[]:f;for(n=0;n<=g;n++)for(q=0;q<=g-n;q++)r=n+10*q,l[r]=0;if("undefined"==typeof e)return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0};e=attackwithreroll(b,e,g);0<h&&(D=defendwithreroll(c,f,h));for(f=0;20>=f;f++)m[f]=0;for(f=0;f<=g;f++)for(n=0;n<=g-f;n++)for(q=0;q<=g-n-f;q++){r=100*f+10*q+n;var E,G,H,F,I=e[100*f+n+10*q];"undefined"!=typeof b.modifyattackroll&&(r=b.modifyattackroll(r,c));E=Math.floor(r/100);G=
Math.floor((r-100*E)/10);H=r-100*E-10*G;for(F=0;F<=h;F++)for(ef=0;ef<=h-F;ef++)r=10*F+ef,"undefined"!=typeof c.modifydefenseroll&&(r=c.modifydefenseroll(r)),u=Math.floor(r/10),x=r-10*u,v=0==h?1:D[r],t=H,r=0,0<c.evade&&(x+=1),0<c.focus&&(x+=u),0<b.focus&&(t+=E),t>x?(r=t-x,x=0):x-=t,G>x&&(r+=10*(G-x)),l[r]+=I*v}for(n=0;n<=g;n++)for(q=0;q<=g-n;q++)switch(r=n+10*q,0<q+n&&(y+=l[r]),z+=n*l[r],B+=q*l[r],q){case 0:for(f=1;f<=q+n;f++)m[f]+=l[r];break;case 1:for(f=1;f<=q+n;f++)m[f]+=26*l[r]/33;for(f=2;f<=q+
n+1;f++)m[f]+=7*l[r]/33;break;default:for(f=1;f<=q+n;f++)m[f]+=26*l[r]/33*25/32;for(f=2;f<=q+n+1;f++)m[f]+=l[r]*(7/33*.8125+7*(1-7/33)/32);for(f=3;f<=q+n+2;f++)m[f]+=7*l[r]/33*6/32}return{proba:l,tohit:Math.floor(1E4*y)/100,meanhit:0==y?0:Math.floor(100*z/y)/100,meancritical:0==y?0:Math.floor(B/y*100)/100,tokill:m}}
function probatable(b,c){var e,f,g="";for(e=0;5>=e;e++){g+="<tr><td>"+e+"</td>";for(f=0;5>=f;f++){var h=f;0<c.adddice&&(h+=c.adddice);h=tohitproba(b,c,ATTACK[e],DEFENSE[h],e,h);g+="<td class='probacell' style='background:hsl("+1.2*(100-h.tohit)+",100%,80%)'>";g+="<div>"+h.tohit+"%</div><div><code class='symbols'>d</code>"+h.meanhit+"</div><div><code class='symbols'>c</code>"+h.meancritical+"</div></td>"}g+="</tr>"}return g}
function fillprobatable(){var b={focus:$("#focusA").prop("checked")?1:0,reroll:$("#targetA").prop("checked")?5:0},c={focus:$("#focusD").prop("checked")?1:0,evade:$("#evadeD").prop("checked")?1:0,adddice:$("#cloakD").prop("checked")?2:0,reroll:0},e;e=parseInt($("#rerollA").val(),10);var f=parseInt($("#rerollD").val(),10);if(0==b.reroll||0<e&&e<b.reroll)b.reroll=e;if(0==c.reroll||0<f&&f<c.reroll)c.reroll=f;b="<tr><th>Rolls</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>"+probatable(b,
c);$("#probatable").html(b)}var dice=1,ATTACK=[],DEFENSE=[],TEAMS=[0,new Team(1),new Team(2)];
$(document).ready(function(){s=Snap("#svgout");P={F0:{path:s.path("M 0 0 L 0 0"),speed:0,key:"5"},F1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"8"},F2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"8"},F3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"8"},F4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"8"},F5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"8"},TR1:{path:s.path("M0 0 C 0 -40 15 -55 55 -55"),speed:1,key:"6"},TR2:{path:s.path("M0 0 C 0 -50 33 -83 83 -83"),speed:2,key:"6"},TR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105"),
speed:3,key:"6"},TL1:{path:s.path("M0 0 C 0 -40 -15 -55 -55 -55"),speed:1,key:"4"},TL2:{path:s.path("M0 0 C 0 -50 -33 -83 -83 -83"),speed:2,key:"4"},TL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105"),speed:3,key:"4"},BR1:{path:s.path("M0 0 C 0 -20 18 -72 38 -92"),speed:1,key:"9"},BR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126"),speed:2,key:"9"},BR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"9"},SR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160"),speed:3,key:"3"},BL1:{path:s.path("M0 0 C 0 -20 -18 -72 -38 -92"),
speed:1,key:"7"},BL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126"),speed:2,key:"7"},BL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"7"},SL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160"),speed:3,key:"1"},K1:{path:s.path("M 0 0 L 0 -80"),speed:1,key:"2"},K2:{path:s.path("M 0 0 L 0 -120"),speed:2,key:"2"},K3:{path:s.path("M 0 0 L 0 -160"),speed:3,key:"2"},K4:{path:s.path("M 0 0 L 0 -200"),speed:4,key:"2"},K5:{path:s.path("M 0 0 L 0 -240"),speed:5,key:"2"}};$.ajax({dataType:"json",url:"data/ships.json",
mimeType:"application/json",success:function(b){var c=setInterval(function(){ATTACK[dice]=attackproba(dice);DEFENSE[dice]=defenseproba(dice);dice++;7==dice&&(fillprobatable(),$("#showproba").prop("disabled",!1),clearInterval(c))},500);unitlist=b;squadron=[];s.attr({width:"100%",height:"100%",viewBox:"0 0 900 900"});TEAMS[1].setfaction("REBEL");TEAMS[2].setfaction("EMPIRE");UPGRADES.sort(function(b,c){return b.name<c.name?-1:b.name>c.name?1:0});PILOTS.sort(function(b,c){return b.points-c.points});
var e=0,f=0,g="";for(b=0;b<PILOTS.length;b++)1==PILOTS[b].done&&(PILOTS[b].unique&&f++,e++),PILOTS[b].done||(g=PILOTS[b].unique?g+", .":g+", ",g+=PILOTS[b].name);log("<b>X-Wings Squadron Benchmark "+VERSION+"</b>");log(e+"/"+PILOTS.length+" pilots with full effect");log("Pilots NOT implemented"+g);e=0;g="";for(b=0;b<UPGRADES.length;b++)1==UPGRADES[b].done?e++:g+=", "+(UPGRADES[b].unique?".":"")+UPGRADES[b].name;log(e+"/"+UPGRADES.length+" upgrades implemented");log("Upgrades NOT implemented"+g);$("#leftpanel").prepend("<div id='importexport1'><button onclick='currentteam=1;window.location=\"#import\"' class='bigbutton'>Import Squadron</button><button class='bigbutton' onclick='$(\"#jsonexport\").val(JSON.stringify(TEAMS[1])); window.location=\"#export\"'>Export Squadron</button></div>");
$("#rightpanel").prepend("<div id='importexport2'><button onclick='currentteam=2;window.location=\"#import\"' class='bigbutton'>Import Squadron</button><button class='bigbutton' onclick='$(\"#jsonexport\").val(JSON.stringify(TEAMS[2])); window.location=\"#export\"'>Export Squadron</button></div>");phase=-1;$("#showproba").prop("disabled",!0);b=window.location.search.substr(1).split("&");nextphase();""!=b[0]&&(log("Loading permalink..."),TEAMS[1].parseASCII(s,b[0]),TEAMS[2].parseASCII(s,b[1]));loadsound()},
fail:function(){}})});var UPGRADE_dict={turret:"Turret",ioncannonturret:"Ion Cannon Turret",blasterturret:"Blaster Turret",autoblasterturret:"Autoblaster Turret",torpedo:"Torpedo",protontorpedoes:"Proton Torpedoes",advancedprotontorpedoes:"Advanced Proton Torpedoes",flechettetorpedoes:"Flechette Torpedoes",iontorpedoes:"Ion Torpedoes",bombloadout:"Bomb Loadout",amd:"Astromech Droid",r2astromech:"R2 Astromech",r2d2:"R2-D2",r2f2:"R2-F2",r5d8:"R5-D8",r5k6:"R5-K6",r5astromech:"R5 Astromech",r7astromech:"R7 Astromech",r7t1:"R7-T1",
r3a2:"R3-A2",r2d6:"R2-D6",r4d6:"R4-D6",r5p9:"R5-P9",ept:"Elite Pilot Talent",determination:"Determination",swarmtactics:"Swarm Tactics",squadleader:"Squad Leader",experthandling:"Expert Handling",marksmanship:"Marksmanship",daredevil:"Daredevil",elusiveness:"Elusiveness",pushthelimit:"Push the Limit",deadeye:"Deadeye",expose:"Expose",veteraninstincts:"Veteran Instincts",drawtheirfire:"Draw Their Fire",adrenalinerush:"Adrenaline Rush",opportunist:"Opportunist",wingman:"Wingman",decoy:"Decoy",outmaneuver:"Outmaneuver",
predator:"Predator",stayontarget:"Stay On Target",lonewolf:"Lone Wolf",ruthlessness:"Ruthlessness",intimidation:"Intimidation",bodyguard:"Bodyguard",missile:"Missile",concussionmissiles:"Concussion Missiles",clustermissiles:"Cluster Missiles",homingmissiles:"Homing Missiles",assaultmissiles:"Assault Missiles",ionpulsemissiles:"Ion Pulse Missiles",chardaanrefit:"Chardaan Refit",protonrockets:"Proton Rockets",crew:"Crew",gunner:"Gunner",mercenarycopilot:"Mercenary Copilot",weaponsengineer:"Weapons Engineer",
lukeskywalker:"Luke Skywalker",niennunb:"Nien Nunb",chewbacca:"Chewbacca",reconspecialist:"Recon Specialist",saboteur:"Saboteur",intelligenceagent:"Intelligence Agent",darthvader:"Darth Vader",rebelcaptive:"Rebel Captive",flightinstructor:"Flight Instructor",navigator:"Navigator",tactician:"Tactician",r2d2:"R2-D2",c3po:"C-3PO",kylekatarn:"Kyle Katarn",janors:"Jan Ors",torynfarr:"Toryn Farr",wed15repairdroid:"WED-15 Repair Droid",carlistrieekan:"Carlist Rieekan",jandodonna:"Jan Dodonna",hansolo:"Han Solo",
leiaorgana:"Leia Organa",targetingcoordinator:"Targeting Coordinator",raymusantilles:"Raymus Antilles",landocalrissian:"Lando Calrissian",marajade:"Mara Jade",fleetofficer:"Fleet Officer",dashrendar:"Dash Rendar",leebo:"'Leebo'",ysanneisard:"Ysanne Isard",moffjerjerrod:"Moff Jerjerrod",greedo:"Greedo",k4securitydroid:"K4 Security Droid",outlawtech:"Outlaw Tech",cannon:"Cannon",manglercannon:"'Mangler' Cannon",ioncannon:"Ion Cannon",heavylasercannon:"Heavy Laser Cannon",autoblaster:"Autoblaster",bomb:"Bomb",
seismiccharges:"Seismic Charges",proximitymines:"Proximity Mines",protonbombs:"Proton Bombs",system:"System",firecontrolsystem:"Fire-Control System",advancedsensors:"Advanced Sensors",sensorjammer:"Sensor Jammer",enhancedscopes:"Enhanced Scopes",accuracycorrector:"Accuracy Corrector",advancedtargetingcomputer:"Advanced Targeting Computer",cargo:"Cargo",commsbooster:"Comms Booster",slicertools:"Slicer Tools",shieldprojector:"Shield Projector",tibannagassupplies:"Tibanna Gas Supplies",ionizationreactor:"Ionization Reactor",
enginebooster:"Engine Booster",expandedcargohold:"Expanded Cargo Hold",backupshieldgenerator:"Backup Shield Generator",ememitter:"EM Emitter",frequencyjammer:"Frequency Jammer",hardpoint:"Hardpoint",singleturbolasers:"Single Turbolasers",quadlasercannons:"Quad Laser Cannons",team:"Team",gunneryteam:"Gunnery Team",sensorteam:"Sensor Team",engineeringteam:"Engineering Team",illicit:"Illicit",inertialdampeners:"Inertial Dampeners",deadmansswitch:"Dead Man's Switch",feedbackarray:"Feedback Array",hotshotblaster:"'Hot Shot' Blaster",
samd:"Salvaged Astromech Droid",salvagedastromech:"Salvaged Astromech",genius:"'Genius'",unhingedastromech:"Unhinged Astromech",r4b11:"R4-B11",r4agromech:"R4 Agromech",mod:"Modification",stealthdevice:"Stealth Device",shieldupgrade:"Shield Upgrade",engineupgrade:"Engine Upgrade",antipursuitlasers:"Anti-Pursuit Lasers",targetingcomputer:"Targeting Computer",hullupgrade:"Hull Upgrade",munitionsfailsafe:"Munitions Failsafe",stygiumparticleaccelerator:"Stygium Particle Accelerator",advancedcloakingdevice:"Advanced Cloaking Device",
combatretrofit:"Combat Retrofit",bwinge2:"B-Wing/E2",countermeasures:"Countermeasures",experimentalinterface:"Experimental Interface",tacticaljammer:"Tactical Jammer",autothrusters:"Autothrusters",title:"Title",slavei:"Slave I",millenniumfalcon:"Millennium Falcon",moldycrow:"Moldy Crow",st321:"ST-321",royalguardtie:"Royal Guard TIE",dodonnaspride:"Dodonna's Pride",awingtestpilot:"A-Wing Test Pilot",tantiveiv:"Tantive IV",brighthope:"Bright Hope",quantumstorm:"Quantum Storm",dutyfree:"Dutyfree",jainaslight:"Jaina's Light",
outrider:"Outrider",dauntless:"Dauntless",virago:"Virago",heavyscykinterceptor:"'Heavy Scyk' Interceptor",ig2000:"IG-2000",btla4ywing:"BTL-A4 Y-Wing",andrasta:"Andrasta",tiex1:"TIE/x1"},PILOT_dict={rebels:"Rebel Alliance",xwing:"X-Wing",wedgeantilles:"Wedge Antilles",garvendreis:"Garven Dreis",redsquadronpilot:"Red Squadron Pilot",rookiepilot:"Rookie Pilot",biggsdarklighter:"Biggs Darklighter",lukeskywalker:"Luke Skywalker",wesjanson:"Wes Janson",jekporkins:"Jek Porkins",hobbieklivian:"'Hobbie' Klivian",
tarnmison:"Tarn Mison",ywing:"Y-Wing",graysquadronpilot:"Gray Squadron Pilot",dutchvander:"'Dutch' Vander",hortonsalm:"Horton Salm",goldsquadronpilot:"Gold Squadron Pilot",awing:"A-Wing",tychocelchu:"Tycho Celchu",arvelcrynyd:"Arvel Crynyd",greensquadronpilot:"Green Squadron Pilot",prototypepilot:"Prototype Pilot",jakefarrell:"Jake Farrell",gemmersojan:"Gemmer Sojan",yt1300:"YT-1300",outerrimsmuggler:"Outer Rim Smuggler",chewbacca:"Chewbacca",landocalrissian:"Lando Calrissian",hansolo:"Han Solo",
bwing:"B-Wing",tennumb:"Ten Numb",ibtisam:"Ibtisam",daggersquadronpilot:"Dagger Squadron Pilot",bluesquadronpilot:"Blue Squadron Pilot",keyanfarlander:"Keyan Farlander",neradantels:"Nera Dantels",hwk290:"HWK-290",rebeloperative:"Rebel Operative",roarkgarnet:"Roark Garnet",kylekatarn:"Kyle Katarn",janors:"Jan Ors",gr75mediumtransport:"GR-75 Medium Transport",gr75mediumtransport:"GR-75 Medium Transport",z95headhunter:"Z-95 Headhunter",banditsquadronpilot:"Bandit Squadron Pilot",talasquadronpilot:"Tala Squadron Pilot",
lieutenantblount:"Lieutenant Blount",airencracken:"Airen Cracken",ewing:"E-Wing",knavesquadronpilot:"Knave Squadron Pilot",blackmoonsquadronpilot:"Blackmoon Squadron Pilot",etahnabaht:"Etahn A'baht",corranhorn:"Corran Horn",cr90corvette:"CR90 Corvette",cr90corvettefore:"CR90 Corvette (Fore)",cr90corvetteaft:"CR90 Corvette (Aft)",yt2400:"YT-2400",wildspacefringer:"Wild Space Fringer",eadenvrill:"Eaden Vrill",leebo:"'Leebo'",dashrendar:"Dash Rendar",empire:"Galactic Empire",tiefighter:"TIE Fighter",
academypilot:"Academy Pilot",obsidiansquadronpilot:"Obsidian Squadron Pilot",blacksquadronpilot:"Black Squadron Pilot",wingedgundark:"'Winged Gundark'",nightbeast:"'Night Beast'",backstabber:"'Backstabber'",darkcurse:"'Dark Curse'",maulermithel:"'Mauler Mithel'",howlrunner:"'Howlrunner'",tieadvanced:"TIE Advanced",maarekstele:"Maarek Stele",tempestsquadronpilot:"Tempest Squadron Pilot",stormsquadronpilot:"Storm Squadron Pilot",darthvader:"Darth Vader",commanderalozen:"Commander Alozen",tieinterceptor:"TIE Interceptor",
alphasquadronpilot:"Alpha Squadron Pilot",avengersquadronpilot:"Avenger Squadron Pilot",sabersquadronpilot:"Saber Squadron Pilot",felswrath:"'Fel's Wrath'",turrphennir:"Turr Phennir",soontirfel:"Soontir Fel",lieutenantlorrir:"Lieutenant Lorrir",royalguardpilot:"Royal Guard Pilot",tetrancowall:"Tetran Cowall",kirkanos:"Kir Kanos",carnorjax:"Carnor Jax",firespray31:"Firespray-31",kathscarlet:"Kath Scarlet",bobafett:"Boba Fett",krassistrelix:"Krassis Trelix",bountyhunter:"Bounty Hunter",tiebomber:"TIE Bomber",
scimitarsquadronpilot:"Scimitar Squadron Pilot",gammasquadronpilot:"Gamma Squadron Pilot",captainjonus:"Captain Jonus",majorrhymer:"Major Rhymer",lambdaclassshuttle:"Lambda-Class Shuttle",captainkagi:"Captain Kagi",coloneljendon:"Colonel Jendon",captainyorr:"Captain Yorr",omicrongrouppilot:"Omicron Group Pilot",tiedefender:"TIE Defender",deltasquadronpilot:"Delta Squadron Pilot",onyxsquadronpilot:"Onyx Squadron Pilot",colonelvessery:"Colonel Vessery",rexlerbrath:"Rexler Brath",tiephantom:"TIE Phantom",
sigmasquadronpilot:"Sigma Squadron Pilot",shadowsquadronpilot:"Shadow Squadron Pilot",echo:"'Echo'",whisper:"'Whisper'",vt49decimator:"VT-49 Decimator",patrolleader:"Patrol Leader",captainoicunn:"Captain Oicunn",commanderkenkirk:"Commander Kenkirk",rearadmiralchiraneau:"Rear Admiral Chiraneau",scum:"Scum and Villainy",starviper:"StarViper",princexizor:"Prince Xizor",guri:"Guri",blacksunvigo:"Black Sun Vigo",blacksunenforcer:"Black Sun Enforcer",m3ainterceptor:"M3-A Interceptor",serissu:"Serissu",
aggressor:"Aggressor",ig88d:"IG-88D",z95headhunter:"Z-95 Headhunter",ndrusuhlak:"N'Dru Suhlak",kaatoleeachos:"Kaa'To Leeachos",blacksunsoldier:"Black Sun Soldier",binayrepirate:"Binayre Pirate",firespray31:"Firespray-31",bobafett:"Boba Fett",kathscarlet:"Kath Scarlet",emonazzameen:"Emon Azzameen",mandalorianmercenary:"Mandalorian Mercenary",ywing:"Y-Wing",kavil:"Kavil",drearenthal:"Drea Renthal",syndicatethug:"Syndicate Thug",hwk290:"HWK-290",dacebonearm:"Dace Bonearm",palobgodalhi:"Palob Godalhi",
torkilmux:"Torkil Mux"};PILOT_translation={english:{"Wedge Antilles":"When attacking, reduce the defender's agility value by 1 (to a minimum of 0).","Garven Dreis":"After spending a focus token, you may place that token on any other friendly ship at Range 1-2 (instead of discarding it).","Biggs Darklighter":"Other friendly ships at Range 1 cannot be targeted by attacks if the attacker could target you instead.","Luke Skywalker":"When defending, you may change 1 of your <code class='symbols'>f</code> results to a <code class='symbols'>e</code> result.",
"'Dutch' Vander":"After acquiring a target lock, choose another friendly ship at Range 1-2.  The chosen ship may immediately acquire a target lock.","Horton Salm":"When attacking at Range 2-3, you may reroll any of your blank results.","'Winged Gundark'":"When attacking at Range 1, you may change 1 of your <code class='hit'></code> results to a <code class='critical'></code> result.","'Night Beast'":"After executing a green maneuver, you may perform a free focus action.","'Backstabber'":"When attacking from outside the defender's firing arc, roll 1 additional attack die.",
"'Dark Curse'":"When defending, ships attacking you cannot spend focus tokens or reroll attack dice.","'Mauler Mithel'":"When attacking at Range 1, roll 1 additional attack die.","'Howlrunner'":"When another friendly ship at Range 1 is attacking with its primary weapon, it may reroll 1 attack die.","Maarek Stele":"When your attack deals a faceup Damage card to the defender, instead draw 3 Damage cards, choose 1 to deal, and discard the others.","Darth Vader":"During your 'Perform Action' step, you may perform 2 actions.",
"'Fel's Wrath'":"When the number of Damage cards assigned to you equals or exceeds your hull value, you are not destroyed until the end of the Combat phase.","Turr Phennir":"After you perform an attack, you may perform a free boost or barrel roll action.","Soontir Fel":"When you receive a stress token, you may assign 1 focus token to your ship.","Tycho Celchu":"You may perform actions even while you have stress tokens.","Arvel Crynyd":"You may declare an enemy ship inside your firing arc that you are touching as the target of your attack.",
Chewbacca:"When you are dealt a faceup Damage card, immediately flip it facedown (without resolving its ability).","Lando Calrissian":"After you execute a green maneuver, choose 1 other friendly ship at Range 1.  That ship may perform 1 free action shown on its action bar.","Han Solo":"When attacking, you may reroll all of your dice.  If you choose to do so, you must reroll as many of your dice as possible.","Kath Scarlet":"When attacking, the defender receives 1 stress token if he cancels at least 1 <code class='critical'></code> result.",
"Boba Fett":"When you reveal a bank maneuver (<code class='symbols'>7</code> or <code class='symbols'>9</code>), you may rotate your dial to the other bank maneuver of the same speed.","Krassis Trelix":"When attacking with a secondary weapon, you may reroll 1 attack die.","Ten Numb":"When attacking, 1 of your <code class='critical'></code> results cannot be canceled by defense dice.",Ibtisam:"When attacking or defending, if you have at least 1 stress token, you may reroll 1 of your dice.","Roark Garnet":"At the start of the Combat phase, choose 1 other friendly ship at Range 1-3.  Until the end of the phase, treat that ship's pilot skill value as 12.",
"Kyle Katarn":"At the start of the Combat phase, you may assign 1 of your focus tokens to another friendly ship at Range 1-3.","Jan Ors":"When another friendly ship at Range 1-3 is attacking, if you have no stress tokens, you may receive 1 stress token to allow that ship to roll 1 additional attack die.","Captain Jonus":"When another friendly ship at Range 1 attacks with a secondary weapon, it may reroll up to 2 attack dice.","Major Rhymer":"When attacking with a secondary weapon, you may increase or decrease the weapon range by 1 to a limit of Range 1-3.",
"Captain Kagi":"When an enemy ship acquires a target lock, it must lock onto your ship if able.","Colonel Jendon":"At the start of the Combat phase, you may assign 1 of your blue target lock tokens to a friendly ship at Range 1 if it does not have a blue target lock token.","Captain Yorr":"When another friendly ship at Range 1-2 would receive a stress token, if you have 2 or fewer stress tokens, you may receive that token instead.","Lieutenant Lorrir":"When performing a barrel roll action, you may receive 1 stress token to use the (<code class='symbols'>7</code> 1) or (<code class='symbols'>9</code> 1) template instead of the (<code class='symbols'>5</code> 1) template.",
"Tetran Cowall":"When you reveal a <code class='symbols'>2</code> maneuver, you may treat the speed of that maneuver as 1, 3, or 5.","Kir Kanos":"When attacking at Range 2-3, you may spend 1 evade token to add 1 <code class='hit'></code> result to your roll.","Carnor Jax":"Enemy ships at Range 1 cannot perform focus or evade actions and cannot spend focus or evade tokens.","Lieutenant Blount":"When attacking, the defender is hit by your attack, even if he does not suffer any damage.","Airen Cracken":"After you perform an attack, you may choose another friendly ship at Range 1.  That ship may perform 1 free action.",
"Colonel Vessery":"When attacking, immediately after you roll attack dice, you may acquire a target lock on the defender if it already has a red target lock token.","Rexler Brath":"After you perform an attack that deals at least 1 Damage card to the defender, you may spend a focus token to flip those cards faceup.","Etahn A'baht":"When an enemy ship inside your firing arc at Range 1-3 is defending, the attacker may change 1 of its <code class='hit'></code> results to a <code class='critical'></code> result.",
"Corran Horn":"At the start of the End phase, you may perform one attack.  You cannot attack during the next round.","'Echo'":"When you decloak, you must use the (<code class='symbols'>7</code>2) or (<code class='symbols'>9</code>2) template instead of the (<code class='symbols'>8</code>2) template.","'Whisper'":"After you perform an attack that hits, you may assign 1 focus to your ship.","Wes Janson":"After you perform an attack, you may remove 1 focus, evade, or blue target lock token from the defender.",
"Jek Porkins":"When you receive a stress token, you may remove it and roll 1 attack die.  On a <code class='hit'></code> result, deal 1 facedown Damage card to this ship.","'Hobbie' Klivian":"When you acquire or spend a target lock, you may remove 1 stress token from your ship.","Tarn Mison":"When an enemy ship declares you as the target of an attack, you may acquire a target lock on that ship.","Jake Farrell":"After you perform a focus action or are assigned a focus token, you may perform a free boost or barrel roll action.",
"Gemmer Sojan":"While you are at Range 1 of at least 1 enemy ship, increase your agility value by 1.","Keyan Farlander":"When attacking, you may remove 1 stress token to change all of your <code class='symbols'>f</code> results to <code class='hit'></code>results.","Nera Dantels":"You can perform <code class='symbols'>P</code> secondary weapon attacks against enemy ships outside your firing arc.","CR90 Corvette (Fore)":"When attacking with your primary weapon, you may spend 1 energy to roll 1 additional attack die.",
"CR90 Corvette (Crippled Aft)":"You cannot choose or execute (<code class='symbols'>5</code> 4), (<code class='symbols'>7</code> 2), or (<code class='symbols'>9</code> 2) maneuvers.","Dash Rendar":"You may ignore obstacles during the Activation phase and when performing actions.","'Leebo'":"When you are dealt a faceup Damage card, draw 1 additional Damage card, choose 1 to resolve, and discard the other.","Eaden Vrill":"When performing a primary weapon attack against a stressed ship, roll 1 additional attack die.",
"Rear Admiral Chiraneau":"When attacking at Range 1-2, you may change 1 of your <code class='symbols'>f</code> results to a <code class='critical'></code> result.","Commander Kenkirk":"If you have no shields and at least 1 Damage card assigned to you, increase your agility value by 1.","Captain Oicunn":"After executing a maneuver, each enemy ship you are touching suffers 1 damage.","Prince Xizor (Scum)":"When defending, a friendly ship at Range 1 may suffer 1 uncanceled <code class='hit'></code> or <code class='critical'></code> result instead of you.",
"Guri (Scum)":"At the start of the Combat phase, if you are at Range 1 of an enemy ship, you may assign 1 focus token to your ship.","Serissu (Scum)":"When another friendly ship at Range 1 is defending, it may reroll 1 defense die.","Laetin A'shera (Scum)":"After you defend against an attack, if the attack did not hit, you may assign 1 evade token to your ship.","IG-88A (Scum)":"After you perform an attack that destroys the defender, you may recover 1 shield.","IG-88B (Scum)":"Once per round, after you perform an attack that does not hit, you may perform an attack with an equipped <code class='symbols'>C</code> secondary weapon.",
"IG-88C (Scum)":"After you perform a boost action, you may perform a free evade action.","IG-88D (Scum)":"You may execute the (<code class='symbols'>1</code>3) or (<code class='symbols'>3</code>3) maneuver using the corresponding (<code class='symbols'>4</code>3) or (<code class='symbols'>6</code>3) template.","Boba Fett (Scum)":"When attacking or defending, you may reroll 1 of your dice for each enemy ship at Range 1.","Kath Scarlet (Scum)":"When attacking a ship inside your auxiliary firing arc, roll 1 additional attack die.",
"Emon Azzameen (Scum)":"When dropping a bomb, you may use the [<code class='symbols'>4</code> 3], [<code class='symbols'>5</code> 3], or [<code class='symbols'>6</code> 3] template instead of the [<code class='symbols'>5</code> 1] template.","Kavil (Scum)":"When attacking a ship outside your firing arc, roll 1 additional attack die.","Drea Renthal (Scum)":"After you spend a target lock, you may receive 1 stress token to acquire a target lock.","Dace Bonearm (Scum)":"When an enemy ship at Range 1-3 receives at least 1 ion token, if you are not stressed, you may receive 1 stress token to cause that ship to suffer 1 damage.",
"Palob Godalhi (Scum)":"At the start of the Combat phase, you may remove 1 focus or evade token from an enemy ship at Range 1-2 and assign it to yourself.","Torkil Mux (Scum)":"At the end of the Activation phase, choose 1 enemy ship at Range 1-2. Until the end of the Combat phase, treat that ship's pilot skill value as 0.","N'Dru Suhlak (Scum)":"When attacking, if there are no other friendly ships at Range 1-2, roll 1 additional attack die.","Kaa'To Leeachos (Scum)":"At the start of the Combat phase, you may remove 1 focus or evade token from another friendly ship at Range 1-2 and assign it to yourself.",
"Commander Alozen":"At the start of the Combat phase, you may acquire a target lock on an enemy ship at Range 1."}};
var UPGRADE_translation={english:{"Ion Cannon Turret":"<strong>Attack:</strong> Attack 1 ship (even a ship outside your firing arc). If this attack hits the target ship, the ship suffers 1 damage and receives 1 ion token.  Then cancel all dice results.","Proton Torpedoes":"<strong>Attack (target lock):</strong> Spend your target lock and discard this card to perform this attack. You may change 1 of your <code class='symbols'>f</code> results to a <code class='critical'></code> result.","R2 Astromech":"You may treat all 1- and 2-speed maneuvers as green maneuvers.",
"R2-D2":"After executing a green maneuver, you may recover 1 shield (up to your shield value).","R2-F2":"<strong>Action:</strong> Increase your agility value by 1 until the end of this game round.","R5-D8":"<strong>Action:</strong> Roll 1 defense die. On a <code class='symbols'>e</code> or <code class='symbols'>f</code> result, discard 1 of your facedown Damage cards.","R5-K6":"After spending your target lock, roll 1 defense die. On a <code class='symbols'>e</code> result, immediately acquire a target lock on that same ship.  You cannot spend this target lock during this attack.",
"R5 Astromech":"During the End phase, you may choose 1 of your faceup Damage cards with the Ship trait and flip it facedown.",Determination:"When you are dealt a faceup Damage card with the Pilot trait, discard it immediately without resolving its effect.","Swarm Tactics":"At the start of the Combat phase, you may choose 1 friendly ship at Range 1. Until the end of this phase, treat the chosen ship as if its pilot skill were equal to your pilot skill.","Squad Leader":"<strong>Action:</strong> Choose 1 ship at Range 1-2 that has a lower pilot skill than you. The chosen ship may immediately perform 1 free action.",
"Expert Handling":"<strong>Action:</strong> Perform a free barrel roll action.  If you do not have the <code class='symbols'>r</code> action icon, receive 1 stress token. You may then remove 1 enemy target lock from your ship.",Marksmanship:"<strong>Action:</strong> When attacking this round, you may change 1 of your <code class='symbols'>f</code> results to a <code class='critical'></code> result and all of your other <code class='symbols'>f</code> results to <code class='hit'></code> results.",
"Concussion Missiles":"<strong>Attack (target lock):</strong>  Spend your target lock and discard this card to perform this attack. You may change 1 of your blank results to a <code class='hit'></code> result.","Cluster Missiles":"<strong>Attack (target lock):</strong> Spend your target lock and discard this card to perform this attack twice.",Daredevil:"<strong>Action:</strong> Execute a white (<code class='symbols'>4</code> 1) or (<code class='symbols'>6</code> 1) maneuver.  Then, receive 1 stress token. Then, if you do not have the <code class='symbols'>b</code> action icon, roll 2 attack dice.  Suffer any damage (<code class='hit'></code>) and any critical damage (<code class='critical'></code>) rolled.",
Elusiveness:"When defending, you may receive 1 stress token to choose 1 attack die.  The attacker must reroll that die. If you have at least 1 stress token, you cannot use this ability.","Homing Missiles":"<strong>Attack (target lock):</strong> Discard this card to perform this attack. The defender cannot spend evade tokens during this attack.","Push the Limit":"Once per round, after you perform an action, you may perform 1 free action shown in your action bar. Then receive 1 stress token.",Deadeye:"You may treat the <strong>Attack (target lock):</strong> header as <strong>Attack (focus):</strong>. When an attack instructs you to spend a target lock, you may spend a focus token instead.",
Expose:"<strong>Action:</strong> Until the end of the round, increase your primary weapon value by 1 and decrease your agility value by 1.","Gunner(Crew)":"After you perform an attack that does not hit, you may immediately perform a primary weapon attack.  You cannot perform another attack this round.","Ion Cannon":"<strong>Attack:</strong> Attack 1 ship. If this attack hits, the defender suffers 1 damage and receives 1 ion token.  Then cancel all dice results.","Heavy Laser Cannon":"<strong>Attack:</strong> Attack 1 ship. Immediately after rolling your attack dice, you must change all of your <code class='critical'></code> results to <code class='hit'></code> results.",
"Seismic Charges":"When you reveal your maneuver dial, you may discard this card to drop 1 seismic charge token. This token detonates at the end of the Activation phase. <strong>Seismic Charge Token:</strong> When this bomb token detonates, each ship at Range 1 of the token suffers 1 damage.  Then discard this token.","Mercenary Copilot(Crew)":"When attacking at Range 3, you may change 1 of your <code class='hit'></code> results to a <code class='critical'></code> result.","Assault Missiles":"<strong>Attack (target lock):</strong> Spend your target lock and discard this card to perform this attack. If this attack hits, each other ship at Range 1 of the defender suffers 1 damage.",
"Veteran Instincts":"Increase your pilot skill value by 2.","Proximity Mines":"<strong>Action:</strong> Discard this card to <strong>drop</strong> 1 proximity mine token. When a ship's base or maneuver template overlaps this token, this token <strong>detonates</strong>. <strong>Proximity Mine Token:</strong> When this bomb token detonates, the ship that moved through or overlapped this token rolls 3 attack dice and suffers all damage (<code class='hit'></code>) and critical damage (<code class='critical'></code>) rolled.  Then discard this token.",
"Weapons Engineer(Crew)":"You may maintain 2 target locks (only 1 per enemy ship). When you acquire a target lock, you may lock onto 2 different ships.","Draw Their Fire":"When a friendly ship at Range 1 is hit by an attack, you may suffer 1 of the uncanceled <code class='critical'></code> results instead of the target ship.","Luke Skywalker(Crew)":"After you perform an attack that does not hit, you may immediately perform a primary weapon attack.  You may change 1 <code class='symbols'>f</code> result to a <code class='hit'></code> result.  You cannot perform another attack this round.",
"Nien Nunb(Crew)":"You may treat all <code class='symbols'>8</code> maneuvers as green maneuvers.","Chewbacca(Crew)":"When you are dealt a Damage card, you may immediately discard that card and recover 1 shield. Then, discard this Upgrade card.","Advanced Proton Torpedoes":"<strong>Attack (target lock):</strong> Spend your target lock and discard this card to perform this attack. You may change up to 3 of your blank results to <code class='symbols'>f</code> results.",Autoblaster:"<strong>Attack:</strong> Attack 1 ship. Your <code class='hit'></code> results cannot be canceled by defense dice. The defender may cancel <code class='critical'></code> results before <code class='hit'></code> results.",
"Fire-Control System":"After you perform an attack, you may acquire a target lock on the defender.","Blaster Turret":"<strong>Attack (focus):</strong> Spend 1 focus token to perform this attack against 1 ship (even a ship outside your firing arc).","Recon Specialist(Crew)":"When you perform a focus action, assign 1 additional focus token to your ship.","Saboteur(Crew)":"<strong>Action:</strong> Choose 1 enemy ship at Range 1 and roll 1 attack die.  On a <code class='hit'></code> or <code class='critical'></code> result, choose 1 random facedown Damage card assigned to that ship, flip it faceup, and resolve it.",
"Intelligence Agent(Crew)":"At the start of the Activation phase, choose 1 enemy ship at Range 1-2.  You may look at that ship's chosen maneuver.","Proton Bombs":"When you reveal your maneuver dial, you may discard this card to <strong>drop</strong> 1 proton bomb token. This token <strong>detonates</strong> at the end of the Activation phase. <strong>Proton Bomb Token:</strong> When this bomb token detonates, deal 1 <strong>faceup</strong> Damage card to each ship at Range 1 of the token.  Then discard this token.",
"Adrenaline Rush":"When you reveal a red maneuver, you may discard this card to treat that maneuver as a white maneuver until the end of the Activation phase.","Advanced Sensors":"Immediately before you reveal your maneuver, you may perform 1 free action. If you use this ability, you must skip your 'Perform Action' step during this round.","Sensor Jammer":"When defending, you may change 1 of the attacker's <code class='hit'></code> results into a <code class='symbols'>f</code> result. The attacker cannot reroll the die with the changed result.",
"Darth Vader(Crew)":"After you perform an attack against an enemy ship, you may suffer 2 damage to cause that ship to suffer 1 critical damage.","Rebel Captive(Crew)":"Once per round, the first ship that declares you as the target of an attack immediately receives 1 stress token.","Flight Instructor(Crew)":"When defending, you may reroll 1 of your <code class='symbols'>f</code> results.  If the attacker's pilot skill value is '2' or lower, you may reroll 1 of your blank results instead.","Navigator(Crew)":"When you reveal a maneuver, you may rotate your dial to another maneuver with the same bearing. You cannot rotate to a red maneuver if you have any stress tokens.",
Opportunist:"When attacking, if the defender does not have any focus or evade tokens, you may receive 1 stress token to roll 1 additional attack die. You cannot use this ability if you have any stress tokens.","Comms Booster":"<strong>Energy:</strong> Spend 1 energy to remove all stress tokens from a friendly ship at Range 1-3.  Then assign 1 focus token to that ship.","Slicer Tools":"<strong>Action:</strong> Choose 1 or more ships at Range 1-3 that have a stress token.  For each ship chosen, you may spend 1 energy to cause that ship to suffer 1 damage.",
"Shield Projector":"When an enemy ship is declaring either a small or large ship as the target of its attack, you may spend 3 energy to force that ship to target you if possible.","Ion Pulse Missiles":"<strong>Attack (target lock):</strong> Discard this card to perform this attack. If this attack hits, the defender suffers 1 damage and receives 2 ion tokens.  Then cancel <strong>all</strong> dice results.",Wingman:"At the start of the Combat phase, remove 1 stress token from another friendly ship at Range 1.",
Decoy:"At the start of the Combat phase, you may choose 1 friendly ship at Range 1-2.  Exchange your pilot skill with that ship's pilot skill until the end of the phase.",Outmaneuver:"When attacking a ship inside your firing arc, if you are not inside that ship's firing arc, reduce its agility value by 1 (to a minimum of 0).",Predator:"When attacking, you may reroll 1 attack die.  If the defender's pilot skill value is '2' or lower, you may instead reroll up to 2 attack dice.","Flechette Torpedoes":"<strong>Attack (target lock):</strong> Discard this card and spend your target lock to perform this attack. After you perform this attack, the defender receives 1 stress token if its hull value is '4' or lower.",
"R7 Astromech":"Once per round when defending, if you have a target lock on the attacker, you may spend the target lock to choose any or all attack dice.  The attacker must reroll the chosen dice.","R7-T1":"<strong>Action:</strong> Choose an enemy ship at Range 1-2.  If you are inside that ship's firing arc, you may acquire a target lock on that ship.  Then, you may perform a free boost action.","Tactician(Crew)":"After you perform an attack against a ship inside your firing arc at Range 2, that ship receives 1 stress token.",
"R2-D2(Crew)":"At the end of the End phase, if you have no shields, you may recover 1 shield and roll 1 attack die.  On a <code class='hit'></code> result, randomly flip 1 of your facedown Damage cards faceup and resolve it.","C-3PO(Crew)":"Once per round, before you roll 1 or more defense dice, you may guess aloud a number of <code class='symbols'>e</code> results.  If you roll that many <code class='symbols'>e</code> results (before modifying dice), add 1 <code class='symbols'>e</code> result.",
"Single Turbolasers":"<strong>Attack (Energy):</strong> Spend 2 energy from this card to perform this attack.  The defender doubles his agility value against this attack.  You may change 1 of your <code class='symbols'>f</code> results to a <code class='hit'></code> result.","Quad Laser Cannons":"<strong>Attack (Energy):</strong> Spend 1 energy from this card to perform this attack.  If this attack does not hit, you may immediately spend 1 energy from this card to perform this attack again.","Tibanna Gas Supplies":"<strong>Energy:</strong> You may discard this card to gain 3 energy.",
"Ionization Reactor":"<strong>Energy:</strong> Spend 5 energy from this card and discard this card to cause each other ship at Range 1 to suffer 1 damage and receive 1 ion token.","Engine Booster":"Immediately before you reveal your maneuver dial, you may spend 1 energy to execute a white (<code class='symbols'>5</code> 1) maneuver.  You cannot use this ability if you would overlap another ship.","R3-A2":"When you declare the target of your attack, if the defender is inside your firing arc, you may receive 1 stress token to cause the defender to receive 1 stress token.",
"R2-D6":"Your upgrade bar gains the <code class='symbols'>E</code> upgrade icon. You cannot equip this upgrade if you already have a <code class='symbols'>E</code> upgrade icon or if your pilot skill value is '2' or lower.","Enhanced Scopes":"During the Activation phase, treat your pilot skill value as 0.","Chardaan Refit":"This card has a negative squad point cost.","Proton Rockets":"<strong>Attack (Focus):</strong> Discard this card to perform this attack. You may roll additional attack dice equal to your agility value, to a maximum of 3 additional dice.",
"Kyle Katarn(Crew)":"After you remove a stress token from your ship, you may assign a focus token to your ship.","Jan Ors(Crew)":"Once per round, when a friendly ship at Range 1-3 performs a focus action or would be assigned a focus token, you may assign it an evade token instead.","Toryn Farr(Crew)":"<strong>Action:</strong> Spend any amount of energy to choose that many enemy ships at Range 1-2.  Remove all focus, evade, and blue target lock tokens from those ships.","R4-D6":"When you are hit by an attack and there are at least 3 uncanceled <code class='hit'></code> results, you may choose to cancel those results until there are 2 remaining.  For each result canceled this way, receive 1 stress token.",
"R5-P9":"At the end of the Combat phase, you may spend 1 of your focus tokens to recover 1 shield (up to your shield value).","WED-15 Repair Droid(Crew)":"<strong>Action:</strong> Spend 1 energy to discard 1 of your facedown Damage cards, or spend 3 energy to discard 1 of your faceup Damage cards.","Carlist Rieekan(Crew)":"At the start of the Activation phase, you may discard this card to treat each friendly ship's pilot skill value as 12 until the end of the phase.","Jan Dodonna(Crew)":"When another friendly ship at Range 1 is attacking, it may change 1 of its <code class='hit'></code> results to a <code class='critical'></code>.",
"Expanded Cargo Hold":"Once per round, when you would be dealt a faceup Damage card, you may draw that card from either the fore or aft Damage deck.","Backup Shield Generator":"At the end of each round, you may spend 1 energy to recover 1 shield (up to your shield value).","EM Emitter":"When you obstruct an attack, the defender rolls 3 additional defense dice (instead of 1).","Frequency Jammer":"When you perform a jam action, choose 1 enemy ship that does not have a stress token and is at Range 1 of the jammed ship.  The chosen ship receives 1 stress token.",
"Han Solo(Crew)":"When attacking, if you have a target lock on the defender, you may spend that target lock to change all of your <code class='symbols'>f</code> results to <code class='hit'></code> results.","Leia Organa(Crew)":"At the start of the Activation phase, you may discard this card to allow all friendly ships that reveal a red maneuver to treat that maneuver as a white maneuver until the end of the phase.","Targeting Coordinator(Crew)":"<strong>Energy:</strong> You may spend 1 energy to choose 1 friendly ship at Range 1-2.  Acquire a target lock, then assign the blue target lock token to the chosen ship.",
"Raymus Antilles(Crew)":"At the start of the Activation phase, choose 1 enemy ship at Range 1-3.  You may look at that ship's chosen maneuver.  If the maneuver is white, assign that ship 1 stress token.","Gunnery Team":"Once per round, when attacking with a secondary weapon, you may spend 1 energy to change 1 of your blank results to a <code class='hit'></code> result.","Sensor Team":"When acquiring a target lock, you may lock onto an enemy ship at Range 1-5 instead of 1-3.","Engineering Team":"During the Activation phase, when you reveal a <code class='symbols'>5</code> maneuver, gain 1 additional energy during the 'Gain Energy' step.",
"Lando Calrissian(Crew)":"<strong>Action:</strong> Roll 2 defense dice.  For each <code class='symbols'>f</code> result, assign 1 focus token to your ship.  For each <code class='symbols'>e</code> result, assign 1 evade token to your ship.","Mara Jade(Crew)":"At the end of the Combat phase, each enemy ship at Range 1 that does not have a stress token receives 1 stress token.","Fleet Officer(Crew)":"<strong>Action:</strong> Choose up to 2 friendly ships at Range 1-2 and assign 1 focus token to each of those ships.  Then receive 1 stress token.",
"Lone Wolf":"When attacking or defending, if there are no other friendly ships at Range 1-2, you may reroll 1 of your blank results.","Stay On Target":"When you reveal a maneuver, you may rotate your dial to another maneuver with the same speed. Treat that maneuver as a red maneuver.","Dash Rendar(Crew)":"You may perform attacks while overlapping an obstacle. Your attacks cannot be obstructed.","'Leebo'(Crew)":"<strong>Action:</strong> Perform a free boost action.  Then receive 1 ion token.",Ruthlessness:"After you perform an attack that hits, you <strong>must</strong> choose 1 other ship at Range 1 of the defender (other than yourself).  That ship suffers 1 damage.",
Intimidation:"While you are touching an enemy ship, reduce that ship's agility value by 1.","Ysanne Isard(Crew)":"At the start of the Combat phase, if you have no shields and at least 1 Damage card assigned to your ship, you may perform a free evade action.","Moff Jerjerrod(Crew)":"When you are dealt a faceup Damage card, you may discard this Upgrade card or another <code class='symbols'>C</code> Upgrade card to flip that Damage card facedown (without resolving its effect).","Ion Torpedoes":"<strong>Attack (target lock):</strong> Spend your target lock and discard this card to perform this attack. If this attack hits, the defender and each ship at Range 1 of it receives 1 ion token.",
Bodyguard:"At the start of the Combat phase, you may spend a focus token to choose a friendly ship at Range 1 with higher pilot skill than you. Increase its agility value by 1 until the end of the round.",Calculation:"When attacking, you may spend a focus token to change 1 of your <code class='symbols'>f</code> results to a <code class='critical'></code> result.","Accuracy Corrector":"When attacking, you may cancel all of your dice results. Then, you may add 2 <code class='hit'></code> results. Your dice cannot be modified again during this attack.",
"Inertial Dampeners":"When you reveal your maneuver, you may discard this card to instead perform a white [0<code class='symbols'>5</code>] maneuver. Then receive 1 stress token.","Flechette Cannon":"<strong>Attack:</strong> Attack 1 ship. If this attack hits, the defender suffers 1 damage and, if the defender is not stressed, it also receives 1 stress token.  Then cancel <strong>all</strong> dice results.","'Mangler' Cannon":"<strong>Attack:</strong> Attack 1 ship. When attacking, you may change 1 of your <code class='hit'></code> results to a <code class='critical'></code> result.",
"Dead Man's Switch":"When you are destroyed, each ship at Range 1 suffers 1 damage.","Feedback Array":"During the Combat phase, instead of performing any attacks, you may receive 1 ion token and suffer 1 damage to choose 1 enemy ship at Range 1.  That ship suffers 1 damage.","'Hot Shot' Blaster":"<strong>Attack:</strong> Discard this card to attack 1 ship (even a ship outside your firing arc).","Greedo(Crew)":"The first time you attack each round and the first time you defend each round, the first Damage card dealt is dealt faceup.",
"Salvaged Astromech":"When you are dealt a Damage card with the <strong>Ship</strong> trait, you may immediately discard that card (before resolving its effect). Then, discard this Upgrade card.","Bomb Loadout":"Your upgrade bar gains the <code class='symbols'>B</code> icon.","'Genius'":"If you are equipped with a bomb that can be dropped before you reveal your maneuver, you may drop the bomb <strong>after</strong> you execute your maneuver instead.","Unhinged Astromech":"You may treat all 3-speed maneuvers as green maneuvers.",
"R4-B11":"When attacking, if you have a target lock on the defender, you may spend the target lock to choose any or all defense dice. The defender must reroll the chosen dice.","Autoblaster Turret":"<strong>Attack:</strong> Attack 1 ship (even a ship outside your firing arc). Your <code class='hit'></code> results cannot be canceled by defense dice. The defender may cancel <code class='critical'></code> results before <code class='hit'></code> results.","R4 Agromech":"When attacking, after you spend a focus token, you may acquire a target lock on the defender.",
"K4 Security Droid(Crew)":"After executing a green maneuver, you may acquire a target lock.","Outlaw Tech(Crew)":"After you execute a red maneuver, you may assign 1 focus token to your ship.","Advanced Targeting Computer":"When attacking with your primary weapon, if you have a target lock on the defender, you may add 1 <code class='critical'></code> result to your roll.  If you do, you cannot spend target locks during this attack.","Ion Cannon Battery":"<strong>Attack (energy):</strong> Spend 2 energy from this card to perform this attack.  If this attack hits, the defender suffers 1 critical damage and receives 1 ion token.  Then cancel <strong>all</strong> dice results.",
"Stealth Device":"Increase your agility value by 1.  If you are hit by an attack, discard this card.","Shield Upgrade":"Increase your shield value by 1.","Engine Upgrade":"Your action bar gains the <code class='symbols'>b</code> action icon.","Anti-Pursuit Lasers":"After an enemy ship executes a maneuver that causes it to overlap your ship, roll 1 attack die.  On a <code class='hit'></code> or <code class='critical'></code> result, the enemy ship suffers 1 damage.","Targeting Computer":"Your action bar gains the <code class='symbols'>l</code> action icon.",
"Hull Upgrade":"Increase your hull value by 1.","Munitions Failsafe":"When attacking with a secondary weapon that instructs you to discard it to perform the attack, do not discard it unless the attack hits.","Stygium Particle Accelerator":"When you either decloak or perform a cloak action, you may perform a free evade action.","Advanced Cloaking Device":"After you perform an attack, you may perform a free cloak action.","Combat Retrofit":"Increase your hull value by 2 and your shield value by 1.",
"B-Wing/E2":"Your upgrade bar gains the <code class='symbols'>W</code> upgrade icon.",Countermeasures:"At the start of the Combat phase, you may discard this card to increase your agility value by 1 until the end of the round.  Then you may remove 1 enemy target lock from your ship.","Experimental Interface":"Once per round, after you perform an action, you may perform 1 free action from an equipped Upgrade card with the '<strong>Action:</strong>' header.  Then receive 1 stress token.","Tactical Jammer":"Your ship can obstruct enemy attacks.",
Autothrusters:"When defending, if you are beyond Range 2 or outside the attacker's firing arc, you may change 1 of your blank results to a <code class='symbols'>e</code> result. You can equip this card only if you have the <code class='symbols'>b</code> action icon.","Slave I":"Your upgrade bar gains the <code class='symbols'>P</code> upgrade icon.","Millennium Falcon":"Your action bar gains the <code class='symbols'>e</code> action icon.","Moldy Crow":"During the End phase, do not remove unused focus tokens from your ship.",
"ST-321":"When acquiring a target lock, you may lock onto any enemy ship in the play area.","Royal Guard TIE":"You may equip up to 2 different Modification upgrades (instead of 1). You cannot equip this card if your pilot skill value is '4' or lower.","Dodonna's Pride":"When you perform a coordinate action, you may choose 2 friendly ships (instead of 1).  Those ships may each perform 1 free action.","A-Wing Test Pilot":"Your upgrade bar gains 1 <code class='symbols'>E</code> upgrade icon. You cannot equip 2 of the same <code class='symbols'>E</code> Upgrade cards.  You cannot equip this if your pilot skill value is 1 or lower.",
"Tantive IV":"Your fore section upgrade bar gains 1 additional <code class='symbols'>E</code> and 1 additional %TEAM% upgrade icon.","Bright Hope":"A reinforce action assigned to your fore section adds 2 <code class='symbols'>e</code> results (instead of 1).","Quantum Storm":"At the start of the End phase, if you have 1 or fewer energy tokens, gain 1 energy token.",Dutyfree:"When performing a jam action, you may choose an enemy ship at Range 1-3 (instead of at Range 1-2).","Jaina's Light":"When defending, once per attack, if you are dealt a faceup Damage card, you may discard it and draw another faceup Damage card.",
Outrider:"While you have a <code class='symbols'>C</code> Upgrade card equipped, you <strong>cannot</strong> perform primary weapon attacks and you may perform <code class='symbols'>C</code> secondary weapon attacks against ships outside your firing arc.",Dauntless:"After you execute a maneuver that causes you to overlap another ship, you may perform 1 free action.  Then receive 1 stress token.",Virago:"Your upgrade bar gains the <code class='symbols'>S</code> and <code class='symbols'>I</code> upgrade icons. You cannot equip this card if your pilot skill value is '3' or lower.",
"'Heavy Scyk' Interceptor":"Your upgrade bar gains the <code class='symbols'>C</code>, <code class='symbols'>P</code> or <code class='symbols'>M</code> upgrade icon.","IG-2000":"You have the pilot ability of each other friendly ship with the <em>IG-2000</em> Upgrade card (in addition to your own pilot ability).","BTL-A4 Y-Wing":"You cannot attack ships outside your firing arc. After you perform a primary weapon attack, you may immediately perform an attack with a <code class='symbols'>U</code> secondary weapon.",
Andrasta:"Your upgrade bar gains two additional <code class='symbols'>B</code> upgrade icons.","TIE/x1":"Your upgrade bar gains the <code class='symbols'>S</code> upgrade icon. If you equip a <code class='symbols'>S</code> upgrade, its squad point cost is reduced by 4 (to a minimum of 0)."}};var UPGRADE_TYPES={Elite:"ept",Torpedo:"torpedo",Astromech:"amd",Turret:"turret",Missile:"missile",Crew:"crew",Cannon:"cannon",Bomb:"bomb",Title:"title",Mod:"mod",System:"system",Illicit:"illicit",Salvaged:"salvaged"};function Laser(b,c,e){return new Weapon(b,{type:c,name:"Laser",isactive:!0,attack:e,range:[1,3],isprimary:!0})}
function Bomb(b,c){$.extend(this,c);b.upgrades.push(this);log("Installing bomb "+this.name);this.isactive=!0;this.unit=b;b.bombs.push(this);this.exploded=!1;void 0!=this.init&&this.init(b)}
Bomb.prototype={isWeapon:function(){return!1},isBomb:function(){return!0},toString:function(){var b,c,e="";this.isactive||(e="class='inactive'");b="<td><code class='"+this.type+" upgrades'></code></td>";c="<td class='tdstat'>"+this.name+"</td>";return 1==this.unit.team?"<tr "+e+">"+c+b+"</tr>":"<tr "+e+">"+b+c+"</tr>"},getrangeallunits:function(){var b=[[],[],[],[],[]],c;for(c=0;c<squadron.length;c++){var e=this.getrange(squadron[c]);0<e&&b[e].push({unit:c})}return b},getbomblocation:function(){return this.unit.getpathmatrix(this.unit.m.clone().add(MR(180,
0,0)),"F1")},getrange:function(b){var c=this.getOutlinePoints(this.m);b=b.getOutlinePoints(b.m);var e=90001,f,g;for(f=0;f<c.length;f++)for(g=0;4>g;g++){var h=dist(b[g],c[f]);h<e&&(e=h)}return 9E4<e?4:1E4>=e?1:4E4>=e?2:3},resolveactionmove:function(b,c){var e;this.pos=[];var f=function(c,f,l){for(e=0;e<b.length;e++)this.pos[e].remove();this.m=c;l(this,f)}.bind(this);for(e=0;e<b.length;e++)this.pos[e]=this.getOutline(b[e]).attr({fill:"rgba(80,80,80,0.7)"}),function(e){this.pos[e].hover(function(){this.pos[e].attr({stroke:this.unit.color,
strokeWidth:"4px"})}.bind(this),function(){this.pos[e].attr({strokeWidth:"0px"})}.bind(this));this.pos[e].click(function(){f(b[e],e,c)})}.call(this,e)},drop:function(b){log("["+this.unit.name+"] dropped "+this.name);this.img=s.image("png/"+this.img,-10,-8,20,16);this.isactive=!1;this.m=b;this.outline=this.getOutline(new Snap.matrix).attr({display:"block",stroke:halftone(this.unit.color),strokeWidth:2});this.g=s.group(this.outline,this.img);this.g.hover(function(){var b=this.g.getBBox(),e=$("#playmat").position(),
f=e.left+b.x*$("#playmat").width()/900,b=e.top+(b.y-20)*$("#playmat").height()/900;$(".info").css({left:f,top:b}).html(this.name).appendTo("body").show()}.bind(this),function(){$(".info").hide()}.bind(this));this.g.transform(this.m);this.g.appendTo(s);BOMBS.push(this)},getOutlinePoints:function(b){var c=transformPoint(b,{x:-10,y:-10}),e=transformPoint(b,{x:10,y:-10}),f=transformPoint(b,{x:10,y:10});b=transformPoint(b,{x:-10,y:10});return this.op=[c,e,f,b]},getOutline:function(b){b=this.getOutlinePoints(b);
b=s.path("M "+b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+" "+b[2].x+" "+b[2].y+" "+b[3].x+" "+b[3].y+" Z");b.appendTo(s);return b},explode:function(){this.exploded=!0;log("["+this.name+"] exploded");SOUNDS[this.snd].play();this.g.remove()}};function Weapon(b,c){this.isprimary=!1;$.extend(this,c);b.upgrades.push(this);log("Installing weapon "+this.name+" ["+this.type+"]");this.isactive=!0;this.unit=b;b.weapons.push(this);void 0!=this.init&&this.init(b)}
Weapon.prototype={isBomb:function(){return!1},isWeapon:function(){return!0},toString:function(){var b,c,e="";if(this.isactive){c=this.getrangeallunits();for(b=0;b<c.length&&c[b].team==this.unit.team;b++);b==c.length&&(e="class='nofire'")}else e="class='inactive'";for(b=0;b<squadron.length&&squadron[b]!=this.unit;b++);b="<td class='statfire'"+(" onclick='if (!squadron["+b+"].dead) squadron["+b+'].togglehitsector("'+this.name.replace(/\'/g,"&#39;")+"\")'");b+=">"+this.getattack()+"<span class='symbols'>"+
A[this.type.toUpperCase()].key+"</span></td>";c="<td class='tdstat'>"+this.name.replace(/\'/g,"&#39;")+" <span style='font-size:x-small'>";"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&(c+="<code class='symbols'>"+A.TARGET.key+"</code>"),"Focus".match(this.getrequirements())&&(c+=(5<this.getrequirements().length?"/":"")+"<code class='symbols'>"+A.FOCUS.key+"</code>"));c+="["+this.range[0]+"-"+this.range[1]+"]</span></td>";return 1==this.unit.team?"<tr "+e+">"+
c+b+"</tr>":"<tr "+e+">"+b+c+"</tr>"},getrequirements:function(){return this.requires},getattack:function(){return this.attack},isTurret:function(){return"Turret"==this.type},isinrange:function(b){return b>=this.range[0]&&b<=this.range[1]},modifydamagegiven:function(b){return b},modifydamageassigned:function(b,c){return b},canfire:function(b){return!this.isactive||this.unit.checkcollision(b)?!1:"undefined"!=typeof this.getrequirements()?"Target".match(this.getrequirements())&&this.unit.canusetarget(b)?
!0:"Focus".match(this.getrequirements())&&this.unit.canusefocus(b)?!0:!1:!0},getattackreroll:function(b){return 0},modifyattackroll:function(b,c){return b},getattackbonus:function(b){return this.isprimary&&1==this.getrange(b)?(log(this.unit.name+" +1 attack for range 1"),1):0},declareattack:function(b){"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&this.unit.canusetarget(b)?this.unit.removetarget(b):"Focus".match(this.getrequirements())&&this.unit.canusefocus(b)&&
this.unit.removefocustoken(),this.unit.show())},getdefensebonus:function(b){return this.isprimary&&3==this.getrange(b)?(log(b.name+" +1 defense for range 3 against "+this.unit.name),1):0},getrange:function(b){var c;if(!this.canfire(b))return 0;if(this.isTurret()||this.unit.isTurret(this))return b=this.unit.getrange(b),this.isinrange(b)?b:0;for(c=this.range[0];c<=this.range[1];c++)if(this.unit.isinsector(this.unit.m,c,b))return c;if("Bilaser"==this.type){var e=this.unit.m.clone();e.add(MR(180,0,0));
for(c=this.range[0];c<=this.range[1];c++)if(this.unit.isinsector(e,c,b)&&log(b.name+" in range "+c),this.unit.isinsector(e,c,b))return c}return 0},endattack:function(b,c){this.type.match("Torpedo|Missile")&&(this.isactive=!1,log("["+this.name.replace(/\'/g,"&#39;")+"] inactive"))},getrangeallunits:function(){var b,c=[];for(b=0;b<squadron.length;b++){var e=squadron[b];0<this.getrange(e)&&c.push(e)}return c}};
function Upgrade(b,c){$.extend(this,UPGRADES[c]);b.upgrades.push(this);log("Installing upgrade "+this.name.replace(/\'/g,"&#39;")+" ["+this.type+"]");this.isactive=!0;this.unit=b;void 0!=this.init&&this.init(b)}
function Upgradefromname(b,c){var e;for(e=0;e<UPGRADES.length;e++)if(UPGRADES[e].name==c){var f=UPGRADES[e];return"Bomb"==f.type?new Bomb(b,f):"undefined"!=typeof f.isWeapon?f.isWeapon()?new Weapon(b,f):new Upgrade(b,e):f.type.match("Turretlaser|Bilaser|Laser|Torpedo|Cannon|Missile|Turret")||1==f.isweapon?new Weapon(b,f):new Upgrade(b,e)}console.log("Could not find upgrade "+c)}
Upgrade.prototype={toString:function(){var b,c,e="";this.isactive||(e="class='inactive'");b="<td><code class='"+this.type+" upgrades'></code></td>";c="<td class='tdstat'>"+this.name.replace(/\'/g,"&#39;")+"</td>";return 1==this.unit.team?"<tr "+e+">"+c+b+"</tr>":"<tr "+e+">"+b+c+"</tr>"},isWeapon:function(){return!1},isBomb:function(){return!1}};
var rebelonly=function(b){var c;for(c=0;c<PILOTS.length;c++)if(b==PILOTS[c].name&&"REBEL"==PILOTS[c].faction)return!0;return!1},empireonly=function(b){var c;for(c=0;c<PILOTS.length;c++)if(b==PILOTS[c].name&&"EMPIRE"==PILOTS[c].faction)return!0;return!1},UPGRADES=[{name:"Ion Cannon Turret",type:"Turret",firesnd:"falcon_fire",points:5,attack:3,done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,log("["+this.name+"] 1<p class='hit'></p> + 1 ion token assigned to "+c.name),c.addiontoken());return b},
range:[1,2]},{name:"Proton Torpedoes",requires:"Target",type:"Torpedo",firesnd:"missile",points:4,done:!0,attack:4,init:function(b){b.addattackmoda(this,function(c,e){return b.weapons[b.activeweapon]==this?!0:!1}.bind(this),function(b,e){return 0<Math.floor(b/100)%10?(log("[Proton Torpedoes] 1 <p class='focus'></p> -> 1 <p class='critical'></p>"),b-90):b}.bind(this),!1,"focus")},range:[2,3]},{name:"R2 Astromech",done:!0,install:function(b){b.gdr2=b.getdial;b.getdial=function(){for(var c=b.gdr2(),
e=[],f=0;f<c.length;f++){var g=P[c[f].move].speed,h=c[f].difficulty;if(1==g||2==g)h="GREEN";e.push({move:c[f].move,difficulty:h})}return e}.bind(b);log("["+this.name+"] 1, 2 speed maneuvers of "+b.name+" are green")},uninstall:function(b){b.getdial=b.gdr2;log("["+this.name+"] uninstalling effect")},type:"Astromech",points:1},{name:"R2-D2",done:!0,init:function(b){var c=b.handledifficulty;b.handledifficulty=function(b){c.call(this,b);"GREEN"==b&&this.shield<this.ship.shield&&(this.shield++,log("[R2-D2] "+
this.name+" recovers 1 shield"))}},unique:!0,type:"Astromech",points:4},{name:"R2-F2",done:!0,candoaction:function(){return!0},action:function(){var b=this.unit.getagility,c=this.unit.endround;log("[R2-F2] +1 agility for "+this.unit.name+" until end of round");this.unit.getagility=function(){return b.call(this)+1};this.unit.endround=function(){this.unit.getagility=b;this.unit.endround=c;c.call(this)};this.unit.showstats();this.endaction();return!0},unique:!0,type:"Astromech",points:3},{name:"R5-D8",
unique:!0,type:"Astromech",points:3},{name:"R5-K6",init:function(b){var c=b.removetarget;b.removetarget=function(b){c.call(this,b);var f=Math.floor(7*Math.random());"evade"==FACE[DEFENSEDICE[f]]&&(this.addtarget(b),log("[R5-K6] target lock on "+b.name),record(this.id,"TT"+b.id))}},done:!0,unique:!0,type:"Astromech",points:2},{name:"R5 Astromech",type:"Astromech",points:1},{name:"Determination",type:"Elite",points:1},{name:"Swarm Tactics",type:"Elite",points:2,done:!0,init:function(b){b.begincombatphase=
function(){b.dead||waitingforaction.add(function(){var c=b.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c});0<c.length?(log("<b>["+this.name+"] sets a pilot skill to the skill of "+b.name+"</b>"),b.resolveactionselection(c,function(e){log(c[e].name+" has "+b.skill+" pilot skill");c[e].oldskill=c[e].skill;log("old skill :"+c[e].oldskill);c[e].skill=b.skill;filltabskill();c[e].show();var f=c[e].endcombatphase;c[e].endcombatphase=function(){f.call(this);this.skill=this.oldskill;log(this.name+
" has "+this.skill+" pilot skill");squadron.sort(function(b,c){return c.skill-b.skill});filltabskill();this.show()}.bind(c[e]);nextstep()}.bind(b))):nextstep()}.bind(this))}}},{name:"Squad Leader",unique:!0,done:!0,type:"Elite",points:2,candoaction:function(){this.p=this.unit.selectnearbyunits(2,function(b,c){return b.team==c.team&&c!=b&&c.skill<b.skill});return 0<this.p.length},action:function(){var b=this.unit;this.unit.resolveactionselection(p,function(c){p[c].freeaction(function(){b.endaction()})})}},
{name:"Expert Handling",candoaction:function(){return!0},action:function(){-1==this.unit.shipactionList.indexOf("ROLL")&&this.unit.addstress();this.unit.resolveroll();0<this.unit.istargeted.length&&waitingforaction.add(function(){log("<b>["+this.name+"] remove 1 target lock from "+this.unit.name+"</b>");this.unit.resolveactionselection(this.unit.istargeted,function(b){this.istargeted[b].removetarget(this);nextstep()}.bind(this.unit))}.bind(this))},type:"Elite",done:!0,points:2},{name:"Marksmanship",
candoaction:function(){return!0},action:function(){this.unit.addattackmoda(this,function(b,c){return!0}.bind(this.unit),function(b,c){var e=Math.floor(b/100);log("[Marksmanship] "+e+" <code class='xfocustoken'></code> -> 1 <code class='critical'></code>"+(1<e?"+ "+(e-1)+"<code class='hit'></code>":""));return 1<e?b-100*e+10+(e-1):b-90},!1,"focus");this.unit.endaction()},done:!0,type:"Elite",points:3},{name:"Concussion Missiles",requires:"Target",type:"Missile",firesnd:"missile",points:4,attack:4,
range:[2,3]},{name:"Cluster Missiles",type:"Missile",firesnd:"missile",requires:"Target",points:4,attack:3,range:[1,2]},{name:"Daredevil",done:!0,candoaction:function(){return!0},action:function(){log("<b>["+this.name+"] select maneuver to perform</b>");this.unit.resolveactionmove([this.unit.getpathmatrix(this.unit.m.clone(),"TL1"),this.unit.getpathmatrix(this.unit.m.clone(),"TR1")],function(b){b.addstress();if(-1==b.shipactionList.indexOf("BOOST")){log("[Daredevil] "+b.name+" no boost -> 2 rolls for damage");
for(var c=0;2>c;c++){var e=Math.floor(7*Math.random()),e=FACE[ATTACKDICE[e]];"hit"==e?(b.resolvehit(1),b.checkdead()):"critical"==e&&(b.resolvecritical(1),b.checkdead())}}b.endaction()},!0)},type:"Elite",points:3},{name:"Elusiveness",type:"Elite",points:2},{name:"Homing Missiles",requires:"Target",type:"Missile",firesnd:"missile",attack:4,range:[2,3],done:!0,init:function(b){var c=b.resolveattack,e=this;b.resolveattack=function(b,f){this.weapons[b]==e&&(this.cufhm=f.canusefocus,log("[Homing Missile] "+
f.name+" cannot use focus"),f.canusefocus=function(){return!1});c.call(this,b,f)};var f=this.endattack;this.endattack=function(b,c){f.call(this,b,c);targetunit.canusefocus=this.unit.cufhm}},points:5},{name:"Push the Limit",init:function(b){var c=b.endaction;b.r=-1;b.endaction=function(){this.r!=round&&(this.r=round,waitingforaction.add(function(){log("[Push the Limit] select an action or empty to cancel");this.freeaction(function(){log("endfree action with action="+this.action);-1<this.action?(this.r=
round,this.addstress()):this.r=-1;nextstep()}.bind(this))}.bind(this)));c.call(this)}},done:!0,type:"Elite",points:3},{name:"Deadeye",init:function(b){var c=Weapon.prototype.getrequirements;Weapon.prototype.getrequirements=function(){var e=c.call(this);return this.unit==b&&"Target"==e?"Target|Focus":e}},done:!0,type:"Elite",points:1},{name:"Expose",candoaction:function(){return!0},action:function(){var b=this.unit.getagility,c=this.unit.weapons[0],e=c.getattack,f=this.unit.endround;log("["+this.name+
"] -1 agility, +1 primary attack until end of turn");this.unit.getagility=function(){var c=b.call(this)-1;return 0<=c?c:0};c.getattack=function(){return e.call(c)+1};this.unit.endround=function(){this.getagility=b;c.getattack=e;this.endround=f};this.unit.showstats();this.unit.endaction()},done:!0,type:"Elite",points:4},{name:"Gunner",done:!0,init:function(b){var c=b.endattack;b.endattack=function(b,f){c.call(this,b,f);0==b+f&&2>this.hasfired&&(log("[Gunner] "+this.name+" attacks again with primary weapon"),
this.selecttargetforattack(0))}},type:"Crew",points:5},{name:"Ion Cannon",type:"Cannon",firesnd:"slave_fire",done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,log("["+this.name+"] 1<p class='hit'></p> + 1 ion token assigned to "+c.name),c.addiontoken());return b},points:3,attack:3,range:[1,3]},{name:"Heavy Laser Cannon",type:"Cannon",firesnd:"slave_fire",done:!0,modifydamagegiven:function(b){if(10<b){var c=Math.floor(b/10);b-=10*c;log("["+this.name+"] "+c+"<p class='critical'></p>-> "+c+"<p class='hit'></p>");
b=c+b}return b},points:7,attack:4,range:[2,3]},{name:"Seismic Charges",done:!0,img:"seismic.png",snd:"explode",explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){var b=this.getrangeallunits(),c;for(c=0;c<b[1].length;c++)squadron[b[1][c].unit].resolvehit(1);BOMBS.splice(BOMBS.indexOf(this),1);Bomb.prototype.explode.call(this)}},type:"Bomb",points:2},{name:"Mercenary Copilot",type:"Crew",points:2},{name:"Assault Missiles",type:"Missile",requires:"Target",firesnd:"missile",done:!0,modifydamageassigned:function(b,
c){if(0<b){log("["+this.name+"] 1 damage assigned to all units at range 1 of "+c.name);for(var e=c.getrangeallunits(),f=0;f<e[1].length;f++)squadron[e[1][f].unit].resolvehit(1)}return b},points:5,attack:4,range:[2,3]},{name:"Veteran Instincts",done:!0,install:function(b){b.skill+=2},uninstall:function(b){b.skill-=2},type:"Elite",points:1},{name:"Proximity Mines",type:"Bomb",points:3},{name:"Weapons Engineer",type:"Crew",points:3},{name:"Draw Their Fire",type:"Elite",points:1},{name:"Luke Skywalker",
faction:"REBEL",unique:!0,done:!0,init:function(b){var c=b.endattack;b.endattack=function(b,f){c.call(this,b,f);0==b+f&&2>this.hasfired&&(log("[Luke Skywalker] "+this.name+" attacks again with primary weapon"),this.selecttargetforattack(0))};b.addattackmoda(this,function(b,c){return 2==this.hasfired?!0:!1}.bind(b),function(b,c){return 100<b?b-99:b},!1,"focus")},type:"Crew",points:7},{name:"Nien Nunb",faction:"REBEL",done:!0,install:function(b){b.getdial=function(){for(var b=Unit.prototype.getdial.call(this),
e=[],f=0;f<b.length;f++){var g=b[f].move,h=b[f].difficulty;g.match("F1|F2|F3|F4|F5")&&(h="GREEN");e.push({move:g,difficulty:h})}return e}.bind(b)},uninstall:function(b){b.getdial=Unit.prototype.getdial},unique:!0,type:"Crew",points:1},{name:"Chewbacca",faction:"REBEL",unique:!0,type:"Crew",points:4},{name:"Advanced Proton Torpedoes",requires:"Target",type:"Torpedo",firesnd:"missile",attack:5,done:!0,range:[1,1],init:function(b){b.addattackmoda(this,function(c,e){return b.weapons[b.activeweapon]==
this?!0:!1}.bind(this),function(b,e){var f=b%10+Math.floor(b/10)%10+Math.floor(b/100)%10;0<e-f&&(log("[Advanced Proton Torpedoes] change "+(e-f)+" blanks by focus"),b=3>e-f?b+100*(e-f):b+300);return b}.bind(this),!1,"blank")},points:6},{name:"Autoblaster",type:"Cannon",done:!0,firesnd:"slave_fire",attack:3,init:function(b){var c=Unit.prototype.cancelhit;Unit.prototype.cancelhit=function(b,f,g){return"Autoblaster Turret"==g.weapons[g.activeweapon].name?(log("[Autoblaster Turret] Hits cannot be cancelled by defense dice"),
b):c.call(this,b,f,g)}},range:[1,1],points:5},{name:"Fire-Control System",done:!0,init:function(b){var c=b.cleanupattack;b.cleanupattack=function(){log("[Fire-Control System] free target lock on "+targetunit.name);this.addtarget(targetunit);c.call(this)}.bind(b)},type:"System",points:2},{name:"Blaster Turret",type:"Turret",done:!0,firesnd:"falcon_fire",requires:"Focus",points:4,attack:3,range:[1,2]},{name:"Recon Specialist",init:function(b){b.addfocus=function(){b.addfocustoken();return Unit.prototype.addfocus.call(this)}},
done:!0,type:"Crew",points:3},{name:"Saboteur",type:"Crew",points:2},{name:"Intelligence Agent",type:"Crew",points:1},{name:"Proton Bombs",done:!0,snd:"explode",img:"proton.png",explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){var b=this.getrangeallunits(),c;for(c=0;c<b[1].length;c++)squadron[b[1][c].unit].applycritical(1);BOMBS.splice(BOMBS.indexOf(this),1);Bomb.prototype.explode.call(this)}},type:"Bomb",points:5},{name:"Adrenaline Rush",type:"Elite",points:1},{name:"Advanced Sensors",
done:!0,init:function(b){var c=b.timeforaction;b.timeforaction=function(){this.isactive||(this.timeforaction=c);log("[Advanced Sensors] action before maneuver for "+this.name);return this==activeunit&&!this.actiondone&&phase==ACTIVATION_PHASE}},type:"System",points:3},{name:"Sensor Jammer",type:"System",points:4},{name:"Darth Vader",faction:"EMPIRE",unique:!0,type:"Crew",points:3},{name:"Rebel Captive",faction:"EMPIRE",done:!0,init:function(b){var c=b.ishit;b.rebelcaptive=0;b.ishit=function(b){this.rebelcaptive!=
round&&(log("[Rebel Captive] +1 stress for "+b.name),b.addstress(),this.rebelcaptive=round);return c.call(this,b)}.bind(b)},unique:!0,type:"Crew",points:3},{name:"Flight Instructor",init:function(b){b.adddefensererolld(this,["focus"],function(){return 2>=activeunit.skill?2:1},function(b,e){log("[Flight Instructor] +"+(2>=activeunit.skill?2:1)+" reroll(s)");return!0},!1)},done:!0,type:"Crew",points:4},{name:"Navigator",init:function(b){var c=b.completemaneuver;b.completemaneuver=function(b,f,g){var h=
f.replace(/\d/,""),l=this.getdial(),m=[],n=[];n.push(f);m.push(this.getpathmatrix(this.m.clone(),f));for(i=0;i<l.length;i++)!l[i].move.match(h)||l[i].move==f||l[i].difficulty==RED&&0!=this.stress||(m.push(this.getpathmatrix(this.m.clone(),l[i].move)),n.push(l[i].move));1<m.length?(log("<b>[Navigator] choose maneuver of bearing "+h+"</b>"),this.resolveactionmove(m,function(b,e){c.call(b,n[e],n[e],g)},!1,!0)):c.call(this,b,f,g)}},done:!0,type:"Crew",points:3},{name:"Opportunist",done:!0,init:function(b){var c=
b.getattackstrength;b.getattackstrength=function(b,f){var g=c.call(this,b,f);0==f.focus+f.evade&&(g+=1,this.addstress(),log("[Opportunist] +1 attack against "+f.name+", 1 stress more"));return g}},type:"Elite",points:4},{name:"Ion Pulse Missiles",requires:"Target",type:"Missile",firesnd:"missile",done:!0,modifydamageassigned:function(b,c){0<b&&(log("["+this.name+"] 2<p class='hit'></p> + 1 ion token assigned by "+c.name),b=2,c.ionized+=2);return b},points:3,attack:3,range:[2,3]},{name:"Wingman",done:!0,
init:function(b){var c=b.begincombatphase;b.begincombatphase=function(){this.dead||(c.call(this),waitingforaction.add(function(){var b=this.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c&&0<c.stress});0<b.length?(log("<b>[Wingman] select a pilot with stress to remove.</b>"),this.resolveactionselection(b,function(c){b[c].removestresstoken();nextstep()})):nextstep()}.bind(this)))}},type:"Elite",points:2},{name:"Decoy",init:function(b){b.begincombatphase=function(){this.dead||waitingforaction.add(function(){var b=
this.selectnearbyunits(2,function(b,c){return b.team==c.team&&b!=c});b.push(this);1<b.length?(log("<b>[Decoy] select a pilot skill to exchange with "+this.name+" (or self to cancel)</b>"),this.resolveactionselection(b,function(e){if(b[e]!=this){var f=this.skill;this.skill=b[e].skill;b[e].skill=f;filltabskill();b[e].show();this.show()}nextstep()}.bind(this))):nextstep()}.bind(this))}},done:!0,type:"Elite",points:2},{name:"Outmaneuver",done:!0,init:function(b){b.raoutmaneuver=b.resolveattack;b.resolveattack=
function(c,e){e.tagility=e.agility;this.isinsector(this.m,3,e)&&!e.isinsector(e.m,3,b)&&(log("[Outmaneuver] -1 agility for "+e.name),e.agility--);this.raoutmaneuver.call(this,c,e)}.bind(b);b.eaoutmaneuver=b.endattack;b.endattack=function(b,e){targetunit.agility=targetunit.tagility;this.eaoutmaneuver.call(this,b,e)}.bind(b)},type:"Elite",points:3},{name:"Predator",done:!0,init:function(b){b.addattackrerolla(this,["blank","focus"],function(){return 2>=targetunit.skill?2:1},function(b,e){log("[Predator] "+
(2>=targetunit.skill?2:1)+" reroll(s)");return!0},!1)},type:"Elite",points:3},{name:"Flechette Torpedoes",requires:"Target",type:"Torpedo",firesnd:"missile",done:!0,endattack:function(b,c){4>=targetunit.hull&&targetunit.addstress();this.isactive=!1},points:2,attack:3,range:[2,3]},{name:"R7 Astromech",type:"Astromech",points:2},{name:"R7-T1",candoaction:function(){return!0},action:function(){var b=this.unit.selectnearbyunits(2,function(b,e){return b.team!=e.team});0<b.length?(b.push(this.unit),log("<b>[R7-T1] acquire target lock on target enemy ship (self to ignore)</b>"),
this.unit.resolveactionselection(b,function(c){b[c]!=this?(3>=b[c].gethitsector(this)&&this.addtarget(b[c]),this.resolveboost()):this.endaction()})):this.unit.endaction()},done:!0,unique:!0,type:"Astromech",points:3},{name:"Tactician",type:"Crew",points:2,done:!0,init:function(b){var c=b.endattack;b.endattack=function(b,f){c.call(this);this.isinsector(this.m,2,targetunit)&&(targetunit.addstress(),log("[Tactician] +1 stress for "+targetunit.name))}.bind(b)}},{name:"R2-D2",faction:"REBEL",unique:!0,
type:"Crew",points:4},{name:"C-3PO",unique:!0,faction:"REBEL",type:"Crew",points:3},{name:"R3-A2",done:!0,init:function(b){var c=b.declareattack;b.declareattack=function(b,f){c.call(this,b,f);this.isinsector(this.m,3,f)&&(this.addstress(),log("[R3-A2] +1 stress for "+f.name+" and "+this.name),f.addstress())}},unique:!0,type:"Astromech",points:2},{name:"R2-D6",upgrades:["Elite"],noupgrades:"Elite",skillmin:3,done:!0,unique:!0,type:"Astromech",points:1},{name:"Enhanced Scopes",done:!0,init:function(b){b.beginactivationphase=
function(){b.oldskill=b.skill;log("[Enhanced Scopes] "+b.name+" skill set to 0");b.skill=0};b.endactivationphase=function(){b.skill=b.oldskill}},type:"System",points:1},{name:"Chardaan Refit",type:"Missile",done:!0,isWeapon:function(){return!1},points:-2,ship:"A-Wing"},{name:"Proton Rockets",type:"Missile",firesnd:"missile",requires:"Focus",points:3,attack:2,done:!0,getattack:function(){a=this.attack;a=3>=this.unit.agility?a+this.unit.agility:a+3;log("[Proton Rockets] +"+(3<this.unit.agility?3:this.unit.agility)+
" attack for agility");return a},range:[1,1]},{name:"Kyle Katarn",faction:"REBEL",unique:!0,done:!0,type:"Crew",points:3,init:function(b){var c=b.removestresstoken;b.removestresstoken=function(){c.call(this);this.addfocustoken()}.bind(b)}},{name:"Jan Ors",faction:"REBEL",unique:!0,type:"Crew",points:2},{name:"R4-D6",init:function(b){var c=b.cancelhit;b.cancelhit=function(e,f,g){e=c.call(this,e,f,g);if(3<=e)for(e-=2,f=0;f<e;f++)b.addstress();return e}},done:!0,unique:!0,type:"Astromech",points:1},
{name:"R5-P9",done:!0,init:function(b){var c=b.endcombatphase;b.endcombatphase=function(){c.call(this);this.shield<this.ship.shield&&this.canusefocus()&&(this.shield++,log("[R5-P9] 1 <code class='xfocustoken'></code> -> 1 <code class='cshield'></code>"),this.removefocustoken())}.bind(b)},unique:!0,type:"Astromech",points:3},{name:"Han Solo",faction:"REBEL",type:"Crew",unique:!0,points:2},{name:"Leia Organa",faction:"REBEL",type:"Crew",unique:!0,points:4},{name:"Targeting Coordinator",type:"Crew",
limited:!0,points:4},{name:"Lando Calrissian",faction:"REBEL",type:"Crew",unique:!0,points:3},{name:"Mara Jade",faction:"EMPIRE",type:"Crew",unique:!0,done:!0,init:function(b){b.endcombatphase=function(){var b=this.gettargetableunits(1),e;0<b.length&&log("[Mara Jade] +1 stress for all enemies in range 1");for(e=0;e<b.length;e++)0==b[e].stress&&b[e].addstress()}.bind(b)},points:3},{name:"Fleet Officer",faction:"EMPIRE",type:"Crew",points:3},{name:"Stay On Target",type:"Elite",points:2,done:!0,init:function(b){var c=
b.completemaneuver;b.completemaneuver=function(b,f,g){var h=f.substr(-1),l=this.getdial(),m=[],n=[];n.push(f);m.push(this.getpathmatrix(this.m.clone(),f));for(i=0;i<l.length;i++)l[i].move.substr(-1)==h&&l[i].move!=f&&(m.push(this.getpathmatrix(this.m.clone(),l[i].move)),n.push(l[i].move));1<m.length?(log("<b>[Stay on target] choose maneuver of speed "+h+"</b>"),this.resolveactionmove(m,function(b,e){c.call(b,n[e],n[e],0==e?g:RED)},!1,!0)):c.call(this,b,f,g)}}},{name:"Dash Rendar",faction:"REBEL",
unique:!0,type:"Crew",points:2},{name:"Lone Wolf",done:!0,init:function(b){b.addattackrerolla(this,["blank"],function(){return 1},function(b,e){this.unit.getrangeallunits();for(var f=0;f<squadron.length;f++)if(2>=squadron[f].getrange(this.unit)&&squadron[f].team==this.unit.team)return!1;log("[Lone Wolf] 1 reroll");return!0},!1)},unique:!0,type:"Elite",points:2},{name:"'Leebo'",faction:"REBEL",unique:!0,candoaction:function(){return!0},action:function(){log("["+this.name+"] free boost and ion token");
this.unit.addiontoken();this.unit.resolveboost()},done:!0,type:"Crew",points:2},{name:"Ruthlessness",faction:"EMPIRE",type:"Elite",points:3,done:!0,init:function(b){var c=b.endattack;b.endattack=function(b,f){c.call(this);var g=targetunit.selectnearbyunits(1,function(b,c){return!0});0<g.length&&this.resolveactionselection(g,function(b){log("[Ruthlessness] +1 hit to "+g[b].name);g[b].resolvehit(1);g[b].checkdead()})}.bind(b)}},{name:"Intimidation",done:!0,init:function(b){var c=this;c.ga=b.getagility;
b.getagility=function(){var b=c.ga.call(this);return this.team!=c.team&&0<b&&this.iscollidingunit(this.m,c)?(log("[Intimidation] -1 agility to "+this.name),b-1):b}},type:"Elite",points:2},{name:"Ysanne Isard",faction:"EMPIRE",unique:!0,done:!0,init:function(b){b.bcpisard=b.begincombatphase;b.begincombatphase=function(){this.bcpisard.call(this);0==this.shield&&this.hull<this.ship.hull&&this.candoevade()&&(this.addevadetoken(),log("[Ysanne Isard] +1 free evade"))}.bind(b)},done:!0,type:"Crew",points:4},
{name:"Moff Jerjerrod",faction:"EMPIRE",unique:!0,type:"Crew",points:2},{name:"Ion Torpedoes",requires:"Target",type:"Torpedo",firesnd:"missile",done:!0,modifydamageassigned:function(b,c){if(0<b){log("["+this.name+"] 1 ion token for all units at range 1 of "+c.name);c.addiontoken();for(var e=c.getrangeallunits(),f=0;f<e[1].length;f++)squadron[e[1][f].unit].addiontoken()}return b},points:5,attack:4,range:[2,3]},{name:"Bodyguard",faction:"SCUM",unique:!0,done:!0,init:function(b){var c=b.begincombatphase;
b.begincombatphase=function(){c.call(this);this.dead||waitingforaction.add(function(){var b=this.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c&&b.skill<c.skill});b.push(this);1<b.length&&this.canusefocus()?(log("<b>["+this.name+"] increase agility of selected pilot</b>"),this.resolveactionselection(b,function(c){if(this!=b[c]){b[c].agility++;this.removefocustoken();this.show();var g=b[c].endcombatphase;b[c].endcombatphase=function(){g.call(this);this.agility--;this.showstats();b[c].endcombatphase=
g}.bind(b[c])}nextstep()}.bind(this))):nextstep()}.bind(b))}},type:"Elite",points:2},{name:"Calculation",done:!0,init:function(b){b.addattackmoda(this,function(b,e){return this.canusefocus()}.bind(b),function(b,e){return 0<Math.floor(b/100)%10?(log("[Calculation] 1 <p class='focus'></p> -> 1 <p class='critical'></p>"),b-90):b},!1,"focus")},type:"Elite",points:1},{name:"Accuracy Corrector",init:function(b){b.addattackmoda(this,function(b,e){return!0}.bind(this),function(b,e){log("[Accuracy Corrector] replace all dice by 2 <p class='hit'></p>");
return 2}.bind(this),!1,"blank")},done:!0,type:"System",points:3},{name:"Inertial Dampeners",done:!0,init:function(b){var c=b.updateactivationdial,e=this;b.updateactivationdial=function(){var b=c.call(this);this.addactivationdial(function(){return!e.unit.hasmoved&&e.isactive},function(){e.unit.completemaneuver("F0","F0","WHITE");e.isactive=!1;e.unit.addstress()},A.ILLICIT.key,$("<div>").attr({class:"symbols"}));return b}},type:"Illicit",points:1},{name:"Flechette Cannon",type:"Cannon",firesnd:"slave_fire",
done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,log("["+this.name+"] 1<p class='hit'></p> and stress token for "+c.name),0==c.stress&&c.addstress());return b},points:2,attack:3,range:[1,3]},{name:"'Mangler' Cannon",type:"Cannon",firesnd:"slave_fire",points:4,attack:3,done:!0,modifydamagegiven:function(b){0<b%10&&(log("["+this.name+"] 1<p class='hit'></p>-> 1 <p class='critical'></p>"),b+=9);return b},range:[1,3]},{name:"Dead Man's Switch",done:!0,init:function(b){var c=b.dies;b.dies=function(){var e,
f=b.getrangeallunits();c.call(this);log("[Dead Man's Switch] 1 damage for all units in range 1");for(e=0;e<f[1].length;e++)squadron[f[1][e].unit].applydamage(1)}},type:"Illicit",points:2},{name:"Feedback Array",type:"Illicit",points:2},{name:"'Hot Shot' Blaster",done:!0,isWeapon:function(){return!0},isTurret:function(){return!0},endattack:function(b,c){this.isactive=!1},type:"Illicit",firesnd:"xwing_fire",points:3,attack:3,range:[1,2]},{name:"Greedo",faction:"SCUM",unique:!0,type:"Crew",points:1},
{name:"Salvaged Astromech",type:"Salvaged",points:2},{name:"Bomb Loadout",upgrades:["Bomb"],done:!0,isWeapon:function(){return!1},limited:!0,type:"Torpedo",points:0,ship:"Y-Wing"},{name:"'Genius'",unique:!0,done:!0,init:function(b){b.candropbomb=function(){return phase==ACTIVATION_PHASE}},type:"Salvaged",points:0},{name:"Unhinged Astromech",type:"Salvaged",done:!0,install:function(b){var c;b.gd=b.getdial;b.getdial=function(){var e=b.gd(),f=[];for(c=0;c<e.length;c++){var g=e[c].difficulty,h=e[c].move;
h.match("F3|TL3|TR3|BL3|BR3|SR3|SR3|K3")&&(g="GREEN");f.push({move:h,difficulty:g})}return f}},uninstall:function(b){b.getdial=b.gd},points:1},{name:"R4-B11",unique:!0,type:"Salvaged",points:3},{name:"Autoblaster Turret",type:"Turret",firesnd:"falcon_fire",done:!0,points:2,attack:2,init:function(b){var c=Unit.prototype.cancelhit;Unit.prototype.cancelhit=function(b,f,g){return"Autoblaster Turret"==g.weapons[g.activeweapon].name?(log("[Autoblaster Turret] Hits cannot be cancelled by defense dice"),
b):c.call(this,b,f,g)}},range:[1,1]},{name:"R4 Agromech",done:!0,init:function(b){b.usefocusattack=function(b){0==this.target&&(log("[R4 Agromech] free target lock"),this.addtarget(targetunit));Unit.prototype.usefocusattack.call(this,b)};b.declareattack=function(b,e){var f=this.weapons[b].getrequirements();"undefined"!=typeof f&&"Focus".match(f)&&this.canusefocus(e)&&(log("[R4 Agromech] free target lock"),this.addtarget(e));Unit.prototype.declareattack.call(this,b,e)}},type:"Salvaged",points:2},{name:"K4 Security Droid",
faction:"SCUM",type:"Crew",done:!0,init:function(b){b.handledifficulty=function(b){Unit.prototype.handledifficulty.call(this,b);"GREEN"==b&&waitingforaction.add(function(){var b=this.gettargetableunits(3);0<b.length?(b.push(this),log("[K4 Security Droid] select unit to target lock for "+this.name+" (self to cancel)"),this.resolveactionselection(b,function(c){this!=b[c]&&(this.addtarget(b[c]),log("["+this.name+"] lock target "+b[c].name));nextstep()}.bind(this))):nextstep()}.bind(this))}},points:3},
{name:"Outlaw Tech",faction:"SCUM",limited:!0,done:!0,type:"Crew",init:function(b){b.handledifficulty=function(c){Unit.prototype.handledifficulty(c);"RED"==c&&b.addfocustoken()}},points:2},{name:"Advanced Targeting Computer",type:"System",points:5,ship:"TIE Advanced"},{name:"Stealth Device",type:"Mod",done:!0,install:function(b){b.agility++},uninstall:function(b){b.agility--},init:function(b){log("["+this.name+"] +1 agility for "+b.name);var c=b.ishit;b.ishit=function(b){var f;for(f=0;f<this.upgrades.length&&
"Stealth Device"!=this.upgrades[f].name;f++);this.upgrades[f].isactive&&(this.upgrades[f].isactive=!1,this.agility--,log("["+this.name+"] "+this.upgrades[f].name+" is hit => equipment destroyed"),this.show());c.call(this,b)}.bind(b)},points:3},{name:"Shield Upgrade",type:"Mod",done:!0,install:function(b){b.shield++},uninstall:function(b){b.shield--},points:4},{name:"Engine Upgrade",type:"Mod",done:!0,addedaction:"Boost",points:4},{name:"Anti-Pursuit Lasers",type:"Mod",islarge:!0,points:2},{name:"Targeting Computer",
type:"Mod",done:!0,addedaction:"Target",points:2},{name:"Hull Upgrade",type:"Mod",done:!0,install:function(b){b.hull++},uninstall:function(b){b.hull--},points:3},{name:"Munitions Failsafe",type:"Mod",points:1},{name:"Stygium Particle Accelerator",type:"Mod",done:!0,init:function(b){b.resolvecloak=function(){this.focus++;log("[Stygium P.A.] free focus for "+this.name);return Unit.prototype.resolvecloak.call(this)};b.resolveuncloak=function(){this.focus++;log("[Stygium P.A.] free focus for "+this.name);
return Unit.prototype.resolveuncloak.call(this)}},points:2},{name:"Advanced Cloaking Device",type:"Mod",points:4,ship:"TIE Phantom"},{name:"B-Wing/E2",type:"Mod",done:!0,upgrades:["Crew"],points:1,ship:"B-Wing"},{name:"Countermeasures",type:"Mod",islarge:!0,points:3},{name:"Experimental Interface",type:"Mod",unique:!0,points:3},{name:"Tactical Jammer",type:"Mod",islarge:!0,points:1},{name:"Autothrusters",type:"Mod",actionrequired:"Boost",points:2,done:!0,init:function(b){b.adddefensemodd(this,function(b,
e){return this.isinsector(this.m,2,activeunit)?!1:!0}.bind(b),function(b,e){return 0<e-Math.floor(b/10)%10-b%10?(log("[Autothrusters] 1 <p class='blank'></p> -> 1 <p class='evade'></p>"),b+1):b},!1," ")}},{name:"Slave I",type:"Title",unique:!0,points:0,done:!0,ship:"Firespray-31",upgrades:["Torpedo"]},{name:"Millennium Falcon",type:"Title",done:!0,addedaction:"Evade",unique:!0,points:1,ship:"YT-1300"},{name:"Moldy Crow",type:"Title",init:function(b){b.endround=function(){this.evade=0;0<this.focus&&
log("["+this.name+"] keeps focus tokens");this.showinfo()}},unique:!0,done:!0,points:3,ship:"HWK-290"},{name:"ST-321",type:"Title",done:!0,init:function(b){var c=b.candotarget;b.candotarget=function(){c.call(this);return!0};b.resolvetarget=function(){var b,c=[];for(b=0;b<squadron.length;b++)squadron[b].team!=this.team&&c.push(squadron[b]);return 0<c.length?(log("[ST-321] can target any unit on area"),this.resolveactionselection(c,function(b){this.addtarget(c[b]);this.endaction()}.bind(this)),!0):
!1}},unique:!0,points:3,ship:"Lambda-Class Shuttle"},{name:"Royal Guard TIE",type:"Title",done:!0,upgrades:["Mod"],skillmin:5,points:0,ship:"TIE Interceptor"},{name:"A-Wing Test Pilot",type:"Title",done:!0,upgrades:["Elite"],skillmin:2,points:0,ship:"A-Wing",special_case:"A-Wing Test Pilot"},{name:"Outrider",type:"Title",done:!0,init:function(b){var c;for(c=0;c<b.weapons.length;c++)if("Cannon"==b.weapons[c].type){b.weapons[0].isactive=!1;log("["+this.name+"] setting primary weapon inactive");b.weapons[c].isTurret=
function(){return!0};log("["+this.name+"] can fire in 360 degrees");break}},unique:!0,points:5,ship:"YT-2400"},{name:"Dauntless",type:"Title",unique:!0,points:2,ship:"VT-49 Decimator"},{name:"Virago",type:"Title",done:!0,upgrades:["Illicit","System"],unique:!0,points:1,skillmin:4,ship:"StarViper"},{name:"'Heavy Scyk' Interceptor",done:!0,upgrades:["Cannon|Torpedo|Missile"],type:"Title",points:2,ship:"M3-A Interceptor"},{name:"IG-2000",type:"Title",points:0,ship:"Aggressor"},{name:"BTL-A4 Y-Wing",
type:"Title",done:!0,init:function(b){var c;for(c=0;c<b.weapons.length&&"Turret"!=b.weapons[c].type;c++);c!=b.weapons.length&&(b.weapons[c].isTurret=function(){return!1},b.isTurret=function(e){return e==b.weapons[c]?!1:Unit.prototype.isTurret(e)},b.endattack=function(b,c){var g;Unit.prototype.endattack.call(this,b,c);for(g=0;g<this.weapons.length&&"Turret"!=this.weapons[g].type;g++);g<this.weapons.length&&2>this.hasfired&&this.weapons[this.activeweapon].isprimary&&(log("[BTL-A4 Y-Wing] "+this.name+
" attacks again with secondary weapon"),this.selecttargetforattack(g))})},points:0,ship:"Y-Wing"},{name:"Andrasta",type:"Title",done:!0,upgrades:["Bomb","Bomb"],unique:!0,points:0,ship:"Firespray-31"},{name:"TIE/x1",type:"Title",done:!0,upgrades:["System"],pointsupg:-4,points:0,ship:"TIE Advanced"}];
