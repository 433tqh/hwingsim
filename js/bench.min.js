var ROCKIMG="png/asteroid.jpg",OBSTACLES=[],PX=[300,500,300,500,300,500],PY=[250,250,400,400,550,550],id=0;function loadrock(b,c){var f,g=[],h;PATTERN=b.image(ROCKIMG,0,0,200,200).pattern(0,0,200,200);if(""!=c)for(h=c.split(";"),f=0;6>f;f++)g[f]=Base64.toCoord(h[f]);else for(f=0;6>f;f++)g[f]=[0,0,0];for(f=1;6>=f;f++)(function(b){Snap.load("data/rock"+b+".svg",function(c){OBSTACLES.push(new Rock(c,g[b-1]))})})(f)}
function saverock(){var b,c=OBSTACLES[0].toASCII();for(b=1;6>b;b++)c+=";"+OBSTACLES[b].toASCII();return c}function getid(){return id++}
function Rock(b,c){var f,g=getid();this.g=b.select("path");this.g.attr({fill:PATTERN,strokeWidth:0,stroke:"#F00"});this.o=[];this.name="Asteroid #"+g;this.arraypts=[];for(f=0;f<this.g.getTotalLength();f+=5)this.arraypts.push(this.g.getPointAtLength(f));this.dragged=!1;this.tx=c[0];this.ty=c[1];this.alpha=c[2];this.m=(new Snap.Matrix).translate(c[0]+PX[g],c[1]+PY[g]).rotate(c[2],0,0).scale(.5,.5);this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this));this.path="";
this.g.hover(function(){this.g.attr({strokeWidth:4})}.bind(this),function(){this.g.attr({strokeWidth:0})}.bind(this));this.g.addClass("unit");g=this.g.getBBox();this.o=[];for(f=1;4>f;f++)this.o[f]=s.ellipse(g.x+g.width/2,g.y+g.height/2,200*f+g.width/2,200*f+g.height/2).attr({pointerEvents:"none",display:"none",fill:WHITE,opacity:.3,strokeWidth:2});this.g.transform("t "+-g.width/2+" "+-g.height/2);this.getOutlineString();this.show()}
Rock.prototype={toASCII:function(){return Base64.fromCoord([this.tx,this.ty,this.alpha])},getrangeallunits:function(){return Unit.prototype.getrangeallunits.call(this)},getrange:function(b){return Unit.prototype.getrange.call(this,b)},gethitrangeallunits:function(){return[[],[],[],[]]},togglehitsector:function(){},togglerange:function(){},getOutlinePoints:function(){var b,c=[];for(b=0;b<this.arraypts.length;b+=5)c.push(transformPoint(this.m,this.arraypts[b]));c.obstacle=!0;return c},getBox:function(){},
getOutline:function(){var b=s.path(this.path);b.appendTo(s);return b},getOutlineString:function(){var b,c=[];this.path="M ";for(b=0;b<this.arraypts.length;b+=5){var f=transformPoint(this.m,this.arraypts[b]);c.push(f);this.path+=f.x+" "+f.y+" ";0==b&&(this.path+="L ")}this.path+="Z";return{s:this.path,p:c}},turn:function(b){this.m.add(MR(b,0,0));this.alpha+=b;this.show()},unselect:function(){},select:function(){if(phase==SETUP_PHASE){var b=activeunit;activeunit=this;b.unselect();this.showpanel()}},
showpanel:function(){Unit.prototype.showpanel.call(this)},dragmove:function(b,c,f,g){Unit.prototype.dragmove.call(this,b,c,f,g)},dragstart:function(b,c,f){var g=activeunit;activeunit=this;g.unselect();Unit.prototype.dragstart.call(this,b,c,f);this.dragshow()},dragshow:function(){for(var b=1;4>b;b++)this.o[b].transform(this.dragMatrix).attr({display:"block"}).appendTo(VIEWPORT);this.g.transform(this.dragMatrix);this.g.appendTo(VIEWPORT)},showhitsector:function(){},dragstop:function(b){for(var c=1;4>
c;c++)this.o[c].attr({display:"none"});Unit.prototype.dragstop.call(this,b)},show:function(){this.g.transform(this.m);this.g.appendTo(VIEWPORT)}};function Critical(b,c){this.lethal=!1;$.extend(this,CRITICAL_DECK[c]);this.no=this.name+c;b.criticals.push(this);this.isactive=!1;this.unit=b}
Critical.prototype={toString:function(){var b;if(!this.isactive)return"";var c=this.name;"undefined"!=typeof CRIT_translation[this.name].name&&(c=CRIT_translation[this.name].name);b="<td class='tdstat'>"+c+"</td>";c="";"undefined"!=typeof CRIT_translation[this.name].text&&(c=formatstring(CRIT_translation[this.name].text));d="<td class='tooltip outoverflow'>"+c+"</td>";return 1==this.unit.team?"<tr >"+b+"<td><code class='Criticalupg upgrades'></code></td>"+d+"</tr>":"<tr ><td><code class='Criticalupg upgrades'></code></td>"+
b+d+"</tr>"}};
var CRITICAL_DECK=[{type:"ship",count:2,name:"Structural Damage",faceup:function(){this.unit.log("Critical: %0",this.name);this.isactive=!0;this.unit.wrap_after("getagility",this,function(b){return 0<b?b-1:b})},facedown:function(){this.isactive&&(this.unit.getagility.unwrap(this),this.log("%0 repaired",this.name),this.unit.showstats());this.isactive=!1},action:function(b){"hit"==this.unit.rollattackdie(1)[0]?this.facedown():this.log("%0 not repaired ",this.name);this.unit.endaction(b,"CRITICAL")}},
{type:"ship",name:"Damaged Engine",count:1,faceup:function(){this.unit.log("Critical: %0",this.name);this.isactive=!0;var b=[];this.unit.wrap_after("getdial",this,function(c){if(0==b.length)for(var f=0;f<c.length;f++)b[f]={move:c[f].move,difficulty:c[f].difficulty},c[f].move.match("TLd|TRd")&&(b[f].difficulty="RED");return b})},facedown:function(){this.isactive&&this.unit.getdial.unwrap(this);this.isactive=!1}},{type:"ship",name:"Console Fire",count:2,lethal:!0,faceup:function(){this.unit.log("Critical: %0",
this.name);this.isactive=!0;this.unit.wrap_before("begincombatphase",this,function(){"hit"==this.rollattackdie(1)[0]&&(this.log("+1 %HIT% [%0]",this.name),this.resolvehit(1),this.checkdead())}.bind(this.unit))},action:function(b){this.facedown();this.unit.endaction(b,"CRITICAL")},facedown:function(){this.isactive&&(log("Console no longer in fire for "+this.unit.name),this.unit.begincombatphase.unwrap(this));this.isactive=!1}},{type:"ship",count:2,name:"Weapon Malfunction",faceup:function(){this.unit.log("Critical: %0",
this.name);this.isactive=!0;for(var b=0;b<this.unit.weapons.length&&!this.unit.weapons[b].isprimary;b++);this.w=this.unit.weapons[b];this.w.wrap_after("getattack",this,function(b){return 0<b?b-1:b})},facedown:function(){this.isactive&&(this.w.getattack.unwrap(this),this.log("%0 repaired",this.w.name),this.isactive=!1)},action:function(b){var c=this.unit.rollattackdie(1)[0];"critical"==c||"hit"==c?this.facedown():log("Primary weapon for "+this.unit.name+" not functioning.");this.unit.endaction(b,"CRITICAL")}},
{type:"ship",count:2,name:"Damaged Sensor Array",faceup:function(){this.unit.log("Critical: %0",this.name);this.isactive=!0;this.unit.wrap_after("getactionbarlist",this,function(){return[]})},facedown:function(){this.isactive&&(this.unit.getshipactionlist.unwrap(this),log("%0 repaired",this.name),this.isactive=!1)},action:function(b){"hit"==this.unit.rollattackdie(1)[0]?this.facedown():log("Sensor array still damaged for "+this.unit.name);this.unit.endaction(b,"CRITICAL")}},{name:"Minor Explosion",
count:2,type:"ship",lethal:!0,faceup:function(){this.unit.log("Critical: %0",this.name);var b=this.unit.rollattackdie(1)[0];this.isactive=!1;"hit"==b&&this.unit.removehull(1)},facedown:function(){this.isactive=!1}},{name:"Thrust Control Fire",count:2,type:"ship",faceup:function(){this.unit.log("Critical: %0",this.name);this.unit.addstress();this.isactive=!1},facedown:function(){this.isactive=!1}},{name:"Direct Hit!",count:7,type:"ship",lethal:!0,faceup:function(){this.unit.log("Critical: %0",this.name);
this.unit.removehull(1)},facedown:function(){this.isactive=!1;this.unit.hull++}},{name:"Munitions Failure",count:2,type:"ship",lethal:!0,faceup:function(){this.unit.log("Critical: %0",this.name);var b=[];for(i=0;i<this.unit.weapons.length;i++)this.unit.weapons[i].isprimary||b.push(this.unit.weapons[i]);this.isactive=!1;if(0!=b.length){var c=this.unit.rand(b.length);this.wp=b[c];this.wp.isactive=!1;log(this.wp.name+" not functioning anymore for "+this.unit.name);this.unit.show()}},facedown:function(){this.isactive=
!1}},{name:"Minor Hull Breach",count:2,type:"ship",lethal:!0,faceup:function(){var b=this;this.unit.log("Critical: %0",this.name);this.isactive=!0;this.hd=this.unit.handledifficulty;this.unit.wrap_after("handledifficulty",this,function(c){"hit"==this.rollattackdie(1)[0]&&"RED"==c&&(this.log("+1 %HIT% [%0]",b.name),this.removehull(1))})},facedown:function(){this.isactive&&(this.unit.handledifficulty.unwrap(this),this.isactive=!1,this.log("%0 repaired",this.name))}},{name:"Damaged Cockpit",count:2,
type:"pilot",faceup:function(){this.unit.log("Critical: %0",this.name);this.isactive=!0;this.skill=this.unit.skill;this.unit.wrap_before_once("endround",this,function(){this.skill=0;filltabskill();this.showstats()}.bind(this.unit))},facedown:function(){this.isactive&&(this.isactive=!1,this.unit.skill=this.skill,filltabskill(),this.unit.showstats())}},{name:"Blinded Pilot",count:2,type:"pilot",faceup:function(){var b=this;this.unit.log("Critical: %0",this.name);this.isactive=!0;this.unit.wrap_after("getattackstrength",
this,function(b,f,g){return 0});this.unit.wrap_before("cleanupattack",this,function(){this.getattackstrength.unwrap(b);this.cleanupattack.unwrap(b);b.isactive=!1})},facedown:function(){this.isactive=!1}},{name:"Injured Pilot",count:2,type:"pilot",lethal:!0,faceup:function(){this.unit.log("Critical: %0",this.name);var b;this.isactive=!0;for(b=0;b<this.unit.upgrades.length;b++){var c=this.unit.upgrades[b];"Elite"==c.type&&(c.isactive=!1)}this.old={};for(b in this.unit)"function"==typeof this.unit[b]&&
(this.old[b]=this.unit[b],delete this.unit[b]);TEAMS[this.unit.team].isia&&$.extend(this.unit,IAUnit.prototype);this.unit.show()},facedown:function(){if(this.isactive){for(var b in this.old)"function"==typeof this.old[b]&&(this.unit[b]=this.old[b]);for(b=0;b<this.unit.upgrades.length;b++){var c=this.unit.upgrades[b];"Elite"==c.type&&(c.isactive=!0)}this.unit.show()}this.isactive=!1}},{name:"Stunned Pilot",count:2,type:"pilot",lethal:!0,faceup:function(){var b=this;this.unit.log("Critical: %0",this.name);
this.isactive=!0;this.unit.wrap_before("resolvecollision",this,function(){this.removehull(1);this.log("+1 %HIT% [%0]",b.name)});this.unit.wrap_before("resolveocollision",this,function(){this.removehull(1);this.log("+1 %HIT% [%0]",b.name)})},facedown:function(){this.isactive&&(this.unit.unwrap("resolvecollision",this),this.unit.unwrap("resolveocollision",this),this.log("no longer stunned"))}}],s,GREEN="#0F0",RED="#F00",WHITE="#FFF",BLUE="#0AF",YELLOW="#FF0",GREY="#888",HALFGREEN="#080",HALFRED="#800",
HALFWHITE="#888",HALFBLUE="#058",HALFYELLOW="#880",HALFGREY="#444",TIMEANIM=1E3,FACE=["focus","hit","critical","evade","blank"],ATTACKDICE=[0,0,1,1,1,2,4,4],DEFENSEDICE=[0,0,3,3,3,4,4,4],MPOS={F0:[0,3],F1:[1,3],F2:[2,3],F3:[3,3],F4:[4,3],F5:[5,3],BL1:[1,2],BL2:[2,2],BL3:[3,2],TL1:[1,1],TL2:[2,1],TL3:[3,1],BR1:[1,4],BR2:[2,4],BR3:[3,4],TR1:[1,5],TR2:[2,5],TR3:[3,5],K1:[1,6],K2:[2,6],K3:[3,6],K4:[4,5],K5:[5,5],SL2:[2,0],SL3:[3,0],SR2:[2,6],SR3:[3,6],TRL3:[3,0],TRR3:[3,6]},REBEL="REBEL",EMPIRE="EMPIRE",
SCUM="SCUM",ILLICIT="Illicit",ELITE="Elite",TURRET="Turret",MISSILE="Missile",ASTROMECH="Astromech",TORPEDO="Torpedo",CANNON="Cannon",BOMB="Bomb",TECH="Tech",CREW="Crew",SYSTEM="System",SALVAGED="Salvaged",MOD="Mod",TITLE="Title",NOLOG=!1,generics=[],gid=0,ATTACKREROLLA=[],DEFENSEREROLLD=[],ATTACKMODA=[],ATTACKMODD=[],DEFENSEMODD=[],DEFENSEADD=[],xws_lookup=function(b){for(var c in PILOT_dict)if(PILOT_dict[c]==b)return c;return""},upg_lookup=function(b){for(var c in UPGRADE_dict)if(UPGRADE_dict[c]==
b)return c;return""},activeunit,unitlist,pilotlist,squadron=[],active=0,globalid=1,targetunit,PATTERN,SOUND_FILES="ogg/EXPLODE3 ogg/KX9_laser_cannon ogg/TIE-Fire ogg/Slave1-Guns ogg/Falcon-Guns ogg/XWing-Fly1 ogg/TIE-Fly2 ogg/Slave1-Fly1 ogg/Falcon-Fly1 ogg/Falcon-Fly3 ogg/YWing-Fly2 ogg/ISD-Fly ogg/missile ogg/XWing-Fly2 ogg/DStar-Gun4 ogg/TIE-Fly6 ogg/Slave1-Fly2 ogg/ghost".split(" "),SOUNDS={},SOUND_NAMES="explode xwing_fire tie_fire slave_fire falcon_fire xwing_fly tie_fly slave_fly falcon_fly yt2400_fly ywing_fly isd_fly missile xwing2_fly dstar_gun tie2_fly slave2_fly ghost".split(" ");
function loadsound(){var b;for(b=0;b<SOUND_FILES.length;b++)SOUNDS[SOUND_NAMES[b]]=new buzz.sound(SOUND_FILES[b],{formats:["ogg","wav"],preload:!0});SOUNDS.cloak=new buzz.sound("ogg/cloak_romulan",{formats:["ogg","mp3"],preload:!0});SOUNDS.decloak=new buzz.sound("ogg/decloak_romulan",{formats:["ogg","mp3"],preload:!0})}function transformPoint(b,c){return{x:c.x*b.a+c.y*b.c+b.e,y:c.x*b.b+c.y*b.d+b.f}}
function halftone(b){return b==GREEN?HALFGREEN:b==RED?HALFRED:b==WHITE?HALFWHITE:b==BLUE?HALFBLUE:b==YELLOW?HALFYELLOW:b==GREY?HALFGREY:b}
var MS=function(b,c){return(new Snap.Matrix).scale(b,c)},MT=function(b,c){return(new Snap.Matrix).translate(b,c)},MR=function(b,c,f){return(new Snap.Matrix).rotate(b,c,f)},C={GREEN:"#0F0",RED:"#F00",WHITE:"#FFF"},P,A={ROLL:{key:"r",color:GREEN},SLAM:{key:"s",color:BLUE},FOCUS:{key:"f",color:GREEN},TARGET:{key:"l",color:BLUE},EVADE:{key:"e",color:GREEN},BOOST:{key:"b",color:GREEN},STRESS:{key:"?",color:RED},CLOAK:{key:"k",color:BLUE},ISTARGETED:{key:"l",color:RED},ASTROMECH:{key:"A",color:YELLOW},
CANNON:{key:"C",color:YELLOW},CREW:{key:"W",color:YELLOW},MISSILE:{key:"M",color:YELLOW},TORPEDO:{key:"P",color:YELLOW},ELITE:{key:"E",color:YELLOW},TURRET:{key:"U",color:YELLOW},UPGRADE:{key:"S",color:YELLOW},CRITICAL:{key:"c",color:RED},SALVAGED:{key:"V",color:YELLOW},BOMB:{key:"B",color:YELLOW},TITLE:{key:"t",color:YELLOW},MOD:{key:"m",color:YELLOW},SYSTEM:{key:"S",color:YELLOW},ILLICIT:{key:"I",color:YELLOW},LASER:{key:"%",color:RED},TURRETLASER:{key:"$",color:RED},BILASER:{key:"%",color:RED},
LASER180:{key:"%",color:RED},NOTHING:{key:"&nbsp;",color:WHITE},HIT:{key:"d",color:WHITE},SHIELD:{key:"v",color:YELLOW},TECH:{key:"X",color:WHITE}},AINDEX="ROLL FOCUS TARGET EVADE BOOST STRESS CLOAK ISTARGETED ASTRO CANNON CREW MISSILE TORPEDO ELITE TURRET UPGRADE CRITICAL NOTHING".split(" ");function repeat(b,c){if(1>c)return"";for(var f="";1<c;)c&1&&(f+=b),c>>=1,b+=b;return f+b}function dist(b,c){return(b.x-c.x)*(b.x-c.x)+(b.y-c.y)*(b.y-c.y)}
function Unit(b,c){var f;this.dead=!1;this.ship={};f=this.id=gid;generics["u"+gid]=this;gid++;this.maxupg=[];this.exclupg=[];this.team=b;this.faction=TEAMS[b].faction;this.shipactionList=[];this.dial=[];this.ordnance=!1;this.dialselect="<table class='dial' id='dial"+f+"'></table>";this.text="<span id='text"+f+"' class='details'></span>";this.upgradesno=0;this.upgrades=[];this.criticals=[];this.DEFENSEREROLLD=[];this.ATTACKREROLLA=[];this.ATTACKMODA=[];this.ATTACKADD=[];this.DEFENSEMODD=[];this.DEFENSEADD=
[];this.tx=this.ty=this.alpha=0;if("undefined"==typeof PILOTS[c])console.log("pilot does not exists "+c);else{var g=unitlist[PILOTS[c].unit];this.ship={shield:g.shield,hull:g.hull,firesnd:g.firesnd,flysnd:g.flysnd,name:PILOTS[c].unit,hastitle:g.hastitle};this.shipimg=g.img[0];this.scale=g.scale;this.islarge=1==g.islarge?!0:!1;this.hull=g.hull;this.shield=g.shield;this.agility=g.evade;for(f=0;f<g.dial.length;f++)this.dial[f]={move:g.dial[f].move,difficulty:g.dial[f].difficulty};this.shipactionList=
g.actionList.slice(0);this.weapons=[];this.upgrades=[];this.criticals=[];this.bombs=[];this.lastdrop=-1;Laser(this,g.weapon_type,g.fire);this.name=PILOTS[c].name;this.pilotid=c;this.unique=1==PILOTS[c].unique?!0:!1;this.skill=PILOTS[c].skill;this.install="undefined"!=typeof PILOTS[c].install?PILOTS[c].install:function(){};this.uninstall="undefined"!=typeof PILOTS[c].uninstall?PILOTS[c].uninstall:function(){};f=PILOTS[c].upgrades;this.upg=[];this.upgbonus=[];for(j=0;10>j;j++)this.upg[j]=-1;this.upgradetype=
[];for(k=0;k<f.length;k++)this.upgradetype[k]=f[k];this.upgradetype[k++]=MOD;unitlist[this.ship.name].hastitle&&(this.upgradetype[k++]=TITLE);this.upgradesno=k;this.points=PILOTS[c].points;this.install(this);TEAMS[this.team].updatepoints()}}
Unit.prototype={tosquadron:function(b){var c=this.upg;this.activeweapon=this.usedweapon=-1;this.touching=[];this.action=this.maneuver=-1;this.actionsdone=[];this.actiondone=this.hasdecloaked=this.hasmoved=!1;this.focus=this.reroll=0;this.lastmaneuver=-1;this.iscloaked=!1;this.istargeted=[];this.targeting=[];this.criticalresolved=this.hitresolved=this.hasfired=this.evade=this.ionized=this.stress=0;this.m=new Snap.Matrix;this.collision=!1;this.ocollision={overlap:-1,template:[],mine:[]};var f=[];for(j in c)-1<
c[j]&&f.push(Upgradefromid(this,c[j]));for(j=0;j<f.length;j++)"function"==typeof f[j].init&&f[j].init(this);this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;c=this.shipimg;this.islarge?this.img="undefined"==typeof c?b.text(0,0,this.ship.code).transform("r -90 0 0 "+("EMPIRE"==this.faction||"SCUM"==this.faction?"s 2 -2":"s 2 2")+"t -15 5").attr({class:"xwingship"}):b.image("png/"+this.shipimg,-50*this.scale,-50*this.scale,100*this.scale,100*this.scale).transform("r 90 0 0"):
("undefined"!=typeof this.shipimg&&(c=this.shipimg),this.img="undefined"==typeof c?b.text(-10,10,this.ship.code).transform("r -90 0 0 "+("EMPIRE"==this.faction||"SCUM"==this.faction?"r -1 1":"")).attr({class:"xwingship"}):b.image("png/"+c,-20*this.scale,-20*this.scale,40*this.scale,40*this.scale).transform("r 90 0 0"));this.imgsmoke=b.image("png/smoke.gif",-20,-60,30,50).transform("r 180 0 0").attr({display:"none"});this.imgflame=b.image("png/out.gif",-15,-40,20,40).transform("r 180 0 0").attr({display:"none"});
c=this.islarge?40:20;this.outline=b.rect(-c,-c,2*c,2*c).attr({fill:"rgba(8,8,8,0.5)",strokeWidth:2});this.skillbar=b.text(1-c,3-c,repeat("u",this.skill)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#fa0"});this.firebar=b.text(1-c,5-c,repeat("u",this.weapons[0].attack)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#f00"});this.evadebar=b.text(1-c,7-c,repeat("u",this.agility)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#0f0"});this.hullbar=b.text(1-c,9-c,repeat("u",this.hull)).transform("r -90 0 0").attr({class:"xsymbols",
fill:"#cc0"});this.shieldbar=b.text(1-c,9-c,repeat("u",this.shield+this.hull)).transform("r -90 0 0").attr({class:"xsymbols",fill:"#0af"});this.gstat=b.group(this.skillbar,this.firebar,this.evadebar,this.shieldbar,this.hullbar);this.dialspeed=b.text(2+c,3-c,"").attr({class:"dialspeed"});this.dialdirection=b.text(c+8,3-c,"").attr({class:"symbols"});this.actionicon=b.text(c+2,-7,"").attr({class:"symbols",strokeWidth:0});this.sector=b.polygon(3-c,-c,0,0,c-3,-c).attr({fill:this.color,opacity:.5,strokeWidth:0});
this.ranges=[];this.sectors=[];this.infoicon=[];for(f=0;4>f;f++)this.infoicon[f]=b.text(c-7,6-c+7*f,A[AINDEX[f+2]].key).attr({class:"xsymbols",fill:A[AINDEX[f+2]].color,strokeWidth:0});this.geffect=b.group(this.imgflame,this.imgsmoke);this.g=b.group(this.sector,this.outline,this.img,this.dialspeed,this.dialdirection,this.actionicon,this.infoicon[0],this.infoicon[1],this.infoicon[2],this.infoicon[3],this.gstat);VIEWPORT.add(this.g);VIEWPORT.add(this.geffect);this.g.addClass("unit");this.g.hover(function(){var b=
VIEWPORT.m.clone(),c=$("#svgout").width(),f=$("#svgout").height(),m=0,q=0;f>c?q=(f-c)/2:m=(c-f)/2;var r=Math.max(900/c,900/f),t=this.g.getBBox(),f=$("#svgout").position();Math.min($("#playmat").width(),$("#playmat").height());c=b.x(t.x,t.y-20)/r;c+=f.left+m;b=b.y(t.x,t.y-20)/r;b+=f.top+q;q=this.name;m=PILOT_translation[this.name+("SCUM"==this.faction?" (Scum)":"")];"undefined"!=typeof m&&"undefined"!=typeof m.name&&(q=m.name);$(".info").css({left:c,top:b}).html(q).appendTo("body").show()}.bind(this),
function(){$(".info").hide()}.bind(this));this.setdefaultclickhandler();this.upgrades.sort(function(b,c){var f=(b.isWeapon()?4:0)+(b.isBomb()?1:0);return(c.isWeapon()?4:0)+(c.isBomb()?1:0)-f});this.g.drag(this.dragmove.bind(this),this.dragstart.bind(this),this.dragstop.bind(this));this.addstdmod()},wrap_after:function(b,c,f,g){var h=this,l=h[b],m=function(){var b=Array.prototype.slice.call(arguments),c;c=l.apply(this,b);return c=f.apply(this,b.concat([c]))};m.save=l;m.org=c;m.unwrapper=function(b){var f=
h.wrap_before(b,c,function(b){m.unwrap(c);f.unwrap(c);return b})};m.unwrap=function(c){m.org==c||"function"!=typeof m.save.unwrap?(h[b]=m.save,"function"==typeof g&&g.call(h),"getskill"==b&&filltabskill(),h.show()):m.save=m.save.unwrap(c);h.show();return m.save};this[b]=m;"getskill"==b&&filltabskill();return m},wrap_before_once:function(b,c,f){var g=this,h=g[b],l=function(){var b=Array.prototype.slice.call(arguments);l.unwrap(c);f.apply(this,b);return h.apply(this,b)};l.save=h;l.org=c;l.unwrap=function(c){g[b]=
l.save};return this[b]=l},wrap_before:function(b,c,f,g){var h=this,l=h[b],m=function(){var b=Array.prototype.slice.call(arguments);f.apply(this,b);return l.apply(this,b)};m.save=l;m.org=c;m.unwrapper=function(b){var f=h.wrap_before(b,c,function(){m.unwrap(c);f.unwrap(c)})};m.unwrap=function(c){m.org==c||"function"!=typeof m.save.unwrap?(h[b]=m.save,"function"==typeof g&&g.call(h),h.show()):m.save=m.save.unwrap(c);return m.save};return this[b]=m},toJSON:function(){var b={};b.name=xws_lookup(this.name);
b.points=PILOTS[this.pilotid].points;b.ship=xws_lookup(this.ship.name);for(var c={},f={},g=0;g<this.upg.length;g++){var h=this.upg[g];if(-1!=h){var l=UPGRADES[h];"undefined"==typeof c[upg_lookup(l.type)]&&(c[upg_lookup(l.type)]=[]);b.points+=l.points;if("undefined"!=typeof UPGRADES[h].pointsupg)for(var m=0;m<UPGRADES[h].upgrades.length;m++)f[UPGRADES[h].upgrades[m]]=UPGRADES[h].pointsupg;c[upg_lookup(l.type)].push(upg_lookup(l.name))}}for(g=0;g<this.upg.length;g++)h=this.upg[g],-1!=h&&"undefined"!=
typeof f[UPGRADES[h].type]&&(l=f[UPGRADES[h].type],b.points=0<UPGRADES[h].points+l?b.points+l:b.points-UPGRADES[h].points);this.points=b.points;b.upgrades=c;return b},toJuggler:function(b){var c="",c=PILOT_translation[this.name+("SCUM"==this.faction?" (Scum)":"")],c=1!=b||"undefined"==typeof c||"undefined"==typeof c.name?this.name.replace(/\'/g,""):c.name.replace(/\'/g,"");1==PILOTS[this.pilotid].ambiguous&&(c=c+"("+this.ship.name+")");for(var f=0;f<this.upg.length;f++){var g=this.upg[f];-1<g&&(g=
UPGRADES[g].name+("Crew"==UPGRADES[g].type?"(Crew)":""),c=1==b&&"undefined"!=typeof UPGRADE_translation[g]&&"undefined"!=typeof UPGRADE_translation[g].name?c+(" + "+UPGRADE_translation[g].name.replace(/\(Crew\)/g,"").replace(/\'/g,"")):c+(" + "+g.replace(/\(Crew\)/g,"").replace(/\'/g,"")))}return c},toASCII:function(){var b;b=""+Base64.fromNumber(this.pilotid);for(var c=0;c<this.upg.length;c++){var f=this.upg[c];-1<f&&(b+=","+Base64.fromNumber(f))}return b+="%"+Base64.fromCoord([this.tx,this.ty,this.alpha])},
toString2:function(){var b=currentteam.faction,c=SHIP_translation[this.ship.name];"undefined"==typeof c&&(c=this.ship.name);if(phase==CREATION_PHASE){var f=PILOTS[this.pilotid].dict;1==PILOTS[this.pilotid].ambiguous&&(f+="-"+unitlist[this.ship.name].dict);b=""+("<img class='headimg' src='png/"+b+"/"+f+".png'>")+("<table><tr><td class='statskill'>"+this.getskill()+"</td><td class='shipname'>"+getpilottranslation(this.name,b)+"</td><td>(<span class='pts'>"+this.points+"</span>)</td><td><code class='close' data="+
this.id+" title='Remove'>&#xd7;</code></td></tr></table>");b+="<table><tr>";b+="<td onclick='switchdialimg(true)' class='shipimg' rowspan='4' style='background-image:url(png/"+this.shipimg+")'>";b+=this.getstatstring();b+="</td>";b+="<td onclick='switchdialimg(false)' class='shipdial' rowspan='4'><table>";b+=this.getdialstring();b+="</table></td>";b+="<td>"+c+"</td></tr>";b+="<tr><td class='actionlist'>";b+=this.getactionstring();b+="</td></tr></table>";b+="<table class='upgs'>";b+="<tr><td colspan=3 class='upgavail'>";
b+=this.getupgradeaddstring();b+="</td></tr><tr>";b+="<td colspan=3 class='upg'></td>";return b+="<tbody class='upglist'></tbody></table>"}},getstatstring:function(){var b;b=""+("<div class='xsymbols RED'>"+repeat("u",this.weapons[0].getattack())+"</div>");b+="<div class='xsymbols GREEN'>"+repeat("u",this.getagility())+"</div>";b+="<div class='xsymbols YELLOW'>"+repeat("u",this.hull)+"</div>";return b+="<div class='xsymbols BLUE'>"+repeat("u",this.shield)+"</div>"},getupgradeaddstring:function(){for(var b=
"",c=0;c<this.upgradetype.length;c++)-1==this.upg[c]&&(b+="<button num="+c+" class='upgrades "+this.upgradetype[c]+"'>+</button>");return b},showskill:function(){$("#unit"+this.id+" .statskill").html(this.getskill())},showupgradeadd:function(){$("#unit"+this.id+" .upgavail").html(this.getupgradeaddstring());addupgradeaddhandler(this)},getagility:function(){return this.agility},getskill:function(){return this.skill},getdial:function(){return 0<this.ionized&&!this.islarge||1<this.ionized?[{move:"F1",
difficulty:"WHITE"}]:this.dial},doplan:function(){this.showdial();return this.deferred},getdialstring:function(){var b=[],c="";for(j=0;5>=j;j++)for(b[j]=[],k=0;6>=k;k++)b[j][k]="<td></td>";var f=this.getdial();for(j=0;j<f.length;j++)d=f[j],b[MPOS[d.move][0]][MPOS[d.move][1]]="<td class='symbols "+d.difficulty+"' >"+P[d.move].key+"</td>";for(j=5;0<=j;j--){c+="<tr>";c=0<j&&5>j?c+("<td>"+j+"</td>"):c+"<td></td>";for(k=0;6>=k;k++)c+=b[j][k];c+="</tr>\n"}return c},canreveal:function(b){return"RED"!=b.difficulty||
0==this.stress},showdial:function(){var b=[],c,f,g=this.getdial();if(phase==PLANNING_PHASE||phase==SELECT_PHASE||phase==CREATION_PHASE){for(c=0;5>=c;c++)for(b[c]=[],f=0;6>=f;f++)b[c][f]="<td></td>";$("#select"+this.id).val();for(c=0;c<g.length;c++){f=g[c];var h=MPOS[f.move][0],l=MPOS[f.move][1];this.canreveal(f)?(b[h][l]="<td",phase==PLANNING_PHASE&&(b[h][l]+=" onclick='activeunit.setmaneuver("+c+")'"),b[h][l]+=" class='symbols maneuver "+f.difficulty,this.maneuver==c&&(b[h][l]+=" selected"),b[h][l]+=
"' >"+P[f.move].key+"</td>"):b[h][l]="<td></td>"}g="";for(c=5;0<=c;c--){g+="<tr>";g=0<c&&5>c?g+("<td>"+c+"</td>"):g+"<td></td>";for(f=0;6>=f;f++)g+=b[c][f];g+="</tr>\n"}phase==SELECT_PHASE||phase==CREATION_PHASE?$("#dial"+this.id).html(g):$("#maneuverdial").html(g)}phase>=PLANNING_PHASE&&(-1==this.maneuver||this.hasmoved)&&(this.dialspeed.attr({text:""}),this.dialdirection.attr({text:""}))},getupgradelist:function(b){for(var c=[],f=0;f<UPGRADES.length;f++){var g=UPGRADES[f];"undefined"!=typeof g.faction&&
g.faction!=this.faction||"undefined"!=typeof g.ship&&-1==this.ship.name.search(g.ship)||"undefined"!=typeof g.ishuge||"undefined"!=typeof g.islarge&&1!=this.islarge||"undefined"!=typeof g.skillmin&&this.getskill()<g.skillmin||"undefined"!=typeof g.noupgrades&&-1<this.upgradetype.indexOf(g.noupgrades)||"undefined"!=typeof g.actionrequired&&-1==this.shipactionList.indexOf(g.actionrequired.toUpperCase())||"undefined"!=typeof this.maxupg[g.type]&&this.maxupg[g.type]<g.points||!b.match(g.type)||1==g.takesdouble&&
this.upgradetype.indexOf(g.type)==this.upgradetype.lastIndexOf(g.type)||c.push(f)}return c},turn:function(b){this.m.rotate(b,0,0);this.show()},getactionstring:function(){for(var b="",c=0;c<this.shipactionList.length;c++)b+="<span class='GREEN symbols'>"+A[this.shipactionList[c]].key+"</span>&nbsp;";return b},showactionlist:function(){var b=this.getactionstring();$("#unit"+this.id+" .actionlist").html(b)},getattacktable:function(b){return ATTACK[b]},attackroll:function(b){var c,f,g,h,l=this.getattacktable(b),
m=0,q=Math.random();record(this.id,q,"attackroll");if(0==b)return 0;for(f=0;f<=b;f++)for(g=0;g<=b-f;g++)for(h=0;h<=b-f-g;h++)if(c=f*FCH_FOCUS+g+FCH_CRIT*h,m+=l[c],m>q)return FCH_FOCUS*f+h*FCH_CRIT+g;return 0},rollattackdie:function(b){for(var c=[],f=0;f<b;f++)c.push(FACE[ATTACKDICE[this.rand(8)]]);return c},rolldefensedie:function(b){for(var c=[],f=0;f<b;f++)c.push(FACE[DEFENSEDICE[this.rand(8)]]);return c},rand:function(b){return Math.floor(Math.random()*b)},getdefensetable:function(b){return DEFENSE[b]},
defenseroll:function(b){var c,f,g,h=$.Deferred(),l=this.getdefensetable(b),m=0,q=Math.random();record(this.id,q,"defenseroll");if(0==b)return h.resolve({dice:b,roll:0}).promise();"undefined"==typeof l&&console.log("P undefined for n="+b);for(g=0;g<=b;g++)for(f=0;f<=b-g;f++)if(c=g*FE_FOCUS+f*FE_EVADE,m+=l[c],m>q)return h.resolve({dice:b,roll:FE_FOCUS*g+f*FE_EVADE}).promise();return h.resolve({dice:b,roll:0}).promise()},addattackrerolla:function(b,c,f,g){this.ATTACKREROLLA.push({org:b,type:c,n:f,req:g})},
addglobalattackrerolla:function(b,c,f,g){ATTACKREROLLA.push({org:b,type:c,n:f,req:g})},adddefensererolld:function(b,c,f,g){this.DEFENSEREROLLD.push({org:b,type:c,n:f,req:g})},addglobaldefensereroll:function(b,c,f,g){DEFENSEREROLLD.push({org:b,type:c,n:f,req:g})},addattackmoda:function(b,c,f,g,h,l){g?ATTACKMODA.push({org:b,req:c,f:f,str:h,token:l}):this.ATTACKMODA.push({org:b,req:c,f:f,str:h,token:l})},addattackmodd:function(b,c,f,g){ATTACKMODD.push({org:b,req:c,f:f,str:g})},addattackadd:function(b,
c,f,g){this.ATTACKADD.push({org:b,req:c,f:f,str:g})},adddefenseadd:function(b,c,f,g,h){this.DEFENSEADD.push({org:b,req:c,f:f,str:g,token:h})},adddefensemodd:function(b,c,f,g,h,l){g?DEFENSEMODD.push({org:b,req:c,f:f,str:h,token:l}):this.DEFENSEMODD.push({org:b,req:c,f:f,str:h,token:l})},setclickhandler:function(b){this.g.unmousedown();this.g.mousedown(b)},setdefaultclickhandler:function(){this.g.unmousedown();this.g.mousedown(function(){this.select()}.bind(this))},dragshow:function(){this.g.transform(this.dragMatrix);
this.geffect.transform(this.dragMatrix)},dragmove:function(b,c,f,g){f=VIEWPORT.m.split();g=Math.max(900/$("#svgout").width(),900/$("#svgout").height());b=b*g/f.scalex;c=c*g/f.scalex;this.dragMatrix=MT(b,c).add(this.m);this.dx=b;this.dy=c;this.dragged=!0;$(".phasepanel").hide();this.dragshow()},dragstart:function(b,c,f){this.showhitsector(!1);this.dragMatrix=this.m;this.dragged=!1},dragstop:function(b){this.dragged&&(this.m=this.dragMatrix,this.showpanel(),this.tx+=this.dx,this.ty+=this.dy);this.dragged=
!1},isinzone:function(b){b=this.getOutlinePoints(b);var c,f;c="undefined"!=typeof SETUP.playzone1&&1==this.team?SETUP.playzone1:SETUP.playzone;for(f=0;4>f;f++)if(!Snap.path.isPointInside(c,b[f].x,b[f].y))return!1;return!0},getOutlinePoints:function(b){var c=this.islarge?40:20;"undefined"==typeof b&&(b=this.m);var f={x:b.x(-c,-c),y:b.y(-c,-c)},g={x:b.x(c,-c),y:b.y(c,-c)},h={x:b.x(c,c),y:b.y(c,c)};b={x:b.x(-c,c),y:b.y(-c,c)};return[f,g,h,b]},getOutlineString:function(b){b=this.getOutlinePoints(b);return{s:"M "+
b[0].x+" "+b[0].y+" L "+b[1].x+" "+b[1].y+" "+b[2].x+" "+b[2].y+" "+b[3].x+" "+b[3].y+" Z",p:b}},getOutline:function(b){var c=this.islarge?40:20,f=s.rect(-c,-c,2*c,2*c),c=s.text(c+8,3-c,"8").attr({class:"symbols",fontSize:"1.3em"});return s.g(c,f).transform(b).attr({fill:this.color,opacity:.3,display:"none"})},getRangeString:function(b,c){var f=this.islarge?40:20,g=" A "+100*b+" "+100*b+" 0 0 1 ",h=transformPoint(c,{x:-f,y:-100*b-f}),l=transformPoint(c,{x:f,y:-100*b-f}),m=transformPoint(c,{x:100*
b+1+f,y:-f}),q=transformPoint(c,{x:100*b+1+f,y:f}),r=transformPoint(c,{x:f,y:100*b+1+f}),t=transformPoint(c,{x:-f,y:100*b+1+f}),v=transformPoint(c,{x:-100*b-f-1,y:f}),f=transformPoint(c,{x:-100*b-f-1,y:-f});return"M "+l.x+" "+l.y+g+m.x+" "+m.y+" L "+q.x+" "+q.y+g+r.x+" "+r.y+" L "+t.x+" "+t.y+g+v.x+" "+v.y+" L "+f.x+" "+f.y+g+h.x+" "+h.y+" Z"},getHalfRangeString:function(b,c){var f=this.islarge?40:20,g=" A "+100*b+" "+100*b+" 0 0 0 ",h=transformPoint(c,{x:100*b+1+f,y:0}),l=transformPoint(c,{x:100*
b+1+f,y:-f}),m=transformPoint(c,{x:f,y:-100*b-1-f}),q=transformPoint(c,{x:-f,y:-100*b-1-f}),r=transformPoint(c,{x:-100*b-f-1,y:-f}),f=transformPoint(c,{x:-100*b-f-1,y:0});return"M "+h.x+" "+h.y+" L "+l.x+" "+l.y+g+m.x+" "+m.y+" L "+q.x+" "+q.y+g+r.x+" "+r.y+" L "+f.x+" "+f.y+" "+h.x+" "+h.y},getSubRangeString:function(b,c,f){var g=this.islarge?40:20,h=" A "+100*b+" "+100*b+" 0 0 1 ",l=transformPoint(f,{x:-g,y:-100*b-g}),m=transformPoint(f,{x:g,y:-100*b-g});transformPoint(f,{x:50*b+g,y:-100*b-g});
transformPoint(f,{x:100*b+g,y:-50*b-g});var q=transformPoint(f,{x:100*b+g,y:-g}),r=transformPoint(f,{x:100*b+g,y:g}),t=transformPoint(f,{x:g,y:100*b+g}),v=transformPoint(f,{x:-g,y:100*b+g}),x=transformPoint(f,{x:-100*b-g,y:g});b=transformPoint(f,{x:-100*b-g,y:-g});var y="M "+l.x+" "+l.y+" L "+m.x+" "+m.y+h+q.x+" "+q.y+" L "+r.x+" "+r.y+h+t.x+" "+t.y+" L "+v.x+" "+v.y+h+x.x+" "+x.y+" L "+b.x+" "+b.y+h+l.x+" "+l.y,h=" A "+100*c+" "+100*c+" 0 0 0 ",l=transformPoint(f,{x:-g,y:-100*c-g}),m=transformPoint(f,
{x:g,y:-100*c-g}),q=transformPoint(f,{x:100*c+g,y:-g}),r=transformPoint(f,{x:100*c+g,y:g}),t=transformPoint(f,{x:g,y:100*c+g}),v=transformPoint(f,{x:-g,y:100*c+g}),x=transformPoint(f,{x:-100*c-g,y:g});b=transformPoint(f,{x:-100*c-g,y:-g});return y+=" L "+l.x+" "+l.y+h+b.x+" "+b.y+" L "+x.x+" "+x.y+h+v.x+" "+v.y+" L "+t.x+" "+t.y+h+r.x+" "+r.y+" L "+q.x+" "+q.y+h+m.x+" "+m.y+" L "+l.x+" "+l.y},getHalfSubRangeString:function(b,c,f){var g=this.islarge?40:20,h=" A "+100*b+" "+100*b+" 0 0 0 ",l=transformPoint(f,
{x:100*b+g,y:0}),m=transformPoint(f,{x:100*b+g,y:-g}),q=transformPoint(f,{x:g,y:-100*b-g}),r=transformPoint(f,{x:-g,y:-100*b-g}),t=transformPoint(f,{x:-100*b-g,y:-g});b=transformPoint(f,{x:-100*b-g,y:0});var v="M "+l.x+" "+l.y+" L "+m.x+" "+m.y+h+q.x+" "+q.y+" L "+r.x+" "+r.y+h+t.x+" "+t.y+" L "+b.x+" "+b.y,h=" A "+100*c+" "+100*c+" 0 0 1 ",l=transformPoint(f,{x:100*c+g,y:0}),m=transformPoint(f,{x:100*c+g,y:-g}),q=transformPoint(f,{x:g,y:-100*c-g}),r=transformPoint(f,{x:-g,y:-100*c-g}),t=transformPoint(f,
{x:-100*c-g,y:-g});b=transformPoint(f,{x:-100*c-g,y:0});return v+=" L "+b.x+" "+b.y+" L "+t.x+" "+t.y+h+r.x+" "+r.y+" L "+q.x+" "+q.y+h+m.x+" "+m.y+" L "+l.x+" "+l.y+" Z"},getPrimarySectorString:function(b,c){var f=this.getSectorPoints(b,c),g=" A "+100*b+" "+100*b+" 0 0 1 ",h=transformPoint(c,{x:0,y:0});return"M "+h.x+" "+h.y+" L "+f[0].x+" "+f[0].y+g+f[1].x+" "+f[1].y+" L "+f[2].x+" "+f[2].y+g+f[3].x+" "+f[3].y+" Z"},getPrimarySubSectorString:function(b,c,f){var g=" A "+100*b+" "+100*b+" 0 0 1 ";
b=this.getSectorPoints(b,f);var h="M "+b[0].x+" "+b[0].y+g+b[1].x+" "+b[1].y+" L "+b[2].x+" "+b[2].y+g+b[3].x+" "+b[3].y;b=this.getSectorPoints(c,f);g=" A "+100*c+" "+100*c+" 0 0 0 ";return h+="L "+b[3].x+" "+b[3].y+g+b[2].x+" "+b[2].y+" L "+b[1].x+" "+b[1].y+g+b[0].x+" "+b[0].y+" Z"},getSectorPoints:function(b,c){var f=this.islarge?40:20,g=Math.sqrt((f-3)*(f-3)+f*f),h=transformPoint(c,{x:-(g+100*b)/Math.sqrt(1+f*f/(f-3)/(f-3)),y:-(g+100*b)/Math.sqrt(1+(f-3)*(f-3)/f/f)}),l=transformPoint(c,{x:-f+
3,y:-f-100*b-1}),m=transformPoint(c,{x:f-3,y:-f-100*b-1}),f=transformPoint(c,{x:(g+100*b)/Math.sqrt(1+f*f/(f-3)/(f-3)),y:-(g+2+100*b)/Math.sqrt(1+(f-3)*(f-3)/f/f)});return[h,l,m,f]},setmaneuver:function(b){this.lastmaneuver=this.maneuver;this.maneuver=b;record(this.id,b,"setmaneuver");this.showdial();this.showmaneuver();"undefined"==typeof this.deferred&&this.log("undefined deferred");this.deferred.notify()},select:function(){if(this.dead)return activeunit;if(phase<ACTIVATION_PHASE||phase==ACTIVATION_PHASE||
phase==COMBAT_PHASE){var b=activeunit;activeunit=this;b!=this&&b.unselect();$("#"+this.id).addClass("selected");record(this.id,0,"select");this.show();center(this)}return activeunit},unselect:function(){this!=activeunit&&($("#"+this.id).removeClass("selected"),this.showoutline(),this.showmaneuver())},getmcollisions:function(b){var c=[],f=[],g=[],f=this.getOutlineString(b),c=f.s,f=f.p;for(b=6;b<OBSTACLES.length;b++){var h=OBSTACLES[b].getOutlineString();if(0<Snap.path.intersection(h.s,c).length||this.isPointInside(h.s,
f)||this.isPointInside(c,h.p)){g.push(b);break}}return g},getocollisions:function(b,c,f,g){var h,l=[];h=[];var m=[],q={overlap:-1,template:[],mine:[]};c=this.getOutlineString(c);h=c.s;m=c.p;for(c=0;c<OBSTACLES.length;c++){var r=OBSTACLES[c].getOutlineString();if(0<Snap.path.intersection(r.s,h).length||this.isPointInside(r.s,m)||this.isPointInside(h,r.p)){6>c?q.overlap=c:q.mine.push(OBSTACLES[c]);break}}if("undefined"!=typeof f){for(h=0;h<=g;h++)c=f.getPointAtLength(h),l.push({x:b.x(c.x,c.y),y:b.y(c.x,
c.y)});for(b=0;b<l.length;b++)for(c=0;c<OBSTACLES.length;c++)if(c!=q.overlap&&-1==q.template.indexOf(c)&&-1==q.mine.indexOf(OBSTACLES[c]))for(f=OBSTACLES[c].getOutlineString().p,h=0;h<f.length;h++)if(g=f[h].x-l[b].x,m=f[h].y-l[b].y,100>=g*g+m*m){6>c?q.template.push(c):q.mine.push(OBSTACLES[c]);break}}return q},iscollidingunit:function(b,c){var f=this.getOutlineString(b).s,g=c.getOutlineString(c.m).s,h=0<Snap.path.intersection(f,g).length;this.islarge&&(h=h||this.isinoutline(f,c,c.m));c.islarge&&(h=
h||c.isinoutline(g,this,b));return h},getcollidingunits:function(b){var c,f=[];for(c in squadron){var g=squadron[c];g!=this&&this.iscollidingunit(b,g)&&f.push(g)}return f},getpathmatrix:function(b,c){var f=P[c].path,g=f.getTotalLength();this.islarge&&(g+=40);g=this.getmatrixwithmove(b,f,g);c.match(/K\d|SR\d|SL\d/)&&g.rotate(180,0,0);c.match(/TRL\d/)&&g.rotate(-90,0,0);c.match(/TRR\d/)&&g.rotate(90,0,0);f.remove();return g},getmovecolor:function(b,c,f,g,h){var l;if(!this.isinzone(b))return RED;var m=
this.getOutlineString(b);if(f&&(b=this.getocollisions(this.m,b,g,h),-1<b.overlap||0<b.mine.length||0<b.template.length))return YELLOW;if(c)for(l in squadron)if(c=squadron[l],b=c.m,c!=this&&(b=c.getOutlineString(b),0<Snap.path.intersection(b.s,m.s).length||this.islarge&&!c.islarge&&this.isPointInside(m.s,b.p)||!this.islarge&&c.islarge&&this.isPointInside(b.s,m.p)))return WHITE;return GREEN},isTurret:function(b){return"Turretlaser"==b.type},candoactivation:function(){return-1!=this.maneuver},newaction:function(b,
c){return{action:b,org:this,type:c,name:c}},getactionbarlist:function(){var b,c=[];for(b=0;b<this.shipactionList.length;b++){var f=this.shipactionList[b];if(-1==this.actionsdone.indexOf(f))switch(f){case "CLOAK":this.candocloak()&&c.push(this.newaction(this.addcloak,"CLOAK"));break;case "FOCUS":this.candofocus()&&c.push(this.newaction(this.addfocus,"FOCUS"));break;case "EVADE":this.candoevade()&&c.push(this.newaction(this.addevade,"EVADE"));break;case "TARGET":this.candotarget()&&c.push(this.newaction(this.resolvetarget,
"TARGET"));break;case "BOOST":c.push(this.newaction(this.resolveboost,"BOOST"));break;case "ROLL":c.push(this.newaction(this.resolveroll,"ROLL"));break;case "SLAM":c.push(this.newaction(this.resolveslam,"SLAM"))}}return c},getupgactionlist:function(){var b,c=[];for(b=0;b<this.upgrades.length;b++){var f=this.upgrades[b];-1==this.actionsdone.indexOf(f.name)&&f.isactive&&"function"==typeof f.action&&f.candoaction()&&c.push({org:f,action:f.action,type:f.type.toUpperCase(),name:f.name})}return c},getcritactionlist:function(){var b,
c=[];for(b=0;b<this.criticals.length;b++){var f=this.criticals[b];-1==this.actionsdone.indexOf(f.name)&&f.isactive&&"function"==typeof f.action&&(f.type="CRITICAL",f.org=f,c.push(f))}return c},getactionlist:function(){var b=this.getactionbarlist(),c=this.getupgactionlist(),f=this.getcritactionlist();return b.concat(c).concat(f)},addevadetoken:function(){this.evade++;this.show()},addevade:function(b){this.addevadetoken();this.endaction(b,"EVADE")},addfocustoken:function(){this.focus++;this.show()},
addfocus:function(b){this.addfocustoken();this.endaction(b,"FOCUS")},addstress:function(){this.stress++;this.show()},addiontoken:function(){this.ionized++;this.show()},removeiontoken:function(){this.ionized--;this.show()},dies:function(){var b;$("#"+this.id).attr("onclick","");$("#"+this.id).addClass("dead");$("#"+this.id).html(""+this);b=squadron.indexOf(this);for(b in squadron)if(squadron[b]==this){delete squadron[b];break}filltabskill();for(b=0;b<this.targeting.length;b++){var c=this.targeting[b];
n=c.istargeted.indexOf(this);-1<n&&c.istargeted.splice(n,1);c.show()}for(b=0;b<this.istargeted.length;b++)c=this.istargeted[b],n=c.targeting.indexOf(this),-1<n&&c.targeting.splice(n,1),c.show();this.targeting=[];this.g.attr({display:"none"});this.imgsmoke.attr("display","none");this.imgflame.attr("display","none");this.imgexplosion=this.islarge?s.image("png/explosion3.gif",-80,-80,160,160):s.image("png/explosion3.gif#"+Math.random(),-40,-40,80,80);this.geffect.add(this.imgexplosion);this.show();this.dead=
!0;SOUNDS.explode.play();this.log("has exploded!");setTimeout(function(){this.m=MT(-60,-60);this.geffect.attr({display:"none"});this.show();TEAMS[this.team].checkdead()&&win()}.bind(this),1E3)},canbedestroyed:function(){return skillturn!=this.getskill()?!0:!1},checkdead:function(){if(!this.dead&&(0>=this.hull||!this.isinzone(this.m))){this.dies();var b=TEAMS[this.team].history.rawdata;"undefined"==typeof b[round]&&(b[round]={hits:0,dead:""});b[round].dead+=this.name+" ";return!0}return!1},cancelhit:function(b,
c){var f=FCH_hit(b.ch);return f>=b.e?{ch:b.ch-b.e*FCH_HIT,e:0}:{ch:b.ch-f*FCH_HIT,e:b.e-f}},cancelcritical:function(b,c){var f=FCH_crit(b.ch);return f>=b.e?{ch:b.ch-b.e*FCH_CRIT,e:0}:{ch:b.ch-f*FCH_CRIT,e:b.e-f}},evadeattack:function(b){var c=getdefenseresult(),f=b.weapons[b.activeweapon].modifydamagegiven(getattackresult()),c=this.cancelhit({ch:f,e:c},b),c=this.cancelcritical(c,b);return c.ch},declareattack:function(b,c){targetunit=c;this.activeweapon=b;this.weapons[b].declareattack(c);this.log("attacks %0 with %1",
c.name,this.weapons[b].name);c.isattackedby(b,this)},isattackedby:function(b,c){},modifydamageassigned:function(b,c){return b},resolveishit:function(){},hashit:function(b){return 0<this.criticalresolved+this.hitresolved},resolvedamage:function(){this.fireline.remove();this.playfiresnd();var b=targetunit.evadeattack(this),b=this.weapons[this.activeweapon].modifydamageassigned(b,targetunit),b=targetunit.modifydamageassigned(b,this),c=FCH_crit(b),b=FCH_hit(b);this.hasdamaged=!0;this.hitresolved=b;this.criticalresolved=
c;this.hashit(targetunit)&&(this.hitresolved+this.criticalresolved<targetunit.shield?targetunit.log("-%0 %SHIELD%",this.criticalresolved+this.hitresolved):0<targetunit.shield&&targetunit.log("-%0 %SHIELD%",targetunit.shield),targetunit.resolveishit(this),this.weapons[this.activeweapon].prehit(targetunit,c,b),this.hitresolved=targetunit.resolvehit(this.hitresolved),this.criticalresolved=targetunit.resolvecritical(this.criticalresolved),this.weapons[this.activeweapon].posthit(targetunit,c,b));targetunit.endbeingattacked(c,
b);this.weapons[this.activeweapon].endattack(c,b);this.usedweapon=this.activeweapon;this.endattack(c,b);targetunit.canbedestroyed(skillturn)&&targetunit.checkdead();this.cleanupattack()},cleanupattack:function(){this.actionbarrier()},endround:function(){for(var b=0;b<this.upgrades.length;b++)this.upgrades[b].endround();this.hasfired=this.focus=this.evade=0;this.ocollision.overlap=-1;this.ocollision.template=[];this.ocollision.mine=[];this.collision=!1;this.touching=[];this.showinfo()},playfiresnd:function(){var b=
targetunit.g.getBBox(),c=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)}),f=s.path("M "+c.x+" "+c.y+" L "+(b.x+b.w/2)+" "+(b.y+b.h/2)).appendTo(VIEWPORT).attr({stroke:this.color,strokeWidth:2}),g=setInterval(function(){f.remove();clearInterval(g)},200);"undefined"!=typeof this.weapons[this.activeweapon].firesnd?SOUNDS[this.weapons[this.activeweapon].firesnd].play():SOUNDS[this.ship.firesnd].play()},endattack:function(b,c){for(i=0;i<DICES.length;i++)$("."+DICES[i]+"dice").remove();this.show()},
endbeingattacked:function(b,c){this.show()},showpositions:function(b){var c,f=[];for(c=0;c<b.length;c++)f[c]=this.getOutline(b[c].m).attr({title:b[c].move,opacity:.4,fill:halftone(b[c].color),display:"block",class:"possible"}).appendTo(VIEWPORT),function(c){f[c].hover(function(){f[c].attr({stroke:b[c].color,strokeWidth:4})}.bind(this),function(){f[c].attr({strokeWidth:0})}.bind(this))}.call(this,c)},showmeanposition:function(){this.getdial();this.evaluatemoves(!0,!0);this.showpositions([{color:GREEN,
move:"mean",m:this.meanm}])},shownextpositions:function(){var b=this.getdial();this.evaluatemoves(!0,!0);var c=[];for(i=0;i<b.length;i++)c[i]=b[i].next;this.showpositions(c)},showpossiblepositions:function(){this.evaluatemoves(!0,!0);var b=this.getdial();this.showpositions(b)},evaluateposition:function(){var b=0,c=0,f=0,g,h,l=0;NOLOG=!0;for(h in squadron){var m=squadron[h];if(m.team!=this.team){var q=0,r=m.m;m.m=m.meanm;for(g=0;g<m.weapons.length;g++){var t=m.weapons[g].getrange(this);0<t&&4>t&&(q=
Math.max(q,m.getattackstrength(g,this)))}b+=q;for(g=0;g<this.weapons.length;g++)q=this.weapons[g].getrange(m),0<q&&4>q&&(c=Math.max(c,this.getattackstrength(g,m)));l+=this.getdist(this.m,m)/9E4;m.m=r;f++}}NOLOG=!1;return c-b-l/f},evaluatemoves:function(b,c){this.meanmround=round;var f=this.getdial(),g=0,h=0,l=0,m=0,q,r=function(b,c){return b==RED||b==YELLOW&&(c==GREEN||c==WHITE)||b==WHITE&&c==GREEN?b:c},t=function(b,c){return r(b,c)==b?c:b};NOLOG=!0;for(q=0;q<f.length;q++){var v=this.getpathmatrix(this.m,
f[q].move);f[q].m=v;if(this.canreveal(f[q])){var x=RED;f[q].color=this.getmovecolor(v,b,c);if(f[q].color!=RED&&b&&c){for(j=0;j<f.length;j++)if(!("F0"==f[j].move||"RED"==f[j].difficulty&&(0<this.stress&&"GREEN"!=f[q].difficulty||"RED"==f[q].difficulty)))var y=this.getpathmatrix(v,f[j].move),x=t(x,this.getmovecolor(y,!1,!1));"F0"!=f[q].move&&(f[q].color=r(x,f[q].color))}}else f[q].color=RED;f[q].color!=GREEN||f[q].move.match(/K\d|SR\d|SL\d|TRL\d|TRR\d/)||(v=v.split(),m++,g+=v.dx,h+=v.dy,l+=(v.rotate+
360)%360)}0==m&&(m=1);g/=m;h/=m;l/=m;this.meanm=(new Snap.Matrix).translate(g,h).rotate(l,0,0);NOLOG=!1},usestress:function(b){},removetarget:function(b){var c;c=b.istargeted.indexOf(this);-1<c&&b.istargeted.splice(c,1);this.targeting.splice(b);b.show();this.show();0==this.targeting.length&&$("#atokens > .xtargettoken").remove()},usetarget:function(){return phase==COMBAT_PHASE&&activeunit==this&&-1<this.targeting.indexOf(targetunit)?(this.removetarget(targetunit),reroll(10,!0,99,""),!0):!1},useevade:function(){phase==
COMBAT_PHASE&&this==targetunit&&(this.removeevadetoken(),this.show(),$("#dtokens > .xevadetoken").remove(),$("#defense").prepend("<td class='evadegreen'></td>"))},removeevadetoken:function(){this.evade--;this.show()},removefocustoken:function(){this.focus--;this.show()},resolveactionmove:function(b,c,f,g){var h;this.pos=[];var l=function(b,c,g){record(this.id,c,"resolveactionmove");for(h=0;h<this.pos.length;h++)this.pos[h].ol.remove();f&&(this.m=b);var l=this.getmcollisions(this.m);if(0<l.length)for(h=
0;h<l.length;h++)OBSTACLES[l[h]].detonate(this);f&&this.movelog({move:b.toTransformString()});g(this,c);this.show()}.bind(this);"undefined"==typeof g&&(g=!1);for(h=b.length-1;0<=h;h--)if(g||this.getmovecolor(b[h],!0,!0)==GREEN)p=this.getOutline(b[h]).attr({display:"block"}).appendTo(VIEWPORT),this.pos.push({ol:p,k:h});if(0<this.pos.length)if(1==this.pos.length)l(b[this.pos[0].k],this.pos[0].k,c);else for(h=0;h<this.pos.length;h++)(function(f){var g=this.pos[f];g.ol.hover(function(){this.pos[f].ol.attr({stroke:this.color,
strokeWidth:4})}.bind(this),function(){this.pos[f].ol.attr({strokeWidth:0})}.bind(this));g.ol.click(function(){l(b[this.pos[f].k],this.pos[f].k,c)}.bind(this))}).call(this,h);else l(this.m,-1,c)},resolveactionselection:function(b,c){var f;this.pos=[];var g=function(g){record(this.id,g,"resolveactionselection");for(f=0;f<b.length;f++)b[f].outline.attr({fill:"rgba(8,8,8,0.5)"}),b[f].setdefaultclickhandler();c(g)}.bind(this);if(0==b.length)g(-1);else if(1==b.length)g(0);else for(f=0;f<b.length;f++)b[f].outline.attr({fill:"rgba(100,100,100,0.8)"}),
function(c){b[c].setclickhandler(function(){g(c)})}(f)},getboostmatrix:function(b){return[this.getpathmatrix(this.m,"F1"),this.getpathmatrix(this.m,"BL1"),this.getpathmatrix(this.m,"BR1")]},resolveboost:function(b){this.resolveactionmove(this.getboostmatrix(this.m),function(c,f){c.endaction(b,"BOOST")},!0,!1)},getdecloakmatrix:function(b){var c=this.getpathmatrix(this.m.clone().rotate(90,0,0),"F2").translate(0,this.islarge?20:0).rotate(-90,0,0),f=this.getpathmatrix(this.m.clone().rotate(-90,0,0),
"F2").translate(0,this.islarge?20:0).rotate(90,0,0);return[b.clone(),c.clone().translate(0,-20),c,c.clone().translate(0,20),f.clone().translate(0,-20),f,f.clone().translate(0,20),this.getpathmatrix(b.clone(),"F2")]},resolvedecloak:function(){this.doselection(function(b){this.resolveactionmove(this.getdecloakmatrix(this.m),function(c,f){0<f&&(c.agility-=2,c.iscloaked=!1,SOUNDS.decloak.play());this.hasdecloaked=!0;this.endnoaction(b,"")}.bind(this),!0,!1)}.bind(this));return!0},getrollmatrix:function(b){b=
this.getpathmatrix(this.m.clone().rotate(90,0,0),"F1").translate(0,this.islarge?20:0).rotate(-90,0,0);var c=this.getpathmatrix(this.m.clone().rotate(-90,0,0),"F1").translate(0,this.islarge?20:0).rotate(90,0,0);return[b.clone().translate(0,-20),b,b.clone().translate(0,20),c.clone().translate(0,-20),c,c.clone().translate(0,20)]},resolveroll:function(b){this.resolveactionmove(this.getrollmatrix(this.m),function(c,f){c.endaction(b,"ROLL")},!0,!1)},boundtargets:function(b){if(-1<this.targeting.indexOf(b))return!0;
for(b=0;b<this.targeting.length;b++)this.removetarget(this.targeting[b]);return!1},addtarget:function(b){this.boundtargets(b)||(this.targeting.push(b),b.istargeted.push(this),b.show(),this.show())},gettargetableunits:function(b){var c=[],f;for(f in squadron)squadron[f].team!=this.team&&this.getrange(squadron[f])<=b&&c.push(squadron[f]);return c},selectnearbyunits:function(b,c){var f=[],g;for(g in squadron)c(this,squadron[g])&&this.getrange(squadron[g])<=b&&f.push(squadron[g]);return f},selectnearbyally:function(b){return this.selectnearbyunits(b,
function(b,f){return b.team==f.team&&b!=f})},selectnearbyenemy:function(b){return this.selectnearbyunits(b,function(b,f){return b.team!=f.team})},resolvetarget:function(b){var c=this.gettargetableunits(3);this.resolveactionselection(c,function(f){0<=f&&this.addtarget(c[f]);this.endaction(b,"TARGET")}.bind(this))},addcloaktoken:function(){this.iscloaked=!0;this.agility+=2;SOUNDS.cloak.play()},addcloak:function(b){this.addcloaktoken();this.endaction(b,"CLOAK")},resolveslam:function(b){var c=this.getdial();
c.length<=this.lastmaneuver&&(this.lastmaneuver=0);for(var f=c[this.lastmaneuver].move.substr(-1),g=[],h=[],l=0;l<c.length;l++)c[l].move.substr(-1)==f&&(g.push(this.getpathmatrix(this.m,c[l].move)),h.push(l));this.log("select maneuver for SLAM");var m=this.endmaneuver,q=this.timeformaneuver;this.timeformaneuver=function(){return!0};this.endmaneuver=function(){this.endaction(b,"SLAM");this.endmaneuver=m;this.timeformaneuver=q};var r=this.canfire;this.canfire=function(){this.canfire=r;return!1};this.resolveactionmove(g,
function(b,c){this.maneuver=h[c];this.doactivation()}.bind(this),!1,!0)},enqueueaction:function(b,c){actionr.push($.Deferred());var f=actionr.length-1;"undefined"==typeof c&&(c="undefined");actionr[f-1].done(function(){b(f)}.bind(this));return actionr[f]},endnoaction:function(b,c){this.show();actionr[b].resolve(c);b==actionr.length-1&&actionrlock.resolve()},endaction:function(b,c){this.actiondone=!0;this.clearaction();this.endnoaction(b,c)},resolveaction:function(b,c){$("#actiondial").empty();null==
b?this.endaction(c,null):(this.actionsdone.push(b.name),b.action.call(b.org,c))},resolvenoaction:function(b,c){$("#actiondial").empty();null==b?this.endnoaction(c,null):b.action.call(b.org,c)},evaluatetohit:function(b,c){var f=this.gethitrange(b,c);if(c!=this&&3>=f&&0<f){var f=this.getattackstrength(b,c),g=c.getdefensestrength(b,this);-1<this.targeting.indexOf(c)?this.reroll=10:this.reroll=0;return tohitproba(this,c,this.getattacktable(f),c.getdefensetable(g),f,g)}return{proba:[],tohit:0,meanhit:0,
meancritical:0,tokill:0}},isfireobstructed:function(){return-1<this.ocollision.overlap},canfire:function(){return 0==this.hasfired&&!this.iscloaked&&!this.isfireobstructed()},getattackstrength:function(b,c){return this.weapons[b].getattack()+this.weapons[b].getrangeattackbonus(c)},getobstructiondef:function(b){return this.getoutlinerange(this.m,b).o?1:0},getdefensestrength:function(b,c){var f=this.getagility(),g=c.getobstructiondef(this);0<g&&this.log("+%0 defense for obstacle",g);return f+c.weapons[b].getrangedefensebonus(this)+
g},getattackmodtokens:function(b,c){var f="",g,h;for(me in squadron)if(squadron[me]==this)break;for(g=0;g<ATTACKMODA.length;g++){var l=ATTACKMODA[g];l.req(b,c)&&(f+="<td id='moda"+g+"' class='"+l.str+"modtokena' onclick='record("+this.id+","+g+',"attackmodag_'+c+'"); modroll(ATTACKMODA['+g+"].f,"+c+","+g+")' title='modify roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>")}for(g=0;g<ATTACKMODD.length;g++)l=ATTACKMODD[g],l.req(b,c)&&(f+="<td id='moda"+(g+ATTACKMODA.length)+"' class='"+l.str+"modtokend' onclick='record("+
this.id+","+g+',"attackmodd_'+c+'"); modroll(ATTACKMODD['+g+"].f,"+c+","+(g+ATTACKMODA.length)+")' title='modify roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>");g=ATTACKMODA.length+ATTACKMODD.length;for(h=0;h<this.ATTACKMODA.length;h++)if(l=this.ATTACKMODA[h],l.req(b,c)){var m=l.str+"modtokena";"undefined"!=typeof l.token&&(m="x"+l.str+"token");f+="<td id='moda"+(g+h)+"' class='"+m+"' onclick='record("+this.id+","+h+',"attackmoda_'+c+'"); modroll(squadron['+me+"].ATTACKMODA["+h+"].f,"+c+","+
(g+h)+")' title='modify roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>"}g=ATTACKMODA.length+ATTACKMODD.length+this.ATTACKMODA.length;for(h=0;h<this.ATTACKADD.length;h++)l=this.ATTACKADD[h],l.req(b,c)&&(f+="<td id='moda"+(h+g)+"' class='"+l.str+"modtokena' onclick='addroll(squadron["+me+"].ATTACKADD["+h+"].f,"+c+","+(g+h)+")' title='add roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>");return f},getdefensemodtokens:function(b,c){var f="",g,h;for(me in squadron)if(squadron[me]==this)break;
for(g=0;g<DEFENSEMODD.length;g++){var l=DEFENSEMODD[g];l.req(b,c)&&(f+="<td id='modd"+g+"' class='"+l.str+"modtokend' onclick='record("+this.id+","+g+',"defensemoddg_'+c+'"); modrolld(DEFENSEMODD['+g+"].f,"+c+","+g+")' title='modify roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>")}for(h=0;h<this.DEFENSEMODD.length;h++)if(l=this.DEFENSEMODD[h],l.req(b,c)){var m=l.str+"modtokend";"undefined"!=typeof l.token&&(m="x"+l.str+"token");f+="<td id='modd"+(g+h)+"' class='"+m+"' onclick='record("+this.id+
","+h+',"defensemodd_'+c+'"); modrolld(squadron['+me+"].DEFENSEMODD["+h+"].f,"+c+","+(g+h)+")' title='modify roll ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>"}g=DEFENSEMODD.length+this.DEFENSEMODD.length;for(h=0;h<this.DEFENSEADD.length;h++)l=this.DEFENSEADD[h],l.req(b,c)&&(m=l.str+"modtokend","undefined"!=typeof l.token&&(m="x"+l.str+"token"),f+="<td id='modd"+(h+g)+"' class='"+m+"' onclick='record("+this.id+","+h+',"defenseadd_'+c+'"); addrolld(squadron['+me+"].DEFENSEADD["+h+"].f,"+c+","+(g+
h)+")' title='add result ["+l.org.name.replace(/\'/g,"&#39;")+"]'></td>");return f},getattackrerolltokens:function(){for(var b="",c=function(b,c){var f=0,g=b.n();-1<b.type.indexOf("blank")&&(f+=g);-1<b.type.indexOf("focus")&&(f+=10*g);-1<b.type.indexOf("hit")&&(f+=100*g);-1<b.type.indexOf("critical")&&(f+=1E3*g);return"<td id='rerolla"+c+"' class='tokens' onclick='reroll("+g+",true,"+f+","+c+")' title='"+g+" rerolls ["+b.org.name.replace(/\'/g,"&#39;")+"]'>R"+g+"</td>"},f=0;f<ATTACKREROLLA.length;f++){var g=
ATTACKREROLLA[f];g.req(this,this.weapons[this.activeweapon],targetunit)&&(b+=c(g,f))}for(f=0;f<this.ATTACKREROLLA.length;f++)g=this.ATTACKREROLLA[f],g.req(this.weapons[this.activeweapon],targetunit)&&(b+=c(g,f+ATTACKREROLLA.length));return b},getdefensererolltokens:function(){for(var b="",c=function(b,c){var f=0,g=b.n();-1<b.type.indexOf("blank")&&(f+=g);-1<b.type.indexOf("focus")&&(f+=10*g);-1<b.type.indexOf("evade")&&(f+=100*g);return"<td id='rerolld"+c+"' class='tokens' onclick='record(\"defensererolld\","+
c+"); reroll("+g+",false,"+f+","+c+")' title='"+g+" rerolls ["+b.org.name.replace(/\'/g,"&#39;")+"]'>R"+g+"</td>"},f=0;f<DEFENSEREROLLD.length;f++){var g=DEFENSEREROLLD[f];g.req(activeunit,activeunit.weapons[activeunit.activeweapon],this)&&(b+=c(g,f))}for(f=0;f<this.DEFENSEREROLLD.length;f++)g=this.DEFENSEREROLLD[f],g.req(activeunit.weapons[activeunit.activeweapon],activeunit)&&(b+=c(g,f+DEFENSEREROLLD.length));return b},resolveattack:function(b,c){var f;this.gethitrange(b,c);this.hasfired++;this.hasdamaged=
!1;$("#combatdial").show();var g=c.g.getBBox(),h=transformPoint(this.m,{x:0,y:-(this.islarge?40:20)});this.fireline=s.path("M "+h.x+" "+h.y+" L "+(g.x+g.w/2)+" "+(g.y+g.h/2)).attr({stroke:this.color,strokeWidth:2,strokeDasharray:100,"class":"animated"}).appendTo(VIEWPORT);this.select();for(f in squadron)if(squadron[f]==this)break;this.preattackroll(b,c);this.doselection(function(g){var h=this.getattackstrength(b,c),q=c.getdefensestrength(b,this);this.doattackroll(this.attackroll(h),h,q,f,g)}.bind(this),
this.name+" attack")},preattackroll:function(b,c){},doattack:function(b){this.showattack(b)},doattackroll:function(b,c,f,g,h){displayattackroll(b,c);this.ar=b;this.da=c;displayattacktokens(this,function(){record("doattackroll",-1);targetunit.defenseroll(f).done(function(b){targetunit.dodefenseroll(b.roll,b.dice,g,h)})})},dodefenseroll:function(b,c,f,g){this.dr=b;this.dd=c;displaydefenseroll(b,c);displaydefensetokens(this,function(){this.log("firing "+targetunit.name);this.resolvedamage();this.endnoaction(g,
"incombat")}.bind(squadron[f]))},getmatrixwithmove:function(b,c,f){var g=c.getTotalLength();b=b.clone();this.islarge?20>=f?b.translate(0,-f):(g=f>g+20?f-g-20:0,c=c.getPointAtLength(f-g-20),b.translate(c.x,-20+c.y).rotate(c.alpha-90,0,0).translate(0,-g)):(c=c.getPointAtLength(f),b.translate(c.x,c.y).rotate(c.alpha-90,0,0));return b},removestresstoken:function(){0<this.stress&&this.stress--;this.show()},handledifficulty:function(b){"RED"==b?this.addstress():"GREEN"==b&&0<this.stress&&this.removestresstoken()},
completemaneuver:function(b,c,f){var g=P[b].path,h,l;if("F0"==b)this.hasmoved=!0,this.handledifficulty(c),this.lastmaneuver=this.maneuver,this.maneuver=-1,this.show(),this.endmaneuver(),this.touching=[];else{var m=g.getTotalLength();this.collision=!1;this.showhitsector(!1);movePoint=g.getPointAtLength(m);this.islarge&&(m+=40);l=this.m;h=this.getmatrixwithmove(this.m,g,m);var q=this.getcollidingunits(h),r=[];if(0<q.length)for(this.log("collides with %0: no action",q[0].name),this.collision=!0;0<m&&
0<q.length;)r=q,--m,h=this.getmatrixwithmove(this.m,g,m),q=this.getcollidingunits(h);for(i=0;i<this.touching.length;i++)q=this.touching[i],q.touching.splice(q.touching.indexOf(this),1);this.touching=r;this.ocollision=this.getocollisions(l,h,g,m);this.isfireobstructed()&&this.log("overlaps obstacle: no action, cannot attack");0<this.ocollision.template.length&&this.log("template overlaps obstacle: no action");0<m&&this.movelog({len:m,path:$(g.outerSVG()).attr("d")});0<m&&(this.m=h);0<m?(this.hasmoved=
!0,$("#activationdial").empty(),SOUNDS[this.ship.flysnd].play(),Snap.animate(0,m,function(b){h=this.getmatrixwithmove(l,g,b);this.g.transform(h);this.geffect.transform(h)}.bind(this),TIMEANIM*m/200,mina.linear,function(){this.collision||(b.match(/K\d|SR\d|SL\d/)||1==f?(this.movelog({move:"r180 0 0"}),this.m.rotate(180,0,0)):b.match(/TRL\d/)?(this.movelog({move:"r-90 0 0"}),this.m.rotate(-90,0,0)):b.match(/TRR\d/)&&(this.movelog({move:"r90 0 0"}),this.m.rotate(90,0,0)));this.handledifficulty(c);this.lastmaneuver=
this.maneuver;this.maneuver=-1;g.remove();(-1<this.ocollision.overlap||0<this.ocollision.template.length)&&this.resolveocollision();if(0<this.ocollision.mine.length)for(i=0;i<this.ocollision.mine.length;i++)this.ocollision.mine[i].detonate(this);this.collision&&this.resolvecollision();this.endmaneuver();this.show()}.bind(this))):(this.hasmoved=!0,this.log("cannot move"),this.handledifficulty(c),this.lastmaneuver=this.maneuver,this.maneuver=-1,this.show(),g.remove(),this.collision&&this.resolvecollision(),
this.endmaneuver())}},getmaneuverlist:function(){var b=this.getmaneuver(),c={};c[b.move]=b;return"undefined"!=typeof b?c:{}},resolvemaneuver:function(){$("#activationdial").empty();if(!(0>this.maneuver)){var b=[],c=[],f=this.getmaneuverlist(),g;for(g in f)c.push(f[g]),b.push(this.getpathmatrix(this.m,f[g].move));this.resolveactionmove(b,function(b,f){-1==f&&(f=0);var g=c[f].move,q=c[f].difficulty;1!=c[f].halfturn&&(c[f].halfturn=!1);this.completemaneuver(g,q,c[f].halfturn)}.bind(this),!1,!0)}},endmaneuver:function(){this.ionized=
0;this.hasmoved=!0;this.checkdead()?this.shield=this.hull=0:this.doendmaneuveraction();this.actionbarrier()},unlock:function(b){this.deferred.resolve(b)},newlock:function(){this.deferred=$.Deferred();return this.deferred.promise()},enddecloak:function(){return this.newlock()},candomaneuver:function(){return-1<this.maneuver},candoendmaneuveraction:function(){return this.candoaction()&&!this.collision&&0==this.ocollision.template.length&&-1==this.ocollision.overlap},doendmaneuveraction:function(){this.candoendmaneuveraction()?
this.doaction(this.getactionlist()):(this.action=-1,this.actiondone=!0)},doselection:function(b,c){return this.enqueueaction(function(c){b(c)}.bind(this),c)},doaction:function(b,c){return 0==b.length?this.enqueueaction(function(b){this.endnoaction(b)}.bind(this),this.name):this.enqueueaction(function(f){var g;$("#actiondial").empty();if(this.candoaction()){this.select();"undefined"!=typeof c&&this.log(c);$("#actiondial").html($("<div>"));for(g=0;g<b.length;g++)-1==this.actionsdone.indexOf(b[g].name)&&
function(b,c){var g=$("<div>").addClass("symbols").text(A[b.type].key).click(function(){record(this.id,c,"doaction");this.resolveaction(b,f)}.bind(this));$("#actiondial > div").append(g)}.call(this,b[g],g);g=$("<button>").addClass("m-skip").click(function(){record(this.id,-1,"skipaction");this.resolveaction(null,f)}.bind(this));$("#actiondial > div").append(g)}else this.endaction(f)}.bind(this),b[0].name)},donoaction:function(b,c,f){return this.enqueueaction(function(g){var h;"undefined"!=typeof c&&
this.log(c);this.select();$("#actiondial").html($("<div>"));for(h=0;h<b.length;h++)(function(b,c){var f=$("<div>").addClass("symbols").text(A[b.type].key).click(function(){record(this.id,c,"donoaction");this.resolvenoaction(b,g)}.bind(this));$("#actiondial > div").append(f)}).call(this,b[h],h);1==f&&(h=$("<button>").addClass("m-skip").click(function(){record(this.id,-1,"skipnoaction");this.resolvenoaction(null,g)}.bind(this)),$("#actiondial > div").append(h))}.bind(this),b[0].name)},candoaction:function(){return 0==
this.stress},candecloak:function(){return this.iscloaked&&phase==ACTIVATION_PHASE&&!this.hasdecloaked},selecttargetforattack:function(b,c){if("undefined"!=typeof c)return this.declareattack(b,c),this.resolveattack(b,c),!0;var f=this.weapons[b].getenemiesinrange();if(0==f.length)return this.log("no target for %0",this.weapons[b].name),this.cleanupattack(),!1;this.doselection(function(c){this.resolveactionselection(f,function(h){0<=h&&(this.declareattack(b,f[h]),this.resolveattack(b,f[h]));this.endnoaction(c,
"HIT")}.bind(this))}.bind(this));return!0},showattack:function(b){var c="",f=[],g;$("#attackdial").hide();if(1==b||phase==COMBAT_PHASE&&skillturn==this.getskill())if(this.canfire()){g=this.getenemiesinrange();$("#attackdial").empty();for(b=0;b<this.weapons.length;b++)0<g[b].length&&f.push(b);for(g=0;g<f.length;g++)b=A[this.weapons[f[g]].type.toUpperCase()],c+="<div class='symbols "+b.color+"' onclick='record("+this.id+","+g+',"selecttargetforattack"); activeunit.selecttargetforattack('+f[g]+")'>"+
b.key+"</div>";c+="<button class='m-skip' onclick='record("+this.id+',-1,"skiptargetforattack"); activeunit.hasfired++;activeunit.show();activeunit.deferred.resolve();\'></button>';$("#attackdial").html("<div>"+c+"</div>").show()}else this.hasfired||(this.hasfired++,this.deferred.resolve())},candotarget:function(){return 0<this.gettargetableunits(3).length},candofocus:function(){return!0},candoevade:function(){return!0},candropbomb:function(){return this.lastdrop!=round&&this.getskill()==skillturn},
addactivationdial:function(b,c,f,g){this.activationdial.push({pred:b,action:c,html:f,elt:g})},actionbarrier:function(){var b=0;actionrlock=$.Deferred();for(b=0;b<actionr.length&&"pending"!=actionr[b].state();b++);b<actionr.length?actionrlock.done(function(){this.unlock()}.bind(this)):(actionrlock.resolve(),this.unlock())},dodecloak:function(){this.iscloaked?this.resolvedecloak():this.hasdecloaked=!0;this.actionbarrier()},getbomblocation:function(){return["F1"]},getbombposition:function(b,c){for(var f=
[],g=0;g<b.length;g++)f.push(this.getpathmatrix(this.m.clone().rotate(180,0,0),b[g]).translate(0,(this.islarge?40:20)-c));return f},bombdropped:function(){},updateactivationdial:function(){var b=this;this.activationdial=[];if(this.candropbomb()&&0==this.ionized)switch(this.bombs.length){case 3:this.bombs[2].canbedropped()&&this.addactivationdial(function(){return b.bombs[2].canbedropped()},function(){b.doselection(function(c){b.bombs[2].actiondrop(c)})},A.BOMB.key,$("<div>").attr({class:"symbols",
title:b.bombs[2].name}));case 2:this.bombs[1].canbedropped()&&this.addactivationdial(function(){return b.bombs[1].canbedropped()},function(){b.doselection(function(c){b.bombs[1].actiondrop(c)})},A.BOMB.key,$("<div>").attr({class:"symbols",title:b.bombs[1].name}));case 1:this.bombs[0].canbedropped()&&this.addactivationdial(function(){return b.bombs[0].canbedropped()},function(){b.doselection(function(c){b.bombs[0].actiondrop(c)})},A.BOMB.key,$("<div>").attr({class:"symbols",title:b.bombs[0].name}))}return this.activationdial},
doactivation:function(){this.showactivation()},showactivation:function(){$("#activationdial").html("<div></div>");if(this.timeformaneuver()){for(var b=this.updateactivationdial(),c=0;c<b.length;c++){var f=b[c];f.pred()&&f.elt.appendTo("#activationdial > div").click(function(){f.action()}).html(f.html)}$("<button>").addClass("m-move").click(function(){this.resolvemaneuver()}.bind(this)).appendTo("#activationdial > div")}},movelog:function(b){b.id=this.id;ANIM.push(b)},computepoints:function(){},log:function(b,
c,f,g){if(!NOLOG){var h=function(b){return"undefined"!=typeof PILOT_translation[b]&&"undefined"!=typeof PILOT_translation[b].name?PILOT_translation[b].name:"undefined"!=typeof PILOT_translation[b+" (Scum)"]&&"undefined"!=typeof PILOT_translation[b+" (Scum)"].name?PILOT_translation[b+" (Scum)"].name:"undefined"!=typeof UPGRADE_translation[b]&&"undefined"!=typeof UPGRADE_translation[b].name?UPGRADE_translation[b].name:"undefined"!=typeof CRIT_translation[b]&&"undefined"!=typeof CRIT_translation[b].name?
CRIT_translation[b].name:b};"undefined"!=typeof UI_translation[b]&&(b=UI_translation[b]);"string"==typeof c&&(c=h(c));b=b.replace(/%0/g,c);"string"==typeof f&&(f=h(f));b=b.replace(/%1/g,f);"string"==typeof g&&(g=h(g));b=b.replace(/%2/g,g);b=b.replace(/%HIT%/g,"<code class='hit'></code>").replace(/%STRESS%/g,"<code class='xstresstoken'></code>").replace(/%CRIT%/g,"<code class='critical'></code>").replace(/%EVADE%/g,"<code class='xevadetoken'></code>").replace(/%FOCUS%/g,"<code class='xfocustoken'></code>").replace(/%SHIELD%/g,
"<code class='cshield'></code>").replace(/%HULL%/g,"<code class='chull'></code>").replace(/%ROLL%/g,"<code class='symbols'>r</code>").replace(/%TURNLEFT%/g,"<code class='symbols'>4</code>").replace(/%TURNRIGHT%/g,"<code class='symbols'>6</code>").replace(/%BOOST%/g,"<code class='symbols'>b</code>").replace(/%ELITE%/g,"<code class='symbols'>E</code>").replace(/%BOMB%/g,"<code class='symbols'>B</code>").replace(/%STRAIGHT%/g,"<code class='symbols'>8</code>").replace(/%CREW%/g,"<code class='symbols'>C</code>").replace(/%STOP%/g,
"<code class='symbols'>5</code>").replace(/%TARGET%/g,"<code class='symbols'>l</code>").replace(/%TORPEDO%/g,"<code class='symbols'>P</code>").replace(/%CANNON%/g,"<code class='symbols'>C</code>").replace(/%SYSTEM%/g,"<code class='symbols'>S</code>").replace(/%ILLICIT%/g,"<code class='symbols'>I</code>").replace(/%MISSILE%/g,"<code class='symbols'>M</code>").replace(/%TURRET%/g,"<code class='symbols'>U</code>").replace(/%BANKLEFT%/g,"<code class='symbols'>7</code>").replace(/%BANKRIGHT%/g,"<code class='symbols'>9</code>").replace(/%UTURN%/g,
"<code class='symbols'>2</code>").replace(/%SLOOPLEFT%/g,"<code class='symbols'>1</code>").replace(/%SLOOPRIGHT%/g,"<code class='symbols'>3</code>").replace(/%TALONLEFT%/g,"<code class='symbols'>;</code>").replace(/%TALONRIGHT%/g,"<code class='symbols'>:</code>");log("<div><span style='color:"+this.color+"'>["+this.name+"]</span> "+b+"</div>")}},candocloak:function(){return!this.iscloaked},clearaction:function(){this.action=-1},showaction:function(){if(this.action<this.actionList.length&&-1<this.action){var b=
A[this.actionList[this.action].type].color;this.actionicon.attr({fill:this==activeunit?b:halftone(b)})}else this.actionicon.attr({text:""})},showinfo:function(){var b=0,c;0<this.focus&&this.infoicon[b++].attr({text:A.FOCUS.key,fill:A.FOCUS.color});0<this.evade&&this.infoicon[b++].attr({text:A.EVADE.key,fill:A.EVADE.color});1==this.iscloaked&&this.infoicon[b++].attr({text:A.CLOAK.key,fill:A.CLOAK.color});0<this.targeting.length&&this.infoicon[b++].attr({text:A.TARGET.key,fill:A.TARGET.color});0<this.istargeted.length&&
this.infoicon[b++].attr({text:A.ISTARGETED.key,fill:A.ISTARGETED.color});0<this.stress&&this.infoicon[b++].attr({text:A.STRESS.key,fill:A.STRESS.color});0<this.ionized&&this.infoicon[b++].attr({text:"Z",fill:A.STRESS.color});for(c=b;4>c;c++)this.infoicon[b++].attr({text:""})},showoutline:function(){this.outline.attr({stroke:activeunit==this?this.color:halftone(this.color)})},endcombatphase:function(){},endphase:function(){},beginplanningphase:function(){return this.newlock()},beginactivationphase:function(){return this.newlock()},
timetoshowmaneuver:function(){return-1<this.maneuver},getmaneuver:function(){return 0<this.ionized?{move:"F1",difficulty:"WHITE"}:this.getdial()[this.maneuver]},showmaneuver:function(){if(this.timetoshowmaneuver()){var b=this.getmaneuver(),c=C["undefined"!=typeof this.forceddifficulty?this.forceddifficulty:b.difficulty];activeunit!=this&&(c=halftone(c));this.dialspeed.attr({text:P[b.move].speed,fill:c});this.dialdirection.attr({text:P[b.move].key,fill:c})}},beginactivation:function(){this.showmaneuver();
this.show()},endactivationphase:function(){this.actionsdone=[]},begincombatphase:function(){return this.newlock()},beginattack:function(){},toString:function(){if(phase==SELECT_PHASE||phase==CREATION_PHASE)return this.toString2();var b,c=8;b=squadron.indexOf(this);str=-1==b?"<div class='dead '>":"<div>";c+=2*this.upgrades.length;this.hull+this.shield<=c?(str+="<div class='vertical outoverflow stat'>",str+="<div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",
this.shield)+"</div></div>"):this.hull>c?(str+="<div class='vertical outoverflow stat'>",str+="<div class='hull'>"+repeat("u ",c)+"</div></div>",this.hull<=2*c?(str+="<div class='vertical outoverflow stat2'>",str+="<div class='hull'>"+repeat("u ",this.hull-c)+"</div>",this.shield+this.hull<=2*c?str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>":(str+="<div class='shield'>"+repeat("u ",2*c-this.hull)+"</div></div>",str+="<div class='vertical outoverflow stat3'>",str+="<div class='shield'>"+
repeat("u ",this.shield-2*c+this.hull)+"</div></div>")):(str+="<div class='vertical outoverflow stat2'><div class='hull'>"+repeat("u ",c)+"</div></div>",str+="<div class='vertical outoverflow stat3'><div class='hull'>"+repeat("u ",this.hull-2*c)+"</div>",str+="<div class='shield'>"+repeat("u ",this.shield)+"</div></div>")):(str+="<div class='vertical outoverflow stat'><div class='hull'>"+repeat("u ",this.hull)+"</div>",str+="<div class='shield'>"+repeat("u ",c-this.hull)+"</div></div>",str+="<div class='vertical outoverflow stat2'><div class='shield'>"+
repeat("u ",this.shield-c+this.hull)+"</div></div>");str+="<div><div class='statskill'>"+this.getskill()+"</div>";var f=PILOT_translation[this.name+("SCUM"==this.faction?" (Scum)":"")],c=f,c="undefined"==typeof f||"undefined"==typeof f.text?"":"<span>"+formatstring(f.text)+"</span>",f="undefined"==typeof f||"undefined"==typeof f.name?this.name:f.name;str+="<div class='name'>";""!=c&&(str+="<div class='tooltip outoverflow'>"+c+"</div>");str+="<div>"+f+"</div></div>";f=SHIP_translation[this.ship.name];
"undefined"==typeof f&&(f=this.ship.name);str+="<div><div style='font-size:small'><code class='"+this.faction+"'></code>"+f+"</div></div>";str+="<div class='vertical'><div>";-1<b&&(str+="<div><table style='width:100%'><tr style='width:100%'>"+this.getusabletokens()+"</tr></table></div>");str+="</div></div>";var g=f=c="";b="<td><button class='statevade' onclick='if (!squadron["+b+"].dead) squadron["+b+"].togglerange();'>"+this.getagility()+"<span class='symbols'>^</span></button></td>";c=1==this.team?
c+("<tr><td></td>"+b+"</tr>"):c+("<tr>"+b+"<td></td></tr>");for(b=0;b<this.upgrades.length;b++)f+=this.upgrades[b];for(b=0;b<this.criticals.length;b++)g+=this.criticals[b];return str+="<table class='details' style='width:100%'>"+c+f+g+"</table></div>"},canusefocus:function(){return 0<this.focus},canuseevade:function(){return 0<this.evade},canusetarget:function(b){return 0<this.targeting.length&&("undefined"==typeof b||-1<this.targeting.indexOf(b))},addstdmod:function(){this.addattackmoda(this,function(b,
c){return this.canusetarget(targetunit)}.bind(this),function(b,c){this.removetarget(targetunit);var f;f=this.canusefocus()?0:FCH_focus(b);var g=FCH_blank(b,c),g=this.rollattackdie(g+f);b-=f*FCH_FOCUS;for(i=0;i<g.length;i++)"hit"==g[i]&&(b+=FCH_HIT),"critical"==g[i]&&(b+=FCH_CRIT),"focus"==g[i]&&(b+=FCH_FOCUS);return b}.bind(this),!1,"target",!0);this.addattackmoda(this,function(b,c){return this.canusefocus()}.bind(this),function(b,c){this.removefocustoken();var f=FCH_focus(b);return 0<f?b-f*FCH_FOCUS+
FCH_HIT*f:b}.bind(this),!1,"focus",!0);this.adddefensemodd(this,function(b,c){return this.canusefocus()}.bind(this),function(b,c){this.removefocustoken();var f=FE_focus(b);return 0<f?b-FE_FOCUS*f+FE_EVADE*f:b}.bind(this),!1,"focus",!0);this.adddefenseadd(this,function(b,c){return this.canuseevade()}.bind(this),function(b,c){this.removeevadetoken();return{m:b+FE_EVADE,n:c+1}}.bind(this),"evade",!0)},getusabletokens:function(){var b="",c="";0<this.focus&&(b+="<td title='"+this.focus+" focus token(s)' class='xfocustoken'></td>");
0<this.evade&&(b+="<td title='"+this.evade+" evade token(s)' class='xevadetoken'></td>");for(var f=0;f<this.targeting.length;f++)c+=this.targeting[f].name+" ";0<this.targeting.length&&(b+="<td title='targeting "+c.replace(/\'/g,"&#39;")+"' class='xtargettoken'></td>");c="";for(f=0;f<this.istargeted.length;f++)c+=this.istargeted[f].name+" ";0<this.istargeted.length&&(b+="<td title='targeted by "+c.replace(/\'/g,"&#39;")+"' class='xtargetedtoken'></td>");this.iscloaked&&(b+="<td class='xcloaktoken'></td>");
0<this.stress&&(b+="<td title='"+this.stress+" stress token(s)' class='xstresstoken'></td>");0<this.ionized&&(b+="<td title='"+this.ionized+" ionization token(s)' class='xionizedtoken'></td>");return b},showstats:function(){phase==SELECT_PHASE||phase==CREATION_PHASE?($("#unit"+this.id+" .shipimg").html(this.getstatstring()),$("#unit"+this.id+" .shipimg").css("background-image","url(png/"+this.shipimg+")")):"undefined"==typeof this.skillbar?(console.trace(),this.log("undefined skillbar?")):(this.skillbar.attr({text:repeat("u",
this.getskill())}),this.firebar.attr({text:repeat("u",this.weapons[0].getattack())}),this.evadebar.attr({text:repeat("u",this.getagility())}),this.hullbar.attr({text:repeat("u",this.hull)}),this.shieldbar.attr({text:repeat("u",this.shield+this.hull)}),$("#"+this.id).html(""+this))},showpanel:function(){var b=VIEWPORT.m.clone(),c=this.g.getBBox(),f=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>f?l=(g-f)/2:h=(f-g)/2;f=Math.min(f/900,g/900);h+=(b.x(c.x,c.y)+c.width/2)*f;c=l+b.y(c.x,c.y)*f;b=
b.split().scalex;$(".phasepanel").css({left:h+b*(this.islarge?40:20),top:c}).show()},timeforaction:function(){return this==activeunit&&this.hasmoved&&!this.actiondone&&phase==ACTIVATION_PHASE},timeformaneuver:function(){return this==activeunit&&-1<this.maneuver&&!this.hasmoved&&this.getskill()==skillturn&&subphase==ACTIVATION_PHASE},show:function(){phase==CREATION_PHASE?$("#unit"+this.id).html(this.toString2()):"undefined"!=typeof this.g&&(this.g.transform(this.m),this.g.appendTo(VIEWPORT),this.geffect.transform(this.m),
this.geffect.appendTo(VIEWPORT),this.showoutline(),this.flameno++,this.showstats(),this.showinfo(),activeunit==this&&(this.showpanel(),this.showdial(),this.showmaneuver(),phase==ACTIVATION_PHASE&&this.showactivation(),this.showattack(),this.dead||$("#"+this.id).html(""+this)))},showhitsector:function(b,c){this.select();if(b){for(l=0;l<this.weapons.length&&this.weapons[l].name!=c;l++);if(l!=this.weapons.length){var f=this.weapons[l].range[0],g=this.weapons[l].range[1];if(this.weapons[l].isTurret()||
this.isTurret(this.weapons[l]))this.showrange(b,f,g);else{var h,l;if(1==f){for(h=f;h<=g;h++)this.sectors.push(s.path(this.getPrimarySectorString(h,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT));if("undefined"!=typeof this.weapons[l].auxiliary)for(l=this.weapons[l].auxiliary,h=f;h<=g;h++)this.sectors.push(s.path(l.call(this,h,this.m.clone())).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT))}else{for(h=
f;h<=g;h++)this.sectors.push(s.path(this.getPrimarySubSectorString(f-1,h,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT));if("undefined"!=typeof this.weapons[l].subauxiliary)for(l=this.weapons[l].subauxiliary,h=f;h<=g;h++)this.sectors.push(s.path(l.call(this,f-1,h,this.m.clone())).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT))}}}}else{for(h=0;h<this.sectors.length;h++)this.sectors[h].remove();for(h=
0;h<this.ranges.length;h++)this.ranges[h].remove();this.ranges=[];this.sectors=[]}},showrange:function(b,c,f){this.select();if(b)if(1==c)for(b=c;b<=f;b++)this.ranges.push(s.path(this.getRangeString(b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT));else for(b=c;b<=f;b++)this.ranges.push(s.path(this.getSubRangeString(c-1,b,this.m)).attr({fill:this.color,stroke:this.color,opacity:.3,pointerEvents:"none"}).appendTo(VIEWPORT));else{for(b=0;b<this.ranges.length;b++)this.ranges[b].remove();
this.ranges=[]}},togglehitsector:function(b){this.showhitsector(0<this.sectors.length+this.ranges.length?!1:!0,b)},togglerange:function(){this.showrange(0<this.ranges.length?!1:!0,1,3)},isPointInside:function(b,c){var f;for(f=0;f<c.length;f++)if(Snap.path.isPointInside(b,c[f].x,c[f].y))return!0;return!1},isinsector:function(b,c,f,g,h,l){f=f.getOutlineString(f.m);b=1<c?g.call(this,c-1,c,b):h.call(this,c,b);return null!=b&&(0<Snap.path.intersection(f.s,b).length||this.isPointInside(b,f.p))},isinfiringarc:function(b){return 3>=
this.getsector(b)},getsector:function(b,c){return this.weapons[0].getsector(b)},getprimarysector:function(b,c){"undefined"==typeof c&&(c=this.m);var f=this.getoutlinerange(c,b).d;return this.isinsector(c,f,b,this.getPrimarySubSectorString,this.getPrimarySectorString)?f:4},isinoutline:function(b,c,f){return this.isPointInside(b,c.getOutlinePoints(f))},checkcollision:function(b){return-1<this.touching.indexOf(b)},resolvecollision:function(){var b;"undefined"==typeof this.touching&&(this.touching=[]);
for(b=0;b<this.touching.length;b++){var c=this.touching[b];-1==c.touching.indexOf(this)&&(c.touching.push(this),c.collidedby(this))}},collidedby:function(b){},resolveocollision:function(){var b,c=this.ocollision.template.length;-1<this.ocollision.overlap&&c++;for(b=0;b<c;b++){var f=this.rollattackdie(1)[0];"hit"==f?(this.resolvehit(1),this.checkdead()):"critical"==f&&(this.resolvecritical(1),this.checkdead())}},removeshield:function(b){this.shield-=b;0>this.shield&&(this.shield=0);var c=TEAMS[this.team].history.rawdata;
"undefined"==typeof c[round]&&(c[round]={hits:0,dead:""});c[round].hits+=b},resolvehit:function(b){var c=0;if(0==b)return 0;this.shield>b?this.removeshield(b):(c=b-this.shield,this.removeshield(this.shield),0<c&&this.applydamage(c));this.showstats();return c},resolvecritical:function(b){var c=0;if(0==b)return 0;this.shield>b?this.removeshield(b):(c=b-this.shield,this.removeshield(this.shield),0<c&&this.applycritical(c));this.showstats();return c},removehull:function(b){this.hull-=b;var c=TEAMS[this.team].history.rawdata;
"undefined"==typeof c[round]&&(c[round]={hits:0,dead:""});c[round].hits+=b;this.log("-%0 %HULL%",b);this.hull<=this.ship.hull/2&&this.imgsmoke.attr({display:"block"});1==this.hull&&(this.imgsmoke.attr({display:"none"}),this.imgflame.attr({display:"block"}))},selectcritical:function(b,c){var f=function(b,f){$("#actiondial").empty();c(b);this.endnoaction(f,"CRITICAL")}.bind(this);this.doselection(function(c){var h;$("#actiondial").empty();for(h=0;h<b.length;h++)(function(h){var m=$("<button>").text(CRITICAL_DECK[b[h]].name).click(function(){record(this.id,
h,"selectcritical");f(b[h],c)}.bind(this));$("#actiondial").append(m)}).call(this,h);$("#actiondial").show()}.bind(this),"critical")},selectdamage:function(){var b,c=0;for(b=0;b<CRITICAL_DECK.length;b++)c+=CRITICAL_DECK[b].count;var f=this.rand(c);for(b=c=0;b<CRITICAL_DECK.length;b++)if(c+=CRITICAL_DECK[b].count,c>f)return b;return 0},applydamage:function(b){var c,f;for(f=0;f<b;f++)c=this.selectdamage(),CRITICAL_DECK[c].count--,new Critical(this,c);this.removehull(b);this.show()},applycritical:function(b){var c,
f;for(f=0;f<b;f++)c=this.selectdamage(),CRITICAL_DECK[c].count--,this.faceup(new Critical(this,c))&&this.removehull(1);this.show()},faceup:function(b){b.faceup();return!0},gethitrange:function(b,c){return c.team==this.team?0:this.weapons[b].getrange(c)},getenemiesinrange:function(){var b,c=[];for(b=0;b<this.weapons.length;b++)c[b]=this.weapons[b].getenemiesinrange();return c},getrange:function(b){return this.getoutlinerange(this.m,b).d},getdist:function(b,c){var f=this.getOutlinePoints(b),g=c.getOutlinePoints(c.m),
h=-1,l,m;for(l=0;4>l;l++)for(m=0;4>m;m++){var q=dist(g[m],f[l]);if(q<h||-1==h)h=q}return h},getoutlinerange:function(b,c){var f=this.getOutlinePoints(b),g=c.getOutlinePoints(c.m),h=90001,l,m,q,r=!1,t,v;for(l=0;4>l;l++)for(m=0;4>m;m++){var x=dist(g[m],f[l]);x<h&&(h=x,t=l,v=m)}if(9E4<h)return{d:4,o:!1};m=g[v].x-f[t].x;var x=g[v].y-f[t].y,y=-f[t].x*x+f[t].y*m;if(0<OBSTACLES.length)for(q=0;6>q;q++){var z=OBSTACLES[q].getOutlineString().p,B=z[0].x*x-z[0].y*m+y,D=B;for(l=1;l<z.length&&!(dist(g[v],z[l])<
1.2*h&&dist(f[t],z[l])<1.2*h&&(D=z[l].x*x-z[l].y*m+y,0>D*B));l++);if(0>D*B)break}6>q&&(r=!0);return 1E4>=h?{d:1,o:r}:4E4>=h?{d:2,o:r}:{d:3,o:r}},getrangeallunits:function(){var b=[[],[],[],[],[]],c;for(c in squadron){var f=squadron[c];f!=this&&(f=this.getrange(f),b[f].push({unit:c}))}return b}};var IACOMPUTING=0;function IAUnit(){}
IAUnit.prototype={computemaneuver:function(){var b,c,f=0,g=[],f=this.getdial(),h=[];this.evaluatemoves(!0,!0);c=0;for(b in squadron)c=squadron[b],c.team!=this.team&&(c.meanmround!=round&&c.evaluatemoves(!1,!1),c.oldm=c.m,c.m=c.meanm,h.push(c));g=function(b){var c=[],f,g=[GREEN,WHITE,YELLOW];for(f=0;f<b.length;f++){var h=b[f];if(h.color!=RED){var v=this.getpathmatrix(this.m,b[f].move),x=12-4*g.indexOf(h.color),y=this.m;this.m=v;x+=this.evaluateposition();"RED"==h.difficulty&&(x-=1.5);this.m=y;c.push({n:x,
m:f})}}return c}.call(this,f);for(c=0;c<h.length;c++)h[c].m=h[c].oldm;if(0<g.length)g.sort(function(b,c){return c.n-b.n}),f=g[0].m;else{for(b=0;b<f.length&&"RED"==f[b].difficulty&&!f[b].move.match(/F\d/);b++);f=b}this.log("Maneuver set");return f},resolveactionselection:function(b,c){c(0)},selectcritical:function(b,c){for(var f=0;f<b.length;f++)if(0==CRITICAL_DECK[b[f]].lethal){c(b[f]);return}c(b[0])},resolveactionmove:function(b,c,f,g){var h=!1,l=-1E3,m=-1,q=this.m;for(g=0;g<b.length;g++)if(this.getmovecolor(b[g],
!0,!0)==GREEN){h=!0;this.m=b[g];var r=this.evaluateposition();l<r&&(l=r,m=g)}this.m=q;if(h&&-1<m){f&&(this.m=b[m]);b=this.getmcollisions(this.m);if(0<b.length)for(g=0;g<b.length;g++)OBSTACLES[b[g]].detonate(this);c(this,m)}else this.m=q,c(this,-1)},timetoshowmaneuver:function(){return-1<this.maneuver&&phase==ACTIVATION_PHASE&&skillturn==this.getskill()},doplan:function(){$("#move").css({display:"none"});$("#maneuverdial").empty();if(phase==PLANNING_PHASE&&-1==this.maneuver){IACOMPUTING++;1==IACOMPUTING&&
$("#npimg").html("<img style='width:10px' src='png/waiting.gif'/>");var b;b=setInterval(function(){var c=this.computemaneuver();IACOMPUTING--;0==IACOMPUTING&&$("#npimg").html("&#9658;");this.newm=this.getpathmatrix(this.m,this.getdial()[c].move);this.setmaneuver(c);clearInterval(b)}.bind(this),1)}return this.deferred},showdial:function(){$("#maneuverdial").empty();phase>=PLANNING_PHASE&&(-1==this.maneuver||this.hasmoved)&&(this.dialspeed.attr({text:""}),this.dialdirection.attr({text:""}))},resolvedecloak:function(){this.resolveactionmove(this.getdecloakmatrix(this.m),
function(b,c){0<c&&(b.agility-=2,b.iscloaked=!1,SOUNDS.decloak.play());this.hasdecloaked=!0}.bind(this),!0)},showactivation:function(){},doactivation:function(){this.updateactivationdial();this.timeformaneuver()&&this.resolvemaneuver()},showaction:function(){$("#actiondial").empty();if(-1<this.action&&this.action<this.actionList.length){var b=A[this.actionList[this.action]].color;this.actionicon.attr({fill:this==activeunit?b:halftone(b)})}else this.actionicon.attr({text:""})},donoaction:function(b,
c){b.sort(function(b,c){return"CRITICAL"==b.type?-1:"CRITICAL"==c.type?1:"EVADE"==b.type?-1:"EVADE"==c.type?1:"FOCUS"==b.type?-1:"FOCUS"==c.type?1:0});return this.enqueueaction(function(f){this.select();"undefined"!=typeof c&&this.log(c);var g=null;for(i=0;i<b.length;i++)if("CRITICAL"==b[i].type){g=b[i];break}else if("EVADE"==b[i].type&&this.candoevade()){var h=!0,l=this.getenemiesinrange();for(i=0;i<l.length;i++)if(0<l[i].length){h=!1;break}if(h){g=b[i];break}}else if("FOCUS"==b[i].type){if(this.candofocus()){g=
b[i];break}}else{g=b[i];break}this.resolvenoaction(g,f)}.bind(this),"donoaction ia")},setpriority:function(b){var c={FOCUS:3,EVADE:1,CLOAK:4,TARGET:2,CRITICAL:10}[b.type];"undefined"==typeof c&&(c=0);b.priority=c;c=[];"BOOST"==b.type&&(c=this.getboostmatrix(this.m));"ROLL"==b.type&&(c=this.getrollmatrix(this.m));if(0<c.length){var f=this.m,g=this.evaluateposition(),h=g-1;for(i=0;i<c.length;i++)this.m=c[i],h=Math.max(h,this.evaluateposition());this.m=f;h>g&&(b.priority=2*(h-g))}},doaction:function(b,
c){for(i=0;i<b.length;i++)this.setpriority(b[i]);b.sort(function(b,c){return c.priority-b.priority});return 0==b.length?this.enqueueaction(function(b){this.endnoaction(b)}.bind(this)):this.enqueueaction(function(f){if(this.candoaction()){this.select();"undefined"!=typeof c&&this.log(c);var g=null;for(i=0;i<b.length;i++)if("CRITICAL"==b[i].type){g=b[i];break}else if("CLOAK"==b[i].type&&this.candocloak()){g=b[i];break}else if("EVADE"==b[i].type&&this.candoevade()){var h=!0,l=this.getenemiesinrange();
for(i=0;i<l.length;i++)if(0<l[i].length){h=!1;break}if(h){g=b[i];break}}else if("FOCUS"==b[i].type){if(this.candofocus()){g=b[i];break}}else{g=b[i];break}null==g&&this.log("no possible action");this.resolveaction(g,f)}else this.endaction(f)}.bind(this),"doaction ia")},showattack:function(){$("#attackdial").empty()},doattack:function(b){if(1==b||phase==COMBAT_PHASE&&skillturn==this.getskill()){b=0;var c=null,f,g;if(this.canfire()){NOLOG=!0;var h=this.getenemiesinrange();for(g=0;g<this.weapons.length;g++){var l=
h[g];for(f=0;f<l.length;f++){var m=this.getattackstrength(g,l[f]);m>b&&(c=l[f],b=m,this.activeweapon=g)}}NOLOG=!1;if(null!=c)return this.selecttargetforattack(this.activeweapon,c)}this.hasfired++;this.deferred.resolve()}},doattackroll:function(b,c,f,g,h){var l,m;$("#attackdial").empty().show();$("#defense").empty();$("#dtokens").empty();displayattackroll(b,c);m=function(b,c){var f=0,g=b.n();-1<b.type.indexOf("blank")&&(f+=g);-1<b.type.indexOf("focus")&&(f+=10*g);-1<b.type.indexOf("hit")&&(f+=100*
g);-1<b.type.indexOf("critical")&&(f+=1E3*g);reroll(g,!0,f,c)};for(l=0;l<ATTACKREROLLA.length;l++){var q=ATTACKREROLLA[l];q.req(this,this.weapons[this.activeweapon],targetunit)&&m(q,l)}for(l=0;l<this.ATTACKREROLLA.length;l++)q=this.ATTACKREROLLA[l],q.req(this.weapons[this.activeweapon],targetunit)&&m(q,l+ATTACKREROLLA.length);for(l=0;l<ATTACKMODA.length;l++)q=ATTACKMODA[l],q.req(b,c)&&modroll(q.f,c,l);for(l=0;l<ATTACKMODD.length;l++)q=ATTACKMODD[l],q.req(b,c);l=ATTACKMODA.length;for(m=0;m<this.ATTACKMODA.length;m++)q=
this.ATTACKMODA[m],q.req(b,c)&&modroll(q.f,c,l+m);for(m=0;m<this.ATTACKADD.length;m++)q=this.ATTACKADD[m],q.req(b,c)&&addroll(q.f,c,l+m+this.ATTACKMODA.length);$("#atokens").empty();targetunit.defenseroll(f).done(function(b){targetunit.dodefenseroll(b.roll,b.dice,g,h)})},dodefenseroll:function(b,c,f,g){var h,l;displaydefenseroll(b,c);for(l in squadron)if(squadron[l]==this)break;l=function(b,c){var f=0,g=b.n();-1<b.type.indexOf("blank")&&(f+=g);-1<b.type.indexOf("focus")&&(f+=10*g);-1<b.type.indexOf("evade")&&
(f+=100*g);reroll(g,!1,f,c)};for(h=0;h<DEFENSEREROLLD.length;h++){var m=DEFENSEREROLLD[h];m.req(activeunit,activeunit.weapons[activeunit.activeweapon],this)&&l(m,h)}for(h=0;h<targetunit.DEFENSEREROLLD.length;h++)m=targetunit.DEFENSEREROLLD[h],m.req(activeunit.weapons[activeunit.activeweapon],this)&&l(m,h+DEFENSEREROLLD.length);for(h=0;h<DEFENSEMODD.length;h++)m=DEFENSEMODD[h],m.req(b,c)&&modrolld(m.f,c,h);for(l=0;l<this.DEFENSEMODD.length;l++)m=this.DEFENSEMODD[l],m.req(b,c)&&modrolld(m.f,c,h+l);
$("#dtokens").append($("<button>").addClass("m-fire").click(function(){$("#combatdial").hide();this.resolvedamage();this.endnoaction(g,"incombat")}.bind(squadron[f]))).show()}};
var PILOTS=[{name:"Wedge Antilles",done:!0,unique:!0,faction:REBEL,unit:"X-Wing",skill:9,init:function(){this.wrap_after("declareattack",this,function(b,c){c.log("-1 defense [%0]",this.name);c.wrap_after("getagility",this,function(b){return 0<b?b-1:b}).unwrapper("endbeingattacked");c.showstats()})},points:29,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Garven Dreis",done:!0,faction:REBEL,unique:!0,unit:"X-Wing",init:function(){this.wrap_after("removefocustoken",this,function(){var b=this.selectnearbyally(2);
0<b.length&&this.doselection(function(c){this.resolveactionselection(b,function(f){b[f].log("+1 %FOCUS%");b[f].addfocustoken();this.endnoaction(c,"FOCUS")}.bind(this))}.bind(this),"select unit for free %FOCUS%")})},skill:6,points:26,upgrades:[TORPEDO,ASTROMECH]},{name:"Red Squadron Pilot",done:!0,unit:"X-Wing",faction:REBEL,skill:4,points:23,upgrades:[TORPEDO,ASTROMECH]},{name:"Rookie Pilot",done:!0,unit:"X-Wing",faction:REBEL,skill:2,points:21,upgrades:[TORPEDO,ASTROMECH]},{name:"Turbolaser",done:!0,
unit:"Turbolaser",faction:EMPIRE,skill:0,points:5,upgrades:[]},{name:"Thermal Exhaust Port",done:!0,unit:"Exhaust Port",faction:EMPIRE,skill:0,points:100,upgrades:[]},{name:"Biggs Darklighter",done:!0,init:function(){var b=this;Weapon.prototype.wrap_after("getenemiesinrange",this,function(c){-1<c.indexOf(b)&&(c=[b]);return c});Unit.prototype.wrap_after("getenemiesinrange",this,function(c){var f=!1,g=[],h;for(h=0;h<this.weapons.length;h++)-1<c[h].indexOf(b)?(g[h]=c[h],f=!0):g[h]=[];return f?g:c})},
unique:!0,unit:"X-Wing",faction:REBEL,skill:5,points:25,upgrades:[TORPEDO,ASTROMECH]},{name:"Luke Skywalker",done:!0,faction:REBEL,init:function(){this.adddefensemodd(this,function(b,c){return!0},function(b,c){var f=FE_focus(b);FE_evade(b);return 0<f?(this.log("1 %FOCUS% -> 1 %EVADE%"),b-FE_FOCUS+FE_EVADE):b}.bind(this),!1,"focus")},unique:!0,unit:"X-Wing",skill:8,points:28,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Gray Squadron Pilot",done:!0,faction:REBEL,unit:"Y-Wing",skill:4,points:20,upgrades:[TURRET,
TORPEDO,TORPEDO,ASTROMECH]},{name:"'Dutch' Vander",done:!0,init:function(){this.wrap_after("addtarget",this,function(b){var c=this;this.doselection(function(b){var g=this.selectnearbyally(2);0<g.length?(g.push(this),this.log("select unit for free %TARGET% (or self to cancel)"),this.resolveactionselection(g,function(h){if(h<g.length-1){var l=g[h].gettargetableunits(3);g[h].log("select target to lock");g[h].resolveactionselection(l,function(g){0<=g&&this.addtarget(l[g]);c.endnoaction(b,"TARGET")}.bind(g[h]))}else c.endnoaction(b,
"TARGET")})):this.endnoaction(b,"TARGET")}.bind(this))})},faction:REBEL,unique:!0,unit:"Y-Wing",skill:6,points:23,upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Horton Salm",done:!0,faction:REBEL,unique:!0,unit:"Y-Wing",skill:8,points:25,init:function(){unit=this;this.addattackrerolla(this,["blank"],function(){return 9},function(b,c){var f=this.getrange(c);return 2<=f&&3>=f?(this.log("reroll any blank result"),!0):!1}.bind(this))},upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Gold Squadron Pilot",
done:!0,unit:"Y-Wing",faction:REBEL,skill:2,points:18,upgrades:[TURRET,TORPEDO,TORPEDO,ASTROMECH]},{name:"Academy Pilot",done:!0,unit:"TIE Fighter",faction:EMPIRE,skill:1,points:12,upgrades:[]},{name:"Obsidian Squadron Pilot",done:!0,unit:"TIE Fighter",faction:EMPIRE,skill:3,points:13,upgrades:[]},{name:"Black Squadron Pilot",done:!0,unit:"TIE Fighter",faction:EMPIRE,skill:4,points:14,upgrades:[ELITE]},{name:"'Scourge'",unique:!0,beta:!0,done:!0,unit:"TIE Fighter",faction:EMPIRE,skill:7,points:17,
init:function(){this.wrap_after("getattackstrength",this,function(b,c,f){return 0<c.criticals.length?(this.log("+1 attack die for attacking damaged unit"),f+1):f})},upgrades:[ELITE]},{name:"'Winged Gundark'",faction:EMPIRE,init:function(){this.addattackmoda(this,function(b,c){return 1==this.getrange(targetunit)}.bind(this),function(b,c){FCH_crit(b);return 0<FCH_hit(b)?(this.log("1 %HIT% -> 1 %CRIT%"),b-FCH_HIT+FCH_CRIT):b}.bind(this),!1,"hit")},done:!0,unique:!0,unit:"TIE Fighter",skill:5,points:15,
upgrades:[]},{name:"'Night Beast'",faction:EMPIRE,done:!0,init:function(){this.wrap_after("handledifficulty",this,function(b){"GREEN"==b&&this.candofocus()&&this.candoaction()&&this.doaction([this.newaction(this.addfocus,"FOCUS")],"green maneuver -> free focus action")})},unique:!0,unit:"TIE Fighter",skill:5,points:15,upgrades:[]},{name:"'Backstabber'",unique:!0,done:!0,faction:EMPIRE,init:function(){this.wrap_after("getattackstrength",this,function(b,c,f){c.isinfiringarc(this)||(f+=1,this.log("+1 attack against %0",
c.name));return f})},unit:"TIE Fighter",skill:6,points:16,upgrades:[]},{name:"'Dark Curse'",done:!0,faction:EMPIRE,unique:!0,init:function(){var b=this;Unit.prototype.wrap_after("getattackrerolltokens",this,function(c){return targetunit==b&&this.team!=b.team?"":c});Unit.prototype.wrap_after("canusefocus",this,function(c){return targetunit==b&&this.team!=b.team?!1:c});Unit.prototype.wrap_after("canusetarget",this,function(c){return targetunit==b&&this.team!=b.team?!1:c})},unit:"TIE Fighter",skill:6,
points:16,upgrades:[]},{name:"'Mauler Mithel'",faction:EMPIRE,done:!0,init:function(){var b=this.getattackstrength;this.getattackstrength=function(c,f){var g=b.call(this,c,f);return 1==this.gethitrange(c,f)?(this.log("+1 attack against %0",f.name),g+1):g}.bind(this)},unique:!0,unit:"TIE Fighter",skill:7,points:17,upgrades:[ELITE]},{name:"'Howlrunner'",unique:!0,done:!0,faction:EMPIRE,unit:"TIE Fighter",skill:8,init:function(){this.addglobalattackrerolla(this,["blank","focus"],function(){return 1},
function(b,c,f){return!this.dead&&b!=this&&1==b.getrange(this)&&b.team==this.team&&c.isprimary?(b.log("+%1 reroll(s) [%0]",this.name,1),!0):!1}.bind(this))},points:18,upgrades:[ELITE]},{name:"Maarek Stele",unique:!0,done:!0,faction:EMPIRE,unit:"TIE Advanced",skill:7,points:27,init:function(){var b=this;this.ac=Unit.prototype.applycritical;Unit.prototype.applycritical=function(c){if(activeunit==b&&targetunit!=b){for(var f=0;f<c;f++){var g=this.selectdamage();CRITICAL_DECK[g].count--;var h=this.selectdamage();
CRITICAL_DECK[h].count--;var l=this.selectdamage();CRITICAL_DECK[l].count--;sc=[g,h,l];b.log("select one critical");b.selectcritical(sc,function(b){CRITICAL_DECK[b].count++;this.faceup(new Critical(this,b))&&this.removehull(1);this.checkdead();this.show()}.bind(this))}this.show()}else b.ac.call(this,c)}},upgrades:[ELITE,MISSILE]},{name:"Maarek Stele",unique:!0,done:!0,faction:EMPIRE,unit:"TIE Defender",skill:7,points:36,init:function(){var b=this;this.ac=Unit.prototype.applycritical;Unit.prototype.applycritical=
function(c){if(activeunit==b&&targetunit!=b){for(var f=0;f<c;f++){var g=this.selectdamage();CRITICAL_DECK[g].count--;var h=this.selectdamage();CRITICAL_DECK[h].count--;var l=this.selectdamage();CRITICAL_DECK[l].count--;sc=[g,h,l];b.log("select one critical");b.selectcritical(sc,function(b){CRITICAL_DECK[b].count++;this.faceup(new Critical(this,b))&&this.removehull(1);this.checkdead();this.show()}.bind(this))}this.show()}else b.ac.call(this,c)}},upgrades:[ELITE,CANNON,MISSILE]},{name:"Tempest Squadron Pilot",
faction:EMPIRE,done:!0,unit:"TIE Advanced",skill:2,points:21,upgrades:[MISSILE]},{name:"Storm Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Advanced",skill:4,points:23,upgrades:[MISSILE]},{name:"Darth Vader",faction:EMPIRE,unique:!0,done:!0,unit:"TIE Advanced",skill:9,doendmaneuveraction:function(){this.candoaction()?this.doaction(this.getactionlist(),"1st action").done(function(){this.candoaction()?this.doaction(this.getactionlist(),"2nd action"):(this.action=-1,this.actiondone=!0,this.deferred.resolve())}.bind(this)):
(this.action=-1,this.actiondone=!0,this.deferred.resolve())},secaction:-1,points:29,upgrades:[ELITE,MISSILE]},{name:"Alpha Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Interceptor",skill:1,points:18,upgrades:[]},{name:"Avenger Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Interceptor",skill:3,points:20,upgrades:[]},{name:"Saber Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Interceptor",skill:4,points:21,upgrades:["Elite"]},{name:"'Fel's Wrath'",faction:EMPIRE,unique:!0,unit:"TIE Interceptor",
skill:5,done:!0,endcombatphase:function(){this.hasfired=0;this.checkdead()},canbedestroyed:function(b){return-1==b?!0:!1},points:23,upgrades:[]},{name:"Turr Phennir",faction:EMPIRE,unique:!0,done:!0,unit:"TIE Interceptor",skill:7,cleanupattack:function(){this.doaction([this.newaction(this.resolveboost,"BOOST"),this.newaction(this.resolveroll,"ROLL")],"free %BOOST% or %ROLL% action");Unit.prototype.cleanupattack.call(this)},points:25,upgrades:[ELITE]},{name:"Soontir Fel",faction:EMPIRE,unique:!0,done:!0,
addstress:function(){this.stress++;this.log("+1 %STRESS% -> +1 %FOCUS%");this.addfocustoken()},unit:"TIE Interceptor",skill:9,points:27,upgrades:[ELITE]},{name:"Tycho Celchu",faction:REBEL,unique:!0,done:!0,candoaction:function(){return 0==this.collision&&0==this.ocollision.template.length&&-1==this.ocollision.overlap},unit:"A-Wing",skill:8,points:26,upgrades:[ELITE,MISSILE]},{name:"Arvel Crynyd",faction:REBEL,unique:!0,done:!0,unit:"A-Wing",checkcollision:function(b){return!1},skill:6,points:23,
upgrades:[MISSILE]},{name:"Green Squadron Pilot",faction:REBEL,done:!0,unit:"A-Wing",skill:3,points:19,upgrades:[ELITE,MISSILE]},{name:"Prototype Pilot",faction:REBEL,done:!0,unit:"A-Wing",skill:1,points:17,upgrades:[MISSILE]},{name:"Outer Rim Smuggler",faction:REBEL,unit:"YT-1300",done:!0,install:function(){this.hull=6;this.shield=4;this.weapons[0].attack=2},uninstall:function(){this.hull=8;this.shield=5;this.weapons[0].attack=3},skill:1,points:27,upgrades:[CREW,CREW]},{name:"Chewbacca",unique:!0,
done:!0,faction:REBEL,unit:"YT-1300",skill:5,points:42,faceup:function(b){this.log("ignore critical %0",b.name);return!0},upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Lando Calrissian",faction:REBEL,unique:!0,unit:"YT-1300",skill:7,points:44,handledifficulty:function(b){var c=this.selectnearbyally(1);0<c.length&&"GREEN"==b&&this.doselection(function(b){this.resolveactionselection(c,function(g){c[g].log("+1 action [%0]",this);c[g].doaction(c[g].getactionbarlist());this.endnoaction(b,"")}.bind(this))}.bind(this));
Unit.prototype.handledifficulty.call(this,b)},done:!0,upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Han Solo",unique:!0,done:!0,faction:REBEL,unit:"YT-1300",skill:9,points:46,init:function(){this.addattackrerolla(this,["blank","focus","hit","critical"],function(){return 9},function(b,c){return!0}.bind(this))},upgrades:[ELITE,MISSILE,CREW,CREW]},{name:"Kath Scarlet",unique:!0,faction:EMPIRE,unit:"Firespray-31",skill:7,done:!0,declareattack:function(b,c){var f=this;c.wrap_after("cancelcritical",f,function(b,
c,l){FCH_crit(b.ch)>FCH_crit(l.ch)&&(this.log("+1 %STRESS% for cancelling %CRIT% [%0]",f.name),this.addstress());return l}).unwrapper("endbeingattacked");Unit.prototype.declareattack.call(this,b,c)},points:38,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE]},{name:"Boba Fett",unique:!0,done:!0,faction:EMPIRE,getmaneuverlist:function(){for(var b=Unit.prototype.getmaneuverlist.call(this),c=1;3>=c;c++)"undefined"!=typeof b["BL"+c]?(this.log("select %BANKLEFT% or %BANKRIGHT% turn"),b["BR"+c]={move:"BR"+c,difficulty:b["BL"+
c].difficulty}):"undefined"!=typeof b["BR"+c]&&(this.log("select %BANKLEFT% or %BANKRIGHT% turn"),b["BL"+c]={move:"BL"+c,difficulty:b["BR"+c].difficulty});return b},unit:"Firespray-31",skill:8,points:39,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE]},{name:"Krassis Trelix",unique:!0,done:!0,faction:EMPIRE,unit:"Firespray-31",init:function(){this.addattackrerolla(this,["blank","focus"],function(){return 1},function(b,c){return b.isprimary?!1:(this.log("+%1 reroll(s) [%0]",this.name,1),!0)}.bind(this))},
skill:5,points:36,upgrades:[CANNON,BOMB,CREW,MISSILE]},{name:"Bounty Hunter",unit:"Firespray-31",skill:3,done:!0,faction:EMPIRE,points:33,upgrades:[CANNON,BOMB,CREW,MISSILE]},{name:"Ten Numb",faction:REBEL,unique:!0,done:!0,unit:"B-Wing",skill:8,init:function(){this.shipimg="b-wing-1.png"},declareattack:function(b,c){c.wrap_after("cancelcritical",self,function(b,g,h){if(0<FCH_crit(b.ch))return 0==FCH_crit(h.ch)?(c.log("cannot cancel 1 %CRIT% [%0]",this.name),{ch:h.ch+FCH_CRIT,e:h.e+1}):b}.bind(this)).unwrapper("endbeingattacked");
Unit.prototype.declareattack.call(this,b,c)},points:31,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Ibtisam",unique:!0,done:!0,faction:REBEL,unit:"B-Wing",skill:6,points:28,init:function(){this.shipimg="b-wing-1.png";this.addattackrerolla(this,["blank","focus"],function(){return 1},function(b,c){return 0<this.stress?(this.log("+%0 reroll",1),!0):!1}.bind(this));this.adddefensererolld(this,["blank","focus"],function(){return 1},function(b,c){return 0<this.stress?(this.log("+%0 reroll",1),
!0):!1}.bind(this))},upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Dagger Squadron Pilot",unit:"B-Wing",done:!0,faction:REBEL,skill:4,points:24,upgrades:[SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Blue Squadron Pilot",unit:"B-Wing",done:!0,faction:REBEL,skill:2,points:22,upgrades:[SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Rebel Operative",unit:"HWK-290",done:!0,faction:REBEL,skill:2,points:16,upgrades:[TURRET,CREW]},{name:"Roark Garnet",unique:!0,faction:REBEL,unit:"HWK-290",skill:4,begincombatphase:function(){var b=
this,c=this.selectnearbyally(3);0<c.length&&this.doselection(function(f){this.log("select unit for 12 PS");this.resolveactionselection(c,function(g){-1<g&&(c[g].log("has PS of 12"),c[g].wrap_after("getagility",b,function(b){return 12}).unwrapper("endcombatphase"));this.endnoaction(f,"")})}.bind(this));return Unit.prototype.begincombatphase.call(this)},done:!0,points:19,upgrades:[TURRET,CREW]},{name:"Kyle Katarn",faction:REBEL,unique:!0,done:!0,unit:"HWK-290",skill:6,points:21,begincombatphase:function(){if(this.canusefocus()){var b=
this.selectnearbyally(3);0<b.length&&this.doselection(function(c){b.push(this);this.log("select unit for free %FOCUS% (or self to cancel)");this.resolveactionselection(b,function(f){this!=b[f]&&(this.removefocustoken(),b[f].addfocustoken(),b[f].log("+1 %FOCUS%"));this.endnoaction(c,"FOCUS")}.bind(this))}.bind(this))}return Unit.prototype.begincombatphase.call(this)},upgrades:[ELITE,TURRET,CREW]},{name:"Jan Ors",faction:REBEL,unique:!0,done:!0,unit:"HWK-290",skill:8,init:function(){var b=this;this.addattackmoda(this,
function(c,f){return 0==b.stress&&activeunit.team==b.team&&activeunit!=b&&3>=b.getrange(activeunit)}.bind(this),function(c,f){var g=b.rollattackdie(1)[0];b.addstress();b.log("+1 attack die");return"focus"==g?c+FCH_FOCUS:"hit"==g?c+FCH_HIT:"critical"==g?c+FCH_CRIT:c}.bind(this),!0,"hit")},points:25,upgrades:[ELITE,TURRET,CREW]},{name:"Scimitar Squadron Pilot",done:!0,unit:"TIE Bomber",skill:2,faction:EMPIRE,points:16,upgrades:[TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Gamma Squadron Pilot",done:!0,
unit:"TIE Bomber",faction:EMPIRE,skill:4,points:18,upgrades:[TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Captain Jonus",faction:EMPIRE,done:!0,init:function(){this.addglobalattackrerolla(this,["blank","focus"],function(){return 2},function(b,c,f){return this.dead||b==this||1!=b.getrange(this)||b.team!=this.team||1==c.isprimary?!1:(b.log("+2 rerolls [%0]",this.name),!0)}.bind(this))},unique:!0,unit:"TIE Bomber",skill:6,points:22,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Major Rhymer",
done:!0,faction:EMPIRE,init:function(){for(var b=0;b<this.weapons.length;b++){var c=this.weapons[b].range[1];1<this.weapons[b].range[0]&&this.weapons[b].range[0]--;3>c&&this.weapons[b].range[1]++}this.log("extending weapon ranges")},unique:!0,unit:"TIE Bomber",skill:7,points:26,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"Captain Kagi",faction:EMPIRE,unique:!0,done:!0,init:function(){Unit.prototype.wrap_after("gettargetableunits",this,function(b,c){for(var f=0;f<c.length;f++)if("Captain Kagi"==
c[f].name)return[c[f]];return c})},unit:"Lambda-Class Shuttle",skill:8,points:27,upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Colonel Jendon",faction:EMPIRE,begincombatphase:function(){if(!this.dead){var b=this.selectnearbyally(1);0<b.length&&this.targeting.length&&(b.push(this),this.doselection(function(c){this.log("select unit to move %TARGET% (or self to cancel)");this.resolveactionselection(b,function(f){if(this!=b[f]){var g=this.targeting[0];b[f].addtarget(g);this.removetarget(g);b[f].log("+%1 %TARGET% / %0",
g.name,1)}this.endnoaction(c,"TARGET")}.bind(this))}.bind(this)))}return Unit.prototype.begincombatphase.call(this)},done:!0,unique:!0,unit:"Lambda-Class Shuttle",skill:6,points:26,upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Captain Yorr",faction:EMPIRE,unique:!0,done:!0,unit:"Lambda-Class Shuttle",skill:4,init:function(){var b=this;Unit.prototype.wrap_after("addstress",this,function(){this!=b&&2>=this.getrange(b)&&2>=b.stress&&(this.log("-1 %STRESS% [%0]",b.name),b.log("+1 %STRESS%"),this.stress--,
this.showinfo(),b.addstress(),b.showinfo())})},points:24,upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Omicron Group Pilot",faction:EMPIRE,done:!0,unit:"Lambda-Class Shuttle",skill:2,points:21,upgrades:[SYSTEM,CANNON,CREW,CREW]},{name:"Lieutenant Lorrir",faction:EMPIRE,unique:!0,done:!0,unit:"TIE Interceptor",skill:5,points:23,resolveroll:function(b){for(var c=this.getrollmatrix(this.m),f=-20;20>=f;f+=20)var g=this.m.clone().translate(0,f).rotate(90,0,0),h=this.m.clone().translate(0,f).rotate(-90,0,
0),c=c.concat([this.getpathmatrix(g,"BR1").rotate(-90,0,0),this.getpathmatrix(h,"BR1").rotate(90,0,0),this.getpathmatrix(g,"BL1").rotate(-90,0,0),this.getpathmatrix(h,"BL1").rotate(90,0,0)]);this.resolveactionmove(c,function(c,f){5<f&&c.addstress();c.endaction(b,"ROLL")},!0);return!0},upgrades:[]},{name:"Royal Guard Pilot",faction:EMPIRE,done:!0,unit:"TIE Interceptor",skill:6,points:22,upgrades:[ELITE]},{name:"Tetran Cowall",faction:EMPIRE,unique:!0,done:!0,getmaneuverlist:function(){var b=this.getmaneuver(),
c={};c[b.move]=b;if(b.move.match("K5|K3")&&0==this.ionized){this.log("select %UTURN% speed");for(var f=1;5>=f;f+=2)"undefined"==typeof c["K"+f]&&(this.log("difficulty "+f+" "+b.difficulty),c["K"+f]={move:"K"+f,difficulty:b.difficulty,halfturn:!1})}return c},unit:"TIE Interceptor",skill:7,points:24,upgrades:[ELITE]},{name:"Kir Kanos",faction:EMPIRE,init:function(){this.addattackadd(this,function(b,c){var f=this.getrange(targetunit);this.log("Kir Kanos "+f+" "+this.canuseevade());return 3>=f&&2<=f&&
this.canuseevade()}.bind(this),function(b,c){this.removeevadetoken();this.log("+1 %HIT% for attacking at range 2-3");return{m:b+FCH_HIT,n:c+1}}.bind(this),"evade")},done:!0,unique:!0,unit:"TIE Interceptor",skill:6,points:24,upgrades:[]},{name:"Carnor Jax",faction:EMPIRE,init:function(){var b=Unit.prototype.canusefocus,c=Unit.prototype.canuseevade,f=Unit.prototype.candofocus,g=Unit.prototype.candoevade,h=this;Unit.prototype.canusefocus=function(){return 1==this.getrange(h)&&this.team!=h.team?!1:b.call(this)};
Unit.prototype.canuseevade=function(){return 1==this.getrange(h)&&this.team!=h.team?!1:c.call(this)};Unit.prototype.candofocus=function(){return 1==this.getrange(h)&&this.team!=h.team?!1:f.call(this)};Unit.prototype.candoevade=function(){return 1==this.getrange(h)&&this.team!=h.team?!1:g.call(this)}},unique:!0,done:!0,unit:"TIE Interceptor",skill:8,points:26,upgrades:[ELITE]},{name:"Bandit Squadron Pilot",faction:REBEL,done:!0,unit:"Z-95 Headhunter",skill:2,points:12,upgrades:[MISSILE]},{name:"Tala Squadron Pilot",
faction:REBEL,done:!0,unit:"Z-95 Headhunter",skill:4,points:13,upgrades:[MISSILE]},{name:"Lieutenant Blount",faction:REBEL,done:!0,hashit:function(b){0==this.criticalresolved+this.hitresolved&&this.log("%0 is hit",targetunit.name);return!0},unique:!0,unit:"Z-95 Headhunter",skill:6,points:17,upgrades:[ELITE,MISSILE]},{name:"Airen Cracken",faction:REBEL,done:!0,endattack:function(){Unit.prototype.endattack.call(this);var b=this.selectnearbyunits(1,function(b,f){return b.team==f.team&&f!=b&&f.candoaction()});
0<b.length&&this.doselection(function(c){this.log("select unit for a free action");this.resolveactionselection(b,function(f){var g=b[f].getactionlist();0<g.length?b[f].doaction(g).done(function(){this.select()}.bind(this)):this.select();this.endnoaction(c,"")}.bind(this))}.bind(this))},unique:!0,unit:"Z-95 Headhunter",skill:8,points:19,upgrades:[ELITE,MISSILE]},{name:"Delta Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Defender",skill:1,points:30,upgrades:[CANNON,MISSILE]},{name:"Glaive Squadron Pilot",
faction:EMPIRE,done:!0,unit:"TIE Defender",skill:6,points:34,upgrades:[CANNON,MISSILE]},{name:"Onyx Squadron Pilot",done:!0,faction:EMPIRE,unit:"TIE Defender",skill:3,points:32,upgrades:[CANNON,MISSILE]},{name:"Colonel Vessery",done:!0,faction:EMPIRE,attackroll:function(b){b=Unit.prototype.attackroll.call(this,b);0<targetunit.istargeted.length&&0==this.targeting.length&&(this.addtarget(targetunit),this.log("+%1 %TARGET% / %0",targetunit.name,1));return b},unique:!0,unit:"TIE Defender",skill:6,points:35,
upgrades:[ELITE,CANNON,MISSILE]},{name:"Rexler Brath",faction:EMPIRE,done:!0,endattack:function(b,c){Unit.prototype.endattack.call(this,b,c);this.canusefocus()&&0<this.hitresolved&&(this.log("-1 %FOCUS%, %0 damage -> %0 critical(s)",c),this.donoaction([{name:this.name,org:this,type:"FOCUS",action:function(b){var c,h=targetunit.criticals.length-1;this.removefocustoken();for(c=0;c<this.hitresolved;c++)this.log(targetunit.criticals[h-c-this.criticalresolved].name),targetunit.faceup(targetunit.criticals[h-
c-this.criticalresolved]);targetunit.checkdead();targetunit.show();this.endnoaction(b,"")}.bind(this)}],"",!0))},unique:!0,unit:"TIE Defender",skill:8,points:37,upgrades:[ELITE,CANNON,MISSILE]},{name:"Knave Squadron Pilot",faction:REBEL,done:!0,unit:"E-Wing",skill:1,points:27,upgrades:[SYSTEM,TORPEDO,ASTROMECH]},{name:"Blackmoon Squadron Pilot",faction:REBEL,done:!0,unit:"E-Wing",skill:3,points:29,upgrades:[SYSTEM,TORPEDO,ASTROMECH]},{name:"Etahn A'baht",done:!0,faction:REBEL,init:function(){var b=
this;this.addattackmoda(this,function(c,f){return targetunit.team!=b.team&&b.isinfiringarc(targetunit)}.bind(this),function(c,f){FCH_crit(c);return 0<FCH_hit(c)?(b.log("1 %HIT% -> 1 %CRIT%"),c+FCH_CRIT-FCH_HIT):c}.bind(this),!0,"hit")},unique:!0,unit:"E-Wing",skill:5,points:32,upgrades:[ELITE,SYSTEM,TORPEDO,ASTROMECH]},{name:"Corran Horn",faction:REBEL,done:!0,init:function(){this.doublefire=-2;this.lasttry=-1},canfire:function(){return(0==this.hasfired||1==this.hasfired&&this.lasttry==round)&&!this.iscloaked&&
!this.isfireobstructed()&&this.doublefire<round-1},cleanupattack:function(){2==this.hasfired&&(this.hasdamaged&&(this.doublefire=round,this.log("no attack next round")),Unit.prototype.endcombatphase.call(this));Unit.prototype.cleanupattack.call(this)},endcombatphase:function(){this.lasttry=round;this.canfire()&&(this.log("new attack possible (no attack next turn)"),this.hasdamaged=!1,this.select(),this.doattack(!0))},unique:!0,unit:"E-Wing",skill:8,points:35,upgrades:[ELITE,SYSTEM,TORPEDO,ASTROMECH]},
{name:"Sigma Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Phantom",skill:3,points:25,upgrades:[SYSTEM,CREW]},{name:"Shadow Squadron Pilot",done:!0,faction:EMPIRE,unit:"TIE Phantom",skill:5,points:27,upgrades:[SYSTEM,CREW]},{name:"'Echo'",faction:EMPIRE,done:!0,getdecloakmatrix:function(b){for(var c=0,c=this.getpathmatrix(b,"BL2"),f=this.getpathmatrix(b,"BR2"),f=[this.m,c,f],c=-20;20>=c;c+=20)var g=b.clone().translate(0,c).rotate(90,0,0),h=b.clone().translate(0,c).rotate(-90,0,0),f=f.concat([this.getpathmatrix(g,
"BL2").rotate(-90,0,0),this.getpathmatrix(g,"BR2").rotate(-90,0,0),this.getpathmatrix(h,"BL2").rotate(90,0,0),this.getpathmatrix(h,"BR2").rotate(90,0,0)]);return f},unique:!0,unit:"TIE Phantom",skill:6,points:30,upgrades:[ELITE,SYSTEM,CREW]},{name:"'Whisper'",faction:EMPIRE,done:!0,init:function(){this.wrap_after("hashit",this,function(b,c){c&&(this.log("+1 %FOCUS%"),this.addfocustoken());return c})},unique:!0,unit:"TIE Phantom",skill:7,points:32,upgrades:[ELITE,SYSTEM,CREW]},{name:"Wes Janson",done:!0,
init:function(){this.wrap_before("endattack",this,function(b,c){0<targetunit.targeting.length?(targetunit.log("-1 %TARGET% [%0]",this.name),targetunit.removetarget(targetunit.targeting[0])):0<targetunit.focus?(targetunit.log("-1 %FOCUS% [%0]",this.name),targetunit.removefocustoken()):0<targetunit.evade&&(targetunit.log("-1 %EVADE% [%0]",this.name),targetunit.removeevadetoken())})},faction:REBEL,unique:!0,unit:"X-Wing",skill:8,points:29,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"Jek Porkins",done:!0,
addstress:function(){var b=this.rollattackdie(1)[0];this.log("-1 %STRESS%, roll 1 attack dice");"hit"==b&&(this.resolvehit(1),this.checkdead())},faction:REBEL,unique:!0,unit:"X-Wing",skill:7,points:26,upgrades:[ELITE,TORPEDO,ASTROMECH]},{name:"'Hobbie' Klivian",faction:REBEL,done:!0,init:function(){this.wrap_before("removetarget",this,function(b){this.stress&&(this.log("-1 %TARGET% -> -1 %STRESS%"),this.removestresstoken())});this.wrap_before("addtarget",this,function(b){this.stress&&(this.removestresstoken(),
this.log("+1 %TARGET% -> -1 %STRESS%"))})},unique:!0,unit:"X-Wing",skill:5,points:25,upgrades:[TORPEDO,ASTROMECH]},{name:"Tarn Mison",done:!0,isattackedby:function(b,c){if(0==this.targeting.length||this.getskill()<c.getskill())this.log("+%1 %TARGET% / %0",c.name,1),this.addtarget(c)},faction:REBEL,unique:!0,unit:"X-Wing",skill:3,points:23,upgrades:[TORPEDO,ASTROMECH]},{name:"Jake Farrell",faction:REBEL,done:!0,freemove:function(){return this.doaction([this.newaction(this.resolveboost,"BOOST"),this.newaction(this.resolveroll,
"ROLL")],"free %BOOST% or %ROLL% action")},addfocustoken:function(){this.candoaction()&&this.freemove();Unit.prototype.addfocustoken.call(this)},unique:!0,unit:"A-Wing",skill:7,points:24,upgrades:[ELITE,MISSILE]},{name:"Gemmer Sojan",done:!0,getdefensestrength:function(b,c){var f=Unit.prototype.getdefensestrength.call(this,b,c),g=this.getrangeallunits(),h;for(h=0;h<g[1].length;h++)if(squadron[g[1][h].unit].team!=this.team)return this.log("+1 defense due to ennemy at range 1"),f+1;return f},faction:REBEL,
unique:!0,unit:"A-Wing",skill:5,points:22,upgrades:[MISSILE]},{name:"Keyan Farlander",faction:REBEL,done:!0,init:function(){this.shipimg="b-wing-1.png";this.addattackmoda(this,function(b,c){return 0<this.stress}.bind(this),function(b,c){var f=FCH_focus(b);return 0<f?(this.removestresstoken(),this.log("%0 %FOCUS% -> %0 %HIT%, -1 %STRESS%",f),b-FCH_FOCUS*f+FCH_HIT*f):b}.bind(this),!1,"stress",!0)},unique:!0,unit:"B-Wing",skill:7,points:29,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Nera Dantels",
faction:REBEL,done:!0,init:function(){this.shipimg="b-wing-1.png";this.log("can fire %TORPEDO% at 360 degrees")},isTurret:function(b){return"Torpedo"==b.type?!0:!1},unique:!0,unit:"B-Wing",skill:5,points:26,upgrades:[ELITE,SYSTEM,CANNON,TORPEDO,TORPEDO]},{name:"Wild Space Fringer",done:!0,faction:REBEL,unit:"YT-2400",skill:2,points:30,upgrades:[CANNON,MISSILE,CREW]},{name:"Eaden Vrill",done:!0,init:function(){var b=this.getattackstrength;this.getattackstrength=function(c,f){var g=b.call(this,c,f);
return 0<f.stress&&this.weapons[c].isprimary?(this.log("+1 attack die"),g+1):g}.bind(this)},faction:REBEL,unit:"YT-2400",unique:!0,skill:3,points:32,upgrades:[CANNON,MISSILE,CREW]},{name:"'Leebo'",faction:REBEL,done:!0,applycritical:function(b){var c;for(c=0;c<b;c++){var f=this.selectdamage();CRITICAL_DECK[f].count--;var g=this.selectdamage();CRITICAL_DECK[g].count--;f=[f,g];this.log("select one critical");this.selectcritical(f,function(b){CRITICAL_DECK[b].count++;this.faceup(new Critical(this,b))&&
this.removehull(1);this.checkdead()}.bind(this))}this.show()},unit:"YT-2400",unique:!0,skill:5,points:34,upgrades:[ELITE,CANNON,MISSILE,CREW]},{name:"Dash Rendar",faction:REBEL,unit:"YT-2400",unique:!0,skill:7,done:!0,getocollisions:function(b,c,f,g){return{overlap:-1,template:[],mine:[]}},points:36,upgrades:[ELITE,CANNON,MISSILE,CREW]},{name:"Patrol Leader",faction:EMPIRE,done:!0,unit:"VT-49 Decimator",skill:3,points:40,upgrades:[TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Captain Oicunn",faction:EMPIRE,
unit:"VT-49 Decimator",skill:4,points:42,unique:!0,done:!0,resolvecollision:function(){var b;for(b=0;b<this.touching.length;b++){var c=this.touching[b];c.team!=this.team&&(c.log("+1 %HIT% [%0]",this.name),c.resolvehit(1),c.checkdead())}Unit.prototype.resolvecollision.call(this)},upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Commander Kenkirk",faction:EMPIRE,getagility:function(){return 0<this.criticals.length?this.agility+1:this.agility},done:!0,unit:"VT-49 Decimator",skill:6,points:44,unique:!0,
upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Rear Admiral Chiraneau",init:function(){this.addattackmoda(this,function(b,c){return 2>=this.getrange(targetunit)}.bind(this),function(b,c){return 0<FCH_focus(b)?(this.log("1 %FOCUS% -> 1 %CRIT%"),b-FCH_FOCUS+FCH_CRIT):b}.bind(this),!1,"hit")},faction:EMPIRE,unit:"VT-49 Decimator",skill:8,points:46,done:!0,unique:!0,upgrades:[ELITE,TORPEDO,CREW,CREW,CREW,BOMB]},{name:"Prince Xizor",faction:SCUM,modifydamageassigned:function(b,c){var f=[];if(0==
b)return 0;f=this.selectnearbyally(1);if(0<f.length){f.sort(function(b,c){hpa=b.hull+b.shield;hpb=c.hull+c.shield;return hpa<hpb?1:hpa>hpb?-1:0});if(10<=b)return f[0].resolvecritical(1),this.log("-1 %CRIT%"),f[0].log("+1 %CRIT% [%0]",this.name),b-10;f[0].resolvehit(1);f[0].checkdead();this.log("-1 %HIT%");f[0].log("+%1 %HIT% [%0]",this.name,1);return b-1}return b},unique:!0,done:!0,unit:"StarViper",skill:7,points:31,upgrades:[ELITE,TORPEDO]},{name:"Guri",faction:SCUM,begincombatphase:function(){!this.dead&&
0<this.selectnearbyenemy(1).length&&(this.log("+1 %FOCUS%, ennemy at range 1"),this.addfocustoken());return Unit.prototype.begincombatphase.call(this)},done:!0,unique:!0,unit:"StarViper",skill:5,points:30,upgrades:[ELITE,TORPEDO]},{name:"Black Sun Vigo",faction:SCUM,done:!0,unit:"StarViper",skill:3,points:27,upgrades:[TORPEDO]},{name:"Black Sun Enforcer",faction:SCUM,done:!0,unit:"StarViper",skill:1,points:25,upgrades:[TORPEDO]},{name:"Serissu",faction:SCUM,done:!0,init:function(){this.addglobaldefensereroll(this,
["blank","focus"],function(){return 1},function(b,c,f){return this.dead?!1:f!=this&&1==f.getrange(this)&&f.team==this.team?(f.log("+%1 reroll(s) [%0]",this.name,1),!0):!1}.bind(this))},unit:"M3-A Interceptor",skill:8,points:20,unique:!0,upgrades:[ELITE]},{name:"Laetin A'shera",faction:SCUM,endbeingattacked:function(b,c){Unit.prototype.endbeingattacked.call(this,b,c);0==b+c&&(this.log("no hit, +1 %EVADE%"),this.addevadetoken())},done:!0,unit:"M3-A Interceptor",skill:6,points:18,unique:!0,upgrades:[]},
{name:"Tansarii Point Veteran",faction:SCUM,done:!0,unit:"M3-A Interceptor",skill:5,points:17,upgrades:[ELITE]},{name:"Cartel Spacer",faction:SCUM,done:!0,unit:"M3-A Interceptor",skill:2,points:14,upgrades:[]},{name:"IG-88A",faction:SCUM,unique:!0,unit:"Aggressor",skill:6,points:36,cleanupattack:function(b,c){targetunit.dead&&this.shield<this.ship.shield&&(this.shield++,this.showstats(),this.log("+1 %SHIELD% for a kill"));Unit.prototype.cleanupattack.call(this)},done:!0,upgrades:[ELITE,SYSTEM,CANNON,
CANNON,BOMB,ILLICIT]},{name:"IG-88B",faction:SCUM,done:!0,endattack:function(b,c){if(0==b+c&&2>this.hasfired)for(var f=0;f<this.weapons.length;f++){var g=this.weapons[f];if("Cannon"==g.type&&g.isWeapon()&&0<g.getrangeallunits().length){this.log("2nd attack with %0",g.name);this.selecttargetforattack(f);break}}else Unit.prototype.endattack.call(this,b,c)},unique:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"IG-88C",faction:SCUM,resolveboost:function(b){Unit.prototype.resolveboost.call(this,
b);this.doaction([this.newaction(this.addevade,"EVADE")],"free evade action")},done:!0,unique:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"IG-88D",faction:SCUM,getmaneuverlist:function(){var b=this.getmaneuver(),c=b.move;return"SL3"==c?(this.log("%SLOOPLEFT% or %TURNLEFT% maneuver"),{SL3:b,TL3:{move:"TL3",halfturn:!0,difficulty:b.difficulty}}):"SR3"==c?(this.log("%SLOOPRIGHT% or %TURNRIGHT% maneuver"),{SR3:b,TR3:{move:"TR3",halfturn:!0,difficulty:b.difficulty}}):
{dial:b}},unique:!0,done:!0,unit:"Aggressor",skill:6,points:36,upgrades:[ELITE,SYSTEM,CANNON,CANNON,BOMB,ILLICIT]},{name:"N'Dru Suhlak",unique:!0,done:!0,faction:SCUM,init:function(){var b=this.getattackstrength;this.getattackstrength=function(c,f){var g=b.call(this,c,f);return 0==this.selectnearbyally(2).length?(this.log("+1 attack against %0, at range >=3 of friendly ships",f.name),g+1):g}.bind(this)},unit:"Z-95 Headhunter",skill:7,points:17,upgrades:[ELITE,MISSILE,ILLICIT]},{name:"Kaa'To Leeachos",
unique:!0,faction:SCUM,done:!0,begincombatphase:function(){if(!this.dead){var b=this.selectnearbyally(2);0<b.length&&this.doselection(function(c){b.push(this);this.log("select %FOCUS%/%EVADE% to take (or self to cancel)");this.resolveactionselection(b,function(f){this!=b[f]&&(0<b[f].evade?(b[f].removeevadetoken(),this.addevadetoken(),b[f].log("-1 %EVADE% [%0]",this.name),this.log("+1 %EVADE%")):0<b[f].focus&&(b[f].removefocustoken(),this.addfocustoken(),b[f].log("-1 %FOCUS% [%0]",this.name),this.log("+1 %FOCUS%")));
this.endnoaction(c,"")}.bind(this))}.bind(this))}return Unit.prototype.begincombatphase.call(this)},unit:"Z-95 Headhunter",skill:5,points:15,upgrades:[ELITE,MISSILE,ILLICIT]},{name:"Black Sun Soldier",faction:SCUM,done:!0,unit:"Z-95 Headhunter",skill:3,points:13,upgrades:[MISSILE,ILLICIT]},{name:"Binayre Pirate",faction:SCUM,done:!0,unit:"Z-95 Headhunter",skill:1,points:12,upgrades:[MISSILE,ILLICIT]},{name:"Boba Fett",faction:SCUM,unit:"Firespray-31",skill:8,points:39,init:function(){var b=function(){for(var b=
0,f=0;f<squadron.length;f++){var g=squadron[f];1==this.getrange(g)&&this.team!=g.team&&b++}return b}.bind(this);this.addattackrerolla(this,["blank","focus"],b,function(b,f){return!0});this.adddefensererolld(this,["blank","focus"],b,function(b,f){return!0})},done:!0,unique:!0,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Kath Scarlet",done:!0,getattackstrength:function(b,c){var f=Unit.prototype.getattackstrength.call(this,b,c);this.isinfiringarc(c)&&4==this.getprimarysector(c)&&(this.log("+1 attack die against %0 in auxiliary arc",
c.name),f+=1);return f},unique:!0,faction:SCUM,unit:"Firespray-31",skill:7,points:38,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Emon Azzameen",done:!0,unique:!0,getbomblocation:function(){return["F1","TL3","TR3","F3"]},faction:SCUM,unit:"Firespray-31",skill:6,points:36,upgrades:[CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Mandalorian Mercenary",faction:SCUM,done:!0,unit:"Firespray-31",skill:5,points:35,upgrades:[ELITE,CANNON,BOMB,CREW,MISSILE,ILLICIT]},{name:"Kavil",unique:!0,done:!0,
init:function(){var b=this.getattackstrength;this.getattackstrength=function(c,f){var g=b.call(this,c,f);return this.isinfiringarc(f)?g:(this.log("+1 attack die against %0 outside firing arc",f.name),g+1)}.bind(this)},faction:SCUM,unit:"Y-Wing",skill:7,points:24,upgrades:[ELITE,TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Drea Renthal",unique:!0,faction:SCUM,unit:"Y-Wing",skill:5,done:!0,removetarget:function(b){var c=this.gettargetableunits(3);0<c.length&&(c.push(this),this.doselection(function(b){this.log("select unit to target, +1 %STRESS% (or self to cancel)");
this.resolveactionselection(c,function(g){g<c.length-1&&-1<g&&-1==this.targeting.indexOf(c[g])&&(this.addtarget(c[g]),this.addstress());this.endnoaction(b,"TARGET")}.bind(this))}.bind(this)));Unit.prototype.removetarget.call(this,b)},points:22,upgrades:[TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Hired Gun",faction:SCUM,done:!0,unit:"Y-Wing",skill:4,points:20,upgrades:[TURRET,TORPEDO,TORPEDO,SALVAGED]},{name:"Syndicate Thug",faction:SCUM,done:!0,unit:"Y-Wing",skill:2,points:18,upgrades:[TURRET,TORPEDO,
TORPEDO,SALVAGED]},{name:"Dace Bonearm",unique:!0,faction:SCUM,unit:"HWK-290",done:!0,init:function(){var b=this,c=Unit.prototype.addiontoken;Unit.prototype.addiontoken=function(){c.call(this);3>=this.getrange(b)&&b.team!=this.team&&0==b.stress&&(b.addstress(),this.resolvehit(1),b.log("+1 %STRESS%"),this.log("+%1 %HIT [%0]",b.name,1),this.checkdead())}},skill:7,points:23,upgrades:[ELITE,TURRET,CREW,ILLICIT]},{name:"Palob Godalhi",unique:!0,faction:SCUM,unit:"HWK-290",begincombatphase:function(){if(!this.dead){var b=
this.selectnearbyenemy(2);0<b.length&&this.doselection(function(c){b.push(this);this.log("select %FOCUS%/%EVADE% to take (or self to cancel)");this.resolveactionselection(b,function(f){this!=b[f]&&(0<b[f].evade?(b[f].removeevadetoken(),this.addevadetoken(),b[f].log("-1 %EVADE% [%0]",this.name),this.log("+1 %EVADE%")):0<b[f].focus&&(b[f].removefocustoken(),this.addfocustoken(),b[f].log("-1 %FOCUS% [%0]",this.name),this.log("+1 %FOCUS%")));this.endnoaction(c,"")}.bind(this))}.bind(this))}return Unit.prototype.begincombatphase.call(this)},
done:!0,skill:5,points:20,upgrades:[ELITE,TURRET,CREW,ILLICIT]},{name:"Torkil Mux",unique:!0,done:!0,endactivationphase:function(){var b=this,c=this.selectnearbyenemy(2);0<c.length&&this.doselection(function(f){this.log("select unit for a 0 PS");this.resolveactionselection(c,function(g){c[g].wrap_after("getskill",b,function(b){return 0}).unwrapper("endcombatphase");this.endnoaction(f,"")}.bind(this))}.bind(this))},faction:SCUM,unit:"HWK-290",skill:3,points:19,upgrades:[TURRET,CREW,ILLICIT]},{name:"Spice Runner",
faction:SCUM,done:!0,unit:"HWK-290",skill:1,points:16,upgrades:[TURRET,CREW,ILLICIT]},{name:"Commander Alozen",faction:EMPIRE,unit:"TIE Advanced",unique:!0,done:!0,skill:5,points:25,begincombatphase:function(){this.doselection(function(b,c){var f=this.gettargetableunits(1);this.log("gettargetableunits"+f.length);0<f.length?(f.push(this),this.log("select unit to lock (or self to cancel)"),this.resolveactionselection(f,function(c){this!=f[c]&&(this.addtarget(f[c]),this.log("+%1 %TARGET% / %0",f[c].name,
1));this.endnoaction(b,"TARGET")}.bind(this))):this.endnoaction(b,"TARGET")}.bind(this));return Unit.prototype.begincombatphase.call(this)},upgrades:[ELITE,MISSILE]},{name:"Juno Eclipse",unique:!0,done:!0,faction:EMPIRE,unit:"TIE Advanced",skill:8,points:28,getmaneuverlist:function(){var b=this.getmaneuver(),c={};c[b.move]=b;for(var f=parseInt(b.move.substr(-1),10),g=-1;1>=g;g++){var h=b.move.replace(/\d/,f+g+"");"undefined"!=typeof P[h]&&(c[h]={move:h,difficulty:b.difficulty,halfturn:b.halfturn})}return c},
upgrades:[ELITE,MISSILE]},{name:"Zertik Strom",unique:!0,done:!0,faction:EMPIRE,unit:"TIE Advanced",skill:6,init:function(){var b=this;Weapon.prototype.wrap_after("getrangeattackbonus",this,function(c,f){return this.unit.team!=b.team&&1==b.getrange(this.unit)?(this.unit.log("0 attack range bonus [%0]",b.name),0):f});Weapon.prototype.wrap_after("getrangedefensebonus",this,function(c,f){return this.unit.team!=b.team&&1==b.getrange(this.unit)?(this.unit.log("0 defense range bonus [%0]",b.name),0):f})},
points:26,upgrades:[ELITE,MISSILE]},{name:"Lieutenant Colzet",unique:!0,faction:EMPIRE,unit:"TIE Advanced",skill:3,points:23,upgrades:[ELITE,MISSILE],done:!0,endcombatphase:function(){this.doselection(function(b){var c=[this].concat(this.targeting);this.resolveactionselection(c,function(f){if(0<f&&this.canusetarget(c[f])){var g=c[f].criticals;this.removetarget(c[f]);0<g.length&&c[f].faceup(g[rand(g.length)])}this.endnoaction(b,"TARGET")}.bind(this))}.bind(this))}},{name:"Bossk",faction:SCUM,unit:"YV-666",
unique:!0,skill:7,points:35,done:!0,hashit:function(b){var c=Unit.prototype.hashit.call(this,b),f=this.criticalresolved+this.hitresolved;c&&0<this.criticalresolved&&(f<=b.shield||2>=b.hull&&f>b.shield?(this.criticalresolved--,this.hitresolved+=2,this.log("1 %CRIT% -> 2 %HIT%")):this.log(b.name+" shields are down, more than 2 hulls: keeping critical"))},upgrades:[ELITE,CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Moralo Eval",faction:SCUM,unit:"YV-666",unique:!0,skill:6,points:34,done:!0,init:function(){for(var b=
0;b<this.weapons.length;b++)"Cannon"==this.weapons[b].type&&(this.log("can fire %0 in auxiliary firing arc",this.weapons[b].name),this.weapons[b].auxiliary=this.weapons[0].auxiliary,this.weapons[b].subauxiliary=this.weapons[0].subauxiliary)},upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Latts Razzi",faction:SCUM,unit:"YV-666",unique:!0,skill:5,points:33,done:!0,init:function(){var b=this,c=Unit.prototype.declareattack;Unit.prototype.declareattack=function(f,g){c.call(this,f,g);b.team==
this.team&&b.canusetarget(g)&&b.donoaction([this.newaction(function(b){this.removetarget(g);var c=g.endbeingattacked,f=g.getdefensestrength;g.endbeingattacked=function(b,g){this.endbeingattacked=c;this.getdefensestrength=f}.bind(g);g.getdefensestrength=function(b,c){return f.call(g,b,c)-1}.bind(g);this.endnoaction(b,"TARGET")}.bind(b),"TARGET")],b.name+": -1 agility for "+g.name,!0)}},upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Trandoshan Slaver",faction:SCUM,unit:"YV-666",done:!0,skill:2,
points:29,upgrades:[CANNON,MISSILE,CREW,CREW,CREW,ILLICIT]},{name:"Talonbane Cobra",unique:!0,faction:SCUM,unit:"Kihraxz Fighter",skill:9,upgrades:[ELITE,MISSILE,ILLICIT],done:!0,getattackstrength:function(b,c){return this.weapons[b].getattack()+2*this.weapons[b].getrangeattackbonus(c)},getdefensestrength:function(b,c){var f=this.getagility(),g=c.getobstructiondef(this);0<g&&this.log("+%0 defense for obstacle",g);return f+2*c.weapons[b].getrangedefensebonus(this)+g},points:28},{name:"Graz the Hunter",
unique:!0,faction:SCUM,unit:"Kihraxz Fighter",skill:6,upgrades:[MISSILE,ILLICIT],getdefensestrength:function(b,c){var f=0;3>=this.weapons[b].getsector(c)&&(f=1,this.log("+1 defense die for defending in firing arc"));return Unit.prototype.getdefensestrength.call(this,b,c)+f},done:!0,points:25},{name:"Black Sun Ace",faction:SCUM,unit:"Kihraxz Fighter",done:!0,skill:5,upgrades:[ELITE,MISSILE,ILLICIT],points:23},{name:"Cartel Marauder",done:!0,faction:SCUM,unit:"Kihraxz Fighter",skill:2,upgrades:[MISSILE,
ILLICIT],points:20},{name:"Miranda Doni",unique:!0,done:!0,faction:REBEL,unit:"K-Wing",skill:8,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],mirandaturn:-1,preattackroll:function(b,c){if(this.mirandaturn!=round){var f={org:this,name:this.name,type:"SHIELD",action:function(b){this.mirandaturn=round;this.log("-1 attack die");this.wrap_after("getattackstrength",this,function(b,c){var f=this.weapons[b].getattack()-1;return this.weapons[b].getrangeattackbonus(c)+(0<f)?f:0}).unwrapper("attackroll");
this.shield<this.ship.shield&&(this.shield++,this.log("+1 %SHIELD%"));this.endnoaction(b,"SHIELD")}.bind(this)},g={org:this,name:this.name,type:"HIT",action:function(b){this.log("-1 %SHIELD%");this.log("+1 attack die");this.mirandaturn=round;this.wrap_after("getattackstrength",this,function(b,c){return 1+Unit.prototype.getattackstrength.call(this,b,c)}).unwrapper("attackroll");this.removeshield(1);this.endnoaction(b,"HIT")}.bind(this)},h=[];0<this.shield&&h.push(g);this.shield<this.ship.shield&&h.push(f);
this.donoaction(h,"select to add shield/roll 1 fewer die or remove shield/roll 1 additional die",!0)}},points:29},{name:"Esege Tuketu",unique:!0,faction:REBEL,unit:"K-Wing",skill:6,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:28,done:!0,init:function(){var b=this;Unit.prototype.wrap_before("beginattack",this,function(){this!=b&&this.team==b.team&&(this.wrap_after("canusefocus",b,function(c){return c||b.canusefocus()&&2>=this.getrange(b)}).unwrapper("endattack"),this.wrap_before("removefocustoken",
b,function(){2>=this.getrange(b)&&(this.focus++,b.log("-1 %FOCUS% [%0]",this.name),b.removefocustoken())}).unwrapper("endattack"))})}},{name:"Guardian Squadron Pilot",faction:REBEL,done:!0,unit:"K-Wing",skill:4,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:25},{name:"Warden Squadron Pilot",faction:REBEL,done:!0,unit:"K-Wing",skill:2,upgrades:[TURRET,TORPEDO,TORPEDO,MISSILE,CREW,BOMB,BOMB],points:23},{name:"'Redline'",unique:!0,faction:EMPIRE,unit:"TIE Punisher",skill:7,done:!0,boundtargets:function(b){if(-1<
this.targeting.indexOf(b))return!0;for(b=0;b<this.targeting.length-1;b++)this.removetarget(this.targeting[b]);return!1},addtarget:function(b){this.boundtargets()||(this.log("+%1 %TARGET% / %0",b.name,2),this.targeting.push(b),this.targeting.push(b),b.istargeted.push(this),b.istargeted.push(this),b.show(),this.show())},upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:27},{name:"'Deathrain'",unique:!0,faction:EMPIRE,unit:"TIE Punisher",skill:6,done:!0,bombdropped:function(){this.doaction([this.newaction(this.resolveroll,
"ROLL")],"free %ROLL% action")},getbombposition:function(b,c){for(var f=Unit.prototype.getbombposition.call(this,b,c),g=0;g<b.length;g++)f.push(this.getpathmatrix(this.m,b[g]).translate(0,-c));return f},upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:26},{name:"Black Eight Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Punisher",skill:4,upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:23},{name:"Cutlass Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE Punisher",
skill:2,upgrades:[SYSTEM,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB,BOMB],points:21},{name:"Poe Dameron",faction:REBEL,unit:"T-70 X-Wing",unique:!0,done:!0,skill:8,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],init:function(){this.addattackmoda(this,function(b,c){return 0<this.focus}.bind(this),function(b,c){return 0<FCH_focus(b)?(this.log("1 %FOCUS% -> 1 %HIT%"),b-FCH_FOCUS+FCH_HIT):b}.bind(this),!1,"focus");this.adddefensemodd(this,function(b,c){return 0<this.focus}.bind(this),function(b,c){return 0<FE_focus(b)?
(this.log("1 %FOCUS% -> 1 %EVADE%"),b-FE_FOCUS+FE_EVADE):b}.bind(this),!1,"focus")},points:31},{name:"'Blue Ace'",faction:REBEL,done:!0,unit:"T-70 X-Wing",skill:5,unique:!0,getboostmatrix:function(b){return[this.getpathmatrix(this.m,"TR1"),this.getpathmatrix(this.m,"TL1")].concat(Unit.prototype.getboostmatrix.call(this,b))},upgrades:[TORPEDO,ASTROMECH,TECH],points:27},{name:"Ello Asty",faction:REBEL,done:!0,beta:!0,unit:"T-70 X-Wing",skill:7,unique:!0,getdial:function(){for(var b=[],c=Unit.prototype.getdial.call(this),
f=0;f<c.length;f++){var g=c[f].move,h=c[f].difficulty;g.match(/TR[RL]\d/)&&0==this.stress&&(h="WHITE");b[f]={move:g,difficulty:h}}return b},upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:30},{name:"'Red Ace'",faction:REBEL,done:!0,beta:!0,unit:"T-70 X-Wing",skill:5,unique:!0,init:function(){this.sr=-1},removeshield:function(b){this.sr<round&&(this.log("+1 %SHIELD%"),this.sr=round,this.addevadetoken());Unit.prototype.removeshield.call(this,b)},upgrades:[TORPEDO,ASTROMECH,TECH],points:29},{name:"Blue Squadron Novice",
faction:REBEL,done:!0,unit:"T-70 X-Wing",skill:2,upgrades:[TORPEDO,ASTROMECH,TECH],points:24},{name:"Red Squadron Veteran",faction:REBEL,done:!0,unit:"T-70 X-Wing",skill:4,upgrades:[ELITE,TORPEDO,ASTROMECH,TECH],points:26},{name:"Omega Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE/FO Fighter",skill:4,upgrades:[TECH,ELITE],points:17},{name:"Zeta Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE/FO Fighter",skill:3,upgrades:[TECH],points:16},{name:"Epsilon Squadron Pilot",faction:EMPIRE,done:!0,unit:"TIE/FO Fighter",
skill:1,upgrades:[TECH],points:15},{name:"'Zeta Ace'",faction:EMPIRE,done:!0,unique:!0,unit:"TIE/FO Fighter",skill:5,getrollmatrix:function(b){var c=this.getpathmatrix(this.m.clone().rotate(90,0,0),"F2").translate(0,this.islarge?20:0).rotate(-90,0,0),f=this.getpathmatrix(this.m.clone().rotate(-90,0,0),"F2").translate(0,this.islarge?20:0).rotate(90,0,0);return[c.clone().translate(0,-20),c,c.clone().translate(0,20),f.clone().translate(0,-20),f,f.clone().translate(0,20)].concat(Unit.prototype.getrollmatrix.call(this,
b))},upgrades:[ELITE,TECH],points:18},{name:"'Epsilon Leader'",faction:EMPIRE,done:!0,unique:!0,unit:"TIE/FO Fighter",skill:6,begincombatphase:function(){for(var b=this.selectnearbyally(1),c=0;c<b.length;c++)b[c].removestresstoken();return Unit.prototype.begincombatphase.call(this)},upgrades:[ELITE,TECH],points:19},{name:"'Omega Ace'",faction:EMPIRE,done:!0,unique:!0,unit:"TIE/FO Fighter",skill:7,init:function(){this.addattackmoda(this,function(b,c){return this.canusefocus()&&-1<this.targeting.indexOf(targetunit)}.bind(this),
function(b,c){this.removefocustoken();this.removetarget(targetunit);this.log("all results are %CRIT%");return c*FCH_CRIT}.bind(this),!1,"critical")},upgrades:[ELITE,TECH],points:20},{name:"'Omega Leader'",faction:EMPIRE,beta:!0,unique:!0,unit:"TIE/FO Fighter",skill:8,upgrades:[ELITE,TECH],points:21,done:!0,canblockattackmod:function(b){return-1<b.istargeted.indexOf(this)&&b.team!=this.team&&this==targetunit&&b==activeunit},canblockdefensemod:function(b){return-1<b.istargeted.indexOf(this)&&b.team!=
this.team&&b==targetunit&&this==activeunit},init:function(){var b=Unit.prototype.getattackrerolltokens,c=Unit.prototype.getdefensererolltokens,f=Unit.prototype.getattackmodtokens,g=Unit.prototype.getdefensemodtokens,h=this;Unit.prototype.getattackrerolltokens=function(){return h.canblockattackmod(this)?"":b.call(this)};Unit.prototype.getdefensererolltokens=function(){return h.canblockdefensemod(this)?"":c.call(this)};Unit.prototype.getattackmodtokens=function(b,c){return h.canblockattackmod(this)?
"":f.call(this,b,c)};Unit.prototype.getdefensemodtokens=function(b,c){return h.canblockdefensemod(this)?"":g.call(this,b,c)}}},{name:"Hera Syndulla",unique:!0,faction:REBEL,unit:"VCX-100",skill:7,ambiguous:!0,points:40,done:!0,getmaneuverlist:function(){var b=this.getmaneuver(),c={},f=this.getdial();c[b.move]=b;if(("RED"==b.difficulty||"GREEN"==b.difficulty)&&0==this.ionized)for(var g=0;g<f.length;g++)f[g].difficulty==b.difficulty&&"undefined"==typeof c[f[g].move]&&(c[f[g].move]=f[g]);return c},upgrades:[SYSTEM,
TURRET,TORPEDO,TORPEDO,CREW,CREW]},{name:"'Chopper'",unique:!0,faction:REBEL,unit:"VCX-100",skill:4,points:37,done:!0,begincombatphase:function(){for(var b=0;b<this.touching.length;b++)this.touching[b].team!=this.team&&(this.touching[b].addstress(),this.touching[b].log("+1 %STRESS% [%0]",this.name));return Unit.prototype.begincombatphase.call(this)},upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW]},{name:"Ezra Bridger",faction:REBEL,unique:!0,done:!0,unit:"Attack Shuttle",skill:4,points:20,init:function(){this.adddefensemodd(this,
function(b,c){return 0<this.stress}.bind(this),function(b,c){var f=FE_focus(b);2<f&&(f=2);return 0<f?(this.log("%0 %FOCUS% -> %0 %EVADE%",f),b-f*FE_FOCUS+f*FE_EVADE):b}.bind(this),!1,"focus")},upgrades:[ELITE,TURRET,CREW]},{name:"Hera Syndulla",faction:REBEL,unique:!0,done:!0,unit:"Attack Shuttle",skill:7,ambiguous:!0,points:22,getmaneuverlist:function(){var b=this.getmaneuver(),c={},f=this.getdial();c[b.move]=b;if(("RED"==b.difficulty||"GREEN"==b.difficulty)&&0==this.ionized)for(var g=0;g<f.length;g++)f[g].difficulty==
b.difficulty&&"undefined"==typeof c[f[g].move]&&(c[f[g].move]=f[g]);return c},upgrades:[ELITE,TURRET,CREW]},{name:"Sabine Wren",faction:REBEL,unique:!0,done:!0,unit:"Attack Shuttle",skill:5,points:21,beginactivation:function(){this.candoaction()&&this.doaction([this.newaction(this.resolveboost,"BOOST"),this.newaction(this.resolveroll,"ROLL")],"free %BOOST% or %ROLL% action")},upgrades:[ELITE,TURRET,CREW]},{name:"'Zeb' Orrelios",faction:REBEL,unique:!0,unit:"Attack Shuttle",skill:3,points:18,done:!0,
cancelhit:function(b,c){this.log("cancel %CRIT% first");b=this.cancelcritical(b,c);return b=Unit.prototype.cancelhit(b,c)},upgrades:[TURRET,CREW]},{name:"Kanan Jarrus",faction:REBEL,unique:!0,unit:"VCX-100",skill:4,points:38,upgrades:[SYSTEM,TURRET,TORPEDO,TORPEDO,CREW,CREW]},{name:"'Wampa'",faction:EMPIRE,unique:!0,unit:"TIE Fighter",skill:4,points:14,done:!0,init:function(){this.addattackadd(this,function(b,c){return!0},function(b,c){this.log("cancel all dice, +1 damage card");targetunit.applydamage(1);
return{m:0,n:0}}.bind(this),"critical")},upgrades:[]},{name:"'Youngster'",faction:EMPIRE,unique:!0,unit:"TIE Fighter",skill:6,points:15,done:!0,init:function(){var b=null,c=this;for(i=0;i<this.upgrades.length;i++)this.upgrades[i].type==ELITE&&"function"==typeof this.upgrades[i].action&&(b=this.upgrades[i]);null!=b&&(this.log("share %0 upgrade",b.name),Unit.prototype.wrap_after("getupgactionlist",c,function(f){return this.team==c.team&&c!=this&&3>=this.getrange(c)&&this.ship.name.match(/.*TIE.*Fighter.*/)?
(this.log("elite action from %0 available",c.name),f.concat({org:c,action:b.action,type:b.type.toUpperCase(),name:b.name})):f}))},upgrades:[ELITE]},{name:"'Chaser'",faction:EMPIRE,unique:!0,done:!0,unit:"TIE Fighter",skill:3,points:14,init:function(){var b=this;Unit.prototype.wrap_after("removefocustoken",this,function(){this.team==b.team&&this!=b&&1>=this.getrange(b)&&(b.log("+1 %FOCUS%"),b.addfocustoken())})},upgrades:[]},{name:"Gamma Squadron Veteran",faction:EMPIRE,done:!0,unit:"TIE Bomber",skill:5,
points:19,upgrades:[ELITE,TORPEDO,TORPEDO,MISSILE,MISSILE,BOMB]},{name:"The Inquisitor",faction:EMPIRE,unit:"TIE Adv. Prototype",skill:8,unique:!0,done:!0,points:25,getattackstrength:function(b,c){if(0==b){var f=this.weapons[b].getattack();if(1<this.weapons[b].getrange(c))return this.log("+1 attack die with primary weapon [%0]",this),f+1}return Unit.prototype.getattackstrength.call(this,b,c)},upgrades:[ELITE,MISSILE]},{name:"Valen Rudor",faction:EMPIRE,unique:!0,unit:"TIE Adv. Prototype",skill:6,
points:22,done:!0,init:function(){this.wrap_after("endbeingattacked",this,function(b,c){this.candoaction()&&(this.log("+1 free action [%0]",this.name),this.doaction(this.getactionlist()))})},upgrades:[ELITE,MISSILE]},{name:"Sienar Test Pilot",faction:EMPIRE,done:!0,unit:"TIE Adv. Prototype",skill:2,points:16,upgrades:[MISSILE]},{name:"Zuckuss",faction:SCUM,unique:!0,unit:"G-1A Starfighter",skill:7,points:28,upgrades:[ELITE,CREW,SYSTEM,ILLICIT]},{name:"4-LOM",faction:SCUM,unique:!0,done:!0,unit:"G-1A Starfighter",
skill:6,points:26,init:function(){this.wrap_before("endphase",this,function(){var b=this.selectnearbyunits(1,function(){return!0});0<this.stress&&1<b.length&&(this.log("select unit (or self to cancel) [%0]",this.name),this.doselection(function(c){this.resolveactionselection(b,function(f){b[f]!=this&&(b[f].addstress(),this.stress--,b[f].log("+1 %STRESS% [%0]",this.name),this.log("-1 %STRESS%"));this.endnoaction(c,"HIT")}.bind(this))}.bind(this)))})},upgrades:[ELITE,CREW,SYSTEM,ILLICIT]}],UPGRADE_TYPES=
{Elite:"ept",Torpedo:TORPEDO,Astromech:"amd",Turret:"turret",Missile:"missile",Crew:"crew",Cannon:"cannon",Bomb:"bomb",Title:"title",Mod:"mod",System:"system",Illicit:"illicit",Salvaged:"salvaged",Tech:"tech"};
function Laser(b,c,f){return"Bilaser"==c?new Weapon(b,{type:c,name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0,auxiliary:function(b,c){return this.getPrimarySectorString(b,c.clone().rotate(180,0,0))},subauxiliary:function(b,c,f){return this.getPrimarySubSectorString(b,c,f.clone().rotate(180,0,0))}}):"Laser180"==c?new Weapon(b,{type:c,name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0,auxiliary:function(b,c){return this.getHalfRangeString(b,c)},subauxiliary:function(b,c,f){return this.getHalfSubRangeString(b,
c,f)}}):new Weapon(b,{type:c,name:"Laser",isactive:!0,attack:f,range:[1,3],isprimary:!0})}function Bomb(b,c){$.extend(this,c);b.upgrades.push(this);this.isactive=!0;this.ordnance=b.ordnance;this.unit=b;b.bombs.push(this);this.exploded=!1}
Bomb.prototype={isWeapon:function(){return!1},isBomb:function(){return!0},canbedropped:function(){return this.isactive&&!this.unit.hasmoved},actiondrop:function(b){this.unit.lastdrop=round;$(".bombs").remove();this.drop(this.unit.getbomblocation());this.unit.showactivation();this.unit.endaction(b)},toString:function(){var b,c,f,g="";this.isactive||(g="class='inactive'");b="<td><code class='"+this.type+" upgrades'></code>";b+="</td>";f=UPGRADE_translation[this.name];c=this.name;var h="";this.ordnance&&
(h='<sup style="padding:1px;color:white;background-color:red;border-radius:100%;">x2</sup>');"undefined"!=typeof f&&"undefined"!=typeof f.name&&(c=f.name);c="<td class='tdstat'><span>"+c.replace(/\'/g,"&#39;")+h+"</span></td>";f="undefined"!=typeof f&&"undefined"!=typeof f.text?f.text:"";f=""==f?"<td class='outoverflow'></td>":"<td class='tooltip outoverflow'><span>"+formatstring(f)+"</span></td>";return 1==this.unit.team?"<tr "+g+">"+c+b+f+"</tr>":"<tr "+g+">"+b+c+f+"</tr>"},getrangeallunits:function(){var b=
[[],[],[],[],[]],c;for(c in squadron){var f=this.getrange(squadron[c]);0<f&&b[f].push({unit:c})}return b},getcollisions:function(){var b=this.getOutlineString(),c=[];for(i in squadron){var f=squadron[i],g=f.getOutlineString(f.m);os=g.s;op=g.p;(0<Snap.path.intersection(b.s,os).length||this.unit.isPointInside(b.s,op)||this.unit.isPointInside(os,b.p))&&c.push(f)}return c},getrange:function(b){var c=this.getOutlineString(this.m).p;b=b.getOutlinePoints(b.m);var f=90001,g,h;for(g=0;g<c.length;g++)for(h=
0;4>h;h++){var l=dist(b[h],c[g]);l<f&&(f=l)}return 9E4<f?4:1E4>=f?1:4E4>=f?2:3},resolveactionmove:function(b,c){var f;this.pos=[];var g=function(c,g,m){for(f=0;f<b.length;f++)this.pos[f].remove();this.m=c;m(this,g)}.bind(this);if(1==b.length)this.pos[0]=this.getOutline(b[0]).attr({fill:this.unit.color,opacity:.7}),g(b[0],0,c);else for(f=0;f<b.length;f++)this.pos[f]=this.getOutline(b[f]).attr({fill:this.unit.color,opacity:.7}),function(f){this.pos[f].hover(function(){this.pos[f].attr({stroke:this.unit.color,
strokeWidth:"4px"})}.bind(this),function(){this.pos[f].attr({strokeWidth:"0"})}.bind(this));this.pos[f].click(function(){g(b[f],f,c)})}.call(this,f)},drop:function(b){var c=this;this.ordnance?(this.ordnance=!1,c=$.extend({},this)):this.isactive=!1;c.img1=s.image("png/"+this.img,-this.width/2,-this.height/2,this.width,this.height);c.outline=this.getOutline(new Snap.matrix).attr({display:"block","class":"outline",stroke:halftone(GREY),strokeWidth:2,fill:"rgba(8,8,8,0.3)"});this.repeatx?(c.img2=s.image("png/"+
this.img,-this.width/2-this.repeatx,-this.height/2,this.width,this.height),c.img3=s.image("png/"+this.img,-this.width/2+this.repeatx,-this.height/2,this.width,this.height),c.g=s.group(c.outline,c.img1,c.img2,c.img3)):c.g=s.group(c.outline,c.img1);c.g.attr("display","none");c.g.hover(function(){var b=VIEWPORT.m.clone(),c=$("#svgout").width(),h=$("#svgout").height(),l=0,m=0;h>c?m=(h-c)/2:l=(c-h)/2;var q=Math.max(900/c,900/h),r=this.g.getBBox(),c=$("#svgout").position();Math.min($("#playmat").width(),
$("#playmat").height());h=b.x(r.x,r.y-20)/q;h+=c.left+l;b=b.y(r.x,r.y-20)/q;b+=c.top+m;this.outline.attr({stroke:GREY});$(".info").css({left:h,top:b}).html(this.name).appendTo("body").show()}.bind(c),function(){$(".info").hide();this.outline.attr({stroke:halftone(GREY)})}.bind(c));c.resolveactionmove(this.unit.getbombposition(b,this.size),function(b){this.g.transform(this.m);this.g.appendTo(VIEWPORT);this.g.attr("display","block");BOMBS.push(this);if(this.stay){OBSTACLES.push(this);var c=this.getcollisions();
0<c.length&&this.unit.resolveactionselection(c,function(b){this.detonate(c[b])}.bind(this))}this.unit.bombdropped(this)}.bind(c))},getOutline:function(b){b=s.path(this.getOutlineString(b).s);b.appendTo(VIEWPORT);return b},getOutlineString:function(b){"undefined"==typeof b&&(b=this.m);var c=transformPoint(b,{x:-16,y:-15}),f=transformPoint(b,{x:16,y:-15}),g=transformPoint(b,{x:16,y:15});b=transformPoint(b,{x:-16,y:15});c=this.op=[c,f,g,b];return{s:"M "+c[0].x+" "+c[0].y+" L "+c[1].x+" "+c[1].y+" "+
c[2].x+" "+c[2].y+" "+c[3].x+" "+c[3].y+" Z",p:c}},explode:function(){this.exploded=!0;this.unit.log("%0 explodes",this.name);SOUNDS[this.snd].play();this.g.remove();BOMBS.splice(BOMBS.indexOf(this),1)},detonate:function(){OBSTACLES.splice(OBSTACLES.indexOf(this),1);Bomb.prototype.explode.call(this)},endround:function(){}};
function Weapon(b,c){this.isprimary=!1;$.extend(this,c);b.upgrades.push(this);this.isactive=!0;this.type.match("Missile|Torpedo")&&(this.ordnance=b.ordnance);this.unit=b;b.weapons.push(this)}
Weapon.prototype={isBomb:function(){return!1},isWeapon:function(){return!0},hasauxiliaryfiringarc:function(){return!1},toString:function(){var b,c,f,g="";if(this.isactive){f=this.getrangeallunits();for(b=0;b<f.length&&f[b].team==this.unit.team;b++);b==f.length&&(g="class='nofire'")}else g="class='inactive'";for(b in squadron)if(squadron[b]==this.unit)break;b="<td><button class='statfire'"+(" onclick='if (!squadron["+b+"].dead) squadron["+b+'].togglehitsector("'+this.name.replace(/\'/g,"&#39;")+"\")'");
b+=">"+this.getattack()+"<span class='symbols'>"+A[this.type.toUpperCase()].key+"</span>";b+="</button></td>";f=UPGRADE_translation[this.name];c=this.name;var h="";this.ordnance&&(h='<sup style="padding:1px;color:white;background-color:red;border-radius:100%;">x2</sup>');"undefined"!=typeof f&&"undefined"!=typeof f.name&&(c=f.name);c="<td class='tdstat'><span>"+c.replace(/\'/g,"&#39;")+h+" <span style='font-size:x-small'>";"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&
(c+="<code class='symbols'>"+A.TARGET.key+"</code>"),"Focus".match(this.getrequirements())&&(c+=(5<this.getrequirements().length?"/":"")+"<code class='symbols'>"+A.FOCUS.key+"</code>"));c+="["+this.range[0]+"-"+this.range[1]+"]</span></span></td>";f="undefined"!=typeof f&&"undefined"!=typeof f.text?f.text:"";f=""==f?"<td class='outoverflow'></td>":"<td class='tooltip outoverflow'><span>"+formatstring(f)+"</span></td>";return 1==this.unit.team?"<tr "+g+">"+c+b+f+"</tr>":"<tr "+g+">"+b+c+f+"</tr>"},
prehit:function(b,c,f){},posthit:function(b,c,f){},getrequirements:function(){return this.requires},getattack:function(){return this.attack},isTurret:function(){return this.type==TURRET},isinrange:function(b){return b>=this.range[0]&&b<=this.range[1]},modifydamagegiven:function(b){return b},modifydamageassigned:function(b,c){return b},canfire:function(b){return!this.isactive||this.unit.team==b.team||this.unit.checkcollision(b)?!1:"undefined"!=typeof this.getrequirements()?"Target".match(this.getrequirements())&&
this.unit.canusetarget(b)?!0:"Focus".match(this.getrequirements())&&this.unit.canusefocus(b)?!0:!1:!0},getrangeattackbonus:function(b){return this.isprimary&&1==this.getrange(b)?(this.unit.log("+1 attack for range 1"),1):0},declareattack:function(b){"undefined"!=typeof this.getrequirements()&&("Target".match(this.getrequirements())&&this.unit.canusetarget(b)?this.unit.removetarget(b):"Focus".match(this.getrequirements())&&this.unit.canusefocus(b)&&this.unit.removefocustoken(),this.unit.show())},getrangedefensebonus:function(b){return this.isprimary&&
3==this.getrange(b)?(b.log("+1 defense for range 3"),1):0},getsector:function(b){var c=this.unit.m,f=this.unit.getoutlinerange(c,b).d;return this.unit.isinsector(c,f,b,this.unit.getPrimarySubSectorString,this.unit.getPrimarySectorString)?f:"undefined"==typeof this.auxiliary?4:this.unit.isinsector(c,f,b,this.subauxiliary,this.auxiliary)?f:4},getrange:function(b){if(!this.canfire(b))return 0;if(this.isTurret()||this.unit.isTurret(this))return b=this.unit.getrange(b),this.isinrange(b)?b:0;b=this.getsector(b);
return b>=this.range[0]&&b<=this.range[1]?b:0},endattack:function(b,c){this.type.match("Torpedo|Missile")&&(this.ordnance?this.ordnance=!1:this.isactive=!1)},getenemiesinrange:function(){var b,c=[];for(b in squadron){var f=squadron[b];this.unit.team!=f.team&&0<this.getrange(f)&&c.push(f)}return c},getrangeallunits:function(){var b,c=[];for(b in squadron){var f=squadron[b];this.unit!=f&&0<this.getrange(f)&&c.push(f)}return c},wrap_before:Unit.prototype.wrap_before,wrap_after:Unit.prototype.wrap_after,
endround:function(){}};function Upgrade(b,c){$.extend(this,UPGRADES[c]);b.upgrades.push(this);this.isactive=!0;this.unit=b;var f=this.addedaction;"undefined"!=typeof f&&(f=f.toUpperCase(),b.shipactionList.push(f))}
function Upgradefromid(b,c){var f=UPGRADES[c];f.id=c;return f.type==BOMB?new Bomb(b,f):"undefined"!=typeof f.isWeapon?f.isWeapon()?new Weapon(b,f):new Upgrade(b,c):f.type.match("Turretlaser|Bilaser|Laser180|Laser|Torpedo|Cannon|Missile|Turret")||1==f.isweapon?new Weapon(b,f):new Upgrade(b,c)}
Upgrade.prototype={toString:function(){var b,c,f="",g;this.isactive||(f="class='inactive'");b="<td><code class='"+this.type+" upgrades'></code></td>";g=UPGRADE_translation[this.name+(this.type==CREW?"(Crew)":"")];c=this.name;"undefined"!=typeof g&&"undefined"!=typeof g.name&&(c=g.name);c="<td class='tdstat'>"+c.replace(/\'/g,"&#39;")+"</td>";g="undefined"!=typeof g&&"undefined"!=typeof g.text?g.text:"";g=""==g?"<td class='outoverflow'></td>":"<td class='tooltip outoverflow'><span>"+formatstring(g)+
"</span></td>";return 1==this.unit.team?"<tr "+f+">"+c+b+g+"</tr>":"<tr "+f+">"+b+c+g+"</tr>"},isWeapon:function(){return!1},isBomb:function(){return!1},endround:function(){},install:function(b){if("undefined"!=typeof this.addedaction){var c=this.addedaction.toUpperCase();b["addedaction"+this.id]=b.shipactionList.length;b.shipactionList.push(c);b.showactionlist()}"undefined"!=typeof this.upgrades&&(b["addedupg"+this.id]=b.upgradesno,"undefined"!=typeof this.pointsupg&&(b.upgbonus[this.upgrades[0]]=
this.pointsupg),"undefined"!=typeof this.maxupg&&(b.maxupg[this.upgrades[0]]=this.maxupg),1==this.exclusive&&(b.exclupg[this.upgrades[0]]=!0),b.upgradetype=b.upgradetype.concat(this.upgrades),b.upgradesno=b.upgradetype.length,b.showupgradeadd());if("undefined"!=typeof this.lostupgrades){for(c=0;c<b.upgradetype.length;c++)-1<this.lostupgrades.indexOf(b.upgradetype[c])&&(-1<b.upg[c]&&removeupgrade(b,c,b.upg[c]),b.upg[c]=-2);b.showupgradeadd()}if("undefined"!=typeof this.takesdouble){for(c=0;c<b.upgradetype.length;c++)if(b.upgradetype[c]==
this.type&&(-1==b.upg[c]||UPGRADES[b.upg[c]].name!=this.name)){log("found upgrade "+c+" "+b.upg[c]+" "+this.id);break}c<b.upgradetype.length&&(-1<b.upg[c]&&removeupgrade(b,c,b.upg[c]),b.upg[c]=-2);b.showupgradeadd()}},uninstall:function(b){"undefined"!=typeof this.addedaction&&(this.addedaction.toUpperCase(),b.shipactionList.splice(b["addedaction"+this.id],1));if("undefined"!=typeof this.upgrades){"undefined"!=typeof this.pointsupg&&(b.upgbonus[this.upgrades[0]]=0);"undefined"!=typeof this.maxupg&&
(b.maxupg[this.upgrades[0]]=0);for(var c=0;c<this.upgrades.length;c++){var f=c+b["addedupg"+this.id],g=$("#unit"+b.id+" .upg span[num="+f+"]");0<g.length&&(g=g.attr("data"),removeupgrade(b,f,g))}1==typeof this.exclusive&&(b.exclupg[this.upgrades[0]]=!1);b.upgradetype.splice(b["addedupg"+this.id],this.upgrades.length);b.upgradesno=b.upgradetype.length}if("undefined"!=typeof this.lostupgrades)for(c=0;c<b.upgradetype.length;c++)-1<this.lostupgrades.indexOf(b.upgradetype[c])&&(b.upg[c]=-1);if("undefined"!=
typeof this.takesdouble)for(c=0;c<b.upgradetype.length;c++)b.upgradetype[c]==this.type&&-2==b.upg[c]&&(b.upg[c]=-1)}};
var rebelonly=function(b){var c;for(c=0;c<PILOTS.length;c++)if(b==PILOTS[c].name&&PILOTS[c].faction==REBEL)return!0;return!1},empireonly=function(b){var c;for(c=0;c<PILOTS.length;c++)if(b==PILOTS[c].name&&PILOTS[c].faction==EMPIRE)return!0;return!1},UPGRADES=[{name:"Ion Cannon Turret",type:TURRET,firesnd:"falcon_fire",points:5,attack:3,done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,c.log("+%1 %HIT%, +1 ion token [%0]",this.name,1),c.addiontoken());return b},range:[1,2]},{name:"Proton Torpedoes",
requires:"Target",type:TORPEDO,firesnd:"missile",points:4,done:!0,attack:4,init:function(b){b.addattackmoda(this,function(c,f){return b.weapons[b.activeweapon]==this}.bind(this),function(b,f){return 0<FCH_focus(b)?(this.unit.log("1 %FOCUS% -> 1 %CRIT% [%0]",this.name),b-FCH_FOCUS+FCH_CRIT):b}.bind(this),!1,"focus")},range:[2,3]},{name:"R2 Astromech",done:!0,install:function(b){var c,f=this,g=[];b.wrap_after("getdial",this,function(h){if(0==g.length){for(c=0;c<h.length;c++){var l=P[h[c].move].speed,
m=h[c].difficulty;if(1==l||2==l)m="GREEN";g[c]={move:h[c].move,difficulty:m}}b.log("1, 2 speed maneuvers are green [%0]",f.name)}return g})},uninstall:function(b){b.getdial.unwrap(this);b.log("uninstalling effect [%0]",this.name)},type:ASTROMECH,points:1},{name:"R2-D2",done:!0,init:function(b){var c=this;b.wrap_after("handledifficulty",this,function(b){"GREEN"==b&&this.shield<this.ship.shield&&(this.shield++,this.log("+1 %SHIELD% [%0]",c.name))})},unique:!0,type:ASTROMECH,points:4},{name:"R2-F2",
done:!0,candoaction:function(){return!0},action:function(b){var c=this.unit;this.unit.log("+1 agility until end of round [%0]",c.name);c.wrap_after("getagility",this,function(b){return b+1}).unwrapper("endround");c.showstats();c.endaction(b,ASTROMECH);return!0},unique:!0,type:ASTROMECH,points:3},{name:"R5-D8",done:!0,candoaction:function(){for(var b=0;b<this.unit.criticals.length;b++)if(0==this.unit.criticals[b].isactive)return!0;return!1},action:function(b){var c=this;this.unit.defenseroll(1).done(function(f){if(0<
FE_evade(f.roll)+FE_focus(f.roll))for(f=0;f<this.criticals.length;f++)if(0==this.criticals[f].isactive){this.log("-1 %HIT% [%0]",c.name);this.criticals.slice(f,1);this.hull++;this.show();break}this.endaction(b,ASTROMECH)}.bind(this.unit))},unique:!0,type:ASTROMECH,points:3},{name:"R5-X3",unique:!0,type:ASTROMECH,points:1,done:!0,init:function(b){var c=this;b.wrap_after("updateactivationdial",this,function(){this.addactivationdial(function(){return c.isactive},function(){this.log("ignore obstacles [%0]",
c.name);c.isactive=!1;this.wrap_after("getocollisions",c,function(b,c,h,l){return{overlap:-1,template:[],mine:[]}}).unwrapper("endround");this.show()}.bind(this),A[ASTROMECH.toUpperCase()].key,$("<div>").attr({class:"symbols"}));return b.activationdial})}},{name:"BB-8",unique:!0,done:!0,type:ASTROMECH,points:2,init:function(b){var c=this;c.bb=-1;b.wrap_after("updateactivationdial",this,function(){c.unit.addactivationdial(function(){return c.bb!=round&&c.isactive&&!c.unit.hasmoved&&-1<c.unit.maneuver&&
"GREEN"==c.unit.getmaneuver().difficulty},function(){c.bb=round;c.unit.doaction([c.unit.newaction(c.unit.resolveroll,"ROLL")],c.name+" free roll for green maneuver.")},A[ASTROMECH.toUpperCase()].key,$("<div>").attr({class:"symbols"}));return b.activationdial}.bind(this))}},{name:"Integrated Astromech",points:0,type:MOD,ship:"X-Wing",done:!1,init:function(b){var c=this,f=b.applycritical,g=b.applydamage;b.applydamage=function(b){0<b&&1==this.hull?(c.isactive=!1,this.applydamage=g,this.log("-1 damage [%0]",
c.name),1<b&&g.call(this,b-1)):g.call(this,b)};b.applycritical=function(b){0<b&&(s=this.selectdamage(),CRITICAL_DECK[s].count--,1==this.hull||CRITICAL_DECK[s].lethal?(c.isactive=!1,this.log("-1 damage [%0]",c.name),this.applycritical=f):this.faceup(new Critical(this,s))&&this.removehull(1),1<b&&f.call(this,b-1))}}},{name:"Weapons Guidance",points:2,type:TECH,done:!0,init:function(b){var c=this;b.addattackmoda(this,function(b,g){return c.isactive&&this.canusefocus()}.bind(b),function(b,g){var h=FCH_blank(b);
this.removefocustoken();displayattacktokens(this);return 0<h?(this.log("1 blank -> 1 %HIT% [%0]",c.name),b+FCH_HIT):b}.bind(b),!1,"focus")}},{name:"R5-K6",init:function(b){var c=this;b.wrap_after("removetarget",this,function(b){this.defenseroll(1).done(function(g){0<FE_evade(g.roll)&&(this.addtarget(b),this.log("+1 %TARGET% / %1 [%0]",c.name,b.name))}.bind(this))})},done:!0,unique:!0,type:ASTROMECH,points:2},{name:"R5 Astromech",done:!0,init:function(b){var c=this;b.wrap_before("endround",this,function(){for(var b=
-1,g=-1,h=0;h<this.criticals.length;h++){var l=this.criticals[h];if(l.isactive&&"ship"==l.type&&(b=h,l.lethal)){g=h;break}}-1<g?(this.log("repairing critical %1 [%0]",c.name,this.criticals[g].name),this.criticals[g].facedown()):-1<b&&(this.log("repairing critical %1 [%0]",c.name,this.criticals[b].name),this.criticals[b].facedown())})},type:ASTROMECH,points:1},{name:"Determination",done:!0,init:function(b){var c=this;b.wrap_after("faceup",this,function(b,g){if("pilot"!=b.type)return g;this.log("discarding critical %1 [%0]",
c.name,b.name);this.criticals.slice(this.criticals.indexOf(b),1);return!1})},type:ELITE,points:1},{name:"Swarm Tactics",type:ELITE,points:2,done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){var f=b.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c&&b.getskill()>c.getskill()});0<f.length&&this.doselection(function(g){this.log("select unit [%0]",c.name);this.resolveactionselection(f,function(h){f[h].log("PS set to %1 [%0]",c.name,this.getskill());f[h].wrap_after("getskill",
c,function(c){return b.getskill()}).unwrap("endcombatphase");this.endnoaction(g,"ELITE")}.bind(this))}.bind(this))})}},{name:"Squad Leader",unique:!0,done:!0,type:ELITE,points:2,candoaction:function(){return 0<this.unit.selectnearbyunits(2,function(b,c){return b.team==c.team&&c!=b&&c.getskill()<b.getskill()&&c.candoaction()}).length},action:function(b){var c=this.unit.selectnearbyunits(2,function(b,c){return b.team==c.team&&c!=b&&c.getskill()<b.getskill()&&c.candoaction()});this.unit.resolveactionselection(c,
function(f){c[f].select();c[f].doaction(c[f].getactionlist()).done(function(){this.select();this.endaction(b,"ELITE")}.bind(this))}.bind(this.unit))}},{name:"Expert Handling",candoaction:function(){return-1==this.unit.actionsdone.indexOf("ROLL")},action:function(b){-1==this.unit.shipactionList.indexOf("ROLL")&&this.unit.addstress();0<this.unit.istargeted.length?(this.unit.log("select target to lock [%0]",this.name),this.unit.resolveactionselection(this.unit.istargeted,function(c){this.istargeted[c].removetarget(this);
this.resolveroll(b)}.bind(this.unit))):this.unit.resolveroll(b)},type:ELITE,done:!0,points:2},{name:"Marksmanship",init:function(b){this.mark=-1;var c=this;b.addattackmoda(this,function(b,c){return this.mark==round}.bind(this),function(b,g){var h=FCH_focus(b);return 0<h&&this.mark==round?(1<h?this.unit.log("%0 %FOCUS% -> 1 %CRIT%, %1 %HIT% [%2]",h,h-1,c.name):this.unit.log("1 %FOCUS% -> 1 %CRIT% [%1]",h,c.name),b-FCH_FOCUS*h+FCH_CRIT+(h-1)*FCH_HIT):b}.bind(this),!1,"focus")},candoaction:function(){return!0},
action:function(b){this.mark=round;this.unit.endaction(b,ELITE)},done:!0,type:ELITE,points:3},{name:"Concussion Missiles",requires:"Target",type:MISSILE,firesnd:"missile",points:4,attack:4,done:!0,init:function(b){b.addattackmoda(this,function(c,f){return b.weapons[b.activeweapon]==this}.bind(this),function(b,f){return 0<FCH_blank(b,f)?b+FCH_HIT:b}.bind(this),!1,"blank")},range:[2,3]},{name:"Cluster Missiles",type:MISSILE,firesnd:"missile",requires:"Target",points:4,attack:3,done:!0,fired:-1,endattack:function(){this.fired==
round&&(this.ordnance?this.ordnance=!1:this.isactive=!1)},init:function(b){var c=this;b.wrap_after("endattack",this,function(b,g){c.fired<round&&c.isactive&&-1<this.usedweapon&&this.weapons[this.usedweapon]==c&&(this.log("2nd attack with %0 [%1]",c.name,c.name),c.fired=round,this.resolveattack(this.activeweapon,targetunit))}.bind(b))},range:[1,2]},{name:"Daredevil",done:!0,candoaction:function(){return!0},action:function(b){var c=this;this.unit.log("select maneuver [%0]",this.name);this.unit.resolveactionmove([this.unit.getpathmatrix(this.unit.m,
"TL1"),this.unit.getpathmatrix(this.unit.m,"TR1")],function(f,g){if(-1==g)return f.endaction(b,ELITE);f.addstress();if(-1==f.shipactionList.indexOf("BOOST")){f.log("2 rolls for damage [%0]",c.name);for(var h=f.rollattackdie(2),l=0;2>l;l++)"hit"==h[l]?f.resolvehit(1):"critical"==h[l]&&f.resolvecritical(1);f.checkdead()}f.endaction(b,ELITE)},!0,!0)},type:ELITE,points:3},{name:"Elusiveness",done:!0,init:function(b){b.addattackmodd(this,function(b,f){return 0==this.stress&&targetunit==this}.bind(b),function(b,
f){this.unit.addstress();0<FCH_crit(b)?(this.unit.log("1 %CRIT% rerolled [%0]",this.name),b=b-FCH_CRIT+activeunit.attackroll(1)):0<FCH_hit(b)&&(this.unit.log("1 %HIT% rerolled [%0]",this.name),b=b-FCH_HIT+activeunit.attackroll(1));return b}.bind(this),"critical")},type:ELITE,points:2},{name:"Homing Missiles",requires:"Target",type:MISSILE,firesnd:"missile",attack:4,range:[2,3],done:!0,declareattack:function(b){Weapon.prototype.declareattack.call(this,b);targetunit.wrap_after("canuseevade",this,function(){return!1}).unwrapper("endbeingattacked");
targetunit.log("cannot use evade tokens [%0]",this.name)},points:5},{name:"Push the Limit",init:function(b){var c=this;c.r=-1;var f=b.doaction;b.doaction=function(b,h){var l=f.call(this,b,h),m=$.Deferred();l.then(function(b){c.r<round&&this.candoaction()&&(c.r=round,f.call(this,this.getactionbarlist(),"+1 free action").done(function(b){null!=b?this.addstress():c.r=-1;m.resolve(b)}.bind(this)))}.bind(this));return m}},done:!0,type:ELITE,points:3},{name:"Deadeye",init:function(b){var c=Weapon.prototype.getrequirements;
Weapon.prototype.getrequirements=function(){var f=c.call(this);return this.unit==b&&"Target"==f?"Target|Focus":f}},done:!0,type:ELITE,points:1},{name:"Expose",candoaction:function(){return!0},action:function(b){var c=this.unit.weapons[0];this.unit.log("-1 agility, +1 primary attack until end of turn [%0]",this.name);this.unit.wrap_after("getagility",this,function(b){return 0<b?b-1:0}).unwrapper("endround");c.wrap_after("getattack",this,function(b){return b+1}).unwrapper("endround");this.unit.showstats();
this.unit.endaction(b,ELITE)},done:!0,type:ELITE,points:4},{name:"Gunner",done:!0,init:function(b){var c=this,f=-1;b.wrap_before("endattack",this,function(b,h){0==b+h&&f<round&&(f=round,this.log("+1 attack with primary weapon [%0]",c.name),this.selecttargetforattack(0))})},type:CREW,points:5},{name:"Ion Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,c.log("+%1 %HIT%, +1 ion token [%0]",this.name,1),c.addiontoken());return b},points:3,attack:3,range:[1,
3]},{name:"Heavy Laser Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifydamagegiven:function(b){if(0<FCH_crit(b)){var c=FCH_crit(b);this.unit.log("%0 %CRIT%-> %0 %HIT% [%1]",c,this.name);b=b-FCH_CRIT*c+c*FCH_HIT}return b},points:7,attack:4,range:[2,3]},{name:"Seismic Charges",done:!0,img:"seismic.png",snd:"explode",width:16,height:8,size:15,explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){var b=this.getrangeallunits(),c;Bomb.prototype.explode.call(this);for(c=0;c<b[1].length;c++)squadron[b[1][c].unit].resolvehit(1),
squadron[b[1][c].unit].checkdead()}},type:BOMB,points:2},{name:"Mercenary Copilot",init:function(b){var c=this;b.addattackmoda(this,function(b,c){return 3==this.getrange(targetunit)?!0:!1}.bind(b),function(b,g){return 0<FCH_hit(b)?(this.log("1 %HIT% -> 1 %CRIT% [%0]",c.name),b-FCH_HIT+FCH_CRIT):b}.bind(b),!1,"hit")},done:!0,type:CREW,points:2},{name:"Assault Missiles",type:MISSILE,requires:"Target",firesnd:"missile",done:!0,modifydamageassigned:function(b,c){if(0<b)for(var f=c.getrangeallunits(),
g=0;g<f[1].length;g++)squadron[f[1][g].unit].log("+1 %HIT% [%0]",this.name),squadron[f[1][g].unit].resolvehit(1);return b},points:5,attack:4,range:[2,3]},{name:"Veteran Instincts",done:!0,install:function(b){b.wrap_after("getskill",this,function(b){return b+2});b.showskill()},uninstall:function(b){b.getskill.unwrap();b.showskill()},type:ELITE,points:1},{name:"Proximity Mines",img:"proximity.png",snd:"explode",width:18,height:18,size:35,done:!0,stay:!0,candoaction:function(){return this.unit.lastdrop!=
round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b){if(!this.exploded){for(var c=this.unit.rollattackdie(3),f=0;3>f;f++)"hit"==c[f]?(b.resolvehit(1),b.checkdead()):"critical"==c[f]&&(b.resolvecritical(1),b.checkdead());Bomb.prototype.detonate.call(this)}},getOutlineString:function(b){var c="M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;30>f;f++){var g=transformPoint(b,{x:this.size*Math.sin(2*f*Math.PI/
30),y:this.size*Math.cos(2*f*Math.PI/30)});this.op.push(g);c+=g.x+" "+g.y+" ";0==f&&(c+="L ")}return{s:c+"Z",p:this.op}},type:BOMB,points:3},{name:"Weapons Engineer",type:CREW,points:3},{name:"Draw Their Fire",init:function(b){var c=this,f=Unit.prototype.resolvecritical;Unit.prototype.resolvecritical=function(g){0<g&&this.team==b.team&&b!=this&&1==this.getrange(b)?(this.log("select unit [%0]",c.name),this.doselection(function(c){this.resolveactionselection([this,b],function(g){0==g?f.call(this,1):
f.call(b,1);this.endnoaction(c,"CREW")}.bind(this))}.bind(this)),f.call(this,g-1)):f.call(this,g);return g}},done:!0,type:ELITE,points:1},{name:"Luke Skywalker",faction:REBEL,unique:!0,done:!0,init:function(b){var c=this,f=-1;b.wrap_before("endattack",this,function(b,h){0==b+h&&f<round&&(f=round,this.log("+1 attack with primary weapon [%0]",c.name),this.selecttargetforattack(0))});b.addattackmoda(this,function(b,c){return f==round}.bind(b),function(b,c){return 100<b?b-99:b},!1,"focus")},type:CREW,
points:7},{name:"Nien Nunb",faction:REBEL,done:!0,install:function(b){var c=[];b.wrap_after("getdial",this,function(b){if(0==c.length)for(var g=0;g<b.length;g++){var h=b[g].move,l=b[g].difficulty;h.match(/F[1-5]/)&&(l="GREEN");c[g]={move:h,difficulty:l}}return c})},uninstall:function(b){b.getdial.unwrap(this)},unique:!0,type:CREW,points:1},{name:"Chewbacca",faction:REBEL,unique:!0,done:!0,type:CREW,init:function(b){var c=this,f=b.applycritical,g=b.applydamage;b.applydamage=function(b){0<b&&1==this.hull?
(c.isactive=!1,this.shield<this.ship.shield&&this.shield++,this.log("+1 %SHIELD%, -1 %HIT% [%0]",c.name),this.applydamage=g,1<b&&g.call(this,b-1)):g.call(this,b)};b.applycritical=function(b){0<b&&(s=this.selectdamage(),CRITICAL_DECK[s].count--,1==this.hull||CRITICAL_DECK[s].lethal?(c.isactive=!1,this.shield<this.ship.shield&&this.shield++,this.log("+1 %SHIELD%, -1 %CRIT% %0 [%1]",CRITICAL_DECK[s].name,c.name),this.applycritical=f):this.faceup(new Critical(this,s))&&this.removehull(1),1<b&&f.call(this,
b-1))}},points:4},{name:"Advanced Proton Torpedoes",requires:"Target",type:TORPEDO,firesnd:"missile",attack:5,done:!0,range:[1,1],init:function(b){b.addattackmoda(this,function(c,f){return b.weapons[b.activeweapon]==this}.bind(this),function(b,f){var g=FCH_blank(b,f);3<g&&(g=3);0<g&&(this.unit.log("%0 blanks -> %0 %FOCUS% [%1]",g,this.name),b+=g*FCH_FOCUS);return b}.bind(this),!1,"blank")},points:6},{name:"Autoblaster",type:CANNON,done:!0,firesnd:"slave_fire",attack:3,declareattack:function(b){var c=
this;b.wrap_after("cancelhit",c,function(b,g,h){c.unit.log("%HIT% cannot be cancelled [%0]",c.name);return b}).unwrapper("endattack");Weapon.prototype.declareattack.call(this,b)},range:[1,1],points:5},{name:"Fire-Control System",done:!0,init:function(b){var c=this;b.wrap_before("cleanupattack",this,function(){this.log("+1 %TARGET% / %1 [%0]",c.name,targetunit.name);this.addtarget(targetunit)})},type:SYSTEM,points:2},{name:"Blaster Turret",type:TURRET,done:!0,firesnd:"falcon_fire",requires:"Focus",
points:4,attack:3,range:[1,2]},{name:"Recon Specialist",init:function(b){var c=this;b.wrap_before("addfocus",this,function(f){b.log("+1 %FOCUS% [%0]",c.name);b.addfocustoken()})},done:!0,type:CREW,points:3},{name:"Saboteur",type:CREW,done:!0,candoaction:function(){return 0<this.unit.selectnearbyenemy(1).length},action:function(b){var c=this,f=this.unit.selectnearbyenemy(1);0<f.length?(this.unit.log("select unit [%0]",this.name),this.unit.resolveactionselection(f,function(g){var h,l=[];for(h=0;h<f[g].criticals.length;h++)0==
f[g].criticals[h].isactive&&l.push(f[g].criticals[h]);0<l.length?(h=f[g].rand(l.length),f[g].log("turn faceup one damage card [%0]",c.name),f[g].faceup(l[h]),f[g].show()):f[g].log("no damage card [%0]",c.name);this.endaction(b,"CREW")}.bind(this))):this.endaction(b,"CREW")},points:2},{name:"Intelligence Agent",done:!0,init:function(b){var c=this;b.wrap_before("beginactivationphase",this,function(){var b=this.selectnearbyenemy(2);0<b.length&&this.doselection(function(g){this.log("select unit [%0]",
c.name);this.resolveactionselection(b,function(c){b[c].showmaneuver();this.endnoaction(g,"CREW")}.bind(this))}.bind(this))})},type:CREW,points:1},{name:"Proton Bombs",done:!0,width:32,height:30,size:15,snd:"explode",img:"proton.png",explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){var b=this.getrangeallunits();Bomb.prototype.explode.call(this);for(var c=0;c<b[1].length;c++)squadron[b[1][c].unit].applycritical(1),squadron[b[1][c].unit].checkdead()}},type:BOMB,points:5},{name:"Adrenaline Rush",
done:!0,init:function(b){var c=this;b.wrap_after("updateactivationdial",this,function(){this.addactivationdial(function(){return 0==this.ionized&&!this.hasmoved&&c.isactive&&-1<this.maneuver&&"RED"==this.getmaneuver().difficulty}.bind(this),function(){this.log("red into white maneuver [%0]",c.name);c.isactive=!1;this.wrap_after("getmaneuver",c,function(b){b.difficulty="WHITE";return b}).unwrapper("endactivationphase");this.show()}.bind(this),A[ELITE.toUpperCase()].key,$("<div>").attr({class:"symbols"}));
return this.activationdial})},type:ELITE,points:1},{name:"Advanced Sensors",done:!0,init:function(b){var c=b.doendmaneuveraction;b.wrap_before("beginactivation",this,function(){this.candoaction()&&this.doaction(this.getactionlist()).done(function(f){null==f?b.doendmaneuveraction=c:this.doendmaneuveraction=function(){}}.bind(this))})},type:SYSTEM,points:3},{name:"Sensor Jammer",init:function(b){var c=this;b.addattackmodd(this,function(b,c){return targetunit==this}.bind(b),function(b,g){return 0<FCH_hit(b)?
(this.unit.log("1 %HIT% -> 1 %FOCUS% [%0]",c.name),b-FCH_HIT+FCH_FOCUS):b}.bind(this),"hit")},done:!0,type:SYSTEM,points:4},{name:"Darth Vader",faction:EMPIRE,unique:!0,done:!0,init:function(b){var c=this;b.wrap_before("cleanupattack",this,function(){this.hasfired&&this.donoaction([{org:c,type:"CREW",name:c.name,action:function(b){c.unit.log("+%1 %HIT% [%0]",c.name,2);targetunit.log("+1 %CRIT% [%0]",c.name);this.resolvehit(2);SOUNDS.explode.play();targetunit.resolvecritical(1);this.checkdead();targetunit.checkdead();
this.endnoaction(b,"CREW")}.bind(this)}],"",!0)})},type:CREW,points:3},{name:"Rebel Captive",faction:EMPIRE,done:!0,init:function(b){var c=this;b.rebelcaptive=0;b.wrap_before("isattackedby",this,function(b,g){this.rebelcaptive!=round&&(g.log("+1 %STRESS% [%0]",c.name),g.addstress(),this.rebelcaptive=round)}.bind(this))},unique:!0,type:CREW,points:3},{name:"Flight Instructor",init:function(b){var c=this;b.adddefensererolld(this,["focus"],function(){return 2>=activeunit.getskill()?2:1},function(b,g){this.unit.log("+%1 %FOCUS% reroll(s) [%0]",
c.name,2>=activeunit.getskill()?2:1);return!0}.bind(this))},done:!0,type:CREW,points:4},{name:"Navigator",init:function(b){b.wrap_after("getmaneuverlist",this,function(b){var f=this.getdial();if(0<this.ionized)return b;for(var g in b){var h=g.replace(/\d/,"");for(j=0;j<f.length;j++)!f[j].move.match(h)||"undefined"!=typeof b[f[j].move]||"RED"==f[j].difficulty&&0!=this.stress||(b[f[j].move]=f[j])}return b})},done:!0,type:CREW,points:3},{name:"Opportunist",done:!0,init:function(b){var c=this;b.wrap_after("preattackroll",
this,function(b,g){0==g.focus+g.evade&&this.donoaction([{org:this,name:this.name,type:"ELITE",action:function(b){this.wrap_after("getattackstrength",c,function(b,c,f){return f+1}).unwrapper("endattack");this.addstress();this.log("+1 attack against %1, +1 %STRESS% [%0]",c.name,g.name);this.endnoaction(b,"ELITE")}.bind(this)}],"",!0)})},type:ELITE,points:4},{name:"Ion Pulse Missiles",requires:"Target",type:MISSILE,firesnd:"missile",done:!0,modifydamageassigned:function(b,c){0<b&&(this.unit.log("+%1 %HIT%, +1 ion token [%0]",
this.name,2),b=2,c.addiontoken(),c.addiontoken());return b},points:3,attack:3,range:[2,3]},{name:"Wingman",done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){var b=this.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c&&0<c.stress});0<b.length&&this.doselection(function(g){this.log("select unit [%0]",c.name);this.resolveactionselection(b,function(c){b[c].removestresstoken();this.endnoaction(g,ELITE)}.bind(this))}.bind(this))})},type:ELITE,points:2},{name:"Decoy",
init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){var f=this.selectnearbyally(2);0<f.length&&(f.push(this),this.doselection(function(g){this.log("select unit (or self to cancel) [%0]",c.name);this.resolveactionselection(f,function(h){if(f[h]!=b){var l=f[h].getskill(),m=b.getskill();b.wrap_after("getskill",c,function(b){return l}).unwrapper("endcombatphase");f[h].wrap_after("getskill",c,function(b){return m}).unwrapper("endcombatphase")}b.endnoaction(g,ELITE)})}.bind(this)))})},
done:!0,type:ELITE,points:2},{name:"Outmaneuver",done:!0,init:function(b){var c=this,f=Unit.prototype.getdefensestrength;Unit.prototype.getdefensestrength=function(g,h){var l=f.call(this,g,h);return h==b&&!this.isinfiringarc(h)&&h.isinfiringarc(this)&&0<l?(this.log("-1 defense [%0]",c.name),l-1):l}},type:ELITE,points:3},{name:"Predator",done:!0,init:function(b){var c=this;b.addattackrerolla(this,["blank","focus"],function(){return 2>=targetunit.getskill()?2:1},function(b,g){this.log("+%1 reroll(s) [%0]",
c.name,2>=targetunit.getskill()?2:1);return!0}.bind(b))},type:ELITE,points:3},{name:"Flechette Torpedoes",requires:"Target",type:TORPEDO,firesnd:"missile",done:!0,endattack:function(b,c){4>=targetunit.hull&&targetunit.addstress();Weapon.prototype.endattack.call(this)},points:2,attack:3,range:[2,3]},{name:"R7 Astromech",type:ASTROMECH,points:2},{name:"R7-T1",candoaction:function(){return!0},action:function(b){var c=this.unit.selectnearbyenemy(2);0<c.length?(c.push(this.unit),this.unit.log("select unit (or self to cancel) [%0]",
this.name),this.unit.resolveactionselection(c,function(f){c[f]!=this?(c[f].isinfiringarc(this)&&this.addtarget(c[f]),this.resolveboost(b)):this.endaction(b,"ASTROMECH")}.bind(this.unit))):this.unit.endaction(b,"ASTROMECH")},done:!0,unique:!0,type:ASTROMECH,points:3},{name:"Tactician",type:CREW,limited:!0,points:2,done:!0,init:function(b){var c=this;b.wrap_after("endattack",this,function(b,g){2==this.getsector(targetunit)&&(targetunit.addstress(),targetunit.log("+1 %STRESS% [%0]",c.name))})}},{name:"R2-D2",
faction:REBEL,unique:!0,type:CREW,points:4,done:!0,init:function(b){var c=this;b.wrap_after("endphase",this,function(){for(var b=[],g=this.criticals,h=0;h<g.length;h++)g[h].isactive||b.push(g[h]);0==this.shield&&0<this.ship.shield&&(this.log("+1 %SHIELD% [%0]",c.name),this.shield++,this.show(),0<b.length&&(b=b[this.rand(b.length)],0<FCH_hit(this.attackroll(1))&&(this.log("+1 %CRIT% [%0]",this.name),this.faceup(b))))})}},{name:"C-3PO",unique:!0,faction:REBEL,type:CREW,points:3,done:!0,init:function(b){var c=
this,f=-1;b.wrap_after("defenseroll",this,function(b,h){if(f==round)return h;var l=$.Deferred();f=round;h.done(function(f){var h=function(b){b==FE_evade(f.roll)&&(this.log("guessed correctly ! +1 %EVADE% [%0]",c.name),f.roll+=FE_EVADE,f.dice+=1);$("#actiondial").empty();l.resolve(f)}.bind(this);this.log("guess the number of evades out of %0 dice [%1]",b,c.name);$("#actiondial").empty();for(var r=0;r<=f.dice;r++)(function(b){var c=$("<button>").html(b+" <code class='xevadetoken'></code>").click(function(){h(b)}.bind(this));
$("#actiondial").append(c)}).call(this,r)}.bind(this));return l.promise()})}},{name:"R3-A2",done:!0,init:function(b){var c=this;b.wrap_after("declareattack",this,function(b,g){this.isinfiringarc(g)&&this.donoaction([{org:c,name:c.name,type:"ASTROMECH",action:function(b){this.addstress();this.log("+1 %STRESS% [%0]",c.name);g.log("+1 %STRESS% [%0]",c.name);g.addstress();this.endnoaction(b,"ASTROMECH")}.bind(this)}],"",!0)})},unique:!0,type:ASTROMECH,points:2},{name:"R2-D6",upgrades:[ELITE],noupgrades:ELITE,
skillmin:3,done:!0,unique:!0,type:ASTROMECH,points:1},{name:"Enhanced Scopes",done:!0,init:function(b){var c=this;b.wrap_before("beginactivationphase",this,function(){this.log("PS set to %1 [%0]",c.name,0);this.wrap_after("getskill",c,function(b){return 0}).unwrapper("endactivationphase")})},type:SYSTEM,points:1},{name:"Chardaan Refit",type:MISSILE,done:!0,isWeapon:function(){return!1},points:-2,ship:"A-Wing"},{name:"Proton Rockets",type:MISSILE,firesnd:"missile",requires:"Focus",points:3,attack:2,
done:!0,getattack:function(){a=this.attack;return a=3>=this.unit.agility?a+this.unit.agility:a+3},range:[1,1]},{name:"Kyle Katarn",faction:REBEL,unique:!0,done:!0,type:CREW,points:3,init:function(b){b.wrap_after("removestresstoken",this,function(){this.addfocustoken()})}},{name:"Jan Ors",faction:REBEL,unique:!0,type:CREW,points:2,done:!0,test:"?E,1D%10W5_b;k%10VhdJ;1M%10VHlq;&0%LayHI;&h1Sx4;h1Sx4;h1Sx4;h1Sx4;h1Sx4;h1Sx4#",init:function(b){var c=-1,f=this;Unit.prototype.wrap_after("addfocustoken",
this,function(){3>=this.getrange(b)&&this.team==b.team&&c<round&&(c=round,this.log("select %FOCUS% or %EVADE% token [%0]",f.name),this.donoaction([{name:u.name,org:u,type:"FOCUS",action:function(b){this.endnoaction(b,"FOCUS")}.bind(this)},{name:u.name,org:u,type:"EVADE",action:function(b){this.focus--;this.addevadetoken();this.endnoaction(b,"EVADE")}.bind(this)}],"",!0))})}},{name:"R4-D6",init:function(b){var c=this;b.wrap_after("cancelhit",this,function(f,g,h){f=FCH_hit(h.ch);if(3<=f){b.log("cancelling %0 hits [%1]",
f-2,c);f-=2;g=h.ch-f*FCH_HIT;for(var l=0;l<f;l++)b.addstress();return{ch:g,e:h.e}}return h})},done:!0,unique:!0,type:ASTROMECH,points:1},{name:"R5-P9",done:!0,init:function(b){var c=this;b.wrap_before("endcombatphase",this,function(){this.canusefocus()&&this.shield<this.ship.shield&&(this.shield++,this.log("1 %FOCUS% -> 1 %SHIELD% [%0]",c.name),this.removefocustoken())})},unique:!0,type:ASTROMECH,points:3},{name:"Han Solo",faction:REBEL,init:function(b){var c=this;b.addattackmoda(this,function(b,
c){return-1<this.targeting.indexOf(targetunit)}.bind(b),function(b,g){var h=FCH_focus(b);this.log("%0 %FOCUS% -> %0 %HIT% [%1]",h,c.name);this.removetarget(targetunit);return b-FCH_FOCUS*h+FCH_HIT*h}.bind(b),!1,"target")},type:CREW,unique:!0,done:!0,points:2},{name:"Leia Organa",faction:REBEL,type:CREW,unique:!0,done:!0,init:function(b){var c=this;b.wrap_before("beginactivationphase",this,function(){this.donoaction([{type:"CREW",org:c,name:c.name,action:function(f){c.isactive=!1;for(var g in squadron)squadron[g].team==
b.team&&squadron[g].wrap_after("getmaneuver",c,function(b){"RED"==b.difficulty&&(b.difficulty="WHITE");return b}).unwrapper("endactivationphase");this.beginactivationphase.unwrap(c);this.endnoaction(f,"CREW")}.bind(this)}],"",!0)})},points:4},{name:"Targeting Coordinator",type:CREW,limited:!0,points:4},{name:"Lando Calrissian",faction:REBEL,type:CREW,unique:!0,done:!0,candoaction:function(){return!0},action:function(b){var c=this,f="";this.unit.defenseroll(2).done(function(g){var h=FE_focus(g.roll);
g=FE_evade(g.roll);for(var l=0;l<h;l++)this.addfocustoken();0<h&&(f+=" +"+h+" %FOCUS%");for(l=0;l<g;l++)this.addevadetoken();0<g&&(f+=" +"+g+" %EVADE%");""==f?this.log("no effect [%0]",c.name):this.log(f+" [%0]",c.name);this.endaction(b,"CREW")}.bind(this.unit))},points:3},{name:"Mara Jade",faction:EMPIRE,type:CREW,unique:!0,done:!0,init:function(b){var c=this;b.wrap_before("endcombatphase",this,function(){for(var b=this.gettargetableunits(1),g=0;g<b.length;g++)0==b[g].stress&&(b[g].log("+1 %STRESS% [%0]",
c.name),b[g].addstress())})},points:3},{name:"Fleet Officer",faction:EMPIRE,type:CREW,done:!0,candoaction:function(){return!0},action:function(b){var c=this.unit.selectnearbyally(2);0<c.length?2==c.length?(c[0].addfocustoken(),c[1].addfocustoken(),this.unit.addstress(),this.unit.endaction(b,CREW)):(this.unit.log("select 2 units [%0]",this.name),this.unit.resolveactionselection(c,function(f){c[f].addfocustoken();c.splice(f,1);0<c.length?this.resolveactionselection(c,function(f){c[f].addfocustoken();
this.addstress();this.endaction(b,CREW)}.bind(this)):this.endaction(b,CREW)}.bind(this.unit))):this.unit.endaction(b,CREW)},points:3},{name:"Stay On Target",type:ELITE,points:2,done:!0,init:function(b){b.wrap_after("getmaneuverlist",this,function(b){var f=this.getdial(),g;for(g in b)for(var h=b[g].move.substr(-1),l=0;l<f.length;l++)f[l].move.substr(-1)==h&&"undefined"==typeof b[f[l].move]&&(b[f[l].move]={move:f[l].move,difficulty:"RED",halfturn:!1});return b})}},{name:"Dash Rendar",faction:REBEL,
unique:!0,done:!0,init:function(b){b.isfireobstructed=function(){return!1};b.getobstructiondef=function(){return 0}},type:CREW,points:2},{name:"Lone Wolf",done:!0,init:function(b){var c=this;b.addattackrerolla(this,["blank"],function(){return 1},function(b,g){var h=this.unit.selectnearbyally(2);0==h.length&&this.unit.log("+1 blank reroll [%0]",c.name);return 0==h.length}.bind(this));b.adddefensererolld(this,["blank"],function(){return 1},function(b,g){var h=this.unit.selectnearbyally(2);0==h.length&&
this.unit.log("+1 blank reroll [%0]",c.name);return 0==h.length}.bind(this))},unique:!0,type:ELITE,points:2},{name:"'Leebo'",faction:REBEL,unique:!0,candoaction:function(){return!0},action:function(b){this.unit.log("free %BOOST% and ion token [%0]",this.name);this.unit.addiontoken();this.unit.resolveboost(b)},done:!0,type:CREW,points:2},{name:"Ruthlessness",faction:EMPIRE,type:ELITE,points:3,done:!0,init:function(b){var c=this;b.wrap_after("endattack",this,function(b,g){var h=targetunit.selectnearbyunits(1,
function(b,c){return c!=targetunit});0<h.length&&this.doselection(function(b){this.log("select unit [%0]",c.name);this.resolveactionselection(h,function(f){h[f].log("+%1 %HIT% [%0]",c.name,1);h[f].resolvehit(1);h[f].checkdead();this.endnoaction(b,ELITE)}.bind(this))}.bind(this))})}},{name:"Intimidation",done:!0,init:function(b){var c=this.unit,f=this,g=Unit.prototype.getagility;Unit.prototype.getagility=function(){var b=g.call(this);return this.team!=c.team&&0<b&&"undefined"!=typeof this.touching&&
-1<this.touching.indexOf(c)?(this.log("-1 agility [%0]",f.name),b-1):b}},type:ELITE,points:2},{name:"Ysanne Isard",faction:EMPIRE,unique:!0,done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){0<this.criticals.length&&this.candoevade()&&(this.addevadetoken(),this.log("+1 %EVADE% [%0]",c.name))})},done:!0,type:CREW,points:4},{name:"Moff Jerjerrod",faction:EMPIRE,unique:!0,done:!0,type:CREW,points:2,init:function(b){var c=b.faceup,f=this;b.faceup=function(b){var h,l=
[];if(b.lethal||1==this.hull){for(h=0;h<this.upgrades.length;h++){var m=this.upgrades[h];m.type==CREW&&m!=f&&l.push(m)}l.push(f);for(h=0;h<l.length;h++)if(l[h].isactive)return l[h].isactive=!1,this.log("discard %0 to remove critical %1 [%2]",l[h].name,b.name,f.name),this.criticals.slice(this.criticals.indexOf(b),1),!1}return c.call(this,b)}}},{name:"Ion Torpedoes",requires:"Target",type:TORPEDO,firesnd:"missile",done:!0,modifydamageassigned:function(b,c){if(0<b){c.addiontoken();for(var f=c.getrangeallunits(),
g=0;g<f[1].length;g++)squadron[f[1][g].unit].log("+1 ion token [%0]",this.name),squadron[f[1][g].unit].addiontoken()}return b},points:5,attack:4,range:[2,3]},{name:"Bodyguard",faction:SCUM,unique:!0,done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){var f=this.selectnearbyunits(1,function(b,c){return b.team==c.team&&b!=c&&b.getskill()<c.getskill()});f.push(this);1<f.length&&this.canusefocus()&&this.doselection(function(b){this.log("select unit (or self to cancel) [%0]",
c.name);this.resolveactionselection(f,function(h){this!=f[h]&&(f[h].wrap_after("getagility",c,function(b){return b+1}).unwrapper("endcombatphase"),this.removefocustoken());this.endnoaction(b,ELITE)}.bind(this))}.bind(b))})},type:ELITE,points:2},{name:"Calculation",done:!0,init:function(b){var c=this;b.addattackmoda(this,function(b,c){return this.canusefocus()}.bind(b),function(b,g){var h=FCH_focus(b);this.removefocustoken();displayattacktokens(this);return 0<h?(this.log("1 %FOCUS% -> 1 %CRIT% [%0]",
c.name),b-FCH_FOCUS+FCH_CRIT):b}.bind(b),!1,"focus")},type:ELITE,points:1},{name:"Accuracy Corrector",init:function(b){var c=this;b.addattackadd(this,function(b,c){return!0},function(b,g){this.log("replace all dice by 2 %HIT% [%0]",c.name);return{m:2,n:2}}.bind(b),"hit")},done:!0,type:SYSTEM,points:3},{name:"Inertial Dampeners",done:!0,init:function(b){var c=this;b.wrap_after("updateactivationdial",this,function(){this.addactivationdial(function(){return!this.hasmoved&&c.isactive&&0==this.ionized}.bind(this),
function(){c.isactive=!1;this.addstress();this.wrap_after("getmaneuver",c,function(b){return{move:"F0",difficulty:"WHITE"}}).unwrapper("endactivationphase");this.show()}.bind(this),A[ILLICIT.toUpperCase()].key,$("<div>").attr({class:"symbols"}));return b.activationdial}.bind(b))},type:ILLICIT,points:1},{name:"Tractor Beam",type:CANNON,points:1,attack:3,range:[1,3]},{name:"Flechette Cannon",type:CANNON,firesnd:"slave_fire",done:!0,modifydamageassigned:function(b,c){0<b&&(b=1,c.log("+1 %HIT%, +1 %STRESS% [%0]",
this.name),0==c.stress&&c.addstress());return b},points:2,attack:3,range:[1,3]},{name:"'Mangler' Cannon",type:CANNON,firesnd:"slave_fire",points:4,attack:3,done:!0,init:function(b){var c=this;b.addattackmoda(this,function(c,g){return b.weapons[b.activeweapon]==this?!0:!1}.bind(this),function(b,g){return 0<b%10?(this.log("1 %HIT% -> 1 %CRIT% [%0]",c.name),b+9):b}.bind(b),!1,"hit")},range:[1,3]},{name:"Dead Man's Switch",done:!0,init:function(b){var c=this;b.wrap_after("dies",this,function(){for(var f=
b.getrangeallunits(),g=0;g<f[1].length;g++)squadron[f[1][g].unit].log("+%1 %HIT% [%0]",c.name,1),squadron[f[1][g].unit].applydamage(1)})},type:ILLICIT,points:2},{name:"Feedback Array",type:ILLICIT,done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){var b=this.selectnearbyenemy(1);0<b.length&&(b.push(this),this.doselection(function(g){this.log("select unit (or self to cancel) [%0]",c.name);this.resolveactionselection(b,function(c){b[c]!=this&&(this.resolvehit(1),this.addiontoken(),
SOUNDS.explode.play(),b[c].resolvehit(1),b[c].checkdead(),this.checkdead(),this.hasdamaged=this.hasfired=!0);this.endnoaction(g,ILLICIT)}.bind(this))}.bind(this)))})},points:2},{name:"'Hot Shot' Blaster",done:!0,isWeapon:function(){return!0},isTurret:function(){return!0},endattack:function(b,c){this.isactive=!1},type:ILLICIT,firesnd:"xwing_fire",points:3,attack:3,range:[1,2]},{name:"Greedo",faction:SCUM,unique:!0,done:!0,type:CREW,init:function(b){b.greedoa=-1;b.greedod=-1;b.wrap_after("hashit",this,
function(b,f){var g=this.hitresolved+this.criticalresolved-b.shield;this.greedoa<round&&0<g&&this.hitresolved>b.shield&&(this.log("first damage is a faceup damage [%0]",self.name),this.hitresolved--,this.criticalresolved++,this.greedoa=round);return f});b.wrap_after("resolveishit",this,function(b){var f=b.criticalresolved+b.hitresolved-this.shield;this.greedod<round&&0<f&&b.hitresolved>this.shield&&(this.log("first damage is a faceup damage [%0]",self.name),b.hitresolved--,b.criticalresolved++,this.greedod=
round)})},points:1},{name:"Salvaged Astromech",type:SALVAGED,done:!0,points:2,init:function(b){var c=b.faceup,f=this;b.faceup=function(b){return!b.lethal&&1!=this.hull||"ship"!=b.type?c.call(this,b):(f.isactive=!1,this.faceup=c,this.log("remove critical %0 [%1]",b.name,self.name),this.criticals.slice(this.criticals.indexOf(b),1),!1)}}},{name:"Bomb Loadout",upgrades:[BOMB],done:!0,isWeapon:function(){return!1},limited:!0,type:TORPEDO,points:0,ship:"Y-Wing"},{name:"'Genius'",unique:!0,done:!0,init:function(b){for(var c=
0;c<b.bombs.length;c++){var f=b.bombs[c];"undefined"==typeof f.action&&(f.action=function(b){this.actiondrop(b)},f.candoaction=function(){return this.unit.lastdrop!=round&&this.isactive})}},type:SALVAGED,points:0},{name:"Unhinged Astromech",type:SALVAGED,done:!0,install:function(b){var c=[];b.wrap_after("getdial",this,function(b){if(0==c.length)for(var g=0;g<b.length;g++){var h=b[g].difficulty,l=b[g].move;l.match(/[A-Z]+3/)&&(h="GREEN");c[g]={move:l,difficulty:h}}return c})},uninstall:function(b){b.getdial.unwrap(this)},
points:1},{name:"R4-B11",unique:!0,type:SALVAGED,points:3},{name:"Autoblaster Turret",type:TURRET,firesnd:"falcon_fire",done:!0,points:2,attack:2,declareattack:function(b){var c=this;b.wrap_after("cancelhit",c,function(b,g,h){c.unit.log("%HIT% cannot be cancelled [%0]",c.name);return b}).unwrapper("endattack");Weapon.prototype.declareattack.call(this,b)},range:[1,1]},{name:"R4 Agromech",done:!0,init:function(b){var c=this;b.wrap_before("declareattack",this,function(b,g){this.wrap_before("removefocustoken",
c,function(){0==this.targeting.length&&(this.log("+1 %TARGET% / %1 [%0]",c.name,targetunit.name),this.addtarget(targetunit),displayattacktokens(this))}).unwrapper("endattack")})},type:SALVAGED,points:2},{name:"K4 Security Droid",faction:SCUM,type:CREW,done:!0,init:function(b){var c=this;b.wrap_before("handledifficulty",this,function(b){if("GREEN"==b){var g=this.gettargetableunits(3);0<g.length?(g.push(this),this.log("select unit (or self to cancel) [%0]",c.name),this.doselection(function(b){this.resolveactionselection(g,
function(f){this!=g[f]&&(this.addtarget(g[f]),this.log("+1 %TARGET% / %1 [%0]",c.name,g[f].name));this.endnoaction(b,CREW)}.bind(this))}.bind(this))):this.log("no available target [%0]",c.name)}})},points:3},{name:"Outlaw Tech",faction:SCUM,beta:!0,limited:!0,done:!0,type:CREW,init:function(b){var c=this;b.wrap_after("handledifficulty",this,function(f){"RED"==f&&(b.log("+1 %FOCUS% [%0]",c.name),b.addfocustoken())})},points:2},{name:"Advanced Targeting Computer",type:SYSTEM,points:5,init:function(b){var c=
this;b.addattackadd(this,function(b,c){return-1<this.targeting.indexOf(targetunit)}.bind(b),function(b,g){return-1<this.targeting.indexOf(targetunit)?(this.log("+1 %CRIT% [%0]",c.name),$("#atokens > .xtargettoken").remove(),{m:b+10,n:g+1}):{m:b,n:g}}.bind(b),"critical")},ship:"TIE Advanced",done:!0},{name:"Stealth Device",type:MOD,done:!0,install:function(b){b.wrap_after("getagility",this,function(b){return b+1})},uninstall:function(b){b.getagility.unwrap(this)},init:function(b){var c=this;b.log("+1 agility [%0]",
c.name);b.wrap_before("resolveishit",this,function(b){c.isactive&&(c.isactive=!1,this.getagility.unwrap(c),this.log("%0 is hit => destroyed",c.name),this.show(),this.resolveishit.unwrap(c))})},points:3},{name:"Shield Upgrade",type:MOD,done:!0,install:function(b){b.shield++},uninstall:function(b){b.shield--},points:4},{name:"Engine Upgrade",type:MOD,done:!0,addedaction:"Boost",points:4},{name:"Anti-Pursuit Lasers",type:MOD,islarge:!0,done:!0,points:2,init:function(b){var c=this;b.wrap_before("collidedby",
this,function(b){if(c.isactive&&b.team!=this.team){var g=this.rollattackdie(1)[0];if("hit"==g||"critical"==g)b.log("+%1 %HIT% [%0]",c.name,1),b.resolvehit(1),b.checkdead()}})}},{name:"Targeting Computer",type:MOD,done:!0,addedaction:"Target",points:2},{name:"Hull Upgrade",type:MOD,done:!0,install:function(b){b.hull++},uninstall:function(b){b.hull--},points:3},{name:"Munitions Failsafe",type:MOD,init:function(b){var c=this;b.wrap_after("endattack",this,function(b,g){this.weapons[this.activeweapon].isprimary||
0!=b+g||(this.log("%0 still active [%1]",this.weapons[this.activeweapon].name,c.name),this.weapons[this.activeweapon].isactive=!0,this.show())})},done:!0,points:1},{name:"Stygium Particle Accelerator",type:MOD,done:!0,init:function(b){b.wrap_after("resolvedecloak",this,function(){this.candoevade()&&this.doaction([this.newaction(this.addevade,"EVADE")],"Stygium P.A.: +1 %EVADE%")});b.wrap_after("addcloak",this,function(b){this.candoevade()&&this.doaction([this.newaction(this.addevade,"EVADE")],"Stygium P.A.: +1 %EVADE%")})},
points:2},{name:"Advanced Cloaking Device",type:MOD,points:4,done:!0,init:function(b){var c=this;b.wrap_before("cleanupattack",this,function(){this.candoaction()&&this.candocloak()&&this.doaction([this.newaction(this.addcloak,"CLOAK")],c.name+": free cloack action")})},ship:"TIE Phantom"},{name:"B-Wing/E2",type:MOD,done:!0,upgrades:[CREW],points:1,ship:"B-Wing",install:function(b){b.shipimg="b-wing-1.png"},uninstall:function(b){b.shipimg="b-wing-2.png"}},{name:"Countermeasures",type:MOD,islarge:!0,
done:!0,init:function(b){var c=this;b.wrap_before("begincombatphase",this,function(){c.isactive&&this.donoaction([{action:function(b){c.isactive=!1;this.wrap_after("getagility",c,function(b){return b+1}).unwrapper("endround");0<this.istargeted.length?(this.log("select a lock to remove [%0]",c.name),this.resolveactionselection(this.istargeted,function(c){this.istargeted[c].removetarget(this);this.endnoaction(b,"MOD")}.bind(this))):this.endnoaction(b,"MOD")}.bind(this),type:c.type.toUpperCase(),name:c.name}],
"",!0)})},points:3},{name:"Experimental Interface",type:MOD,unique:!0,points:3,init:function(b){var c=this;c.r=-1;b.wrap_before("endaction",this,function(b,g){c.r!=round&&(c.r=round,this.log("select an action or Skip to cancel [%0]",c.name),this.doaction(this.getupgactionlist()).done(function(b){null!=b?this.addstress():c.r=-1}.bind(this)))})},done:!0},{name:"Tactical Jammer",type:MOD,islarge:!0,points:1},{name:"Autothrusters",type:MOD,actionrequired:"Boost",points:2,done:!0,init:function(b){var c=
this;b.adddefensemodd(this,function(b,c){return 2<activeunit.getsector(this)?!0:!1}.bind(b),function(b,g){return 0<FE_blank(b,g)?(this.log("1 blank -> 1 %EVADE% [%0]",c.name),b+FE_EVADE):b}.bind(b),!1,"blank")}},{name:"Slave I",type:TITLE,unique:!0,points:0,done:!0,ship:"Firespray-31",upgrades:[TORPEDO]},{name:"Millennium Falcon",type:TITLE,done:!0,addedaction:"Evade",unique:!0,points:1,ship:"YT-1300"},{name:"Moldy Crow",type:TITLE,init:function(b){var c=this;b.wrap_before("endround",this,function(){this.evade=
0;0<this.focus&&this.log("keep focus tokens [%0]",c.name);this.showinfo()})},unique:!0,done:!0,points:3,ship:"HWK-290"},{name:"ST-321",type:TITLE,done:!0,init:function(b){var c=this;b.wrap_after("candotarget",this,function(){return!0});b.resolvetarget=function(b){var g,h=[];for(g in squadron)squadron[g].team!=this.team&&h.push(squadron[g]);return 0<h.length?(this.log("target any unit in area [%0]",c.name),this.resolveactionselection(h,function(c){this.addtarget(h[c]);this.endaction(b,"TITLE")}.bind(this)),
!0):!1}},unique:!0,points:3,ship:"Lambda-Class Shuttle"},{name:"Royal Guard TIE",type:TITLE,done:!0,upgrades:[MOD],skillmin:5,points:0,install:function(b){b.shipimg="tie-interceptor-1.png"},uninstall:function(b){b.shipimg="tie-interceptor-2.png"},ship:"TIE Interceptor"},{name:"A-Wing Test Pilot",type:TITLE,done:!0,upgrades:[ELITE],skillmin:2,points:0,ship:"A-Wing",exclusive:!0,install:function(b){b.shipimg="a-wing-1.png"},uninstall:function(b){b.shipimg="a-wing-2.png"},special_case:"A-Wing Test Pilot"},
{name:"Outrider",type:TITLE,done:!0,init:function(b){var c;for(c=0;c<b.weapons.length;c++)if(b.weapons[c].type==CANNON){b.weapons[0].isactive=!1;b.log("primary weapon inactive [%0]",this.name);b.weapons[c].isTurret=function(){return!0};b.log("%0 can fire in 360 degrees [%0]",b.weapons[c].name,this.name);break}},unique:!0,points:5,ship:"YT-2400"},{name:"Dauntless",type:TITLE,done:!0,init:function(b){var c=this;b.wrap_after("doendmaneuveraction",this,function(){this.candoaction()&&this.collision&&(this.log("+1 free action [%0]",
c.name),this.doaction(this.getactionlist()),this.addstress())})},unique:!0,points:2,ship:"VT-49 Decimator"},{name:"Virago",type:TITLE,done:!0,upgrades:[ILLICIT,SYSTEM],unique:!0,points:1,skillmin:4,ship:"StarViper"},{name:"'Heavy Scyk' Interceptor",done:!0,upgrades:["Cannon|Torpedo|Missile"],type:TITLE,points:2,ship:"M3-A Interceptor"},{name:"IG-2000",type:TITLE,done:!0,install:function(b){b.ig2000=!0},uninstall:function(b){b.ig2000=!1},init:function(b){b.init=function(){for(var c in squadron){var f=
squadron[c];f!=b&&1==f.ig2000&&f.faction==b.faction&&("IG-88A"==f.name&&(b.cleanupattack=f.cleanupattack),"IG-88B"==f.name&&(b.endattack=f.endattack),"IG-88C"==f.name&&(b.resolveboost=f.resolveboost),"IG-88D"==f.name&&(b.getmaneuverlist=f.getmaneuverlist))}}},points:0,ship:"Aggressor"},{name:"BTL-A4 Y-Wing",type:TITLE,done:!0,init:function(b){var c=-1,f,g=this;for(f=0;f<b.weapons.length;f++)if(b.weapons[f].type==TURRET){c=f;break}-1!=c&&(b.weapons[c].isTurret=function(){return!1},b.isTurret=function(f){return f==
b.weapons[c]?!1:Unit.prototype.isTurret(f)},b.wrap_before("endattack",this,function(b,f){-1<round&&-1<c&&this.weapons[this.activeweapon].isprimary&&(this.log("+1 attack with %0 [%1]",this.weapons[c].name,g.name),this.selecttargetforattack(c))}))},points:0,ship:"Y-Wing"},{name:"Andrasta",type:TITLE,done:!0,upgrades:[BOMB,BOMB],unique:!0,points:0,ship:"Firespray-31"},{name:"TIE/x1",type:TITLE,done:!0,upgrades:[SYSTEM],pointsupg:-4,points:0,ship:"TIE Advanced"},{name:"Emperor Palpatine",type:CREW,unique:!0,
takesdouble:!0,points:8,faction:EMPIRE},{name:"Extra Munitions",type:TORPEDO,limited:!0,isWeapon:function(){return!1},points:2,done:!0,install:function(b){b.ordnance=!0},uninstall:function(b){b.ordnance=!1}},{name:"Cluster Mines",type:BOMB,snd:"explode",img:"cluster.png",width:15,height:10,repeatx:42,size:22,stay:!0,done:!0,candoaction:function(){return this.unit.lastdrop!=round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b){if(!this.exploded){for(var c=
this.unit.rollattackdie(2),f=0;2>f;f++)"hit"==c[f]?(b.resolvehit(1),b.checkdead()):"critical"==c[f]&&(b.resolvecritical(1),b.checkdead());Bomb.prototype.detonate.call(this)}},init:function(b){b=s.path("M41.844,-21 C54.632,-21 65,-11.15 65,1 C65,13.15 54.632,23 41.844,23 C33.853,22.912 25.752,18.903 21.904,12.169 C17.975,18.963 10.014,22.806 1.964,23 C-7.439,22.934 -14.635,18.059 -18.94,10.466 C-22.908,18.116 -30.804,22.783 -39.845,23 C-52.633,23 -63,13.15 -63,1 C-63,-11.15 -52.633,-21 -39.845,-21 C-30.441,-20.935 -23.246,-16.06 -18.94,-8.466 C-14.972,-16.116 -7.076,-20.783 1.964,-21 C9.956,-20.913 18.055,-16.902 21.904,-10.17 C25.832,-16.964 33.795,-20.807 41.844,-21 z").attr({display:"none"});
var c=b.getTotalLength();this.op0=[];for(var f=0;60>f;f++)this.op0[f]=b.getPointAtLength(f*c/60)},getOutlineString:function(b){var c="M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;60>f;f++){var g=transformPoint(b,this.op0[f]);this.op.push(g);c+=g.x+" "+g.y+" ";0==f&&(c+="L ")}return{s:c+"Z",p:this.op}},points:4},{name:"Glitterstim",type:ILLICIT,points:2,activated:!1,done:!0,init:function(b){var c=this;b.wrap_after("preattackroll",this,function(b,g){c.isactive&&this.donoaction([{org:c,
name:c.name,type:"ILLICIT",action:function(b){this.addstress();c.isactive=!1;c.activated=round;this.preattackroll.unwrap(c);this.endnoaction(b,"ILLICIT")}.bind(this)}],"",!0)});b.addattackmoda(this,function(b,g){return c.activated==round},function(b,g){var h=FCH_focus(b);return 0<h?(this.unit.log("%FOCUS% -> %HIT% [%0]",c.name),b-FCH_FOCUS*h+h*FCH_HIT):b}.bind(this),!1,"illicit");b.adddefensemodd(this,function(b,g){return c.activated==round},function(b,g){var h=FE_focus(b);return 0<h?(this.unit.log("%FOCUS% -> %EVADE% [%0]",
c.name),b-FE_FOCUS*h+FE_EVADE*h):b}.bind(this),!1,"illicit")}},{name:"Cloaking Device",type:ILLICIT,islarge:!1,points:2,candoaction:function(){return this.isactive},action:function(b){var c=this.unit;c.log("cloaked [%0]",this.name);c.addcloak(b)},done:!0,init:function(b){var c=this;b.wrap_before("endround",this,function(){"focus"==this.rollattackdie(1)[0]&&this.iscloaked&&(this.log("decloaked [%0]",c.name),c.isactive=!1,this.wrap_after("getdecloakmatrix",c,function(b,c){return c.concat(b)}),this.resolvedecloak())})}},
{name:"Bossk",unique:!0,faction:SCUM,type:CREW,points:2,done:!0,init:function(b){b.wrap_after("hashit",this,function(b,f){f||(0==this.stress&&this.addstress(),this.addtarget(b),this.addfocustoken());return f})}},{name:"Wired",type:ELITE,init:function(b){var c=this;b.addattackrerolla(this,["focus"],function(){return 9},function(b,g){return 0<this.stress&&this.canusefocus()?(this.log("+%1 %FOCUS% reroll(s) [%0]",c.name,this.focus),!0):!1}.bind(b));b.adddefensererolld(this,["focus"],function(){return 2>=
activeunit.getskill()?2:1},function(b,g){return 0<this.stress&&this.canusefocus()?(this.log("+%1 %FOCUS% reroll(s) [%0]",c.name,this.focus),!0):!1}.bind(this))},done:!0,points:1},{name:"Cool Hand",type:ELITE,points:1,done:!0,init:function(b){var c=this;b.wrap_after("addstress",this,function(){this.stress++;this.donoaction([{type:FOCUS,name:c.name,org:c,action:function(b){c.isactive=!1;this.addfocustoken();this.endnoaction(b,"ELITE")}.bind(this)},{type:EVADE,name:c.name,org:c,action:function(b){c.isactive=
!1;this.addevadetoken();this.endnoaction(b,"ELITE")}.bind(this)}],"Add %EVADE% or %FOCUS% instead of %STRESS% token",!0)})}},{name:"Juke",type:ELITE,points:2,islarge:!1},{name:"Lightning Reflexes",type:ELITE,points:1,done:!0,init:function(b){var c=this;b.wrap_after("handledifficulty",this,function(b){("WHITE"==b||"GREEN"==b&&c.isactive)&&this.donoaction([{type:ELITE,name:c.name,org:c,action:function(b){c.isactive=!1;this.addstress(1);this.m=this.m.rotate(180,0,0);this.show();this.endnoaction(b,ELITE)}.bind(this)}],
"",!0)})},islarge:!1},{name:"Twin Laser Turret",type:TURRET,points:6,done:!0,attack:3,range:[2,3],modifydamageassigned:function(b,c){0<b&&(b=1,c.log("+%1 %HIT% [%0]",this.name,1));return b},init:function(b){var c=this,f=-1;b.wrap_after("cleanupattack",this,function(){f<round&&-1<this.usedweapon&&this.weapons[this.usedweapon]==c&&(this.log("2nd attack with %0 [%1]",c.name,c.name),f=round,this.resolveattack(this.activeweapon,targetunit))}.bind(b))}},{name:"Plasma Torpedoes",type:TORPEDO,points:3,attack:4,
requires:"Target",done:!0,posthit:function(b,c,f){0<b.shield&&b.log("-1 %SHIELD% [%0]",self.name);b.removeshield(1)},range:[2,3]},{name:"Ion Bombs",type:BOMB,points:2,width:14,height:14,size:15,done:!0,snd:"explode",img:"ion.png",explode:function(){if(phase==ACTIVATION_PHASE&&!this.exploded){var b=this.getrangeallunits();Bomb.prototype.explode.call(this);for(var c=0;c<b[1].length;c++)squadron[b[1][c].unit].addiontoken(),squadron[b[1][c].unit].addiontoken()}}},{name:"Conner Net",type:BOMB,snd:"explode",
img:"conner-net3.png",width:40,height:60,size:40,done:!0,init:function(){var b=s.path("M-11.379,-0.26 C-11.241,-6.344 -16.969,-14.641 -19.247,-20.448 C-21.524,-26.255 -24.216,-38.147 -20.213,-39.46 C-16.21,-40.774 -8.619,-37.594 2.424,-37.663 C13.466,-37.732 22.162,-41.327 23.68,-39.322 C25.198,-37.317 26.716,-30.404 22.714,-21.278 C18.711,-12.152 14.156,-6.828 14.087,0.293 C14.018,7.414 19.47,15.364 22.3,22.555 C25.129,29.745 25.681,39.908 23.128,41.429 C20.574,42.95 13.673,41.29 4.218,41.29 C-5.237,41.29 -19.316,42.742 -20.903,41.29 C-22.49,39.839 -24.354,34.446 -20.213,23.108 C-16.072,11.769 -11.448,11.424 -11.379,1.606 C-11.322,-6.487 -11.514,5.685 -11.379,-0.26 z").attr({display:"none"}),
c=b.getTotalLength();this.op0=[];for(var f=0;60>f;f++)this.op0[f]=b.getPointAtLength(f*c/60)},getOutlineString:function(b){var c="M ";this.op=[];"undefined"==typeof b&&(b=this.m);for(var f=0;60>f;f++){var g=transformPoint(b,this.op0[f]);this.op.push(g);c+=g.x+" "+g.y+" ";0==f&&(c+="L ")}return{s:c+"Z",p:this.op}},stay:!0,candoaction:function(){return this.unit.lastdrop!=round&&this.isactive},action:function(b){this.actiondrop(b)},canbedropped:function(){return!1},explode:function(){},detonate:function(b){b.log("makes detonation");
if(!this.exploded){var c=this.unit.rollattackdie(1)[0];"hit"==c?(b.resolvehit(1),b.checkdead()):"critical"==c&&(b.resolvecritical(1),b.checkdead());b.addiontoken();b.addiontoken();this.unit.log("%1 skips action phase [%0]",self.name,b.name);var f=b.candoendmaneuveraction;b.candoendmaneuveraction=function(){b.candoendmaneuveraction=f;return!1};Bomb.prototype.detonate.call(this)}},points:4},{name:"Bombardier",type:CREW,points:1,done:!0,init:function(b){b.wrap_after("getbomblocation",this,function(b){return-1<
b.indexOf("F1")?b.concat("F2"):b})}},{name:"Agent Kallus",type:CREW,faction:EMPIRE,points:2},{name:"'Crack Shot'",type:ELITE,points:1},{name:"Advanced Homing Missiles",type:MISSILE,points:3,requires:"Target",attack:3,range:[2,2],done:!0,init:function(b){var c=this;b.wrap_after("hashit",this,function(b,g){g&&c==this.weapons[this.activeweapon]&&(this.log("+1 %CRIT% [%0]",c.name),b.applycritical(1),this.criticalresolved=this.hitresolved=0);return g})}},{name:"Advanced SLAM",type:MOD,done:!0,points:2,
init:function(b){var c=b.doaction;b.doaction=function(b){var g=c.call(this,b);g.then(function(b){return"SLAM"!=b||-1!=this.ocollision.overlap||0!=this.ocollision.template.length||this.collision?g:c.call(this,this.getactionbarlist())}.bind(this))}}},{name:"Twin Ion Engine Mk. II",type:MOD,points:1,ship:"TIE",done:!0,install:function(b){var c=[];b.wrap_after("getdial",this,function(b){if(0==c.length)for(var g=0;g<b.length;g++){var h=b[g].move,l=b[g].difficulty;h.match(/BL\d|BR\d/)&&(l="GREEN");c[g]=
{move:h,difficulty:l}}return c})},uninstall:function(b){b.getdial.unwrap(this)}},{name:"Maneuvering Fins",type:MOD,points:1,ship:"YV-666",done:!0,init:function(b){var c=this;b.wrap_after("getmaneuverlist",c,function(b){for(var g in b)if(g.match(/TR\d|TL\d/)){this.log("change turn into a bank [%0]",c.name);var h=g.replace(/T/,"B");b[h]={move:h,difficulty:b[g].difficulty,halfturn:b[g].halfturn}}return b}.bind(b))}},{name:"Hound's Tooth",points:6,type:TITLE,unique:!0,ship:"YV-666"},{name:"XX-23 S-Thread Tracers",
points:1,type:MISSILE,range:[1,3],attack:3,done:!0,requires:"Focus",prehit:function(b,c,f){c=this.unit.selectnearbyally(2);f="";if(0<c.length){for(var g=0;g<c.length;g++)f+=c[g].name+" ",c[g].addtarget(b);this.unit.log("all dice cancelled, %0 now targeted by %1",b,f);this.unit.hitresolved=0;this.unit.criticalresolved=0}}},{name:"Comm Relay",points:3,type:TECH,done:!0,init:function(b){var c=this;b.wrap_after("addevadetoken",this,function(){1<this.evade&&(this.log("1 %FOCUS% max [%0]",c.name),this.evade=
1);this.showinfo()});var f=b.endround;b.endround=function(){var g=this.evade;f.call(b);this.evade=g;0<g&&this.log("keep %FOCUS% [%0]",c.name);this.showinfo()}}},{name:"Dorsal Turret",type:TURRET,points:3,attack:2,range:[1,2],done:!0,getrangeattackbonus:function(b){return 1==this.getrange(b)?(this.unit.log("+1 attack for range 1"),1):0}},{name:"'Chopper'",type:CREW,points:0,done:!0,init:function(){this.wrap_after("begincombatphase",this,function(b){for(var c=0;c<this.touching.length;c++){var f=this.touching[c];
f.faction!=this.faction&&(f.log("+1 %STRESS% [%0]",this.name),f.addstress())}return b})},faction:REBEL,unique:!0},{name:"Hera Syndulla",type:CREW,points:1,faction:REBEL,done:!0,init:function(b){b.wrap_after("canreveal",this,function(b,f){return"RED"==b.difficulty&&0<this.stress?!0:f})},unique:!0},{name:"'Zeb' Orrelios",type:CREW,points:1,faction:REBEL,unique:!0},{name:"Ezra Bridger",type:CREW,points:3,faction:REBEL,unique:!0,done:!0,init:function(b){b.addattackmoda(this,function(c,f){return 0<b.stress}.bind(this),
function(b,f){return 0<FCH_focus(b)?(this.unit.log("1 %FOCUS% -> 1 %CRIT% [%0]",this.name),b-FCH_FOCUS+FCH_CRIT):b}.bind(this),!1,"focus")}},{name:"Kanan Jarrus",type:CREW,points:3,faction:REBEL,unique:!0},{name:"Sabine Wren",type:CREW,points:2,upgrades:[BOMB],faction:REBEL,unique:!0},{name:"Ghost",type:TITLE,points:0,unique:!0,ship:"VCX-100"},{name:"Phantom",type:TITLE,points:0,unique:!0,ship:"Attack Shuttle"},{name:"Reinforced Deflectors",points:3,type:SYSTEM,islarge:!0,done:!0,init:function(b){var c=
this;b.wrap_before("resolveishit",this,function(b){c.damage=0;this.wrap_before("removehull",c,function(b){c.damage+=b});this.wrap_before("removeshield",c,function(b){c.damage+=b});this.wrap_before("endbeingattacked",c,function(b,f){3<=c.damage&&(this.log("+1 %SHIELD% [%0]",c.name),this.shield++);this.removeshield.unwrap();this.removehull.unwrap();this.endbeingattacked.unwrap()})})}},{name:"Targeting Astromech",points:2,type:ASTROMECH},{name:"TIE/x7",points:-2,type:TITLE,lostupgrades:[CANNON,MISSILE],
ship:"TIE Defender"},{name:"TIE/D",points:0,type:TITLE,ship:"TIE Defender"},{name:"TIE Shuttle",points:0,done:!0,type:TITLE,ship:"TIE Bomber",maxupg:4,lostupgrades:[TORPEDO,MISSILE,BOMB],upgrades:[CREW,CREW]},{name:"Guidance Chips",points:0,type:MOD},{name:"TIE/v1",ship:"TIE Adv. Prototype",points:1,done:!0,init:function(b){var c=this;b.wrap_after("addtarget",this,function(b){c.isactive&&this.candoaction()&&this.candoevade()&&this.doaction([this.newaction(this.addevade,"EVADE")])})},type:TITLE},{name:"Zuckuss",
faction:SCUM,points:1,unique:!0,type:CREW},{name:"4-LOM",faction:SCUM,points:1,unique:!0,type:CREW},{name:"Mist Hunter",type:TITLE,points:0,addedaction:"Roll",done:!0,ship:"G-1A Starfighter",unique:!0},{name:"Adaptability(+1)",type:ELITE,points:0,done:!0,install:function(b){b.wrap_after("getskill",this,function(b){return b+1});b.showskill()},uninstall:function(b){b.getskill.unwrap();b.showskill()}},{name:"Adaptability(-1)",type:ELITE,points:0,done:!0,install:function(b){b.wrap_after("getskill",this,
function(b){return b-1});b.showskill()},uninstall:function(b){b.getskill.unwrap();b.showskill()}}],factions=["REBEL","EMPIRE"],allunits=[];function winevent(){return new CustomEvent("win",{detail:{time:new Date},bubbles:!0,cancelable:!0})}function Team(b){"undefined"==typeof isia&&(isia=!1);this.team=b;this.initiative=this.isia=this.isdead=!1;this.units=[]}
Team.prototype={setfaction:function(b){$(".listunits .generic").remove();this.faction=b;$("#"+b+"select").prop("checked",!0);this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW},changefaction:function(b){for(var c in generics)generics[c].team==this.team&&delete generics[c];$("#totalpts").html(0);this.setfaction(b);displayfactionunits()},checkdead:function(){var b,c=!0;for(b=0;b<this.units.length;b++)if(!this.units[b].dead){c=!1;break}return this.isdead=c},toggleplayer:function(b){this.isia=
!this.isia},updatepoints:function(){var b=0;$("#listunits .pts").each(function(){b+=parseInt($(this).text())});$("#totalpts").html(b)},addunit:function(b){b=new Unit(this.team,b);$("#listunits").append(""+b);this.updatepoints()},tosquadron:function(b){for(var c in generics)if(generics[c].team==this.team){u=generics[c];for(c in PILOTS[u.pilotid]){var f=PILOTS[u.pilotid];"function"==typeof f[c]&&(u[c]=f[c])}u.tosquadron(b);allunits.push(u);squadron.push(u);this.units.push(u)}for(c in squadron)u=squadron[c],
u.team==this.team&&("undefined"!=typeof u.init&&u.init(),this.isia&&(u=$.extend(u,IAUnit.prototype)));this.units.sort(function(b,c){return c.getskill()-b.getskill()});squadron.sort(function(b,c){return c.getskill()-b.getskill()});this.history={title:{text:UI_translation["Damage taken per turn"]},axisX:{interval:1,title:UI_translation.Turns},axisY:{title:UI_translation["Cumulated damage"]},rawdata:[],data:[{indexLabelFontColor:"darkSlateGray",name:"views",type:"area",color:"rgba(200,10,10,0.8)",markerSize:8,
dataPoints:[]}]};return this.units},endsetup:function(){if(this.isia)for(i=0;i<this.units.length;i++)$.extend(this.units[i],IAUnit.prototype);for(i=0;i<this.units.length;i++)this.units[i].g.undrag()},endselection:function(b){var c=this.team;this.name=$("#teamname"+this.team).val();""==this.name&&(this.name="Squad #"+c);$("#team"+c).empty();$("#importexport"+c).remove();sq=this.tosquadron(b);for(b=0;b<sq.length;b++){if(1==c){if(0>=sq[b].tx||0>=sq[b].ty)sq[b].tx=80-(sq[b].islarge?20:0),sq[b].ty=70+
82*b,sq[b].alpha=90;$("#team1").append('<div id="'+sq[b].id+'" onclick=\'select("'+sq[b].id+"\")'>"+sq[b]+"</div>")}else{if(0>=sq[b].tx||0>=sq[b].ty)sq[b].tx=820+(sq[b].islarge?20:0),sq[b].ty=70+82*b,sq[b].alpha=-90;$("#team2").append('<div id="'+sq[b].id+'" onclick=\'select("'+sq[b].id+"\")'>"+sq[b]+"</div>")}sq[b].m.translate(sq[b].tx,sq[b].ty).rotate(sq[b].alpha,0,0);sq[b].show()}$("#team"+c).css("top",$("nav").height()+2);activeunit=sq[0]},toASCII:function(){var b="",c;for(c in generics)generics[c].team==
this.team&&(b+=generics[c].toASCII()+";");return b},toJSON:function(){var b={description:""};b.faction={REBEL:"rebels",SCUM:"scum",EMPIRE:"empire"}[this.faction];b.name=this.name;var c=[],f=0,g;for(g in generics)if(generics[g].team==this.team){var h=generics[g].toJSON(),f=f+h.points;c.push(h)}b.pilots=c;this.points=b.points=f;b.vendor={xwsbenchmark:{builder:"X-Wings Squadron Benchmark",builder_url:"http://xws-bench.github.io/bench/"}};b.version="0.3.0";return b},toJuggler:function(b){var c="",f;for(f in generics)generics[f].team==
this.team&&(c=c+generics[f].toJuggler(b)+"\n");return c},parseJuggler:function(b,c){var f,g,h,l;f=7;var m=b.trim().split("\n");for(g in generics)generics[g].team==this.team&&delete generics[g];for(g=0;g<m.length;g++){var q=m[g].split(/\s+\+\s+/),r=0;for(h=0;h<PILOTS.length;h++){var t=PILOTS[h].name,v=t,t=t+(PILOTS[h].faction==SCUM?" (Scum)":"");1==c&&"undefined"!=typeof PILOT_translation[t]&&"undefined"!=typeof PILOT_translation[t].name&&(v=PILOT_translation[t].name);1==PILOTS[h].ambiguous&&(v+="("+
PILOTS[h].unit+")");v.replace(/\'/g,"")==q[0]&&(t=r,r=PILOTS[h].faction,r="REBEL"==r?1:"SCUM"==r?2:4,r|=t)}f&=r}this.faction=1==(f&1)?"REBEL":2==(f&2)?"SCUM":"EMPIRE";this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;for(g=0;g<m.length;g++){q=m[g].split(/\s+\+\s+/);for(h=0;h<PILOTS.length;h++)if(v=t=PILOTS[h].name,t+=PILOTS[h].faction==SCUM?" (Scum)":"",PILOTS[h].faction==this.faction&&(1==c&&"undefined"!=typeof PILOT_translation[t]&&"undefined"!=typeof PILOT_translation[t].name&&
(v=PILOT_translation[t].name),1==PILOTS[h].ambiguous&&(v+="("+PILOTS[h].unit+")"),v.replace(/\'/g,"")==q[0])){l=h;break}"undefined"==typeof l&&console.log("pid undefined: >"+q[0]+"<"+this.faction);r=new Unit(this.team,l);r.upg=[];v=[MOD,TITLE].concat(PILOTS[r.pilotid].upgrades);for(h=1;h<q.length;h++)for(f=0;f<UPGRADES.length;f++){t=UPGRADES[f].name+("Crew"==UPGRADES[f].type?"(Crew)":"");if(1==c&&"undefined"!=typeof UPGRADE_translation[t]&&"undefined"!=typeof UPGRADE_translation[t].name&&UPGRADE_translation[t].name.replace(/\'/g,
"").replace(/\(Crew\)/g,"")==q[h]||UPGRADES[f].name.replace(/\'/g,"")==q[h])if(-1<v.indexOf(UPGRADES[f].type)){r.upg[h-1]=f;"undefined"!=typeof UPGRADES[f].upgrades&&(v="Cannon|Torpedo|Missile"==UPGRADES[f].upgrades[0]?v.concat(["Cannon","Torpedo","Missile"]):v.concat(UPGRADES[f].upgrades));"undefined"!=typeof UPGRADES[f].install&&UPGRADES[f].install(r);break}else log("UPGRADE not listed: "+UPGRADES[f].type+" in "+r.name);f==UPGRADES.length&&log("UPGRADE undefined: "+q[h])}}},parseASCII:function(b){b=
b.split(";");for(i in generics)generics[i].team==this.team&&delete generics[i];for(i=0;i<b.length-1;i++){var c=b[i].split("%"),f=c[0].split(","),g=Base64.toNumber(f[0]);this.faction=PILOTS[g].faction;this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;g=new Unit(this.team,g);g.upg=[];for(j=1;j<f.length;j++){var h=Base64.toNumber(f[j]);g.upg[j-1]=h;"undefined"!=typeof UPGRADES[h].install&&UPGRADES[h].install(g)}1<c.length&&(c=Base64.toCoord(c[1]),g.tx=c[0],g.ty=c[1],g.alpha=c[2])}},
parseJSON:function(b,c){var f;try{f=$.parseJSON(b)}catch(g){return this.parseJuggler(b,c)}var h,l,m;this.name=f.name;this.points=f.points;this.faction={rebels:"REBEL",scum:"SCUM",empire:"EMPIRE"}[f.faction];this.color="REBEL"==this.faction?RED:"EMPIRE"==this.faction?GREEN:YELLOW;for(h in generics)generics[h].team==this.team&&delete generics[h];for(h=0;h<f.pilots.length;h++){var q=f.pilots[h],r;q.team=this.team;r=new Unit(this.team,0);""==q.ship&&(q.ship="tiefofighter");log("call selectship "+q.name);
r.selectship(PILOT_dict[q.ship],PILOT_dict[q.name]);for(m in PILOTS[this.pilotid]){var t=PILOTS[this.pilotpid];"function"==typeof t[m]&&(r[m]=t[m])}if("undefined"!=typeof q.upgrades)for(l in t=0,q.upgrades){var v=q.upgrades[l];for(m=0;m<v.length;m++){t++;for(var x=0;x<UPGRADES.length;x++)if(UPGRADES[x].name==UPGRADE_dict[v[m]]){r.upg[t]=x;"undefined"!=typeof UPGRADES[x].install&&UPGRADES[x].install(r);break}}}}}};
var phase=1,subphase=0,round=1,skillturn=0,tabskill,VERSION="v0.7.4",LANG="en",DECLOAK_PHASE=1,SETUP_PHASE=2,PLANNING_PHASE=3,ACTIVATION_PHASE=4,COMBAT_PHASE=5,SELECT_PHASE=1,CREATION_PHASE=6,DICES="focusred hitred criticalred blankred focusgreen evadegreen blankgreen".split(" "),BOMBS=[],ROCKDATA="",allunits=[],PILOT_translation,SHIP_translation,CRIT_translation,UI_translation,UPGRADE_translation,PILOT_dict,UPGRADE_dict,actionr=[],actionrlock,HISTORY=[],REPLAY=[],replayid=0,dice=1,ATTACK=[],DEFENSE=
[],FACTIONS={rebel:"REBEL",empire:"EMPIRE",scum:"SCUM"},SQUADLIST,TEAMS=[new Team(0),new Team(1),new Team(2)],currentteam=TEAMS[0],VIEWPORT,ANIM=[],SETUPS={},SETUP,SHOWDIAL=[],increment=1,theta=0,UNIQUE=[],stype="";
Base64={_Rixits:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_",fromNumber:function(b){if(isNaN(Number(b))||null===b||b===Number.POSITIVE_INFINITY)throw"The input is not valid";if(0>b)throw"Can't represent negative numbers now";for(var c=Math.floor(b),f="";b=c%64,f=this._Rixits.charAt(b)+f,c=Math.floor(c/64),0!=c;);return f},toNumber:function(b){var c=0;b=b.split("");for(e in b)c=64*c+this._Rixits.indexOf(b[e]);return c},fromCoord:function(b){return Base64.fromNumber(Math.floor(b[0]+
900)+2E3*Math.floor(b[1]+900)+4E6*Math.floor(180+b[2]))},toCoord:function(b){b=Base64.toNumber(b);return[b%2E3-900,Math.floor(b/2E3)%2E3-900,Math.floor(b/4E6)-180]}};
function center(){var b=activeunit.g.getBBox(),c=b.x+b.width/2,f=b.y+b.height/2,b=$("#svgout").width(),g=$("#svgout").height(),h=0,l=0;g>b?l=(g-b)/2:h=(b-g)/2;var m=Math.min(b/900,g/900),q=h+VIEWPORT.m.x(c,f)*m,c=l+VIEWPORT.m.y(c,f)*m;VIEWPORT.m.invert();if(0>q||q>b)VIEWPORT.m=MT((-q+b/2-h)/m,0).add(VIEWPORT.m);if(0>c||c>g)VIEWPORT.m=MT(0,(-c+g/2-l)/m).add(VIEWPORT.m);VIEWPORT.transform(VIEWPORT.m);activeunit.show()}
function hitrangetostr(b){var c="",f,g,h,l=[];for(f in squadron)if(squadron[f]==activeunit)break;for(f=1;3>=f;f++)if(0<b[f].length)for(g=0;g<b[f].length;g++){h=b[f][g].unit;var m=squadron[h],c=c+"<tr>",c=c+("<td class='tohit'>"+f+"</td>"),c=c+("<td>"+m.name+"</td>");for(w=0;w<b[f][g].wp.length;w++){var q=activeunit.weapons[w],r=activeunit.evaluatetohit(w,m);if(void 0==r)break;var t=r.tokill[m.hull+m.shield],t="undefined"==typeof t?0:Math.floor(1E4*t)/100;-1==l.indexOf(q.type)&&l.push(q.type);c+="<td class='probacell' style='background:hsl("+
1.2*(100-r.tohit)+",100%,80%)'";c=phase==COMBAT_PHASE&&skillturn==activeunit.getskill()&&activeunit.canfire()?c+(" onclick='activeunit.incombat=true; activeunit.declareattack("+w+",squadron["+h+"]); activeunit.resolveattack("+w+",squadron["+h+"])'>"):c+">";c+="<div class='reddice'>"+activeunit.getattackstrength(w,m)+"</div><div class='greendice'>"+m.getdefensestrength(w,activeunit)+"</div>";c+="<div>"+r.tohit+"%</div><div><code class='symbols' style='border:0'>d</code>"+r.meanhit+"</div><div><code class='symbols'  style='border:0'>c</code>"+
r.meancritical+"</div><div>"+t+"% kill</div>";c+="</td>"}c+="</tr>"}if(""==c)c="No unit in range of "+activeunit.name,activeunit.istargeting=!1;else{b="";b="<table><tr><th>Range</th><th>Name</th>";for(f=0;f<l.length;f++)b+="<th style='width:2em;border:0'><div class='"+l[f]+"' style='width:100px;border:0;background:white;color:black'></div></th>";c=b+"</tr>"+c+"</table>"}return c}
function formatstring(b){return b.replace(/%HIT%/g,"<code class='hit'></code>").replace(/%ACTION%/g,"<b>Action:</b>").replace(/%CRIT%/g,"<code class='critical'></code>").replace(/%EVADE%/g,"<code class='symbols'>e</code>").replace(/%FOCUS%/g,"<code class='symbols'>f</code>").replace(/%ROLL%/g,"<code class='symbols'>r</code>").replace(/%TURNLEFT%/g,"<code class='symbols'>4</code>").replace(/%TURNRIGHT%/g,"<code class='symbols'>6</code>").replace(/%BOOST%/g,"<code class='symbols'>b</code>").replace(/%ELITE%/g,
"<code class='symbols'>E</code>").replace(/%BOMB%/g,"<code class='symbols'>B</code>").replace(/%STRAIGHT%/g,"<code class='symbols'>8</code>").replace(/%STOP%/g,"<code class='symbols'>5</code>").replace(/%TARGET%/g,"<code class='symbols'>l</code>").replace(/%TORPEDO%/g,"<code class='symbols'>P</code>").replace(/%CANNON%/g,"<code class='symbols'>C</code>").replace(/%SYSTEM%/g,"<code class='symbols'>S</code>").replace(/%ILLICIT%/g,"<code class='symbols'>I</code>").replace(/%MISSILE%/g,"<code class='symbols'>M</code>").replace(/%TURRET%/g,
"<code class='symbols'>U</code>").replace(/%BANKLEFT%/g,"<code class='symbols'>7</code>").replace(/%BANKRIGHT%/g,"<code class='symbols'>9</code>").replace(/%UTURN%/g,"<code class='symbols'>2</code>").replace(/%SLOOPLEFT%/g,"<code class='symbols'>1</code>").replace(/%SLOOPRIGHT%/g,"<code class='symbols'>3</code>").replace(/%TALONLEFT%/g,"<code class='symbols'>;</code>").replace(/%TALONRIGHT%/g,"<code class='symbols'>:</code>").replace(/%CREW%/g,"<code class='symbols'>W</code>")}
function nextunit(b,c,f,g){var h,l=!1,m=0;if(0>skillturn||12<skillturn)return f();for(h=0;h<tabskill[skillturn].length;h++)if(b(tabskill[skillturn][h])){l=!0;m=h;break}if(!l){do c(tabskill);while(0<=skillturn&&12>=skillturn&&0==tabskill[skillturn].length)}if(0>skillturn||12<skillturn)return f();active=m;tabskill[skillturn][m].select();g()}function endphase(){for(var b in squadron)squadron[b].endphase()}
function nextcombat(){nextunit(function(b){return b.canfire()},function(b){var c=!1;0<=skillturn&&skillturn--;for(i=0;i<b[skillturn+1].length;i++){var f=b[skillturn+1][i];f.canbedestroyed(skillturn)&&f.checkdead()&&(c=!0)}c&&(TEAMS[1].checkdead()||TEAMS[2].checkdead())&&win()},function(){log(UI_translation["No more firing units, ready to end phase."]);for(var b in squadron)squadron[b].endcombatphase();barrier(endphase);enablenextphase()},function(){activeunit.beginattack();activeunit.doattack(!1)})}
function nextactivation(){nextunit(function(b){return b.candomaneuver()},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.beginactivation();activeunit.doactivation()})}function nextdecloak(){nextunit(function(b){return b.candecloak()},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.dodecloak()})}
function nextplanning(){nextunit(function(b){return-1==b.maneuver},function(){13>skillturn&&skillturn++},function(){return enablenextphase()},function(){activeunit.select();activeunit.doplan()})}function getattackresult(){var b=$(".hitreddice").length,c=$(".criticalreddice").length;return FCH_CRIT*c+FCH_HIT*b}function getdefenseresult(){return $(".evadegreendice").length+$(".evadegreen").length}function addattackdie(b,c){for(var f=0;f<c;f++)$("#attack").append("<td class="+b+"reddice'></td>")}
function adddefensedie(b,c){for(var f=0;f<c;f++)$("#defense").append("<td class="+b+"greendice'></td>")}
function displayattackroll(b,c){var f,g=0;$("#attackdial").empty();$("#dtokens").empty();$("#defense").empty();for(f=0;f<DICES.length;f++)$("."+DICES[f]+"dice").remove();$("#attack").empty();for(f=0;f<Math.floor(b/100)%10;f++,g++)$("#attack").append("<td class='focusreddice'></td>");for(f=0;f<Math.floor(b/10)%10;f++,g++)$("#attack").append("<td class='criticalreddice'></td>");for(f=0;f<b%10;f++,g++)$("#attack").append("<td class='hitreddice'></td>");for(f=g;f<c;f++)$("#attack").append("<td class='blankreddice'></td>");
f=function(){$(this).hasClass("focusreddice")?($(this).removeClass("focusreddice"),$(this).addClass("hitreddice")):$(this).hasClass("blankreddice")?($(this).removeClass("blankreddice"),$(this).addClass("focusreddice")):$(this).hasClass("hitreddice")?($(this).removeClass("hitreddice"),$(this).addClass("criticalreddice")):$(this).hasClass("criticalreddice")&&($(this).removeClass("criticalreddice"),$(this).addClass("blankreddice"))};$(".focusreddice").click(f);$(".hitreddice").click(f);$(".blankreddice").click(f);
$(".criticalreddice").click(f)}function displayattacktokens(b,c){"function"!=typeof c&&(c=b.lastaf);b.lastaf=c;$("#atokens").html(b.getattackrerolltokens()+b.getattackmodtokens(b.ar,b.da));$("#atokens").append($("<button>").addClass("m-done").click(function(){$("#atokens").empty();c()}))}
function displaydefensetokens(b,c){"function"!=typeof c&&(c=b.lastdf);b.lastdf=c;$("#dtokens").html(b.getdefensererolltokens()+b.getdefensemodtokens(b.dr,b.dd));$("#dtokens").append($("<button>").addClass("m-fire").click(function(){$("#combatdial").hide();c()}.bind(b)))}function FE_focus(b){return Math.floor(b/10)%10}function FE_evade(b){return b%10}function FE_blank(b,c){return c-FE_evade(b)-FE_focus(b)}function FCH_hit(b){return b%10}function FCH_focus(b){return Math.floor(b/100)%10}
function FCH_crit(b){return Math.floor(b/10)%10}function FCH_blank(b,c){return c-FCH_crit(b)-FCH_focus(b)-FCH_hit(b)}var FE_EVADE=1,FE_FOCUS=10,FCH_HIT=1,FCH_FOCUS=100,FCH_CRIT=10;function addroll(b,c,f){var g=$(".focusreddice").length,h=$(".hitreddice").length,l=$(".criticalreddice").length;b=b(100*g+10*l+h,c);displayattackroll(b.m,b.n);$("#moda"+f).remove()}
function addrolld(b,c,f){var g=$(".focusgreendice").length,h=$(".evadegreendice").length;b=b(10*g+h,c);displaydefenseroll(b.m,b.n);$("#modd"+f).remove()}function modroll(b,c,f){var g=$(".focusreddice").length,h=$(".hitreddice").length,l=$(".criticalreddice").length;b=b(100*g+10*l+h,c);displayattackroll(b,c);$("#moda"+f).remove()}
function displaydefenseroll(b,c){var f,g=0;$("#defense").empty();for(f=0;f<Math.floor(b/10);f++,g++)$("#defense").append("<td class='focusgreendice'></td>");for(f=0;f<b%10;f++,g++)$("#defense").append("<td class='evadegreendice'></td>");for(f=g;f<c;f++)$("#defense").append("<td class='blankgreendice'></td>");f=function(){$(this).hasClass("focusgreendice")?($(this).removeClass("focusgreendice"),$(this).addClass("evadegreendice")):$(this).hasClass("blankgreendice")?($(this).removeClass("blankgreendice"),
$(this).addClass("focusgreendice")):$(this).hasClass("evadegreendice")&&($(this).removeClass("evadegreendice"),$(this).addClass("blankgreendice"))};$(".focusgreendice").click(f);$(".evadegreendice").click(f);$(".blankgreendice").click(f)}function modrolld(b,c,f){var g=$(".focusgreendice").length,h=$(".evadegreendice").length;b=b(10*g+h,c);displaydefenseroll(b,c);$("#modd"+f).remove()}
function reroll(b,c,f,g){var h,l=0,m=["blank","focus","hit","critical"],q=["blank","focus","evade"];if(c){for(c=0;4>c;c++)h=f,f=Math.floor(f/10),activeunit.canusefocus()&&activeunit.candofocus()&&1==c||!(1<=h%10)||(h=$("."+m[c]+"reddice:not([noreroll])"),h.length<b?(h.remove(),l+=h.length,b-=h.length):($("."+m[c]+"reddice:lt("+b+"):not([noreroll])").remove(),l+=b,b=0));$("#rerolla"+g).remove();b=activeunit.rollattackdie(l);for(c=0;c<l;c++)$("#attack").prepend("<td noreroll='true' class='"+b[c]+"reddice'></td>")}else{for(c=
0;3>c;c++)h=f,f=Math.floor(f/10),targetunit.canusefocus()&&targetunit.candofocus()&&1==c||!(1<=h%10)||(h=$("."+q[c]+"greendice:not([noreroll])"),h.length<b?(h.remove(),l+=h.length,b-=h.length):($("."+m[c]+"greendice:lt("+b+"):not([noreroll])").remove(),l+=b,b=0));$("#rerolld"+g).remove();activeunit.defenseroll(l).done(function(b){var c;for(c=0;c<FE_evade(b.roll);c++)$("#defense").prepend("<td noreroll='true' class='evadegreendice'></td>");for(c=0;c<FE_focus(b.roll);c++)$("#defense").prepend("<td noreroll='true' class='focusgreendice'></td>");
for(c=0;c<FE_blank(b.roll,b.dice);c++)$("#defense").prepend("<td noreroll='true' class='blankgreendice'></td>")})}}function next_replay(){var b=[];0<REPLAY.length&&(b=REPLAY[replayid].split("_"));return b}
function enablenextphase(){var b,c=!0;switch(phase){case SELECT_PHASE:b=$("#squad1").attr("data-name");var f=$("#squad2").attr("data-name");if("undefined"==typeof b||"undefined"==typeof f)c=!1,$(".nextphase").prop("disabled",!0);break;case PLANNING_PHASE:for(b in squadron)if(0>squadron[b].maneuver&&!squadron[b].isdead){c=!1;break}c&&$(".nextphase").prop("disabled")&&log(UI_translation["All units have planned a maneuver, ready to end phase"]);break;case ACTIVATION_PHASE:if(subphase!=ACTIVATION_PHASE){subphase=
ACTIVATION_PHASE;skillturn=0;c=!1;for(b in squadron)squadron[b].enddecloak().done(nextactivation);barrier(nextactivation)}else{for(b in squadron)if(-1<squadron[b].maneuver&&!squadron[b].isdead){c=!1;break}c&&$(".nextphase").prop("disabled")&&log(UI_translation["All units have been activated, ready to end phase"])}}c&&$(".nextphase").prop("disabled",!1);return c}
function win(){var b="m-draw",c,f="",g="",h=0,l=0;for(c=0;c<allunits.length;c++){var m=allunits[c];m.dead&&(1==m.team?(g+="<tr><td>"+m.name+"</td><td>"+m.points+"</td></tr>",l+=m.points):(f+="<tr><td>"+m.name+"</td><td>"+m.points+"</td></tr>",h+=m.points))}""==f&&(f="<tr><td class='m-nocasualty'></td><td>0</td></tr>");""==g&&(g="<tr><td class='m-nocasualty'></td><td>0</td></tr>");c=h-l;h=c+100;l=100-c;$(".victory-table").empty();$(".victory-table").append("<tr><th class='m-squad1'></th><th>"+h+"</th></tr>");
$(".victory-table").append(f);$(".victory-table").append("<tr><th class='m-squad2'></th><th>"+l+"</th></tr>");$(".victory-table").append(g);0<c?b="m-1win":0>c&&(b="m-2win");$(".victory").attr("class",b);window.location="#modal"}document.addEventListener("win",win,!1);
function createsquad(){$(".activeunit").prop("disabled",!0);$("#selectphase").hide();phase=CREATION_PHASE;$(".nextphase").prop("disabled",!1);currentteam.changefaction("REBEL");$(".factionselect selected").val("REBEL");$("#creation").show();displayfactionunits()}function switchdialimg(b){1==b?($(".shipimg").css("display","none"),$(".shipdial").css("display","table-cell")):($(".shipdial").css("display","none"),$(".shipimg").css("display","table-cell"))}
function displayfactionunits(){var b=0,c=0,f,g,h=currentteam.faction,l={};if(phase==CREATION_PHASE){for(f in unitlist)-1<unitlist[f].faction.indexOf(h)&&b++;Math.round(93/Math.tan(Math.PI/b));$(".caroussel").html("");increment=360/b;var m;for(f=0;f<PILOTS.length;f++){var q=PILOTS[f].unit;PILOTS[f].faction==h&&("undefined"==typeof l[q]&&(l[q]=[]),l[q].push(PILOTS[f]),PILOTS[f].pilotid=f)}for(f=0;f<UPGRADES.length;f++)q=UPGRADES[f],q.type==TITLE&&(unitlist[q.ship].hastitle=!0);for(f in unitlist)if(m=
"",-1<unitlist[f].faction.indexOf(h)){c++;var q=unitlist[f],r=SHIP_translation[f];"undefined"==typeof r&&(r=f);m+="<table><tr>";m+="<td onclick='switchdialimg(true)' class='shipimg' rowspan='4' style='background-image:url(png/"+q.img[0]+")'>";m+="<div class='xsymbols RED'>"+repeat("u",q.fire)+"</div>";m+="<div class='xsymbols GREEN'>"+repeat("u",q.evade)+"</div>";m+="<div class='xsymbols YELLOW'>"+repeat("u",q.hull)+"</div>";m+="<div class='xsymbols BLUE'>"+repeat("u",q.shield)+"</div></td>";for(var t=
[],b=0;5>=b;b++)for(t[b]=[],g=0;6>=g;g++)t[b][g]="<td></td>";for(b=0;b<q.dial.length;b++)d=q.dial[b],t[MPOS[d.move][0]][MPOS[d.move][1]]="<td><span class='symbols "+d.difficulty+"' >"+P[d.move].key+"</span></td>";m+="<td onclick='switchdialimg(false)' class='shipdial' rowspan='4'><table>";for(b=5;0<=b;b--){m+="<tr>";m=0<b&&5>b?m+("<td>"+b+"</td>"):m+"<td></td>";for(g=0;6>=g;g++)m+=t[b][g];m+="</tr>\n"}m+="</table></td>";m+="<td class='shipname'>"+r;m+="</td></tr><tr><td>";for(b=0;b<q.actionList.length;b++)m+=
"<code class='GREEN symbols'>"+A[q.actionList[b]].key+"</code>&nbsp;";m+="</td></tr><tr><td>";for(b=0;b<l[f][0].upgrades.length;b++)l[f][0].upgrades[b]!=ELITE&&(m+="<code class='upgrades "+l[f][0].upgrades[b]+"'></code>");1==q.hastitle&&(m+="<code class='upgrades Title'></code>");m+="<code class='upgrades Mod'></code>";m+="</td></tr></table>";m+="<table class='pilots'>";for(b=0;b<l[f].length;b++)g=l[f][b].name,r=getpilottexttranslation(g,h),""!=r&&(r+=1==l[f][b].done?"":"<div><strong class='m-notimplemented'></strong></div>"),
m+="<tr data="+l[f][b].pilotid+"><td><button pilotid="+l[f][b].pilotid+" onclick='addunit("+l[f][b].pilotid+")'>+</button></td><td>"+getpilottranslation(g,h)+"</td><td>"+l[f][b].points+"</td>",m+="<td style='font-size:smaller' class='statskill'>"+l[f][b].skill+"</td>",m+="<td>",-1<l[f][b].upgrades.indexOf(ELITE)&&(m+="<code class='"+ELITE+" upgrades'></code>"),m+="</td>",m=""!=r?m+("<td class='tooltip'>"+r+"</td>"):m+"<td></td>",m+="</tr>";m+="</table>";$("#caroussel").append("<li>"+m+"</li>")}}}
function getpilottranslation(b,c){var f=b+("SCUM"==c?" (Scum)":"");return"undefined"!=typeof PILOT_translation[f]&&"undefined"!=typeof PILOT_translation[f].name?PILOT_translation[f].name:b}function getpilottexttranslation(b,c){var f=b+("SCUM"==c?" (Scum)":"");return"undefined"!=typeof PILOT_translation[f]&&"undefined"!=typeof PILOT_translation[f].text?formatstring(PILOT_translation[f].text):""}
function getupgtranslation(b,c){var f=b+(c==CREW?"(Crew)":"");"undefined"!=typeof UPGRADE_translation[f]&&"undefined"!=typeof UPGRADE_translation[f].name&&(b=UPGRADE_translation[f].name.replace(/\(Crew\)/g,""));return b}function getupgtxttranslation(b,c){var f=b+(c==CREW?"(Crew)":"");return"undefined"!=typeof UPGRADE_translation[f]&&"undefined"!=typeof UPGRADE_translation[f].text?formatstring(UPGRADE_translation[f].text):""}
function addunique(b){UNIQUE[b]=!0;for(var c=0;c<PILOTS.length;c++)b==PILOTS[c].name&&$(".pilots button[pilotid="+PILOTS[c].pilotid+"]").prop("disabled",!0);for(c=0;c<UPGRADES.length;c++)b==UPGRADES[c].name&&$(".upglist button[data="+c+"]").prop("disabled",!0)}
function removeunique(b){UNIQUE[b]=!1;for(var c=0;c<PILOTS.length;c++)b==PILOTS[c].name&&$(".pilots button[pilotid="+PILOTS[c].pilotid+"]").prop("disabled",!1);for(c=0;c<UPGRADES.length;c++)b==UPGRADES[c].name&&$(".upglist button[data="+c+"]").prop("disabled",!1)}function addlimited(b,c){$("#unit"+b.id+" .upglist button[data="+c+"]").prop("disabled",!0)}function removelimited(b,c){$("#unit"+b.id+" .upglist button[data="+c+"]").prop("disabled",!1)}
function addupgradeaddhandler(b){$("#unit"+b.id+" .upgrades").click(function(b){var f=b.currentTarget.getAttribute("class").split(" ")[1];b=b.currentTarget.getAttribute("num");var g=this.getupgradelist(f);$("#unit"+this.id+" .upglist").empty();$("#unit"+this.id+" .upglist").append("<tr><td><button>+</button></td><td class='m-none'></td><td></td><td></td></tr>");$("#unit"+this.id+" .upglist button").click(function(){$("#unit"+this.id+" .upglist").empty()}.bind(this));"undefined"==typeof this.upgbonus[f]&&
(this.upgbonus[f]=0);for(var h=0;h<g.length;h++){var l=UPGRADES[g[h]],m=!1,q=l.name,r=l.points+this.upgbonus[f];0>r&&(r=0);var t=">",v="</td><td>";"undefined"!=typeof l.attack&&(v="<span class='statfire'>"+l.attack+"</span></td><td>["+l.range[0]+"-"+l.range[1]+"]");var x=q+(l.type==CREW?"(Crew)":"");"undefined"!=typeof UPGRADE_translation[x]&&"undefined"!=typeof UPGRADE_translation[x].name&&(q=UPGRADE_translation[x].name.replace(/\(Crew\)/g,""));"undefined"!=typeof UPGRADE_translation[x]&&"undefined"!=
typeof UPGRADE_translation[x].text&&(t=" class='tooltip'>"+formatstring(UPGRADE_translation[x].text)+(1==l.done?"":"<div><strong class='m-notimplemented'></strong></div>"));1==UNIQUE[l.name]&&(m=!0);(1==l.limited||1==this.exclupg[l.type])&&0<$("#unit"+this.id+" .upg span[data="+g[h]+"]").length&&(m=!0);$("#unit"+this.id+" .upglist").append("<tr><td><button "+(m?"disabled":"")+" num="+b+" data="+g[h]+">+</button></td><td>"+q+"</td><td>"+r+"</td><td>"+v+"</td><td"+t+"</td></tr>")}$("#unit"+this.id+
" .upglist button").click(function(b){var c=b.currentTarget.getAttribute("data");b=b.currentTarget.getAttribute("num");addupgrade(this,c,b)}.bind(this))}.bind(b))}
function addunit(b){b=new Unit(currentteam.team,b);$("#listunits").append("<li id='unit"+b.id+"'></li>");b.show();$("li#unit"+b.id).hover(function(){$(".highlighted").removeClass("highlighted");$(this).addClass("highlighted")},function(){});1==b.unique&&addunique(b.name);$("#unit"+b.id+" .close").click(function(){var b=$(this).attr("data"),f=generics["u"+b];$("#unit"+b+" .upg span[data]").each(function(){var b=$(this).attr("data");1==UPGRADES[b].unique&&removeunique(UPGRADES[b].name)});1==PILOTS[f.pilotid].unique&&
removeunique(f.name);$("#unit"+b).remove();delete generics["u"+b];currentteam.updatepoints()});currentteam.updatepoints();addupgradeaddhandler(b)}
function addupgrade(b,c,f){$("#unit"+b.id+" .upglist").empty();if("undefined"!=typeof UPGRADES[c]){1==UPGRADES[c].unique&&addunique(UPGRADES[c].name);1==UPGRADES[c].limited&&addlimited(b,c);$("#unit"+b.id+" .upgavail span[num="+f+"]").css("display","none");var g=UPGRADES[c].name,h=g+(UPGRADES[c].type==CREW?"(Crew)":""),g="undefined"!=typeof UPGRADE_translation[h]&&"undefined"!=typeof UPGRADE_translation[h].name?UPGRADE_translation[h].name.replace(/\(Crew\)/g,"").replace(/\'/g,""):g.replace(/\'/g,
"");$("#unit"+b.id+" .upg").append("<span data="+c+" num="+f+"><code class='upgrades "+UPGRADES[c].type+"'></code>"+g+" (<span class='pts'>"+(UPGRADES[c].points+b.upgbonus[UPGRADES[c].type])+"</span>)</span>");b.upg[f]=c;"undefined"!=typeof UPGRADES[c].install&&UPGRADES[c].install(b);Upgrade.prototype.install.call(UPGRADES[c],b);$("#unit"+b.id+" .shipdial").html("<table>"+b.getdialstring()+"</table>");b.showupgradeadd();b.showactionlist();b.showstats();currentteam.updatepoints();$("#unit"+b.id+" .upg span[num="+
f+"]").click(function(c){var f=c.currentTarget.getAttribute("num");c=c.currentTarget.getAttribute("data");$("#unit"+b.id+" .upglist").empty();removeupgrade(b,f,c)}.bind(b))}}
function removeupgrade(b,c,f){$("#unit"+b.id+" .upgavail span[num="+c+"]").css("display","block");$("#unit"+b.id+" .upg span[num="+c+"]").remove();1==UPGRADES[f].unique&&removeunique(UPGRADES[f].name);1==UPGRADES[f].limited&&removelimited(b,f);b.upg[c]=-1;"undefined"!=typeof UPGRADES[f].uninstall&&UPGRADES[f].uninstall(b);Upgrade.prototype.uninstall.call(UPGRADES[f],b);$("#unit"+b.id+" .shipdial").html("<table>"+b.getdialstring()+"</table>");b.showupgradeadd();b.showactionlist();b.showstats();currentteam.updatepoints()}
function setselectedunit(b,c){currentteam=TEAMS[b];try{currentteam.parseJuggler(c,!0)}catch(f){currentteam.parseJuggler(c,!1)}currentteam.name=currentteam.toASCII();currentteam.toJSON();addrow(b,currentteam.name,0,currentteam.faction,currentteam.toJuggler(!0))}
function addrow(b,c,f,g,h){1==b&&($("#squad1").val(h),$("#squad1").attr("data-name",c));2==b&&($("#squad2").val(h),$("#squad2").attr("data-name",c));enablenextphase();b=g.toUpperCase();"undefined"!=typeof localStorage[c]&&SQUADLIST.row.add(["",b,""+f,h,c,"",""]).draw(!1)}
function makeGrid(b,c){var f=b.length,g=b.concat(c),h=Math.max.apply(null,g),g=Math.min.apply(null,g);h>$("#svgLine").height()&&$("#svgLine").height(h+10);for(var l=0;l<f;l++){var m=100*l;sl.line(m,g-10,m,h+10).attr({stroke:"#ccc",strokeWidth:.25})}f*=100;m=(h+10)%5;for(l=h+10-(g-10);0<l;l--)0===(l-m)%5&&sl.line(0,l,f,l).attr({stroke:"#ccc",strokeWidth:.25})}
function convertToPath(b){for(var c="",f=0;f<b.length;f++)var g=100*f,h=-b[f]+$("#svgLine").height(),c=0===f?c+("M"+g+","+h+" S"):f===b.length-1?c+(g+","+h):c+(g+","+h+",");return c}
function makePath(b,c){function f(c){for(var f="M0,"+h+" H",g=0;g<b.length;g++)0!==g&&(f+=100*g+" ");c&&(f+="V"+h+" H0 Z");return f}var g=convertToPath(b),h=$("#svgLine").height(),l=g+" V"+h+" H0 Z",m=sl.path(f()).attr({stroke:c,strokeWidth:2,fill:"transparent"}),q=sl.path(f(!0)).attr({fill:c,fillOpacity:.25});m.animate({path:g},500);q.animate({path:l},500)}
function endselection(){var b;$("#creation").hide();$("#selectphase").show();currentteam.name="SQUAD."+currentteam.toASCII();currentteam.toJSON();var c=currentteam.toJuggler(!1);localStorage[currentteam.name]=JSON.stringify({pts:currentteam.points,faction:currentteam.faction,jug:c});currentteam==TEAMS[1]?b=1:currentteam==TEAMS[2]&&(b=2);addrow(b,currentteam.name,currentteam.points,currentteam.faction,currentteam.toJuggler(!0))}
function removerow(b){b=SQUADLIST.row(b.parents("tr"));var c=b.data()[4];delete localStorage[c];b.remove().draw(!1)}function checkrow(b,c){var f=SQUADLIST.row(c.parents("tr")).data()[3];setselectedunit(b,f)}
function importsquad(b){currentteam.parseJuggler($("#squad"+b).val(),!0);currentteam.name="SQUAD."+currentteam.toASCII();var c=currentteam.toJuggler(!0);currentteam.toJSON();localStorage[currentteam.name]=JSON.stringify({pts:currentteam.points,faction:currentteam.faction,jug:currentteam.toJuggler(!1)});addrow(b,currentteam.name,currentteam.points,currentteam.faction,c)}function startcombat(){}
function filltabskill(){tabskill=[];for(i=0;12>=i;i++)tabskill[i]=[];for(i in squadron)tabskill[squadron[i].getskill()].push(squadron[i]);for(i in tabskill)tabskill[i].sort(function(b,c){var f=0,g=0;1==TEAMS[b.team].initiative&&(f=1);1==TEAMS[c.team].initiative&&(g=1);return g-f})}var ZONE=[];
function nextphase(){var b;0==REPLAY.length&&record("nextphase",phase,phase);window.location="#";switch(phase){case SELECT_PHASE:$(".h2 .share-buttons").hide();$("#game").show();$("#selectphase").hide();$("#creation").hide();$("#rightpanel").show();$("#leftpanel").show();"human"==$("input[name='player1']:checked").val()?TEAMS[1].isia=!1:TEAMS[1].isia=!0;"human"==$("input[name='player2']:checked").val()?TEAMS[2].isia=!1:TEAMS[2].isia=!0;break;case CREATION_PHASE:$(".h2 .share-buttons").hide();endselection();
phase=SELECT_PHASE;return;case SETUP_PHASE:$(".buttonbar .share-buttons").hide();$("#leftpanel").show();ZONE[1].remove();ZONE[2].remove();TEAMS[1].endsetup();TEAMS[2].endsetup();$(".playerselect").remove();$(".nextphase").prop("disabled",!0);$(".unit").css("cursor","pointer");$("#positiondial").hide();for(b=0;b<OBSTACLES.length;b++)OBSTACLES[b].g.undrag();HISTORY=[];break;case PLANNING_PHASE:$("#maneuverdial").hide();break;case ACTIVATION_PHASE:$("#activationdial").hide();for(b in squadron)squadron[b].hasmoved=
!1,squadron[b].hasdecloaked=!1,squadron[b].actiondone=!1,squadron[b].endactivationphase();var c=[];for(b=0;b<BOMBS.length;b++)c[b]=BOMBS[b];for(b=0;b<c.length;b++)c[b].explode();break;case COMBAT_PHASE:$("#attackdial").hide();$("#listunits").html("");for(b in squadron)squadron[b].endround();round++}phase=phase==COMBAT_PHASE?PLANNING_PHASE:phase+1;3>phase?$("#phase").html(UI_translation["phase"+phase]):$("#phase").html(UI_translation["turn #"]+round+" "+UI_translation["phase"+phase]);$("#combatdial").hide();
if(phase>SELECT_PHASE)for(b in squadron)squadron[b].unselect();$(".nextphase").prop("disabled",!1);switch(phase){case SELECT_PHASE:$(".buttonbar .share-buttons").hide();$(".h2 .share-buttons").show();$(".activeunit").prop("disabled",!0);$("#rightpanel").hide();$("#leftpanel").hide();$("#game").hide();$("#selectphase").show();$("#creation").hide();currentteam.setfaction("REBEL");$(".nextphase").prop("disabled",!0);break;case SETUP_PHASE:$(".buttonbar .share-buttons").show();$("#team2").css("top",$("nav").height()+
2);$("#team1").css("top",$("nav").height()+2);$(".ctrl").css("display","block");ZONE[0]=s.path(SETUP.playzone).attr({strokeWidth:6,stroke:halftone(WHITE),strokeDasharray:"20,10,5,5,5,10",id:"ZONE",pointerEvents:"none"});""!=SETUP.background&&$(".playmat").css("background","url("+SETUP.background+") no-repeat");""==SETUP.pattern?ZONE[0].attr("fillOpacity",0):(b=s.image(SETUP.pattern,0,0,360,360).pattern(0,0,360,360),ZONE[0].attr("fill",b));ZONE[0].appendTo(VIEWPORT);ZONE[1]=s.path(SETUP.zone1).attr({fill:TEAMS[1].color,
strokeWidth:2,opacity:.3,pointerEvents:"none"});ZONE[1].appendTo(VIEWPORT);ZONE[2]=s.path(SETUP.zone2).attr({fill:TEAMS[2].color,strokeWidth:2,opacity:.3,pointerEvents:"none"});ZONE[2].appendTo(VIEWPORT);"undefined"!=typeof SETUP.playzone1&&(ZONE[3]=s.path(SETUP.playzone1).attr({strokeWidth:6,stroke:halftone(WHITE),strokeDasharray:"20,10,5,5,5,10",id:"ZONE",fillOpacity:0,pointerEvents:"none"}),ZONE[3].appendTo(VIEWPORT));TEAMS[1].endselection(s);TEAMS[2].endselection(s);TEAMS[1].points>TEAMS[2].points?
TEAMS[2].initiative=!0:"EMPIRE"==TEAMS[2].faction?TEAMS[2].initiative=!0:TEAMS[1].initiative=!0;1==TEAMS[1].initiative?log("TEAM #1 has initiative"):log("TEAM #2 has initiative");$(".activeunit").prop("disabled",!1);activeunit=squadron[0];activeunit.select();activeunit.show();$("#svgout").bind("mousewheel DOMMouseScroll",function(b){var c=b.originalEvent;b=Math.pow(1.1,"undefined"!=typeof c.wheelDelta?c.wheelDelta/360:c.detail/-9);var h=c.clientX-$("#team1").width(),c=c.clientY-$("nav").height(),
l=$("#svgout").width(),m=$("#svgout").height(),q=0,r=0;m>l?r=(m-l)/2:q=(l-m)/2;l=Math.max(900/l,900/m);h=(h-q)*l;r=(c-r)*l;q=VIEWPORT.m.clone().invert();c=q.x(h,r);h=q.y(h,r);VIEWPORT.m.translate(c,h).scale(b).translate(-c,-h);VIEWPORT.transform(VIEWPORT.m);activeunit.show()});$("#svgout").mousedown(function(b){dragstart(b)});$("#svgout").mousemove(function(b){dragmove(b)});$("#svgout").mouseup(function(b){dragstop(b)});jwerty.key("x",function(){window.location="#"});jwerty.key("escape",nextphase);
jwerty.key("c",center);jwerty.key("9",function(){console.log("active:"+activeunit.name+" in hit range:"+activeunit.weapons[0].name);var b=activeunit.weapons[0],c;for(c in squadron)console.log("      "+squadron[c].name+":"+b.getrange(squadron[c]))});jwerty.key("p",function(){activeunit.showpossiblepositions()});jwerty.key("m",function(){activeunit.showmeanposition()});jwerty.key("shift+p",function(){$(".possible").remove()});jwerty.key("1",function(){activeunit.focus++;activeunit.show()});jwerty.key("2",
function(){activeunit.evade++;activeunit.show()});jwerty.key("3",function(){activeunit.iscloaked||(activeunit.iscloaked=!0,activeunit.agility+=2,activeunit.show())});jwerty.key("4",function(){activeunit.stress++;activeunit.show()});jwerty.key("5",function(){activeunit.ionized++;activeunit.show()});jwerty.key("shift+1",function(){0<activeunit.focus&&activeunit.focus--;activeunit.show()});jwerty.key("shift+2",function(){0<activeunit.evade&&activeunit.evade--;activeunit.show()});jwerty.key("shift+3",
function(){activeunit.iscloaked&&(activeunit.iscloaked=!1,activeunit.agility-=2,activeunit.show())});jwerty.key("shift+4",function(){0<activeunit.stress&&activeunit.stress--;activeunit.show()});jwerty.key("shift+5",function(){0<activeunit.ionized&&activeunit.ionized--;activeunit.show()});jwerty.key("f",function(){activeunit.doattack(!0)});jwerty.key("d",function(){activeunit.resolvehit(1)});jwerty.key("c",function(){activeunit.resolvecritical(1)});jwerty.key("shift+d",function(){activeunit.hull<activeunit.ship.hull?
activeunit.hull++:activeunit.shield<activeunit.ship.shield&&activeunit.shield++;activeunit.show()});0<SETUP.asteroids&&loadrock(s,ROCKDATA);0<OBSTACLES.length&&showrock();log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$(".unit").css("cursor","move");$("#positiondial").show();$(".permalink").show();break;case PLANNING_PHASE:active=0;actionr=[$.Deferred().resolve()];actionrlock=$.Deferred().resolve();log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+
phase]+"</div>");$(".nextphase").prop("disabled",!0);$("#maneuverdial").show();skillturn=0;filltabskill();for(b in squadron)squadron[b].newm=squadron[b].m,squadron[b].beginplanningphase().progress(nextplanning);nextplanning();break;case ACTIVATION_PHASE:log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$(".nextphase").prop("disabled",!0);$("#activationdial").show();for(b in squadron)squadron[b].beginactivationphase().done(nextdecloak);filltabskill();subphase=
DECLOAK_PHASE;skillturn=0;barrier(nextdecloak);break;case COMBAT_PHASE:log("<div>["+UI_translation["turn #"]+round+"]"+UI_translation["phase"+phase]+"</div>");$("#attackdial").show();skillturn=12;for(b in squadron)squadron[b].begincombatphase().done(nextcombat);barrier(nextcombat)}}function barrier(b){$.when.apply(null,actionr).done(b)}function log(b){$("#log").append("<div>"+b+"<div>");$("#log").scrollTop(1E4)}
function permalink(b){b="?"+TEAMS[1].toASCII()+"&"+TEAMS[2].toASCII()+"&"+saverock();document.location.search=b}function resetlink(){switch(phase){case SETUP_PHASE:case SELECT_PHASE:case CREATION_PHASE:phase=0;document.location.search="";nextphase();break;default:permalink()}}function record(b,c,f){}function history_toASCII(){for(var b="",c=0;c<HISTORY.length;c++)b+=HISTORY[c].s+"_"+HISTORY[c].id+";";return b}
function select(b){for(var c in squadron)if(squadron[c].id==b)break;squadron[c].select();$("#"+u.id).attr({color:"black",background:"white"});$("#"+activeunit.id).attr({color:"white",background:"tomato"})}var a1=[.25,.375];a1[10]=.125;a1[100]=.25;var d1=[.375,.375];d1[10]=.25;
function addattackdice(b,c){var f,g,h,l,m=[];for(f=0;f<b;f++)for(h=0;h<b-f;h++)for(g=0;g<b-h-f;g++)l=100*f+h+10*g,m[l]=0,m[l+1]=0,m[l+10]=0,m[l+100]=0;for(f=0;f<b;f++)for(h=0;h<b-f;h++)for(g=0;g<b-h-f;g++)l=100*f+h+10*g,m[l]+=c[l]*a1[0],m[l+1]+=c[l]*a1[1],m[l+10]+=c[l]*a1[10],m[l+100]+=c[l]*a1[100];return m}
function adddefensedice(b,c){var f,g,h,l=[];for(f=0;f<b;f++)for(g=0;g<b-f;g++)h=10*f+g,l[h]=0,l[h+1]=0,l[h+10]=0;for(f=0;f<b;f++)for(g=0;g<b-f;g++)h=10*f+g,l[h]+=c[h]*d1[0],l[h+1]+=c[h]*d1[1],l[h+10]+=c[h]*d1[10];return l}function attackproba(b){var c,f=[];f[0]=a1[0];f[1]=a1[1];f[10]=a1[10];f[100]=a1[100];for(c=2;c<=b;c++)f=addattackdice(c,f);return f}function defenseproba(b){var c,f=[];f[0]=d1[0];f[1]=d1[1];f[10]=d1[10];for(c=2;c<=b;c++)f=adddefensedice(c,f);return f}
function attackwithreroll(b,c,f){var g,h,l,m,q,r,t,v,x=[];if(0==b.reroll||"undefined"==typeof b.reroll)return c;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)for(l=0;l<=f-h-g;l++)t=100*g+h+10*l,x[t]=0;var y=0,z;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)for(l=0;l<=f-h-g;l++)if(t=100*g+h+10*l,m=f-h-l-g,z=b.reroll,y=g,b.reroll>m&&(0==b.focus?b.reroll>g+m?(z=g+m,y=0):y=g-(z-m):z=m),0==z)x[t]+=c[t];else for(m=0;m<=z;m++)for(q=0;q<=z-m;q++)for(r=0;r<=z-m-q;r++)v=100*m+q+10*r,k=100*(y+m)+h+q+10*(l+r),x[k]+=c[t]*ATTACK[z][v];
return x}function defendwithreroll(b,c,f){var g,h,l,m,q,r,t=[];if(0==b.reroll||"undefined"==typeof b.reroll)return c;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)t[10*g+h]=0;var v=0,x;for(g=0;g<=f;g++)for(h=0;h<=f-g;h++)if(q=10*g+h,l=f-h-g,x=b.reroll,v=g,b.reroll>l&&(0==b.focus?b.reroll>g+l?(x=g+l,v=0):v=g-(x-l):x=l),0==x)t[q]+=c[q];else for(l=0;l<=x;l++)for(m=0;m<=x-l;m++)r=10*l+m,k=10*(v+l)+h+m,t[k]+=c[q]*DEFENSE[x][r];return t}
function tohitproba(b,c,f,g,h,l){var m=[],q=[],r,t,v,x,y,z,B,D=0,H=0,I=0,J=g;g=0==l?[]:g;for(r=0;r<=h;r++)for(t=0;t<=h-r;t++)y=r+10*t,m[y]=0;if("undefined"==typeof f)return{proba:[],tohit:0,meanhit:0,meancritical:0,tokill:0};f=attackwithreroll(b,f,h);0<l&&(J=defendwithreroll(c,g,l));for(g=0;20>=g;g++)q[g]=0;for(g=0;g<=h;g++)for(r=0;r<=h-g;r++)for(t=0;t<=h-r-g;t++){y=100*g+10*t+r;var F,G,K,E,L=f[100*g+r+10*t];"undefined"!=typeof b.modifyattackroll&&(y=b.modifyattackroll(y,c));F=Math.floor(y/100);G=
Math.floor((y-100*F)/10);K=y-100*F-10*G;for(E=0;E<=l;E++)for(ef=0;ef<=l-E;ef++)y=10*E+ef,"undefined"!=typeof c.modifydefenseroll&&(y=c.modifydefenseroll(y)),x=Math.floor(y/10),B=y-10*x,v=0==l?1:J[y],z=K,y=0,0<c.evade&&(B+=1),0<c.focus&&(B+=x),0<b.focus&&(z+=F),z>B?(y=z-B,B=0):B-=z,G>B&&(y+=10*(G-B)),m[y]+=L*v}for(r=0;r<=h;r++)for(t=0;t<=h-r;t++)switch(y=r+10*t,0<t+r&&(D+=m[y]),H+=r*m[y],I+=t*m[y],t){case 0:for(g=1;g<=t+r;g++)q[g]+=m[y];break;case 1:for(g=1;g<=t+r;g++)q[g]+=26*m[y]/33;for(g=2;g<=t+
r+1;g++)q[g]+=7*m[y]/33;break;default:for(g=1;g<=t+r;g++)q[g]+=26*m[y]/33*25/32;for(g=2;g<=t+r+1;g++)q[g]+=m[y]*(7/33*.8125+7*(1-7/33)/32);for(g=3;g<=t+r+2;g++)q[g]+=7*m[y]/33*6/32}return{proba:m,tohit:Math.floor(1E4*D)/100,meanhit:0==D?0:Math.floor(100*H)/100,meancritical:0==D?0:Math.floor(100*I)/100,tokill:q}}
function probatable(b,c){var f,g,h="";for(f=0;5>=f;f++){h+="<tr><td>"+f+"</td>";for(g=0;5>=g;g++){var l=g;0<c.adddice&&(l+=c.adddice);l=tohitproba(b,c,ATTACK[f],DEFENSE[l],f,l);h+="<td class='probacell' style='background:hsl("+1.2*(100-l.tohit)+",100%,80%)'>";h+="<div>"+l.tohit+"%</div><div><code class='symbols'>d</code>"+l.meanhit+"</div><div><code class='symbols'>c</code>"+l.meancritical+"</div></td>"}h+="</tr>"}return h}
function fillprobatable(){var b={focus:$("#focusA").prop("checked")?1:0,reroll:$("#targetA").prop("checked")?5:0},c={focus:$("#focusD").prop("checked")?1:0,evade:$("#evadeD").prop("checked")?1:0,adddice:$("#cloakD").prop("checked")?2:0,reroll:0},f;f=parseInt($("#rerollA").val(),10);var g=parseInt($("#rerollD").val(),10);if(0==b.reroll||0<f&&f<b.reroll)b.reroll=f;if(0==c.reroll||0<g&&g<c.reroll)c.reroll=g;b="<tr><th>Rolls</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>"+probatable(b,
c);$("#probatable").html(b)}function modal_dragstart(b){var c=window.getComputedStyle(b.originalEvent.target,null);b.originalEvent.dataTransfer.setData("text/plain",b.target.parentElement.id+","+(parseInt(c.getPropertyValue("left"),10)-b.originalEvent.clientX)+","+(parseInt(c.getPropertyValue("top"),10)-b.originalEvent.clientY))}function modal_dragover(b){b.originalEvent.preventDefault();return!1}
function modal_drop(b){var c=b.originalEvent.dataTransfer.getData("text/plain").split(","),f=c[0];$("#"+f+" > div").css("left",b.originalEvent.clientX+parseInt(c[1],10)+"px");$("#"+f+" > div").css("top",b.originalEvent.clientY+parseInt(c[2],10)+"px");b.originalEvent.preventDefault();return!1}
var viewport_translate=function(b,c){VIEWPORT.m=MT(b,c).add(VIEWPORT.m);$(".phasepanel").hide();VIEWPORT.transform(VIEWPORT.m)},viewport_zoom=function(b){$("#svgout").width();$("#svgout").height();var c=activeunit.m.x(0,0),f=activeunit.m.y(0,0),g=VIEWPORT.m.clone().invert(),h=g.x(c,f),c=g.y(c,f);VIEWPORT.m.translate(h,c).scale(b).translate(-h,-c);VIEWPORT.transform(VIEWPORT.m);activeunit.show()},dragmove=function(b){if(1!=activeunit.dragged&&VIEWPORT.dragged){var c=$("#svgout").width(),f=$("#svgout").height(),
c=Math.max(900/c,900/f);VIEWPORT.dragMatrix=MT((b.offsetX-VIEWPORT.x0)*c,(b.offsetY-VIEWPORT.y0)*c).add(VIEWPORT.m);VIEWPORT.dragged=!0;$(".phasepanel").hide();VIEWPORT.transform(VIEWPORT.dragMatrix)}},dragstart=function(b){VIEWPORT.dragged=!0;"svgout"==b.originalEvent.target.id?(VIEWPORT.x0=b.offsetX,VIEWPORT.y0=b.offsetY,VIEWPORT.dragged=!0,VIEWPORT.dragMatrix=VIEWPORT.m):VIEWPORT.dragged=!1},dragstop=function(b){VIEWPORT.dragged&&(VIEWPORT.m=VIEWPORT.dragMatrix,VIEWPORT.m.clone(),VIEWPORT.transform(VIEWPORT.m),
activeunit.show());VIEWPORT.dragged=!1},changelanguage=function(b){localStorage.LANG=b;log("reloading "+b);location.reload()},changesetup=function(){SETUP=SETUPS[$("#setuplist select").val()];var b=UI_translation[SETUP.description];"undefined"==typeof b&&(b=SETUP.description);$("#setuplist span").html(b);$("#setuplist img").attr("src",SETUP.img)};
$(document).ready(function(){s=Snap("#svgout");VIEWPORT=s.g().attr({id:"viewport"});VIEWPORT.m=new Snap.Matrix;P={F0:{path:s.path("M 0 0 L 0 0").attr({display:"none"}),speed:0,key:"5"},F1:{path:s.path("M 0 0 L 0 -80").attr({display:"none"}),speed:1,key:"8"},F2:{path:s.path("M 0 0 L 0 -120").attr({display:"none"}),speed:2,key:"8"},F3:{path:s.path("M 0 0 L 0 -160").attr({display:"none"}),speed:3,key:"8"},F4:{path:s.path("M 0 0 L 0 -200").attr({display:"none"}),speed:4,key:"8"},F5:{path:s.path("M 0 0 L 0 -240").attr({display:"none"}),
speed:5,key:"8"},TR1:{path:s.path("M0 0 C 0 -40 15 -55 55 -55").attr({display:"none"}),speed:1,key:"6"},TR2:{path:s.path("M0 0 C 0 -50 33 -83 83 -83").attr({display:"none"}),speed:2,key:"6"},TR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105").attr({display:"none"}),speed:3,key:"6"},TRR3:{path:s.path("M0 0 C 0 -60 45 -105 105 -105").attr({display:"none"}),speed:3,key:";"},TL1:{path:s.path("M0 0 C 0 -40 -15 -55 -55 -55").attr({display:"none"}),speed:1,key:"4"},TL2:{path:s.path("M0 0 C 0 -50 -33 -83 -83 -83").attr({display:"none"}),
speed:2,key:"4"},TL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105").attr({display:"none"}),speed:3,key:"4"},TRL3:{path:s.path("M0 0 C 0 -60 -45 -105 -105 -105").attr({display:"none"}),speed:3,key:":"},BR1:{path:s.path("M0 0 C 0 -20 18 -72 38 -92").attr({display:"none"}),speed:1,key:"9"},BR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126").attr({display:"none"}),speed:2,key:"9"},SR2:{path:s.path("M0 0 C 0 -30 24 -96 54 -126").attr({display:"none"}),speed:2,key:"3"},BR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160").attr({display:"none"}),
speed:3,key:"9"},SR3:{path:s.path("M0 0 C 0 -40 29 -120 69 -160").attr({display:"none"}),speed:3,key:"3"},BL1:{path:s.path("M0 0 C 0 -20 -18 -72 -38 -92").attr({display:"none"}),speed:1,key:"7"},BL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126").attr({display:"none"}),speed:2,key:"7"},SL2:{path:s.path("M0 0 C 0 -30 -24 -96 -54 -126").attr({display:"none"}),speed:2,key:"1"},BL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160").attr({display:"none"}),speed:3,key:"7"},SL3:{path:s.path("M0 0 C 0 -40 -29 -120 -69 -160").attr({display:"none"}),
speed:3,key:"1"},K1:{path:s.path("M 0 0 L 0 -80").attr({display:"none"}),speed:1,key:"2"},K2:{path:s.path("M 0 0 L 0 -120").attr({display:"none"}),speed:2,key:"2"},K3:{path:s.path("M 0 0 L 0 -160").attr({display:"none"}),speed:3,key:"2"},K4:{path:s.path("M 0 0 L 0 -200").attr({display:"none"}),speed:4,key:"2"},K5:{path:s.path("M 0 0 L 0 -240").attr({display:"none"}),speed:5,key:"2"}};$.ajaxSetup({beforeSend:function(b){b.overrideMimeType&&b.overrideMimeType("application/json")}});LANG=localStorage.LANG||
window.navigator.userLanguage||window.navigator.language;LANG=LANG.substring(0,2);$.when($.ajax("data/ships.json"),$.ajax("data/strings."+LANG+".json"),$.ajax("data/xws.json"),$.ajax("data/setups.json")).done(function(b,c,f,g){var h=setInterval(function(){ATTACK[dice]=attackproba(dice);DEFENSE[dice]=defenseproba(dice);dice++;8==dice&&(fillprobatable(),$("#showproba").prop("disabled",!1),clearInterval(h))},500);unitlist=b[0];SHIP_translation=c[0].ships;PILOT_translation=c[0].pilots;UPGRADE_translation=
c[0].upgrades;UI_translation=c[0].ui;CRIT_translation=c[0].criticals;c=c[0].css;b="";for(var l in c)b+="."+l+'::after { content:"'+c[l]+'";}\n';$("#localstrings").html(b);UPGRADE_dict=f[0].upgrades;PILOT_dict=f[0].pilots;for(var m in PILOT_dict){for(l=0;l<PILOTS.length;l++)PILOTS[l].name==PILOT_dict[m]&&(PILOTS[l].dict=m);for(l in unitlist)l==PILOT_dict[m]&&(unitlist[l].dict=m)}for(l in g[0].data)SETUPS[l]=g[0].data[l];squadron=[];s.attr({width:"100%",height:"100%",viewBox:"0 0 900 900"});TEAMS[1].setfaction("REBEL");
TEAMS[2].setfaction("EMPIRE");UPGRADES.sort(function(b,c){var f=b.name,g=c.name;"undefined"!=typeof UI_translation[f]&&"undefined"!=typeof UI_translation[f].name&&(f=UI_translation[b.name].name);"undefined"!=typeof UI_translation[g]&&"undefined"!=typeof UI_translation[g].name&&(g=UI_translation[c.name].name);return(f+b.type).localeCompare(g+c.name)});PILOTS.sort(function(b,c){var f=b.points-c.points;return 0==f?b.name.localeCompare(c.name):f});g=f=0;b="";for(l=0;l<PILOTS.length;l++)1==PILOTS[l].done&&
(PILOTS[l].unique&&g++,f++),PILOTS[l].done||(b=PILOTS[l].unique?b+", .":b+", ",b+=PILOTS[l].name);log(f+"/"+PILOTS.length+" pilots with full effect");""!=b&&log("Pilots NOT implemented"+b);f=0;b="";for(l=0;l<UPGRADES.length;l++)1==UPGRADES[l].done?f++:b+=", "+(UPGRADES[l].unique?".":"")+UPGRADES[l].name;$(".ver").html(VERSION);log(f+"/"+UPGRADES.length+" upgrades implemented");log("Upgrades NOT implemented"+b);$("#showproba").prop("disabled",!0);loadsound();jwerty.key("a",function(){theta+=-1*increment;
$("#carousel").css("transform","rotateY("+theta+"deg)")});var q=new Hammer(document.getElementById("svgout"));q.get("pinch").set({enable:!0});q.get("pan").set({direction:Hammer.DIRECTION_ALL});q.on("panleft panright panup pandown",function(b){"svgout"==b.target.id&&1!=activeunit.dragged&&viewport_translate(50*-b.velocityX,50*-b.velocityY)});q.zoom=1;q.on("pinch",function(b){if("svgout"==b.target.id&&1!=activeunit.dragged){var c=VIEWPORT.m.clone().invert(),f=c.x(b.center.x,b.center.y),c=c.y(b.center.x,
b.center.y);VIEWPORT.m.translate(f,c).scale(b.scale).scale(1/q.zoom).translate(-f,-c);q.zoom=b.scale;VIEWPORT.transform(VIEWPORT.m);activeunit.show();b.final&&(q.zoom=1)}});$("aside").on("scroll touchmove touchstart mousewheel",function(b){$("#"+b.target.id+" .outoverflow").each(function(b){"auto"!=$(this).css("top")&&$(this).css("top",$(this).parent().offset().top+"px")})});f=window.location.search.substr(1).split("&");if(1<f.length)return log("Loading permalink..."),ROCKDATA=f[2],phase=CREATION_PHASE,
TEAMS[1].parseASCII(f[0]),TEAMS[1].toJSON(),TEAMS[2].parseASCII(f[1]),TEAMS[2].toJSON(),SETUP=SETUPS["Classic Map"],3<f.length&&(ANIM=$.parseJSON(f[3])),phase=SELECT_PHASE,nextphase();phase=0;nextphase();for(l in SETUPS)m=l,"undefined"!=typeof UI_translation[l]&&(m=UI_translation[l]),$("#setuplist select").append("<option value='"+l+"'>"+m+"</option>");SETUP=SETUPS["Classic Map"];changesetup();$("#squadlist").html("<thead><tr><th></th><th>"+UI_translation.type+"</th><th><span class='m-points'></span></th><th><span class='m-units'></span></th><th></th><th></th></tr></thead>");
$.fn.dataTable.ext.search.push(function(b,c,f){return-1<c[1].search(stype)});SQUADLIST=$("#squadlist").DataTable({language:{search:UI_translation.Search,lengthMenu:UI_translation["Display _MENU_ records per page"],zeroRecords:UI_translation["Nothing found - sorry"],info:UI_translation["Showing page _PAGE_ of _PAGES_"],infoEmpty:UI_translation["No records available"],infoFiltered:UI_translation["(filtered from _MAX_ total records)"]},columnDefs:[{targets:[0],render:function(){return"<div class='closemiddle' onclick='removerow($(this))'>&#xd7;</div><div><button class='m-squad1 button2' onclick='checkrow(1,$(this))'>&#x27a1;</button></div><div><button class='m-squad2 button2' onclick='checkrow(2,$(this))'>&#x27a1;</button></div>"},
sortable:!1},{targets:[1],sortable:!1,render:function(b,c,f){return-1<f[4].search("SQUAD")?"<span style='display:none'>"+b+" USER</span><span class='"+b+"'></span>":"<span style='display:none'>"+b+" PREBUILT</span><span class='"+b+"'></span><span class='prebuilt'></span>"}},{targets:[4],visible:!1,searchable:!1},{targets:[3],render:function(b,c,f){"en"!=LANG&&phase==SELECT_PHASE&&-1==f[4].search("SQUAD")&&(TEAMS[0].parseJuggler(b,!1),b=TEAMS[0].toJuggler(!0));return"<pre>"+b+"</pre>"}}],ajax:"data/full4b.json",
scrollY:"20em",scrollCollapse:!0,ordering:!0,info:!0,paging:!1});for(l in localStorage)"string"==typeof localStorage[l]&&l.match(/SQUAD.*/)&&(f=$.parseJSON(localStorage[l]),"undefined"==typeof f.jug||"undefined"==typeof f.pts?delete localStorage[l]:"en"!=LANG?(TEAMS[0].parseJuggler(f.jug,!1),addrow(0,l,f.pts,f.faction,TEAMS[0].toJuggler(!0))):addrow(0,l,f.pts,f.faction,f.jug));g=[];for(l=0;l<PILOTS.length;l++)f=l,f=PILOTS[l].name,"undefined"!=typeof PILOT_translation[f]&&"undefined"!=typeof PILOT_translation[f].name&&
(f=PILOT_translation[f].name),1==PILOTS[l].ambiguous&&(f+="("+PILOTS[l].unit+")"),g.push(f.replace(/\'/g,"").replace(/\(Scum\)/g,""));b=[];for(l in UPGRADE_translation)f=l,"undefined"!=typeof UPGRADE_translation[f].name&&(f=UPGRADE_translation[l].name),b.push(f.replace(/\'/g,"").replace(/\(Crew\)/g,""));$(".squadbg > textarea").asuggest(g,{delimiters:"^\n",cycleOnTab:!0});$(".squadbg > textarea").asuggest(b,{delimiters:"+ ",cycleOnTab:!0})})});
